define("ivplugin_annotation/main",["exports","jquery","mod_interactivevideo/type/base","core/ajax","core/templates","core/event_dispatcher","core_form/modalform","core_filters/events"],(function(_exports,_jquery,_base,_ajax,_templates,_event_dispatcher,_modalform,_events){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * TODO describe module main
   *
   * @module     ivplugin_annotation/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_base=_interopRequireDefault(_base),_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modalform=_interopRequireDefault(_modalform);class Annotation extends _base.default{async init(){const videoWrapper=(0,_jquery.default)("#video-wrapper");let item=this.annotations.find((annotation=>"annotation"==annotation.type));if(this.isEditMode()){if((0,_jquery.default)(document).on("timeupdate",(function(e){const t=e.originalEvent.detail.time;(0,_jquery.default)("#annotation-canvas .annotation-wrapper").each((function(){let start=(0,_jquery.default)(this).data("start"),end=(0,_jquery.default)(this).data("end");t>=start&&t<=end?(0,_jquery.default)(this).css("visibility","visible"):(0,_jquery.default)(this).css("visibility","hidden")}))})),item){(0,_jquery.default)("#annotation-canvas").attr("data-id",item.id),item.editmode=!0,window.console.log(item);let content=await this.render(item,"json");window.console.log(content),this.postContentRender(item,content)}}else{if(!item||""==item.content)return;const updateAspectRatio=async(video,reset)=>{let elem=video?(0,_jquery.default)("#player"):(0,_jquery.default)(`#annotation-canvas[data-id='${item.id}']`);if((0,_jquery.default)("#wrapper").hasClass("fullscreen")){let ratio=await this.player.ratio(),videowrapperaspect=videoWrapper.width()/videoWrapper.height(),gap="- 55px";(0,_jquery.default)("#wrapper").hasClass("no-videonav")&&(gap=""),videowrapperaspect>ratio?(elem.css("height",`calc(100vh ${gap})`),elem.css("width",`calc((100vh ${gap}) * ${ratio})`),elem.css("top","0"),elem.css("left",`calc((100vw - (100vh ${gap}) * ${ratio}) / 2)`)):videowrapperaspect<ratio&&(elem.css("width","100vw"),elem.css("height",100/ratio+"vw"),elem.css("top",`calc((100vh ${gap} - 100vw / ${ratio}) / 2)`),elem.css("left","0"))}else elem.css("width","100%"),elem.css("height","100%"),elem.css("top","0"),elem.css("left","0");reset&&(elem.css("width","100%"),elem.css("height","100%"),elem.css("top","0"),elem.css("left","0"))};updateAspectRatio(),updateAspectRatio(!0);let vwrapper=document.querySelector("#video-wrapper");new ResizeObserver((()=>{updateAspectRatio(),updateAspectRatio(!0)})).observe(vwrapper),(0,_jquery.default)(document).on("timeupdate",(function(e){updateAspectRatio(!0,!0);const t=e.originalEvent.detail.time;(0,_jquery.default)("#annotation-canvas .annotation-wrapper").each((function(){let start=(0,_jquery.default)(this).data("start"),end=(0,_jquery.default)(this).data("end");t>=start&&t<=end?(0,_jquery.default)(this).css("visibility","visible"):(0,_jquery.default)(this).css("visibility","hidden")}))})),(0,_jquery.default)("#annotation-canvas").attr("data-id",item.id);let content=await this.render(item,"json");this.postContentRender(item,content)}}async renderAnnotationToolbar(annotation){(0,_jquery.default)("#annotation-btns").remove();let annotationitems=[{icon:"bi bi-image",type:"media",mediatype:"image",label:M.util.get_string("image","ivplugin_inlineannotation")},{icon:"bi bi-alphabet-uppercase",type:"text",mediatype:"text",label:M.util.get_string("text","ivplugin_inlineannotation")},{icon:"bi bi-circle-square",type:"shape",mediatype:"shape",label:M.util.get_string("shape","ivplugin_inlineannotation")},{icon:"bi bi-file-earmark-arrow-down",type:"media",mediatype:"file",label:M.util.get_string("inlinefile","ivplugin_inlineannotation")},{icon:"bi bi-sign-turn-right",type:"navigation",mediatype:"navigation",label:M.util.get_string("navigation","ivplugin_inlineannotation")},{icon:"bi bi-plus-circle",type:"hotspot",mediatype:"hotspot",label:M.util.get_string("hotspot","ivplugin_inlineannotation")}];const dataForTemplate={id:annotation.id,items:annotationitems};let html=await _templates.default.render("ivplugin_annotation/toolbar",dataForTemplate);(0,_jquery.default)("#wrapper").append(html),this.enableColorPicker()}postContentRender(annotation,data){let self=this;var $videoWrapper=(0,_jquery.default)("#annotation-canvas"),$playerWrapper=(0,_jquery.default)("#wrapper");const convertSecondsToMMSS=seconds=>{let hours=Math.floor(seconds/3600),minutes=Math.floor((seconds-3600*hours)/60),sec=seconds-3600*hours-60*minutes,formattedTime="";return hours>0&&(formattedTime+=hours+":"),minutes<10&&(formattedTime+="0"),formattedTime+=minutes+":",sec<10&&(formattedTime+="0"),formattedTime+=sec,formattedTime},appendTimestamp=seconds=>{var formattedTime=convertSecondsToMMSS(seconds);(0,_jquery.default)("#scrollbar").append(`<div id="position" class="position-absolute bg-black text-white small rounded-sm p-1"\n                 style="top: -30px;">${formattedTime}</div>`)},updatePositionInfo=elem=>{let w=parseFloat(elem.outerWidth()),hw=parseFloat(elem.outerHeight()),t=parseFloat(elem.position().top)<0?0:parseFloat(elem.position().top),l=parseFloat(elem.position().left)<0?0:parseFloat(elem.position().left),z=elem.css("z-index"),s=elem.data("start"),e=elem.data("end");(0,_jquery.default)("#annotation-btns #position").html(`<i class="bi-bounding-box-circles bi mr-1"></i>\n                    x: <span id="x-position" class="mr-2">${Math.round(l)}</span>\n                    y: <span id="y-position" class="mr-2">${Math.round(t)}</span>\n                    z: <span id="z-position" class="mr-2">${z-5}</span>\n                    w: <span id="w-position" class="mr-2">${Math.round(w)}</span>\n                    h: <span id="h-position" class="mr-2">${Math.round(hw)}</span>\n                <i class="bi-stopwatch bi ml-2 mr-1"></i>\n                <span id="s-position" class="mr-1">${convertSecondsToMMSS(s)}</span>\n                -<span id="e-position" class="mx-1">${convertSecondsToMMSS(e)}</span>`)},recalculatingSize=elem=>{let message=(0,_jquery.default)("#annotation-canvas");(0,_jquery.default)("#annotation-btns #down, #annotation-btns #up").removeAttr("disabled");let w=parseFloat(elem.outerWidth())/parseFloat(message.width())*100,h=parseFloat(elem.outerHeight())/parseFloat(message.height())*100;elem.position().right<0&&elem.css("right","0"),elem.position().bottom<0&&elem.css("bottom","0");let t=parseFloat(elem.position().top)/parseFloat(message.height())*100<0?0:parseFloat(elem.position().top)/parseFloat(message.height())*100,l=parseFloat(elem.position().left)/parseFloat(message.width())*100<0?0:parseFloat(elem.position().left)/parseFloat(message.width())*100,z=elem.css("z-index"),position={width:w+"%",height:h+"%",left:l+"%",top:t+"%","z-index":z};return elem.css(position),6==z&&(0,_jquery.default)("#annotation-btns #down").attr("disabled","disabled"),updatePositionInfo(elem),"video"==elem.data("type")&&elem.find(".playpause").css({"font-size":.2*elem.outerHeight()+"px","line-height":.2*elem.outerHeight()+"px"}),position},recalculatingTextSize=(elem,button)=>{let fontSize=elem.outerHeight();elem.find(".annotation-content").css({"font-size":(button?.7*fontSize:.9*fontSize)+"px","line-height":fontSize+"px","padding-left":(button?.4:.1)+"em","padding-right":(button?.4:.1)+"em"}),elem.css("width","auto")},renderTimelineItems=async(elements,activeid)=>{let timeline=(0,_jquery.default)("#timeline #annotation-timeline");timeline.empty(),elements.sort(((a,b)=>b.position["z-index"]-a.position["z-index"])),elements.forEach(((item,i)=>{let prop=item.properties,type=item.type,id=item.id,left=(prop.start-self.start)/(self.end-self.start)*100,width=(prop.end-prop.start)/(self.end-self.start)*100;timeline.append(`<div class="annotation-timeline-item position-absolute ${activeid==id?"active":""}"\n                     data-item="${id}" data-type="${type}" data-end="${prop.end}" data-start="${prop.start}"\n                         style="left: ${left}%; top: ${7*(i+1)}px; width: ${width}%"></div>`)})),(0,_event_dispatcher.dispatchEvent)("timeupdate",{time:await self.player.getCurrentTime()})},renderItems=async(elements,active,update)=>{update||($videoWrapper.find(".annotation-wrapper").remove(),(0,_jquery.default)("#timeline #annotation-timeline").empty()),elements.sort(((a,b)=>b.position["z-index"]-a.position["z-index"]));let count=0;elements.forEach((item=>{let prop=item.properties,type=item.type,id=item.id,position=item.position,wrapper=(0,_jquery.default)(`<div class="annotation-wrapper" data-start="${prop.start}" data-end="${prop.end}"\n                     data-anno="${annotation.id}" data-item="${id}" data-type="${type}"\n                      data-property='${JSON.stringify(prop)}'></div>`);switch(("1"==prop.resizable||self.isEditMode())&&(wrapper.addClass("resizable"),wrapper.attr("tabindex",0)),type){case"image":var parts=prop.timestamp.split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);""!=prop.gotourl?wrapper.append(`<a href="${prop.gotourl}" target="_blank"><img src="${prop.url}" id="${id}"\n                             class="annotation-content ${1==prop.rounded?"rounded":"rounded-0"} w-100\n                              ${"1"==prop.shadow?"shadow":""}" alt="${prop.formattedalttext}"/></a>`):wrapper.append(`<img src="${prop.url}" id="${id}"\n                                 ${timestamp>0?'data-timestamp="'+timestamp+'"':""} class="annotation-content\n                                 ${1==prop.rounded?"rounded":"rounded-0"} w-100 ${"1"==prop.shadow?"shadow":""}\n                                  ${timestamp>0?"cursor-pointer":""}" alt="${prop.formattedalttext}"/>`),(""!=prop.gototurl||timestamp>0)&&!self.isEditMode()&&wrapper.removeClass("resizable"),wrapper.css(position),wrapper.css("height","auto"),$videoWrapper.append(wrapper);break;case"file":var wrapperhtml;wrapperhtml=`<a id="${id}"\n                        class="btn ${prop.style} ${"1"==prop.rounded?"btn-rounded":"rounded-0"}\n                        annotation-content text-nowrap ${"1"==prop.shadow?"shadow":""} rotatey-180" href="${prop.url}"\n                         target="_blank"><i class="bi bi-paperclip"\n                          style="font-size:0.7em;"></i>${""!=prop.formattedlabel?`<span style="margin-left:0.25em;">${prop.formattedlabel}`:""}</a>`,wrapper.append(`<div class="d-flex h-100">${wrapperhtml}</div>`),position.width=0,wrapper.css(position),$videoWrapper.append(wrapper),recalculatingTextSize(wrapper,!0);break;case"navigation":parts=prop.timestamp.split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);wrapper.append(`<div class="d-flex h-100"><span id="${id}" tabindex="0"\n                             class="btn ${prop.style} ${"1"==prop.rounded?"btn-rounded":"rounded-0"}\n                              annotation-content text-nowrap ${"1"==prop.shadow?"shadow":""}"\n                               data-timestamp="${timestamp}">${prop.formattedlabel}</span></div>`),position.width=0,wrapper.css(position),$videoWrapper.append(wrapper),recalculatingTextSize(wrapper,!0);break;case"text":null!=prop.url&&""!=prop.url?wrapper.append(`<a id="${id}"\n                                 class="annotation-content text-nowrap ${"1"==prop.shadow?"text-shadow":""} d-block"\n                                  href="${prop.url}" target="_blank">${prop.formattedlabel}</a>`):wrapper.append(`<div id="${id}"\n                                 class="annotation-content text-nowrap ${"1"==prop.shadow?"text-shadow":""}\n                                 ">${prop.formattedlabel}</div>`),wrapper.position.width=0,wrapper.css(position);var style={"font-weight":"1"==prop.bold?"bold":"normal","font-style":"1"==prop.italic?"italic":"normal","text-decoration":"1"==prop.underline?"underline":"none",color:prop.textcolor,background:prop.bgcolor,"border-width":prop.borderwidth,"border-color":prop.bordercolor,"border-style":"solid","font-family":""!=prop.textfont?prop.textfont:"inherit"};wrapper.find(".annotation-content").css(style),$videoWrapper.append(wrapper),recalculatingTextSize(wrapper);break;case"shape":parts=prop.timestamp.split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);""!=prop.gotourl?wrapper.append(`<a href="${prop.gotourl}" target="_blank"><div id="${id}"\n                             class="annotation-content ${"1"==prop.shadow?"shadow":""}"\n                              style="width: 100%; height: 100%;"></div></a>`):wrapper.append(`<div id="${id}" class="annotation-content ${"1"==prop.shadow?"shadow":""}\n                                 ${timestamp>0?"cursor-pointer":""}"\n                             ${timestamp>0?'data-timestamp="'+timestamp+'"':""}\n                             style="width: 100%; height: 100%;"></div>`),wrapper.css(position);style={background:prop.bgcolor,"border-width":prop.borderwidth,"border-color":prop.bordercolor,"border-style":"solid",opacity:prop.opacity/100};"circle"==prop.shape?style["border-radius"]="50%":"rectangle"==prop.shape&&(style["border-radius"]="1"==prop.rounded?"10px":"0"),wrapper.find(".annotation-content").css(style),$videoWrapper.append(wrapper);break;case"hotspot":wrapper.append(`<div id="${id}" class="annotation-content shadow-sm pulse" role="button"></div>`),position["aspect-ratio"]="1",wrapper.css(position);style={"background-color":prop.color,opacity:prop.opacity/100,"border-radius":"50%","aspect-ratio":"1"};wrapper.find(".annotation-content").css(style),$videoWrapper.append(wrapper),self.isEditMode()||("1"==prop.usemodal?wrapper.attr({"data-toggle":"modal","data-content":prop.content.text,"data-title":prop.formattedtitle,"data-link":prop.url}):(wrapper.attr({tabindex:-1,"data-trigger":"manual","data-boundary":"viewport","data-placement":"auto","data-html":"true","data-content":'<div class="loader"></div>',"data-title":prop.formattedtitle+'<i class="bi bi-x-circle-fill ml-auto popover-dismiss cursor-pointer"\n                                         style="font-size:1.5em;"></i>'}),wrapper.popover({container:"#wrapper",html:!0,template:`<div class="popover inlineannotation-popover id-${id}"\n                                     role="tooltip"><div class="arrow"></div>\n                                     <h3 class="popover-header d-flex justify-content-between"></h3>\n                                     <div class="popover-body rounded"></div>${""!=prop.url?`<div class="popup-footer bg-gray p-2 rounded-bottom"><a href="${prop.url}"\n                                          class="d-block w-100 text-right rotatex-360" target="_blank">\n                                          <i class="bi bi-arrow-right"><i></i></i></a></div>`:""}</div>`}),wrapper.on("shown.bs.popover",(function(){let $body=(0,_jquery.default)(`.popover.id-${id} .popover-body`);self.formatContent(prop.content.text,M.cfg.contextid).then((html=>{$body.html(html),(0,_events.notifyFilterContentUpdated)($body),wrapper.popover("update")}))})),"1"==prop.openbydefault&&wrapper.popover("show")))}if("shape"!=type&&wrapper.on("mouseover",(function(){if(!(0,_jquery.default)(this).hasClass("resizable"))return;let aspectRatio=(0,_jquery.default)(this).find(".annotation-content").width()/(0,_jquery.default)(this).find(".annotation-content").height();wrapper.width()/wrapper.height()==aspectRatio||"image"!=type&&"video"!=type||(0,_jquery.default)(this).height(wrapper.width()/aspectRatio),(0,_jquery.default)(this).resizable("option","aspectRatio",(0,_jquery.default)(this).find(".annotation-content").outerWidth()/(0,_jquery.default)(this).find(".annotation-content").outerHeight())})),id==active&&wrapper.trigger("click"),count++,count==elements.length){const currentTime=self.player.getCurrentTime();(0,_event_dispatcher.dispatchEvent)("timeupdate",{time:currentTime}),self.isEditMode()&&(renderTimelineItems(elements,active),0==(0,_jquery.default)("#annotation-btns").is(":visible")&&$videoWrapper.find(".annotation-wrapper").addClass("no-pointer-events"),$videoWrapper.find(".annotation-wrapper").draggable({containment:"#annotation-canvas",cursor:"move",handle:".annotation-content",stop:function(){recalculatingSize((0,_jquery.default)(this)),(0,_jquery.default)(this).trigger("click")},drag:function(){updatePositionInfo((0,_jquery.default)(this))}}),$videoWrapper.find(".annotation-wrapper").resizable({containment:"#annotation-canvas",handles:"all",start:function(event){"shape"==(0,_jquery.default)(this).data("type")&&event.ctrlKey&&(0,_jquery.default)(this).resizable("option","aspectRatio",1)},stop:function(){let type=(0,_jquery.default)(this).data("type");"text"==type||"file"==type||"navigation"==type?recalculatingTextSize((0,_jquery.default)(this),"text"!=type):"shape"==type&&(0,_jquery.default)(this).resizable("option","aspectRatio",!1),recalculatingSize((0,_jquery.default)(this)),(0,_jquery.default)(this).trigger("click")},resize:function(event){let type=(0,_jquery.default)(this).data("type");"text"==type||"file"==type||"navigation"==type?recalculatingTextSize((0,_jquery.default)(this),"text"!=type):"shape"==type&&event.ctrlKey&&(0,_jquery.default)(this).resizable("option","aspectRatio",1),updatePositionInfo((0,_jquery.default)(this))}}),(0,_jquery.default)("#timeline #annotation-timeline .annotation-timeline-item").draggable({axis:"x",containment:"parent",cursor:"move",start:function(){let elementid=(0,_jquery.default)(this).data("item");$videoWrapper.find(`.annotation-wrapper[data-item="${elementid}"]`).trigger("click"),appendTimestamp((0,_jquery.default)(this).data("timestamp")),(0,_jquery.default)("#timeline-items").addClass("no-pointer-events"),(0,_jquery.default)(this).addClass("no-pointer-events")},drag:async function(e,ui){let timestamp=ui.position.left/(0,_jquery.default)("#annotation-timeline").width()*self.totaltime+self.start;await self.player.seek(Math.round(timestamp)),self.player.pause(),(0,_jquery.default)("#scrollbar").css("left",(timestamp-self.start)/self.totaltime*100+"%"),(0,_jquery.default)("#scrollbar #position").text(convertSecondsToMMSS(Math.round(timestamp)));let length=(0,_jquery.default)(this).data("end")-(0,_jquery.default)(this).data("start");window.console.log((0,_jquery.default)(this).data("end"),(0,_jquery.default)(this).data("start")),(0,_jquery.default)("#s-position").text(convertSecondsToMMSS(Math.round(timestamp))),(0,_jquery.default)("#e-position").text(convertSecondsToMMSS(Math.round(timestamp)+length))},stop:function(e,ui){(0,_jquery.default)("#scrollbar #position").remove(),(0,_jquery.default)("#timeline-items").removeClass("no-pointer-events"),(0,_jquery.default)(this).removeClass("no-pointer-events");let elementid=(0,_jquery.default)(this).data("item"),elem=$videoWrapper.find(`.annotation-wrapper[data-item="${elementid}"]`),prop=elem.data("property"),timestamp=ui.position.left/(0,_jquery.default)("#annotation-timeline").width()*self.totaltime+self.start,duration=prop.end-prop.start;prop.start=Math.round(ui.position.left/(0,_jquery.default)("#annotation-timeline").width()*self.totaltime+self.start),prop.end=Math.round(prop.start+duration),elem.attr("data-property",JSON.stringify(prop)),elem.attr("data-start",prop.start),elem.attr("data-end",prop.end),(0,_jquery.default)("#scrollbar").css("left",(Math.round(timestamp)-self.start)/self.totaltime*100+"%"),(0,_jquery.default)(this).attr("data-start",prop.start),getItems(!1),renderItems(items,elementid,!1),(0,_event_dispatcher.dispatchEvent)("timeupdate",{time:Math.round(timestamp)}),(0,_jquery.default)("#s-position").text(convertSecondsToMMSS(Math.round(timestamp))),(0,_jquery.default)("#e-position").text(convertSecondsToMMSS(Math.round(timestamp)+duration))}}),(0,_jquery.default)("#timeline #annotation-timeline .annotation-timeline-item").resizable({handles:"e, w",containment:"parent",start:function(){let elementid=(0,_jquery.default)(this).data("item");$videoWrapper.find(`.annotation-wrapper[data-item="${elementid}"]`).trigger("click"),appendTimestamp((0,_jquery.default)(this).data("timestamp")),(0,_jquery.default)("#timeline-items").addClass("no-pointer-events")},resize:async function(e,ui){let timestamp;ui.originalPosition.left!=ui.position.left||ui.originalSize.width==ui.size.width?(ui.position.left<0&&(ui.position.left=0),timestamp=ui.position.left/(0,_jquery.default)("#annotation-timeline").width()*self.totaltime+self.start):timestamp=(ui.position.left+ui.size.width)/(0,_jquery.default)("#annotation-timeline").width()*self.totaltime+self.start,(0,_jquery.default)("#scrollbar").css("left",(timestamp-self.start)/self.totaltime*100+"%"),await self.player.seek(Math.round(timestamp)),self.player.pause(),(0,_jquery.default)("#scrollbar #position").text(convertSecondsToMMSS(Math.round(timestamp)));let start=ui.position.left/(0,_jquery.default)("#annotation-timeline").width()*self.totaltime+self.start,end=(ui.position.left+ui.size.width)/(0,_jquery.default)("#annotation-timeline").width()*self.totaltime+self.start;(0,_jquery.default)("#s-position").text(convertSecondsToMMSS(Math.round(start))),(0,_jquery.default)("#e-position").text(convertSecondsToMMSS(Math.round(end)))},stop:async function(e,ui){(0,_jquery.default)("#scrollbar #position").remove(),setTimeout((function(){(0,_jquery.default)("#timeline-items").removeClass("no-pointer-events")}),200);let timestamp,direction,elementid=(0,_jquery.default)(this).data("item"),elem=$videoWrapper.find(`.annotation-wrapper[data-item="${elementid}"]`),prop=elem.data("property");ui.originalPosition.left!=ui.position.left?(ui.position.left<0&&(ui.position.left=0),timestamp=ui.position.left/(0,_jquery.default)("#annotation-timeline").width()*self.totaltime+self.start,direction="left"):(timestamp=(ui.position.left+ui.size.width)/(0,_jquery.default)("#annotation-timeline").width()*self.totaltime+self.start,direction="right"),"left"==direction?prop.start=Math.round(timestamp):prop.end=Math.round(timestamp),elem.attr("data-property",JSON.stringify(prop)),elem.attr("data-start",prop.start),elem.attr("data-end",prop.end),await self.player.seek(Math.round(timestamp)),self.player.pause(),(0,_jquery.default)("#scrollbar").css("left",(timestamp-self.start)/self.totaltime*100+"%"),(0,_jquery.default)(this).attr("data-start",prop.start),getItems(!1),renderItems(items,elementid,!1),(0,_event_dispatcher.dispatchEvent)("timeupdate",{time:Math.round(timestamp)}),(0,_jquery.default)("#s-position").text(convertSecondsToMMSS(Math.round(prop.start))),(0,_jquery.default)("#e-position").text(convertSecondsToMMSS(Math.round(prop.end)))}}))}})),self.isEditMode()||($videoWrapper.on("click",".annotation-wrapper",(function(e){e.stopImmediatePropagation();let wrapper=(0,_jquery.default)(this);switch(wrapper.data("type")){case"navigation":case"image":case"shape":var navigation=wrapper.find(".annotation-content");navigation.data("timestamp")&&self.isBetweenStartAndEnd(navigation.data("timestamp"))&&(self.player.seek(navigation.data("timestamp")),self.player.play());break;case"hotspot":if("modal"==wrapper.data("toggle")){let title=wrapper.data("title"),content=wrapper.data("content"),url=wrapper.data("link"),modal=`<div class="modal fade" id="annotation-modal" role="dialog"\n                                aria-labelledby="annotation-modal"\n                             aria-hidden="true" data-backdrop="static" data-keyboard="false">\n                             <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">\n                                <div class="modal-content rounded-lg">\n                                    <div class="modal-header d-flex align-items-center shadow-sm pr-0" id="title">\n                                        <h5 class="modal-title text-truncate mb-0">${title}</h5>\n                                        <button class="btn mx-2 p-0 close" aria-label="Close" data-dismiss="modal">\n                                            <i class="bi bi-x-lg fa-fw" style="font-size: x-large;"></i>\n                                        </button>\n                                    </div>\n                                    <div class="modal-body" id="content">\n                                    <div class="loader"></div>\n                                    </div>\n                                    ${""!=url?`<div class="modal-footer bg-gray p-2 rounded-bottom">\n                                        <a href="${url}" class="d-block w-100 text-right rotatex-360" target="_blank">\n                                        <i class="bi bi-arrow-right"><i></i></i></a></div>`:""}\n                                    </div>\n                                </div>\n                                </div>`;(0,_jquery.default)("#wrapper").append(modal),(0,_jquery.default)("#annotation-modal").modal("show"),(0,_jquery.default)("#annotation-modal").on("hide.bs.modal",(function(){(0,_jquery.default)("#annotation-modal").remove()})),(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(async function(){(0,_jquery.default)("#annotation-modal .modal-body").fadeIn(300);let $body=(0,_jquery.default)("#annotation-modal .modal-body");const html=await self.formatContent(content,M.cfg.contextid);$body.html(html),(0,_events.notifyFilterContentUpdated)($body)}))}else wrapper.popover("show")}})),$playerWrapper.on("click",".popover-dismiss",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)(this).closest(".popover").remove()})))};let vwrapper=document.querySelector("#video-wrapper");new ResizeObserver((()=>{let existingwrapper=(0,_jquery.default)("#annotation-canvas").find(".annotation-wrapper");0!=existingwrapper.length&&existingwrapper.each((function(){let type=(0,_jquery.default)(this).data("type");"text"==type||"file"==type||"navigation"==type?recalculatingTextSize((0,_jquery.default)(this),"text"!=type):"video"==type&&recalculatingSize((0,_jquery.default)(this))}))})).observe(vwrapper);let items=[];""!=data.items&&null!==data.items&&(items=JSON.parse(data.items));let draftitemid=data.draftitemid;if(renderItems(items,null,!1),!self.isEditMode())return;const getItems=updateid=>{items=[],$videoWrapper.find(".annotation-wrapper").each((function(index,element){let item={id:updateid?(new Date).getTime()+index:(0,_jquery.default)(element).data("item"),type:(0,_jquery.default)(element).data("type"),position:recalculatingSize((0,_jquery.default)(element)),properties:JSON.parse((0,_jquery.default)(element).attr("data-property"))};items.push(item)}))};(0,_jquery.default)(document).on("click",".annotation-timeline-item",(function(e){e.preventDefault(),e.stopImmediatePropagation();let elementid=(0,_jquery.default)(this).data("item"),elem=$videoWrapper.find(`.annotation-wrapper[data-item="${elementid}"]`);(0,_jquery.default)(".annotation-timeline-item").removeClass("active"),(0,_jquery.default)(this).addClass("active"),elem.trigger("click"),self.player.seek((0,_jquery.default)(this).data("start"))})),$playerWrapper.on("click","#annotation-btns #save",(function(e){e.preventDefault(),e.stopImmediatePropagation(),getItems(!0);let cleanItems=JSON.stringify(items).replace(/</g,"&lt;").replace(/>/g,"&gt;"),updateId=$videoWrapper.data("id");_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quickeditfield",sesskey:M.cfg.sesskey,id:updateId,field:"content",contextid:M.cfg.contextid,draftitemid:draftitemid,value:cleanItems,cmid:self.cmid,token:self.token},success:function(data){let updated=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"edit"})}})})),(0,_jquery.default)(document).on("click","#annotation-btns #closetoolbar",(function(e){e.preventDefault(),(0,_jquery.default)("#annotation-btns").remove(),(0,_jquery.default)("#interaction-timeline, #video-timeline-wrapper, #timeline-btns").show(),(0,_jquery.default)("#content-region").removeClass("no-pointer-events"),(0,_jquery.default)("#annotation-timeline").hide(),(0,_jquery.default)("#annotation-canvas .annotation-wrapper").addClass("no-pointer-events").removeClass("active")}));const handleFormData=(newItem,type,add)=>{switch(type){case"file":add&&(newItem.position.height="40px",newItem.position.width="130px");break;case"navigation":case"text":newItem.width="0";break;case"shape":add&&(newItem.position.height="100px",newItem.position.width="100px");break;case"image":newItem.position.height="auto";break;case"hotspot":add&&(newItem.position.width="5%")}items.push(newItem),renderItems(items,newItem.id,!1)};$playerWrapper.on("click","#annotation-btns .add-ia",(async function(e){e.preventDefault(),e.stopImmediatePropagation();let annoid=$videoWrapper.data("id"),type=(0,_jquery.default)(this).attr("data-mediatype"),currenttime=await self.player.getCurrentTime(),iaform=new _modalform.default({formClass:"ivplugin_annotation\\items\\"+(0,_jquery.default)(this).attr("data-type"),args:{contextid:M.cfg.contextid,id:0,type:type,annotationid:annoid,start:currenttime,end:currenttime+5},modalConfig:{title:M.util.get_string("addinlineannotation","ivplugin_inlineannotation",M.util.get_string(type,"ivplugin_inlineannotation"))}});iaform.show(),iaform.addEventListener(iaform.events.LOADED,(()=>{iaform.modal.modal.draggable({handle:".modal-header"}),"navigation"!=type&&"image"!=type&&"shape"!=type||(0,_jquery.default)(document).on("change",'[name="timestamp"]',(function(e){e.preventDefault();let parts=(0,_jquery.default)(this).val().split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);if(!self.isBetweenStartAndEnd(timestamp)){let message=M.util.get_string("timemustbebetweenstartandendtime","ivplugin_inlineannotation",{start:self.convertSecondsToHMS(self.start),end:self.convertSecondsToHMS(self.end)});return self.addNotification(message),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}if(self.isInSkipSegment(timestamp))return self.addNotification(M.util.get_string("interactionisbetweentheskipsegment","ivplugin_inlineannotation")),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}))})),iaform.addEventListener(iaform.events.FORM_SUBMITTED,(e=>{getItems(!1);let left=100*Math.random(),top=100*Math.random(),newItem={id:(new Date).getTime(),type:type,position:{width:"30%",left:left+"px",top:top+"px","z-index":items.length+6},properties:e.detail};handleFormData(newItem,type,!0)}))})),$playerWrapper.on("click","#annotation-btns #edit",(function(e){e.preventDefault(),e.stopImmediatePropagation();let annnoid=$videoWrapper.data("id"),active=(0,_jquery.default)("#edit-btns").attr("data-active");getItems(!1);let item=items.find((x=>x.id==active)),type=item.type,formdata={...item.properties};formdata.contextid=M.cfg.contextid,formdata.id=item.id,formdata.annotationid=annnoid,formdata.type=type;let editform=new _modalform.default({formClass:"ivplugin_annotation\\items\\"+("image"==type||"file"==type?"media":type),args:item.properties,modalConfig:{title:M.util.get_string("editinlineannotation","ivplugin_inlineannotation",M.util.get_string(type,"ivplugin_inlineannotation"))}});editform.show(),editform.addEventListener(editform.events.LOADED,(()=>{editform.modal.modal.draggable({handle:".modal-header"}),"navigation"!=type&&"image"!=type&&"shape"!=type||(0,_jquery.default)(document).on("change",'[name="timestamp"]',(function(e){e.preventDefault();let parts=(0,_jquery.default)(this).val().split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);if(!self.isBetweenStartAndEnd(timestamp)){let message=M.util.get_string("timemustbebetweenstartandendtime","mod_interactivevideo",{start:self.convertSecondsToHMS(self.start),end:self.convertSecondsToHMS(self.end)});return self.addNotification(message),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}if(self.isInSkipSegment(timestamp))return self.addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo")),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}))})),editform.addEventListener(editform.events.FORM_SUBMITTED,(e=>{getItems(!1),item=items.find((x=>x.id==active)),item.properties=e.detail,$videoWrapper.find(`.annotation-wrapper[data-item="${active}"]`).remove(),items=items.filter((x=>x.id!=active)),handleFormData(item,type,!1)}))})),$videoWrapper.on("click",".annotation-wrapper",(function(e){e.preventDefault(),e.stopImmediatePropagation(),e.ctrlKey?(0,_jquery.default)(this).hasClass("active")?(0,_jquery.default)(this).removeClass("active"):((0,_jquery.default)(this).addClass("active"),this.focus()):((0,_jquery.default)("#annotation-btns .btn").removeClass("active rotatey-360"),$videoWrapper.find(".annotation-wrapper").removeClass("active"),(0,_jquery.default)(this).addClass("active"),this.focus(),recalculatingSize((0,_jquery.default)(this))),recalculatingSize((0,_jquery.default)(this));const id=(0,_jquery.default)(this).data("item");(0,_jquery.default)("#timeline #annotation-timeline .annotation-timeline-item").removeClass("active"),(0,_jquery.default)(`#timeline #annotation-timeline .annotation-timeline-item[data-item="${id}"]`).addClass("active");var activewrapper=$videoWrapper.find(".annotation-wrapper.active");if(0==activewrapper.length)(0,_jquery.default)("#edit-btns").attr("data-active","").addClass("d-none").removeClass("d-flex"),(0,_jquery.default)("#annotation-btns #edit").attr("disabled","disabled"),(0,_jquery.default)("#annotation-btns #edit").removeAttr("disabled");else{let dataActive=activewrapper.map((function(){return(0,_jquery.default)(this).data("item")})).get();(0,_jquery.default)("#edit-btns").attr("data-active",dataActive).addClass("d-flex").removeClass("d-none"),activewrapper.each((function(){let type=(0,_jquery.default)(this).data("type");(0,_jquery.default)(`#annotation-btns .btn[data-mediatype="${type}"]`).addClass("active rotatey-360")})),activewrapper.length>1?(0,_jquery.default)("#annotation-btns #edit").attr("disabled","disabled"):(0,_jquery.default)("#annotation-btns #edit").removeAttr("disabled")}})),$playerWrapper.on("click","#annotation-btns #up",(function(e){e.preventDefault(),e.stopImmediatePropagation();let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(","),active.forEach((item=>{let activeItem=(0,_jquery.default)(`.annotation-wrapper[data-item="${item}"]`),zIndex=parseInt(activeItem.css("z-index"));activeItem.css("z-index",zIndex+1),recalculatingSize(activeItem)})),1==active.length&&(active=active[0]),getItems(!1),renderTimelineItems(items,active)})),$playerWrapper.on("click","#annotation-btns #down",(function(e){e.preventDefault(),e.stopImmediatePropagation();let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(","),active.forEach((item=>{let activeItem=(0,_jquery.default)(`.annotation-wrapper[data-item="${item}"]`),zIndex=parseInt(activeItem.css("z-index"));activeItem.css("z-index",zIndex-1),recalculatingSize(activeItem)})),1==active.length&&(active=active[0]),getItems(!1),renderTimelineItems(items,active)})),$playerWrapper.on("click","#annotation-btns #delete",(function(e){e.preventDefault(),e.stopImmediatePropagation();let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(","),active.forEach((item=>{(0,_jquery.default)(`.annotation-wrapper[data-item="${item}"]`).remove(),(0,_jquery.default)("#edit-btns").attr("data-active","").addClass("d-none").removeClass("d-flex")})),getItems(!1),renderTimelineItems(items,null),(0,_jquery.default)("#annotation-btns .btn").removeClass("active rotatey-360")})),$playerWrapper.on("click","#annotation-btns #copy",(function(e){e.preventDefault(),e.stopImmediatePropagation(),getItems(!1);let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(",");let newItems=[];for(let i=0;i<active.length;i++){let a=active[i],activeItem=(0,_jquery.default)(`.annotation-wrapper[data-item="${a}"]`);activeItem.removeClass("active");let newItem={...items.find((x=>x.id==a))};newItem.position=recalculatingSize(activeItem),newItem.id=(new Date).getTime(),newItems.push(newItem.id),newItem.position.zIndex=items.length+6,newItem.position.left=parseInt(newItem.position.left)+5+"%",newItem.position.top=parseInt(newItem.position.top)+5+"%",items.push(newItem),renderItems(items,null,!1),i==active.length-1&&((0,_jquery.default)("#edit-btns").attr("data-active",newItems.join(",")).addClass("d-flex").removeClass("d-none"),newItems.forEach((ni=>{(0,_jquery.default)(`.annotation-wrapper[data-item="${ni}"]`).addClass("active")})),document.querySelector(".annotation-wrapper.active").focus())}})),$playerWrapper.on("keydown",".annotation-wrapper",(function(e){let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(",");for(let i=0;i<active.length;i++){let a=active[i],activeItem=(0,_jquery.default)(`.annotation-wrapper[data-item="${a}"]`);if(null!=activeItem){let position=activeItem.position();position["z-index"]=parseInt(activeItem.css("z-index"));let ctrl=e.ctrlKey||e.metaKey,step=1;switch(e.preventDefault(),e.stopImmediatePropagation(),e.key){case"ArrowUp":if(ctrl){position["z-index"]=position["z-index"]+1;break}position.top>0&&(position.top=position.top-step);break;case"ArrowDown":if(ctrl){position["z-index"]=position["z-index"]-1;break}position.top+activeItem.outerHeight()<$videoWrapper.height()&&(position.top=position.top+step);break;case"ArrowLeft":position.left>0&&(position.left=position.left-step);break;case"ArrowRight":position.left+activeItem.outerWidth()<$videoWrapper.width()&&(position.left=position.left+step);break;case"Delete":return void(0,_jquery.default)("#annotation-btns #delete").trigger("click");case"d":return void(ctrl&&(0,_jquery.default)("#annotation-btns #copy").trigger("click"));default:return}activeItem.css(position),recalculatingSize(activeItem)}}})),(0,_jquery.default)(document).on("annotationdeleted",(function(e){let deleted=e.originalEvent.detail.annotation;$videoWrapper.data("id")==deleted.id&&($videoWrapper.find(".annotation-wrapper").remove(),(0,_jquery.default)("#annotation-btns").remove(),(0,_jquery.default)("#timeline #annotation-timeline .annotation-timeline-item").remove())}))}async renderEditItem(annotations,listItem,item){return this.annotations=annotations,listItem.removeAttr("id").removeClass("d-none"),listItem.attr("data-type",item.type),listItem.addClass(item.type),listItem.attr("data-id",item.id),listItem.removeAttr("data-timestamp"),listItem.find(".timestamp").remove(),listItem.find(".title").text(item.formattedtitle).addClass("no-pointer-events"),listItem.find(".btn.xp").remove(),listItem.find(".type-icon i").addClass(this.prop.icon),listItem.find(".type-icon").attr("title",this.prop.title),listItem.find(".btn.copy").remove(),listItem.appendTo("#annotation-list"),listItem}async editAnnotation(annotations,id){this.annotations=annotations;let item=this.annotations.find((annotation=>annotation.id==id));(0,_jquery.default)("#annotation-canvas").attr("data-id",item.id),(0,_jquery.default)("#interaction-timeline, #video-timeline-wrapper, #timeline-btns").hide(),(0,_jquery.default)("#content-region").addClass("no-pointer-events"),(0,_jquery.default)("#annotation-timeline").show(),(0,_jquery.default)("#annotation-canvas .annotation-wrapper").removeClass("no-pointer-events"),this.renderAnnotationToolbar(item)}async addAnnotation(annotations,timestamp,coursemodule){let self=this;if(annotations.find((annotation=>annotation.type==self.prop.name)))return void self.addNotification("Annotation already exists","danger");let data={title:"Annotation",timestamp:-1,contextid:M.cfg.contextid,type:self.prop.name,courseid:self.course,cmid:coursemodule,annotationid:self.interaction,hascompletion:0,advanced:JSON.stringify({visiblebeforecompleted:"1",visibleaftercompleted:null,clickablebeforecompleted:"1",clickableaftercompleted:null,replaybehavior:"1"})},ajax=await _ajax.default.call([{methodname:"ivplugin_annotation_add",args:{annotationdata:JSON.stringify(data)},contextid:M.cfg.contextid}])[0],newAnnotation=JSON.parse(ajax.data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:newAnnotation,action:"add"}),self.annotations=annotations,(0,_jquery.default)("#contentmodal").modal("hide"),self.editAnnotation(annotations,newAnnotation.id)}runInteraction(annotation){return annotation}}return _exports.default=Annotation,_exports.default}));

//# sourceMappingURL=main.min.js.map