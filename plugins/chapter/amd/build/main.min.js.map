{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Interactive video chapter type script\n *\n * @module     ivplugin_chapter/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\n\nexport default class Chapter extends Base {\n    /**\n     * Initialize the interaction type\n     * @returns {void}\n     */\n    init() {\n        let self = this;\n        let chapters = this.annotations.filter((annotation) => annotation.type == 'chapter');\n\n        $(\"#chaptertoggle\").removeClass('d-none');\n        // Order the chapters by timestamp.\n        chapters.sort((a, b) => a.timestamp - b.timestamp);\n        // If the first chapter doesn't start at the beginning, add a chapter at the beginning.\n        if (chapters[0].timestamp > this.start) {\n            chapters.unshift({\n                id: 0,\n                title: M.util.get_string('startchapter', 'ivplugin_chapter'),\n                formattedtitle: M.util.get_string('startchapter', 'ivplugin_chapter'),\n                timestamp: this.start\n            });\n        }\n        // Calculate start and end time of each chapter.\n        chapters.forEach((chapter, index) => {\n            chapter.start = chapter.timestamp;\n            if (index < chapters.length - 1) {\n                chapter.end = chapters[index + 1].timestamp;\n            } else {\n                chapter.end = this.end;\n            }\n        });\n\n        const convertSecondsToHMS = (seconds) => {\n            var h = Math.floor(seconds / 3600);\n            var m = Math.floor(seconds % 3600 / 60);\n            var s = Math.floor(seconds % 3600 % 60);\n            return (h > 0 ? h + ':' : '') + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;\n        };\n\n        // Render the chapters.\n        const $chapterlists = $('[data-region=chapterlists]');\n        $chapterlists.empty();\n        chapters.forEach((chapter) => {\n            $chapterlists.append(`<li class=\"p-0 flex-column border-left-0 border-right-0 chapter\n            list-group-item d-flex justify-content-between align-items-center cursor-pointer\"\n            data-id=\"${chapter.id}\" data-start=\"${chapter.start}\" data-end=\"${chapter.end}\">\n            <div class=\"w-100 d-flex align-items-center justify-content-between p-2\">\n            <span class=\"flex-grow-1 text-truncate font-weight-bold\"><i class=\"bi bi-chevron-down mr-2 toggle\"></i>\n            <span class=\"chapter-title\">${chapter.formattedtitle}</span></span><span class=\"badge badge-primary badge-pill\">\n            ${convertSecondsToHMS(chapter.start - this.start)}</span></div>\n            <ul class=\"annolistinchapter w-100 p-0\"></ul></li>`);\n        });\n\n        var interval = setInterval(async () => {\n            var currenttime = await this.player.getCurrentTime();\n            if (currenttime >= this.end) {\n                clearInterval(interval);\n                return;\n            }\n            var currentchapter = chapters.find((chapter) => currenttime >= chapter.start && currenttime < chapter.end);\n            if (currentchapter) {\n                $chapterlists.find('.chapter').removeClass('active-chapter');\n                $chapterlists.find(`.chapter[data-id=${currentchapter.id}]`).addClass('active-chapter');\n            }\n        }, 1000);\n\n        $chapterlists.on('click', '.chapter .chapter-title', function (e) {\n            e.preventDefault();\n            // Hide the start, end screen.\n            $('#start-screen').fadeOut(300);\n            $('#end-screen').fadeOut(300);\n\n            let starttime = $(this).closest('li').data('start');\n            self.player.seek(starttime);\n\n            self.player.play();\n\n            // Replace the progress bar.\n            const percentage = (starttime - self.start) / self.totaltime * 100;\n            $('#video-nav #progress').replaceWith(`<div id=\"progress\"\n             style=\"width: ${percentage > 100 ? 100 : percentage}%;\"></div>`);\n            // If the .chapter is in the left container, hide it.\n            if ($(this).closest('#chapter-container-left').length > 0) {\n                $('#chaptertoggle .btn').trigger('click');\n            }\n        });\n\n        // Chapter toggle.\n        $(document).on('click', '#chaptertoggle .btn', function (e) {\n            e.preventDefault();\n            $('#interactivevideo-container').toggleClass('chapter-open');\n            $(this).find('i').toggleClass('bi-collection bi-collection-fill');\n        });\n\n        $(document).on('click', '#closechapter', function (e) {\n            e.preventDefault();\n            $('#chaptertoggle .btn').trigger('click');\n        });\n\n        // Collapse/Expand the chapters on click of the chevron.\n        $(document).on('click', '.chapter i.toggle.bi', function (e) {\n            e.preventDefault();\n            $(this).closest('.chapter').find('.annolistinchapter').slideToggle(300);\n            $(this).toggleClass('bi-chevron-down bi-chevron-right');\n        });\n    }\n\n    renderEditItem(annotations, listItem, item) {\n        listItem = super.renderEditItem(annotations, listItem, item);\n        listItem.find('.type-name').addClass('justify-content-center');\n        listItem.find('.type-icon i').remove();\n        if (Number(item.timestamp) > this.end || Number(item.timestamp) < this.start || this.isSkipped(item.timestamp)) {\n            listItem.find('.title').addClass('text-muted');\n        }\n        return listItem;\n    }\n    /**\n     * Render the annotation on the video navigation\n     * @param {object} annotation The annotation object\n     * @returns {void}\n     */\n    renderItemOnVideoNavigation(annotation) {\n        if (annotation.hide) {\n            return;\n        }\n        if (annotation.timestamp < this.start || annotation.timestamp > this.end) {\n            return;\n        }\n        const percentage = ((Number(annotation.timestamp) - this.start) / this.totaltime) * 100;\n        if (this.isVisible(annotation)) {\n            $(\"#video-nav ul\").append(`<li class=\"annotation ${annotation.type}\n             ${this.isClickable(annotation) ? '' : 'no-pointer-events'} li-draggable\" data-timestamp=\"${annotation.timestamp}\"\n              data-id=\"${annotation.id}\" style=\"left: calc(${percentage}% - 5px)\">\n        <div class=\"item\" data-toggle=\"tooltip\" data-container=\"#wrapper\" data-trigger=\"hover\" data-html=\"true\"\n        data-original-title='<i class=\"${this.prop.icon} mr-1\"></i>${annotation.formattedtitle}'></div></li>`);\n        }\n    }\n    /**\n     * Run the interaction\n     * @param {object} annotation The annotation object\n     * @returns {void}\n     */\n    runInteraction(annotation) {\n        $('#controler').addClass('no-pointer-events');\n        $('#video-wrapper').append(`<h2 id=\"message\" class=\"chapter position-absolute w-100 py-4\n        px-3 m-0 justify-content-start\"><span class=\"text-truncate\">${annotation.formattedtitle}</span></h2>`);\n        // Add a progress bar and load it for 3 seconds.\n        $('#video-wrapper #message').append(`<div id=\"chapterprogress\"\n        class=\"progress position-absolute w-100\">\n        <div class=\"progress-bar\"></div></div>`);\n        $('#message span').animate({\n            'top': '30px',\n        }, 300, 'swing');\n        $('#chapterprogress .progress-bar').animate({ width: '100%' }, 3000, 'linear', () => {\n            if (!this.isEditMode()) {\n                $('#message span').css('top', '0');\n                this.player.play();\n                $('#controler').removeClass('no-pointer-events');\n            } else {\n                $('h2#message').remove();\n            }\n        });\n    }\n}"],"names":["Chapter","Base","init","self","this","chapters","annotations","filter","annotation","type","removeClass","sort","a","b","timestamp","start","unshift","id","title","M","util","get_string","formattedtitle","forEach","chapter","index","length","end","$chapterlists","empty","seconds","h","m","s","append","Math","floor","interval","setInterval","async","currenttime","player","getCurrentTime","clearInterval","currentchapter","find","addClass","on","e","preventDefault","fadeOut","starttime","closest","data","seek","play","percentage","totaltime","replaceWith","trigger","document","toggleClass","slideToggle","renderEditItem","listItem","item","super","remove","Number","isSkipped","renderItemOnVideoNavigation","hide","isVisible","isClickable","prop","icon","runInteraction","animate","width","isEditMode","css"],"mappings":"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"}