define("ivplugin_inlineannotation/main",["exports","jquery","mod_interactivevideo/type/base","core/event_dispatcher","core_form/modalform","core/templates","core_filters/events"],(function(_exports,_jquery,_base,_event_dispatcher,_modalform,_templates,_events){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * TODO describe module main
   *
   * @module     ivplugin_inlineannotation/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_base=_interopRequireDefault(_base),_modalform=_interopRequireDefault(_modalform),_templates=_interopRequireDefault(_templates);class InlineAnnotation extends _base.default{postEditCallback(){}renderContainer(annotation){const videoWrapper=(0,_jquery.default)("#video-wrapper");videoWrapper.find("#message").remove(),videoWrapper.append(`<div id="message" data-id="${annotation.id}"\n             class="message text-white bg-transparent inlineannotation"></div>`);const updateAspectRatio=async(video,reset)=>{let elem=video?(0,_jquery.default)("#player"):(0,_jquery.default)(`#message[data-id='${annotation.id}']`);if((0,_jquery.default)("#wrapper").hasClass("fullscreen")){let ratio=await this.player.ratio(),videowrapperaspect=videoWrapper.width()/videoWrapper.height(),gap="- 55px";(0,_jquery.default)("#wrapper").hasClass("no-videonav")&&(gap=""),videowrapperaspect>ratio?(elem.css("height",`calc(100vh ${gap})`),elem.css("width",`calc((100vh ${gap}) * ${ratio})`),elem.css("top","0"),elem.css("left",`calc((100vw - (100vh ${gap}) * ${ratio}) / 2)`)):videowrapperaspect<ratio&&(elem.css("width","100vw"),elem.css("height",100/ratio+"vw"),elem.css("top",`calc((100vh ${gap} - 100vw / ${ratio}) / 2)`),elem.css("left","0"))}else elem.css("width","100%"),elem.css("height","100%"),elem.css("top","0"),elem.css("left","0");reset&&(elem.css("width","100%"),elem.css("height","100%"),elem.css("top","0"),elem.css("left","0"))};updateAspectRatio(),updateAspectRatio(!0);let vwrapper=document.querySelector("#video-wrapper");new ResizeObserver((()=>{updateAspectRatio(),updateAspectRatio(!0)})).observe(vwrapper),(0,_jquery.default)(document).on("timeupdate",(function(){updateAspectRatio(!0,!0)}))}postContentRender(annotation,data){let self=this;var $videoWrapper=(0,_jquery.default)("#video-wrapper"),$playerWrapper=(0,_jquery.default)("#wrapper");const convertSecondsToMMSS=seconds=>{let minutes=Math.floor(seconds/60);return(minutes<10?"0"+minutes:minutes)+":"+((seconds=Math.round(seconds-60*minutes))<10?"0"+seconds:seconds)},updatePositionInfo=elem=>{let w=parseFloat(elem.outerWidth()),hw=parseFloat(elem.outerHeight()),t=parseFloat(elem.position().top)<0?0:parseFloat(elem.position().top),l=parseFloat(elem.position().left)<0?0:parseFloat(elem.position().left),z=elem.css("z-index");(0,_jquery.default)("#player-region #inlineannotation-btns #position").text(`x: ${Math.round(l)}, y: ${Math.round(t)}, z: ${z-5}, w: ${Math.round(w)}, h: ${Math.round(hw)}`)},recalculatingSize=elem=>{let message=$videoWrapper.find("#message");(0,_jquery.default)("#player-region #inlineannotation-btns #down, #player-region #inlineannotation-btns #up").removeAttr("disabled");let w=parseFloat(elem.outerWidth())/parseFloat(message.width())*100,h=parseFloat(elem.outerHeight())/parseFloat(message.height())*100;elem.position().right<0&&elem.css("right","0"),elem.position().bottom<0&&elem.css("bottom","0");let t=parseFloat(elem.position().top)/parseFloat(message.height())*100<0?0:parseFloat(elem.position().top)/parseFloat(message.height())*100,l=parseFloat(elem.position().left)/parseFloat(message.width())*100<0?0:parseFloat(elem.position().left)/parseFloat(message.width())*100,z=elem.css("z-index"),position={width:w+"%",height:h+"%",left:l+"%",top:t+"%","z-index":z};return elem.css(position),6==z&&(0,_jquery.default)("#player-region #inlineannotation-btns #down").attr("disabled","disabled"),updatePositionInfo(elem),"video"==elem.data("type")&&elem.find(".playpause").css({"font-size":.2*elem.outerHeight()+"px","line-height":.2*elem.outerHeight()+"px"}),position},recalculatingTextSize=(elem,button)=>{let fontSize=elem.outerHeight();elem.find(".annotation-content").css({"font-size":(button?.7*fontSize:.9*fontSize)+"px","line-height":fontSize+"px","padding-left":(button?.4:.1)+"em","padding-right":(button?.4:.1)+"em"}),elem.css("width","auto")},renderItems=(elements,active,update)=>{update||$videoWrapper.find("#message").empty(),elements.forEach((item=>{let prop=item.properties,type=item.type,id=item.id,position=item.position,wrapper=(0,_jquery.default)(`<div class="annotation-wrapper"\n                     data-anno="${annotation.id}" data-item="${id}" data-type="${type}"\n                      data-property='${JSON.stringify(prop)}'></div>`);switch(("1"==prop.resizable||self.isEditMode())&&(wrapper.addClass("resizable"),wrapper.attr("tabindex",0)),type){case"image":var parts=prop.timestamp.split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);""!=prop.gotourl?wrapper.append(`<a href="${prop.gotourl}" target="_blank"><img src="${prop.url}" id="${id}"\n                             class="annotation-content ${1==prop.rounded?"rounded":"rounded-0"} w-100\n                              ${"1"==prop.shadow?"shadow":""}" alt="${prop.formattedalttext}"/></a>`):wrapper.append(`<img src="${prop.url}" id="${id}"\n                                 ${timestamp>0?'data-timestamp="'+timestamp+'"':""} class="annotation-content\n                                 ${1==prop.rounded?"rounded":"rounded-0"} w-100 ${"1"==prop.shadow?"shadow":""}\n                                  ${timestamp>0?"cursor-pointer":""}" alt="${prop.formattedalttext}"/>`),(""!=prop.gototurl||timestamp>0)&&!self.isEditMode()&&wrapper.removeClass("resizable"),wrapper.css(position),wrapper.css("height","auto"),$videoWrapper.find("#message").append(wrapper);break;case"video":wrapper.append(`<video id="${id}" class="annotation-content ${1==prop.rounded?"rounded":"rounded-0"}\n                             w-100 ${"1"==prop.shadow?"shadow":""}" preload="metadata" src="${prop.url}"\n                              disablePictureInPicture/>\n                        </video><i class="playpause bi bi-play-fill shadow position-absolute" style="font-size: unset"></i>`);var video=wrapper.find("video")[0];video.autoplay="1"==prop.autoplay,video.playsInline=!0,self.isEditMode()&&(video.autoplay=!1),video.onplay=function(){wrapper.find(".playpause").removeClass("bi-play-fill").addClass("bi-pause-fill")},video.onpause=function(){wrapper.find(".playpause").removeClass("bi-pause-fill").addClass("bi-play-fill")},video.onended=function(){wrapper.find(".playpause").removeClass("bi-pause-fill").addClass("bi-play-fill")},wrapper.css(position),$videoWrapper.find("#message").append(wrapper),recalculatingSize(wrapper);break;case"file":case"audio":var wrapperhtml="";if("audio"==type?wrapperhtml=`<span id="${id}" tabindex="0"\n                             class="btn ${prop.style} ${"1"==prop.rounded?"btn-rounded":"rounded-0"}\n                              annotation-content text-nowrap ${"1"==prop.shadow?"shadow":""} rotatex-360"\n                               data-src="${prop.url}"><i class="bi bi-volume-up" style="font-size:0.7em;margin-right:0.25em;"></i>\n                               <span class="timeremaining">00:00</span></span>`:"file"==type&&(wrapperhtml=`<a id="${id}"\n                             class="btn ${prop.style} ${"1"==prop.rounded?"btn-rounded":"rounded-0"}\n                             annotation-content text-nowrap ${"1"==prop.shadow?"shadow":""} rotatey-180" href="${prop.url}"\n                              target="_blank"><i class="bi bi-paperclip"\n                               style="font-size:0.7em;"></i>${""!=prop.formattedlabel?`<span style="margin-left:0.25em;">${prop.formattedlabel}`:""}</a>`),wrapper.append(`<div class="d-flex h-100">${wrapperhtml}</div>`),"audio"==type&&!self.isEditMode()){let playButton=wrapper.find(".annotation-content"),audioSrc=prop.url,media=new Audio(audioSrc);playButton.on("click",(function(e){e.stopImmediatePropagation(),media.paused||media.ended||0===media.currentTime?(media.play(),(0,_jquery.default)(this).find("i").removeClass("bi-volume-up").addClass("bi-pause-fill")):(media.pause(),(0,_jquery.default)(this).find("i").removeClass("bi-pause-fill").addClass("bi-volume-up"))}));let totaltime=0;media.onloadedmetadata=function(){totaltime=media.duration,playButton.find("span.timeremaining").text(convertSecondsToMMSS(totaltime))},media.onended=function(){playButton.find("i").removeClass("bi-pause-fill").addClass("bi-volume-up"),playButton.find("span.timeremaining").text(convertSecondsToMMSS(totaltime))},media.ontimeupdate=function(){playButton.find("span.timeremaining").text(convertSecondsToMMSS(media.duration-media.currentTime))},"1"==prop.autoplay&&setTimeout((()=>{playButton.trigger("click")}),100),(0,_jquery.default)(document).on("iv:playerSeek iv:playerPlaying",(function(){media&&media.pause()}))}position.width=0,wrapper.css(position),$videoWrapper.find("#message").append(wrapper),recalculatingTextSize(wrapper,!0);break;case"navigation":parts=prop.timestamp.split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);wrapper.append(`<div class="d-flex h-100"><span id="${id}" tabindex="0"\n                             class="btn ${prop.style} ${"1"==prop.rounded?"btn-rounded":"rounded-0"}\n                              annotation-content text-nowrap ${"1"==prop.shadow?"shadow":""}"\n                               data-timestamp="${timestamp}">${prop.formattedlabel}</span></div>`),position.width=0,wrapper.css(position),$videoWrapper.find("#message").append(wrapper),recalculatingTextSize(wrapper,!0);break;case"stopwatch":var timer,alarm,duration=60*Number(prop.duration);wrapper.append(`<div class="d-flex h-100"><span id="${id}" tabindex="0"\n                             class="btn ${prop.style} ${"1"==prop.rounded?"btn-rounded":"rounded-0"}\n                              annotation-content text-nowrap ${"1"==prop.shadow?"shadow":""} rotatey-180"\n                               data-duration="${duration}">\n                               <i class="bi bi bi-stopwatch" style="font-size:0.7em;margin-right:0.25em;"></i>\n                               <span>${convertSecondsToMMSS(duration)}</span></span></div>`),timer&&clearInterval(timer);var intervalfunction=function(){timer=setInterval((()=>{(0,_jquery.default)(`.annotation-content#${id}`).addClass("running");let time=(0,_jquery.default)(`.annotation-content#${id}`).data("duration");time--,(0,_jquery.default)(`.annotation-content#${id} span`).text(convertSecondsToMMSS(time)),(0,_jquery.default)(`.annotation-content#${id}`).data("duration",time),"1"==prop.playalarmsound.playsoundatinterval&&time%(60*prop.playalarmsound.intervaltime)==0&&1==prop.playalarmsound.playsoundatend&&(alarm=new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/short-alarm.mp3")).play(),time<0&&(clearInterval(timer),1==prop.playalarmsound.playsoundatend&&((alarm=new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/alarm.mp3")).play(),alarm.onplay=function(){(0,_jquery.default)(`.annotation-content#${id}`).addClass("pulse")},alarm.onended=function(){(0,_jquery.default)(`.annotation-content#${id}`).removeClass("pulse")}),(0,_jquery.default)(`.annotation-content#${id}`).removeClass("running"),(0,_jquery.default)(`.annotation-content#${id} span`).text(convertSecondsToMMSS(duration)),(0,_jquery.default)(`.annotation-content#${id}`).data("duration",duration))}),1e3)};self.isEditMode()||(intervalfunction(),$videoWrapper.on("click",`.annotation-content#${id}`,(function(e){e.stopImmediatePropagation(),1==prop.allowpause?(0,_jquery.default)(this).hasClass("running")?(clearInterval(timer),alarm&&alarm.pause(),(0,_jquery.default)(this).removeClass("running")):intervalfunction():(0,_jquery.default)(this).data("duration")==duration&&intervalfunction()}))),(0,_jquery.default)(document).on("iv:playerSeek",(function(){clearInterval(timer)})),position.width=0,wrapper.css(position),$videoWrapper.find("#message").append(wrapper),recalculatingTextSize(wrapper,!0);break;case"text":null!=prop.url&&""!=prop.url?wrapper.append(`<a id="${id}"\n                                 class="annotation-content text-nowrap ${"1"==prop.shadow?"text-shadow":""} d-block"\n                                  href="${prop.url}" target="_blank">${prop.formattedlabel}</a>`):wrapper.append(`<div id="${id}"\n                                 class="annotation-content text-nowrap ${"1"==prop.shadow?"text-shadow":""}\n                                 ">${prop.formattedlabel}</div>`),wrapper.position.width=0,wrapper.css(position);var style={"font-weight":"1"==prop.bold?"bold":"normal","font-style":"1"==prop.italic?"italic":"normal","text-decoration":"1"==prop.underline?"underline":"none",color:prop.textcolor,background:prop.bgcolor,"border-width":prop.borderwidth,"border-color":prop.bordercolor,"border-style":"solid","font-family":""!=prop.textfont?prop.textfont:"inherit"};wrapper.find(".annotation-content").css(style),$videoWrapper.find("#message").append(wrapper),recalculatingTextSize(wrapper);break;case"shape":parts=prop.timestamp.split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);""!=prop.gotourl?wrapper.append(`<a href="${prop.gotourl}" target="_blank"><div id="${id}"\n                             class="annotation-content ${"1"==prop.shadow?"shadow":""}"\n                              style="width: 100%; height: 100%;"></div></a>`):wrapper.append(`<div id="${id}" class="annotation-content ${"1"==prop.shadow?"shadow":""}\n                                 ${timestamp>0?"cursor-pointer":""}"\n                             ${timestamp>0?'data-timestamp="'+timestamp+'"':""}\n                             style="width: 100%; height: 100%;"></div>`),wrapper.css(position);style={background:prop.bgcolor,"border-width":prop.borderwidth,"border-color":prop.bordercolor,"border-style":"solid",opacity:prop.opacity/100};"circle"==prop.shape?style["border-radius"]="50%":"rectangle"==prop.shape&&(style["border-radius"]="1"==prop.rounded?"10px":"0"),wrapper.find(".annotation-content").css(style),$videoWrapper.find("#message").append(wrapper);break;case"hotspot":wrapper.append(`<div id="${id}" class="annotation-content shadow-sm pulse" role="button"></div>`),position["aspect-ratio"]="1",wrapper.css(position);style={"background-color":prop.color,opacity:prop.opacity/100,"border-radius":"50%","aspect-ratio":"1"};wrapper.find(".annotation-content").css(style),$videoWrapper.find("#message").append(wrapper),self.isEditMode()||("1"==prop.usemodal?wrapper.attr({"data-toggle":"modal","data-content":prop.content.text,"data-title":prop.formattedtitle,"data-link":prop.url}):(wrapper.attr({tabindex:-1,"data-trigger":"manual","data-boundary":"viewport","data-placement":"auto","data-html":"true","data-content":'<div class="loader"></div>',"data-title":prop.formattedtitle+'<i class="bi bi-x-circle-fill ml-auto popover-dismiss cursor-pointer"\n                                         style="font-size:1.5em;"></i>'}),wrapper.popover({container:"#wrapper",html:!0,template:`<div class="popover inlineannotation-popover id-${id}"\n                                     role="tooltip"><div class="arrow"></div>\n                                     <h3 class="popover-header d-flex justify-content-between"></h3>\n                                     <div class="popover-body rounded"></div>${""!=prop.url?`<div class="popup-footer bg-gray p-2 rounded-bottom"><a href="${prop.url}"\n                                          class="d-block w-100 text-right rotatex-360" target="_blank">\n                                          <i class="bi bi-arrow-right"><i></i></i></a></div>`:""}</div>`}),wrapper.on("shown.bs.popover",(function(){let $body=(0,_jquery.default)(`.popover.id-${id} .popover-body`);self.formatContent(prop.content.text,M.cfg.contextid).then((html=>{$body.html(html),(0,_events.notifyFilterContentUpdated)($body),wrapper.popover("update")}))})),"1"==prop.openbydefault&&wrapper.popover("show")))}(self.isEditMode()||"1"==prop.resizable)&&(wrapper.draggable({containment:"#message",cursor:"move",handle:".annotation-content",stop:function(){recalculatingSize((0,_jquery.default)(this)),(0,_jquery.default)(this).trigger("click")},drag:function(){updatePositionInfo((0,_jquery.default)(this))}}),wrapper.resizable({containment:"#message",handles:"all",start:function(event){"shape"==type&&event.ctrlKey&&(0,_jquery.default)(this).resizable("option","aspectRatio",1)},stop:function(){"text"==type||"audio"==type||"stopwatch"==type||"file"==type||"navigation"==type?recalculatingTextSize((0,_jquery.default)(this),"text"!=type):"shape"==type&&(0,_jquery.default)(this).resizable("option","aspectRatio",!1),recalculatingSize((0,_jquery.default)(this)),(0,_jquery.default)(this).trigger("click")},resize:function(event){"text"==type||"audio"==type||"stopwatch"==type||"file"==type||"navigation"==type?recalculatingTextSize((0,_jquery.default)(this),"text"!=type):"shape"==type&&event.ctrlKey&&(0,_jquery.default)(this).resizable("option","aspectRatio",1),updatePositionInfo((0,_jquery.default)(this))}})),"shape"!=type&&wrapper.on("mouseover",(function(){if(!(0,_jquery.default)(this).hasClass("resizable"))return;let aspectRatio=(0,_jquery.default)(this).find(".annotation-content").width()/(0,_jquery.default)(this).find(".annotation-content").height();wrapper.width()/wrapper.height()==aspectRatio||"image"!=type&&"video"!=type||(0,_jquery.default)(this).height(wrapper.width()/aspectRatio),(0,_jquery.default)(this).resizable("option","aspectRatio",(0,_jquery.default)(this).find(".annotation-content").outerWidth()/(0,_jquery.default)(this).find(".annotation-content").outerHeight())})),id==active&&wrapper.trigger("click")})),self.isEditMode()||($videoWrapper.on("click",".annotation-wrapper",(function(e){e.stopImmediatePropagation();let wrapper=(0,_jquery.default)(this);switch(wrapper.data("type")){case"video":var video=wrapper.find("video")[0];video.paused||video.ended||0===video.currentTime?video.play():video.pause();break;case"navigation":case"image":case"shape":var navigation=wrapper.find(".annotation-content");navigation.data("timestamp")&&self.isBetweenStartAndEnd(navigation.data("timestamp"))&&(self.player.seek(navigation.data("timestamp")),self.player.play());break;case"hotspot":if("modal"==wrapper.data("toggle")){let title=wrapper.data("title"),content=wrapper.data("content"),url=wrapper.data("link"),modal=`<div class="modal fade" id="annotation-modal" role="dialog"\n                                aria-labelledby="annotation-modal"\n                             aria-hidden="true" data-backdrop="static" data-keyboard="false">\n                             <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">\n                                <div class="modal-content rounded-lg">\n                                    <div class="modal-header d-flex align-items-center shadow-sm pr-0" id="title">\n                                        <h5 class="modal-title text-truncate mb-0">${title}</h5>\n                                        <button class="btn mx-2 p-0 close" aria-label="Close" data-dismiss="modal">\n                                            <i class="bi bi-x-lg fa-fw" style="font-size: x-large;"></i>\n                                        </button>\n                                    </div>\n                                    <div class="modal-body" id="content">\n                                    <div class="loader"></div>\n                                    </div>\n                                    ${""!=url?`<div class="modal-footer bg-gray p-2 rounded-bottom">\n                                        <a href="${url}" class="d-block w-100 text-right rotatex-360" target="_blank">\n                                        <i class="bi bi-arrow-right"><i></i></i></a></div>`:""}\n                                    </div>\n                                </div>\n                                </div>`;(0,_jquery.default)("#wrapper").append(modal),(0,_jquery.default)("#annotation-modal").modal("show"),(0,_jquery.default)("#annotation-modal").on("hide.bs.modal",(function(){(0,_jquery.default)("#annotation-modal").remove()})),(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(function(){(0,_jquery.default)("#annotation-modal .modal-body").fadeIn(300);let $body=(0,_jquery.default)("#annotation-modal .modal-body");self.formatContent(content,M.cfg.contextid).then((html=>{$body.html(html),(0,_events.notifyFilterContentUpdated)($body)}))}))}else wrapper.popover("show")}})),$playerWrapper.on("click",".popover-dismiss",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)(this).closest(".popover").remove()})))};let vwrapper=document.querySelector("#video-wrapper");new ResizeObserver((()=>{let existingwrapper=(0,_jquery.default)("#video-wrapper").find(".annotation-wrapper");0!=existingwrapper.length&&existingwrapper.each((function(){let type=(0,_jquery.default)(this).data("type");"text"==type||"audio"==type||"stopwatch"==type||"file"==type||"navigation"==type?recalculatingTextSize((0,_jquery.default)(this),"text"!=type):"video"==type&&recalculatingSize((0,_jquery.default)(this))}))})).observe(vwrapper);let items=[];""!=data.items&&null!==data.items&&(items=JSON.parse(data.items));let draftitemid=data.draftitemid;if(renderItems(items,null,!1),this.isEditMode()){(0,_jquery.default)("#inlineannotation-btns").remove();let inlineannotationitems=[{icon:"bi bi-image",type:"media",mediatype:"image",label:M.util.get_string("image","ivplugin_inlineannotation")},{icon:"bi bi-film",type:"media",mediatype:"video",label:M.util.get_string("video","ivplugin_inlineannotation")},{icon:"bi bi-volume-up",type:"media",mediatype:"audio",label:M.util.get_string("audio","ivplugin_inlineannotation")},{icon:"bi bi-alphabet-uppercase",type:"text",mediatype:"text",label:M.util.get_string("text","ivplugin_inlineannotation")},{icon:"bi bi-circle-square",type:"shape",mediatype:"shape",label:M.util.get_string("shape","ivplugin_inlineannotation")},{icon:"bi bi-stopwatch",type:"stopwatch",mediatype:"stopwatch",label:M.util.get_string("stopwatch","ivplugin_inlineannotation")},{icon:"bi bi-file-earmark-arrow-down",type:"media",mediatype:"file",label:M.util.get_string("inlinefile","ivplugin_inlineannotation")},{icon:"bi bi-sign-turn-right",type:"navigation",mediatype:"navigation",label:M.util.get_string("navigation","ivplugin_inlineannotation")},{icon:"bi bi-plus-circle",type:"hotspot",mediatype:"hotspot",label:M.util.get_string("hotspot","ivplugin_inlineannotation")}];const dataForTemplate={id:annotation.id,items:inlineannotationitems};_templates.default.render("ivplugin_inlineannotation/inlineannotation_toolbar",dataForTemplate).then((html=>{$videoWrapper.before(html)})).catch((()=>{})),self.enableColorPicker()}if((0,_jquery.default)(document).on("iv:playerSeek iv:playerPlaying",(function(e){let newTime=e.detail.time;Math.floor(newTime)!=annotation.timestamp&&((0,_jquery.default)("#inlineannotation-btns").remove(),(0,_jquery.default)(".inlineannotation-popover").remove())})),!self.isEditMode())return;const getItems=updateid=>{items=[],$videoWrapper.find(".annotation-wrapper").each((function(index,element){let item={id:updateid?(new Date).getTime()+index:(0,_jquery.default)(element).data("item"),type:(0,_jquery.default)(element).data("type"),position:recalculatingSize((0,_jquery.default)(element)),properties:JSON.parse((0,_jquery.default)(element).attr("data-property"))};items.push(item)}))};$playerWrapper.on("click","#inlineannotation-btns #save",(function(e){e.preventDefault(),e.stopImmediatePropagation(),getItems(!0);let cleanItems=JSON.stringify(items).replace(/</g,"&lt;").replace(/>/g,"&gt;"),updateId=$videoWrapper.find("#message").data("id");_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quickeditfield",sesskey:M.cfg.sesskey,id:updateId,field:"content",contextid:M.cfg.contextid,draftitemid:draftitemid,value:cleanItems,cmid:self.cmid,token:self.token},success:function(data){let updated=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"edit"})}})})),$playerWrapper.on("click","#inlineannotation-btns  #close",(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)("#inlineannotation-btns").remove(),$videoWrapper.find("#message").remove()}));const handleFormData=(newItem,type,add)=>{switch(type){case"audio":case"file":case"navigation":case"stopwatch":add&&(newItem.position.height="40px",newItem.position.width="130px");break;case"text":newItem.width="0";break;case"shape":add&&(newItem.position.height="100px",newItem.position.width="100px");break;case"video":case"image":newItem.position.height="auto";break;case"hotspot":add&&(newItem.position.width="5%")}items.push(newItem),renderItems([newItem],newItem.id,!0)};$playerWrapper.on("click","#inlineannotation-btns  .add-ia",(function(e){e.preventDefault(),e.stopImmediatePropagation();let annoid=$videoWrapper.find("#message").data("id"),type=(0,_jquery.default)(this).attr("data-mediatype");if("stopwatch"==type&&items.find((x=>"stopwatch"==x.type)))return void alert(M.util.get_string("onlyonestopwatch","ivplugin_inlineannotation"));let iaform=new _modalform.default({formClass:"ivplugin_inlineannotation\\inlineannotation_children\\"+(0,_jquery.default)(this).attr("data-type"),args:{contextid:M.cfg.contextid,id:0,type:type,annotationid:annoid},modalConfig:{title:M.util.get_string("addinlineannotation","ivplugin_inlineannotation",M.util.get_string(type,"ivplugin_inlineannotation"))}});iaform.show(),iaform.addEventListener(iaform.events.LOADED,(()=>{iaform.modal.modal.draggable({handle:".modal-header"}),"navigation"!=type&&"image"!=type&&"shape"!=type||(0,_jquery.default)(document).on("change",'[name="timestamp"]',(function(e){e.preventDefault();let parts=(0,_jquery.default)(this).val().split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);if(!self.isBetweenStartAndEnd(timestamp)){let message=M.util.get_string("timemustbebetweenstartandendtime","ivplugin_inlineannotation",{start:self.convertSecondsToHMS(self.start),end:self.convertSecondsToHMS(self.end)});return self.addNotification(message),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}if(self.isInSkipSegment(timestamp))return self.addNotification(M.util.get_string("interactionisbetweentheskipsegment","ivplugin_inlineannotation")),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}))})),iaform.addEventListener(iaform.events.FORM_SUBMITTED,(e=>{getItems(!1);let left=100*Math.random(),top=100*Math.random(),newItem={id:(new Date).getTime(),type:type,position:{width:"30%",left:left+"px",top:top+"px","z-index":items.length+6},properties:e.detail};handleFormData(newItem,type,!0)}))})),$playerWrapper.on("click","#inlineannotation-btns  #edit",(function(e){e.preventDefault(),e.stopImmediatePropagation();let annnoid=$videoWrapper.find("#message").data("id"),active=(0,_jquery.default)("#edit-btns").attr("data-active");getItems(!1);let item=items.find((x=>x.id==active)),type=item.type,formdata={...item.properties};formdata.contextid=M.cfg.contextid,formdata.id=item.id,formdata.annotationid=annnoid,formdata.type=type;let editform=new _modalform.default({formClass:"ivplugin_inlineannotation\\inlineannotation_children\\"+("image"==type||"video"==type||"audio"==type||"file"==type?"media":type),args:item.properties,modalConfig:{title:M.util.get_string("editinlineannotation","ivplugin_inlineannotation",M.util.get_string(type,"ivplugin_inlineannotation"))}});editform.show(),editform.addEventListener(editform.events.LOADED,(()=>{editform.modal.modal.draggable({handle:".modal-header"}),"navigation"!=type&&"image"!=type&&"shape"!=type||(0,_jquery.default)(document).on("change",'[name="timestamp"]',(function(e){e.preventDefault();let parts=(0,_jquery.default)(this).val().split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);if(!self.isBetweenStartAndEnd(timestamp)){let message=M.util.get_string("timemustbebetweenstartandendtime","mod_interactivevideo",{start:self.convertSecondsToHMS(self.start),end:self.convertSecondsToHMS(self.end)});return self.addNotification(message),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}if(self.isInSkipSegment(timestamp))return self.addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo")),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}))})),editform.addEventListener(editform.events.FORM_SUBMITTED,(e=>{getItems(!1),item=items.find((x=>x.id==active)),item.properties=e.detail,$videoWrapper.find(`.annotation-wrapper[data-item="${active}"]`).remove(),items=items.filter((x=>x.id!=active)),handleFormData(item,type,!1)}))})),$videoWrapper.on("click",".annotation-wrapper",(function(e){e.preventDefault(),e.stopImmediatePropagation(),e.ctrlKey?(0,_jquery.default)(this).hasClass("active")?(0,_jquery.default)(this).removeClass("active"):((0,_jquery.default)(this).addClass("active"),this.focus()):((0,_jquery.default)("#inlineannotation-btns .btn").removeClass("active rotatey-360"),$videoWrapper.find(".annotation-wrapper").removeClass("active"),(0,_jquery.default)(this).addClass("active"),this.focus(),recalculatingSize((0,_jquery.default)(this))),recalculatingSize((0,_jquery.default)(this));var activewrapper=$videoWrapper.find(".annotation-wrapper.active");if(0==activewrapper.length)(0,_jquery.default)("#edit-btns").attr("data-active","").addClass("d-none").removeClass("d-flex"),(0,_jquery.default)("#inlineannotation-btns #edit").attr("disabled","disabled"),(0,_jquery.default)("#inlineannotation-btns #edit").removeAttr("disabled");else{let dataActive=activewrapper.map((function(){return(0,_jquery.default)(this).data("item")})).get();(0,_jquery.default)("#edit-btns").attr("data-active",dataActive).addClass("d-flex").removeClass("d-none"),activewrapper.each((function(){let type=(0,_jquery.default)(this).data("type");(0,_jquery.default)(`#inlineannotation-btns .btn[data-mediatype="${type}"]`).addClass("active rotatey-360")})),activewrapper.length>1?(0,_jquery.default)("#inlineannotation-btns #edit").attr("disabled","disabled"):(0,_jquery.default)("#inlineannotation-btns #edit").removeAttr("disabled")}})),$playerWrapper.on("click","#inlineannotation-btns  #up",(function(e){e.preventDefault(),e.stopImmediatePropagation();let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(","),active.forEach((item=>{let activeItem=(0,_jquery.default)(`.annotation-wrapper[data-item="${item}"]`),zIndex=parseInt(activeItem.css("z-index"));activeItem.css("z-index",zIndex+1),recalculatingSize(activeItem)}))})),$playerWrapper.on("click","#inlineannotation-btns  #down",(function(e){e.preventDefault(),e.stopImmediatePropagation();let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(","),active.forEach((item=>{let activeItem=(0,_jquery.default)(`.annotation-wrapper[data-item="${item}"]`),zIndex=parseInt(activeItem.css("z-index"));activeItem.css("z-index",zIndex-1),recalculatingSize(activeItem)}))})),$playerWrapper.on("click","#inlineannotation-btns  #delete",(function(e){e.preventDefault(),e.stopImmediatePropagation();let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(","),active.forEach((item=>{(0,_jquery.default)(`.annotation-wrapper[data-item="${item}"]`).remove(),(0,_jquery.default)("#edit-btns").attr("data-active","").addClass("d-none").removeClass("d-flex")})),getItems(!1),(0,_jquery.default)("#inlineannotation-btns .btn").removeClass("active rotatey-360")})),$playerWrapper.on("click","#inlineannotation-btns  #copy",(function(e){e.preventDefault(),e.stopImmediatePropagation(),getItems(!1);let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(",");let newItems=[];for(let i=0;i<active.length;i++){let a=active[i],activeItem=(0,_jquery.default)(`.annotation-wrapper[data-item="${a}"]`);activeItem.removeClass("active");let newItem={...items.find((x=>x.id==a))};newItem.position=recalculatingSize(activeItem),newItem.id=(new Date).getTime(),newItems.push(newItem.id),newItem.position.zIndex=items.length+6,newItem.position.left=parseInt(newItem.position.left)+5+"%",newItem.position.top=parseInt(newItem.position.top)+5+"%",items.push(newItem),renderItems([newItem],null,!0),i==active.length-1&&((0,_jquery.default)("#edit-btns").attr("data-active",newItems.join(",")).addClass("d-flex").removeClass("d-none"),newItems.forEach((ni=>{(0,_jquery.default)(`.annotation-wrapper[data-item="${ni}"]`).addClass("active")})),document.querySelector(".annotation-wrapper.active").focus())}})),$playerWrapper.on("keydown",".annotation-wrapper",(function(e){let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(",");for(let i=0;i<active.length;i++){let a=active[i],activeItem=(0,_jquery.default)(`.annotation-wrapper[data-item="${a}"]`);if(null!=activeItem){let position=activeItem.position();position["z-index"]=parseInt(activeItem.css("z-index"));let ctrl=e.ctrlKey,step=1;switch(e.preventDefault(),e.stopImmediatePropagation(),e.key){case"ArrowUp":if(ctrl)position["z-index"]=position["z-index"]+1;else{if(!(position.top>0))break;position.top=position.top-step}break;case"ArrowDown":if(ctrl)position["z-index"]=position["z-index"]-1;else{if(!(position.top+activeItem.outerHeight()<$videoWrapper.find("#message").height()))break;position.top=position.top+step}break;case"ArrowLeft":if(!(position.left>0))break;position.left=position.left-step;break;case"ArrowRight":if(!(position.left+activeItem.outerWidth()<$videoWrapper.find("#message").width()))break;position.left=position.left+step;break;case"Delete":return void(0,_jquery.default)("#inlineannotation-btns #delete").trigger("click");case"d":return void(ctrl&&(0,_jquery.default)("#inlineannotation-btns #copy").trigger("click"));default:return}activeItem.css(position),recalculatingSize(activeItem)}}})),$playerWrapper.on("click","#message",(function(e){e.preventDefault(),e.stopImmediatePropagation(),$videoWrapper.find(".annotation-wrapper").removeClass("active"),(0,_jquery.default)("#inlineannotation-btns .btn").removeClass("active rotatey-360"),(0,_jquery.default)("#edit-btns").attr("data-active","").addClass("d-none").removeClass("d-flex")})),(0,_jquery.default)(document).on("annotationdeleted",(function(e){let deleted=e.originalEvent.detail.annotation,annoid=$videoWrapper.find("#message").data("id");annoid==deleted.id&&($videoWrapper.find(`#message[data-id='${annoid}']`).remove(),(0,_jquery.default)("#inlineannotation-btns").remove())}))}runInteraction(annotation){this.player.pause(),this.renderContainer(annotation),this.isEditMode()&&(annotation.editmode=!0),this.render(annotation,"json").then((content=>this.postContentRender(annotation,content))).catch((()=>{}))}}return _exports.default=InlineAnnotation,_exports.default}));

//# sourceMappingURL=main.min.js.map