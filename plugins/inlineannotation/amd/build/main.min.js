define("ivplugin_inlineannotation/main",["exports","jquery","mod_interactivevideo/type/base","core/event_dispatcher","core_form/modalform","core/templates","core/notification","core_filters/events"],(function(_exports,_jquery,_base,_event_dispatcher,_modalform,_templates,_notification,_events){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Main class for inlineannotation content type
   *
   * @module     ivplugin_inlineannotation/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_base=_interopRequireDefault(_base),_modalform=_interopRequireDefault(_modalform),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);class InlineAnnotation extends _base.default{postEditCallback(){}roundToTwo(num){return+(Math.round(num+"e+2")+"e-2")}renderContainer(annotation){const videoWrapper=(0,_jquery.default)("#video-wrapper");videoWrapper.find("#canvas").remove(),videoWrapper.append('<div id="canvas" data-id="'.concat(annotation.id,'"\n             class="message text-white bg-transparent inlineannotation position-absolute"></div>'));const updateAspectRatio=async(video,reset)=>{let elem=video?(0,_jquery.default)("#player"):(0,_jquery.default)("#canvas[data-id='".concat(annotation.id,"']"));if((0,_jquery.default)("#wrapper").hasClass("fullscreen")){let ratio=16/9;this.displayoptions.usefixedratio&&0!=this.displayoptions.usefixedratio||(ratio=this.player.aspectratio);let videowrapperaspect=videoWrapper.width()/videoWrapper.height(),gap="- 55px";(0,_jquery.default)("#wrapper").hasClass("no-videonav")&&(gap=""),videowrapperaspect>ratio?(elem.css("height","calc(100dvh ".concat(gap,")")),elem.css("width","calc((100dvh ".concat(gap,") * ").concat(ratio,")")),elem.css("top","0"),elem.css("left","calc((100dvw - (100dvh ".concat(gap,") * ").concat(ratio,") / 2)"))):videowrapperaspect<ratio&&(elem.css("width","100dvw"),elem.css("height","".concat(100/ratio,"dvw")),elem.css("top","calc((100dvh ".concat(gap," - 100dvw / ").concat(ratio,") / 2)")),elem.css("left","0"))}else elem.css("width","100%"),elem.css("height","100%"),elem.css("top","0"),elem.css("left","0");reset&&(elem.css("width","100%"),elem.css("height","100%"),elem.css("top","0"),elem.css("left","0"))};updateAspectRatio(),updateAspectRatio(!0);let vwrapper=document.querySelector("#video-wrapper");new ResizeObserver((()=>{updateAspectRatio(),updateAspectRatio(!0)})).observe(vwrapper),(0,_jquery.default)(document).on("timeupdate",(function(){updateAspectRatio(!0,!0)}))}postContentRender(annotation,data){let self=this;var $videoWrapper=(0,_jquery.default)("#video-wrapper"),$playerWrapper=(0,_jquery.default)("#wrapper");let draftStatus=null;const convertSecondsToMMSS=seconds=>{let minutes=Math.floor(seconds/60);return(minutes<10?"0"+minutes:minutes)+":"+((seconds=Math.round(seconds-60*minutes))<10?"0"+seconds:seconds)},updatePositionInfo=elem=>{let w=elem.outerWidth(),hw=elem.outerHeight(),t=elem.position().top<0?0:elem.position().top,l=elem.position().left<0?0:elem.position().left,z=elem.css("z-index");(0,_jquery.default)("#inlineannotation-btns #position").text("x: ".concat(Math.round(l),", y: ").concat(Math.round(t),", z: ").concat(z-5,", w: ").concat(Math.round(w),", h: ").concat(Math.round(hw)))},recalculatingSize=elem=>{let message=$videoWrapper.find("#canvas");(0,_jquery.default)("#inlineannotation-btns #down, #inlineannotation-btns #up").removeAttr("disabled");let w=self.roundToTwo(elem.outerWidth())/message.width()*100,h=self.roundToTwo(elem.outerHeight())/message.height()*100,t=self.roundToTwo(elem.position().top)/message.height()*100;t=t<0?0:t;let l=self.roundToTwo(elem.position().left)/message.width()*100;l=l<0?0:l;let z=elem.css("z-index"),g=elem.data("group"),position={width:w+"%",height:h+"%",left:l+"%",top:t+"%","z-index":z};return position.group=g,elem.css(position),updatePositionInfo(elem),position},recalculatingTextSize=function(elem,button){let multiline=arguments.length>2&&void 0!==arguments[2]&&arguments[2],fontSize=elem.outerHeight(),padding=0,rowCount=1;if(multiline){if(rowCount=elem.find(".text-row").length,rowCount>1){padding=.3*(elem.outerHeight()/rowCount),fontSize=(elem.outerHeight()-2*padding)/rowCount}}let style={"font-size":(button?.7*fontSize:.9*fontSize)+"px","line-height":fontSize+"px","padding-left":(button?.5*fontSize:.3*fontSize)+"px","padding-right":(button?.5*fontSize:.3*fontSize)+"px"};multiline&&rowCount>1&&(style.padding=padding+"px"),elem.find(".annotation-content").css(style),elem.css("width","auto")},renderFile=(wrapper,item,prop,id,position)=>{const type=item.type;var wrapperhtml="";if("audio"==type?wrapperhtml='<span id="'.concat(id,'" tabindex="0"\n                             class="btn ').concat(prop.style," ").concat("1"==prop.rounded?"btn-rounded":"rounded-0","\n                              annotation-content text-nowrap ").concat("1"==prop.shadow?"shadow":"",' rotatex-360"\n                               data-src="').concat(prop.url,'"><i class="bi bi-volume-up fs-unset" style="margin-right:0.25em;"></i>\n                               <span class="timeremaining">00:00</span></span>'):"file"==type&&(wrapperhtml='<a id="'.concat(id,'"\n                             class="btn ').concat(prop.style," ").concat("1"==prop.rounded?"btn-rounded":"rounded-0","\n                             annotation-content text-nowrap ").concat("1"==prop.shadow?"shadow":"",' rotatey-180" href="').concat(prop.url,'"\n                              target="_blank"><i class="bi bi-paperclip fs-unset"></i>').concat(""!=prop.formattedlabel?'<span style="margin-left:0.25em;">'.concat(prop.formattedlabel):"","</a>")),wrapper.append('<div class="d-flex h-100">'.concat(wrapperhtml,"</div>")),"audio"==type&&!self.isEditMode()){let playButton=wrapper.find(".annotation-content"),audioSrc=prop.url,media=new Audio(audioSrc);playButton.off("click").on("click",(function(e){e.stopImmediatePropagation(),media.paused||media.ended||0===media.currentTime?(media.play(),(0,_jquery.default)(this).find("i").removeClass("bi-volume-up").addClass("bi-pause-fill")):(media.pause(),(0,_jquery.default)(this).find("i").removeClass("bi-pause-fill").addClass("bi-volume-up"))}));let totaltime=0;media.onloadedmetadata=function(){totaltime=media.duration,playButton.find("span.timeremaining").text(convertSecondsToMMSS(totaltime))},media.onended=function(){playButton.find("i").removeClass("bi-pause-fill").addClass("bi-volume-up"),playButton.find("span.timeremaining").text(convertSecondsToMMSS(totaltime))},media.ontimeupdate=function(){playButton.find("span.timeremaining").text(convertSecondsToMMSS(media.duration-media.currentTime))},"1"==prop.autoplay&&setTimeout((()=>{playButton.trigger("click")}),100),(0,_jquery.default)(document).one("iv:playerSeek iv:playerPlaying",(function(){media&&media.pause()}))}position.width=0,wrapper.css(position),$videoWrapper.find("#canvas").append(wrapper),recalculatingTextSize(wrapper,!0)},renderStopwatch=(wrapper,item,prop,id,position)=>{var timer,alarm,duration=60*Number(prop.duration);wrapper.append('<div class="d-flex h-100"><span id="'.concat(id,'" tabindex="0"\n                             class="btn ').concat(prop.style," ").concat("1"==prop.rounded?"btn-rounded":"rounded-0","\n                              annotation-content text-nowrap ").concat("1"==prop.shadow?"shadow":"",' rotatey-180"\n                               data-duration="').concat(duration,'">\n                               <i class="bi bi bi-stopwatch fs-unset" style="margin-right:0.25em;"></i>\n                               <span>').concat(convertSecondsToMMSS(duration),"</span></span></div>")),timer&&clearInterval(timer);var intervalfunction=function(){timer=setInterval((()=>{(0,_jquery.default)(".annotation-content#".concat(id)).addClass("running");let time=(0,_jquery.default)(".annotation-content#".concat(id)).data("duration");time--,(0,_jquery.default)(".annotation-content#".concat(id," span")).text(convertSecondsToMMSS(time)),(0,_jquery.default)(".annotation-content#".concat(id)).data("duration",time),"1"==prop.playalarmsound.playsoundatinterval&&time%(60*prop.playalarmsound.intervaltime)==0&&1==prop.playalarmsound.playsoundatend&&(alarm=new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/short-alarm.mp3")).play(),time<0&&(clearInterval(timer),1==prop.playalarmsound.playsoundatend&&((alarm=new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/alarm.mp3")).play(),alarm.onplay=function(){(0,_jquery.default)(".annotation-content#".concat(id)).addClass("pulse")},alarm.onended=function(){(0,_jquery.default)(".annotation-content#".concat(id)).removeClass("pulse")}),(0,_jquery.default)(".annotation-content#".concat(id)).removeClass("running"),(0,_jquery.default)(".annotation-content#".concat(id," span")).text(convertSecondsToMMSS(duration)),(0,_jquery.default)(".annotation-content#".concat(id)).data("duration",duration))}),1e3)};self.isEditMode()||(intervalfunction(),$videoWrapper.off("click",".annotation-content#".concat(id)).on("click",".annotation-content#".concat(id),(function(e){e.stopImmediatePropagation(),1==prop.allowpause?(0,_jquery.default)(this).hasClass("running")?(clearInterval(timer),alarm&&alarm.pause(),(0,_jquery.default)(this).removeClass("running")):intervalfunction():(0,_jquery.default)(this).data("duration")==duration&&intervalfunction()}))),(0,_jquery.default)(document).one("iv:playerSeek",(function(){clearInterval(timer)})),position.width=0,wrapper.css(position),$videoWrapper.find("#canvas").append(wrapper),recalculatingTextSize(wrapper,!0)},renderItems=(elements,actives,update)=>{if(update||$videoWrapper.find("#canvas").empty(),0==elements.length)actives&&actives.forEach((active=>{$videoWrapper.find('#canvas .annotation-wrapper[data-item="'.concat(active,'"]')).addClass("active")}));else{let count=0;elements.forEach((item=>{let prop=item.properties,type=item.type,id=item.id,position=item.position,wrapper=(0,_jquery.default)('<div class="annotation-wrapper" data-group="'.concat(position.group,'" data-anno="').concat(annotation.id,'"\n                     data-item="').concat(id,'" data-type="').concat(type,"\" data-property='").concat(JSON.stringify(prop),"'></div>"));switch(("1"==prop.resizable||self.isEditMode())&&(wrapper.addClass("resizable"),wrapper.attr("tabindex",0)),type){case"image":((wrapper,item,prop,id,position)=>{var parts=prop.timestamp.split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);""!=prop.gotourl?wrapper.append('<a href="'.concat(prop.gotourl,'" target="_blank"><img src="').concat(prop.url,'" id="').concat(id,'"\n                             class="annotation-content w-100 ').concat("1"==prop.shadow?"shadow":"",'"\n                             ').concat(1==prop.rounded?'style="border-radius:1em;"':"",' alt="').concat(prop.formattedalttext,'"/></a>')):wrapper.append('<img src="'.concat(prop.url,'" id="').concat(id,'"\n                                 ').concat(timestamp>0?' data-timestamp="'+timestamp+'"':"",'\n                                  class="annotation-content w-100 ').concat("1"==prop.shadow?"shadow":"","\n                                  ").concat(timestamp>0?"cursor-pointer":"",'"\n                                   ').concat(1==prop.rounded?'style="border-radius:1em;"':"",' alt="').concat(prop.formattedalttext,'"/>')),self.isEditMode()||(""==prop.gotourl&&0==timestamp?(wrapper.removeClass("resizable"),wrapper.addClass("no-pointer")):wrapper.addClass("clickable")),wrapper.css(position),wrapper.css("height","auto"),$videoWrapper.find("#canvas").append(wrapper)})(wrapper,0,prop,id,position);break;case"video":((wrapper,item,prop,id,position)=>{wrapper.append('<video id="'.concat(id,'" class="annotation-content w-100 ').concat("1"==prop.shadow?"shadow":"",'"\n                 ').concat(1!=prop.showcontrol||self.isEditMode()?"":"controls","\n                  ").concat((0,_jquery.default)("body").hasClass("mobiletheme")?'preload="auto"':"",'\n                 src="').concat(prop.url,'" style="border-radius: ').concat(1==prop.rounded?"1em":"0",'" disablePictureInPicture/></video>\n             <i class="playpause bi bi-play-fill position-absolute" style="font-size: 2em; line-height:: 2em;"></i>'));var video=wrapper.find("video")[0];video.autoplay="1"==prop.autoplay,video.playsInline=!0,self.isEditMode()&&(video.autoplay=!1),video.onplay=function(){wrapper.find(".playpause").removeClass("bi-play-fill").addClass("bi-pause-fill")},video.onpause=function(){wrapper.find(".playpause").removeClass("bi-pause-fill").addClass("bi-play-fill")},video.onended=function(){wrapper.find(".playpause").removeClass("bi-pause-fill").addClass("bi-play-fill")},wrapper.css(position),$videoWrapper.find("#canvas").append(wrapper),recalculatingSize(wrapper)})(wrapper,0,prop,id,position);break;case"file":case"audio":renderFile(wrapper,item,prop,id,position);break;case"navigation":((wrapper,item,prop,id,position)=>{var parts=prop.timestamp.split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);wrapper.append('<div class="d-flex h-100"><span id="'.concat(id,'" tabindex="0" class="btn ').concat(prop.style," ").concat("1"==prop.rounded?"btn-rounded":"rounded-0"," annotation-content text-nowrap ").concat("1"==prop.shadow?"shadow":"",'"\n                data-timestamp="').concat(timestamp,'">').concat(prop.formattedlabel,"</span></div>")),position.width=0,wrapper.css(position),$videoWrapper.find("#canvas").append(wrapper),recalculatingTextSize(wrapper,!0)})(wrapper,0,prop,id,position);break;case"stopwatch":renderStopwatch(wrapper,0,prop,id,position);break;case"textblock":((wrapper,item,prop,id,position)=>{var textparts=prop.formattedlabel.split("\r\n"),textblock='<div class="d-flex flex-column">';textparts.forEach((part=>{""!=part.trim()&&(textblock+='<span class="text-row text-nowrap text-'.concat(prop.alignment,'"\n                                 style="font-family: ').concat(""!=prop.textfont?prop.textfont:"inherit",'">').concat(part,"</span>"))})),textblock+="</div>",null!=prop.url&&""!=prop.url?(wrapper.append('<a id="'.concat(id,'"\n                                     class="annotation-content d-block ').concat("1"==prop.shadow?"text-shadow":"",'"\n                                      href="').concat(prop.url,'" target="_blank">').concat(textblock,"</a>")),wrapper.addClass("clickable")):wrapper.append('<div id="'.concat(id,'"\n                                     class="annotation-content ').concat("1"==prop.shadow?"text-shadow":"",'\n                                     ">').concat(textblock,"</div>")),wrapper.position.width=0,wrapper.css(position);var style={"font-size":item.position.fontSize,"line-height":item.position.lineHeight,"font-weight":"1"==prop.bold?"bold":"normal","font-style":"1"==prop.italic?"italic":"normal","text-decoration":"1"==prop.underline?"underline":"none",color:prop.textcolor,background:prop.bgcolor,"border-radius":"1"==prop.rounded?"0.3em":"0","border-width":prop.borderwidth,"border-color":prop.bordercolor,"border-style":"solid"};wrapper.find(".annotation-content").css(style),$videoWrapper.find("#canvas").append(wrapper),recalculatingTextSize(wrapper,!1,!0)})(wrapper,item,prop,id,position);break;case"shape":((wrapper,item,prop,id,position)=>{var parts=prop.timestamp.split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);""!=prop.gotourl?(wrapper.append('<a href="'.concat(prop.gotourl,'" target="_blank"><div id="').concat(id,'"\n                             class="annotation-content ').concat("1"==prop.shadow?"shadow":"",'"\n                              style="width: 100%; height: 100%;"></div></a>')),wrapper.addClass("clickable")):(self.isEditMode()||(0==timestamp?wrapper.addClass("no-pointer"):wrapper.addClass("clickable")),wrapper.append('<div id="'.concat(id,'" class="annotation-content ').concat("1"==prop.shadow?"shadow":"","\n                                 ").concat(timestamp>0?"cursor-pointer":"",'"\n                             ').concat(timestamp>0?'data-timestamp="'+timestamp+'"':"",'\n                             style="width: 100%; height: 100%;"></div>'))),wrapper.css(position);var style={background:prop.bgcolor,"border-width":prop.borderwidth,"border-color":prop.bordercolor,"border-style":"solid",opacity:prop.opacity/100};"circle"==prop.shape?style["border-radius"]="50%":"rectangle"==prop.shape&&(style["border-radius"]="1"==prop.rounded?"1em":"0"),wrapper.find(".annotation-content").css(style),$videoWrapper.find("#canvas").append(wrapper)})(wrapper,0,prop,id,position);break;case"hotspot":((wrapper,item,prop,id,position)=>{wrapper.append('<div id="'.concat(id,'" class="annotation-content shadow-sm pulse" role="button"></div>')),position["aspect-ratio"]="1",wrapper.css(position);var style={"background-color":prop.color,opacity:prop.opacity/100,"border-radius":"50%","aspect-ratio":"1"};wrapper.find(".annotation-content").css(style),$videoWrapper.find("#canvas").append(wrapper),self.isEditMode()||("1"==prop.usemodal?wrapper.attr({"data-toggle":"modal"}):(wrapper.attr({tabindex:-1,"data-trigger":"manual","data-boundary":"viewport","data-placement":"auto","data-html":"true","data-content":'<div class="loader"></div>',"data-title":prop.formattedtitle+'<i class="bi bi-x-circle-fill ml-auto popover-dismiss cursor-pointer"\n                                         style="font-size:1.5em;"></i>'}),wrapper.popover({container:"#wrapper",html:!0,template:'<div class="popover inlineannotation-popover id-'.concat(id,'"\n                                     role="tooltip"><div class="arrow"></div>\n                                     <h3 class="popover-header d-flex justify-content-between"></h3>\n                                     <div class="popover-body rounded"></div>').concat(""!=prop.url?'<div class="popup-footer bg-light p-2 rounded-bottom"><a href="'.concat(prop.url,'"\n                                          class="d-block w-100 text-right rotatex-360" target="_blank">\n                                          <i class="bi bi-arrow-right"><i></i></i></a></div>'):"","</div>")}),wrapper.on("shown.bs.popover",(async function(){let $body=(0,_jquery.default)(".popover.id-".concat(id," .popover-body"));const html=await self.formatContent(prop.content.text,annotation.contextid);$body.html(html),(0,_events.notifyFilterContentUpdated)($body),wrapper.popover("update")})),"1"==prop.openbydefault&&wrapper.popover("show")))})(wrapper,0,prop,id,position)}count++,count==elements.length&&($videoWrapper.find("#canvas .annotation-wrapper.resizable").draggable({containment:"#canvas",cursor:"move",grid:[1,1],handle:".annotation-content",start:function(){(0,_jquery.default)(this).hasClass("active")||(0,_jquery.default)(this).trigger("click"),$videoWrapper.find("#canvas .annotation-wrapper.active").each((function(){(0,_jquery.default)(this).data("startPosition",(0,_jquery.default)(this).position())}))},drag:function(event,ui){var $selected=$videoWrapper.find("#canvas .annotation-wrapper.active"),left=ui.originalPosition.left-ui.position.left,top=ui.originalPosition.top-ui.position.top,positions=$selected.map((function(){return{id:(0,_jquery.default)(this).data("item"),left:(0,_jquery.default)(this).position().left,top:(0,_jquery.default)(this).position().top,bottom:(0,_jquery.default)(this).position().top+(0,_jquery.default)(this).height(),right:(0,_jquery.default)(this).position().left+(0,_jquery.default)(this).width()}})).get();if(positions.find((x=>x.left<0))){positions.sort(((a,b)=>a.left-b.left));let id=positions.find((x=>x.left<0)).id,target=$videoWrapper.find('#canvas .annotation-wrapper[data-item="'.concat(id,'"]'));target.css("left",0);let distance=target.data("startPosition").left;ui.position.left=ui.originalPosition.left-distance,left=ui.originalPosition.left-ui.position.left}if(positions.find((x=>x.top<0))){positions.sort(((a,b)=>a.top-b.top));let id=positions.find((x=>x.top<0)).id,target=$videoWrapper.find('#canvas .annotation-wrapper[data-item="'.concat(id,'"]'));target.css("top",0);let distance=target.data("startPosition").top;ui.position.top=ui.originalPosition.top-distance,top=ui.originalPosition.top-ui.position.top}if(positions.find((x=>x.right>(0,_jquery.default)("#canvas").width()))){positions.sort(((a,b)=>a.right-b.right));let id=positions.find((x=>x.right>(0,_jquery.default)("#canvas").width())).id,target=$videoWrapper.find('#canvas .annotation-wrapper[data-item="'.concat(id,'"]'));target.css("left",(0,_jquery.default)("#canvas").width()-target.width()-1+"px");let distance=target.data("startPosition").left-target.position().left;ui.position.left=ui.originalPosition.left-distance,left=ui.originalPosition.left-ui.position.left}if(positions.find((x=>x.bottom>(0,_jquery.default)("#canvas").height()))){positions.sort(((a,b)=>a.bottom-b.bottom));let id=positions.find((x=>x.bottom>(0,_jquery.default)("#canvas").height())).id,target=$videoWrapper.find('#canvas .annotation-wrapper[data-item="'.concat(id,'"]'));target.css("top",(0,_jquery.default)("#canvas").height()-target.height()-1+"px");let distance=target.data("startPosition").top-target.position().top;ui.position.top=ui.originalPosition.top-distance,top=ui.originalPosition.top-ui.position.top}$selected.not(this).each((function(){var $this=(0,_jquery.default)(this),position=$this.data("startPosition");$this.css({left:position.left-left+"px",top:position.top-top+"px"})})),updatePositionInfo((0,_jquery.default)(this))},stop:function(){if(self.isEditMode()){let $selected=$videoWrapper.find("#canvas .annotation-wrapper.active");var positions=$selected.map((function(){return{id:(0,_jquery.default)(this).data("item"),left:(0,_jquery.default)(this).position().left,top:(0,_jquery.default)(this).position().top,bottom:(0,_jquery.default)(this).position().top+(0,_jquery.default)(this).height(),right:(0,_jquery.default)(this).position().left+(0,_jquery.default)(this).width()}})).get();if(positions.find((x=>x.left<0))){positions.sort(((a,b)=>a.left-b.left));let id=positions.find((x=>x.left<0)).id,target=$videoWrapper.find('#canvas .annotation-wrapper[data-item="'.concat(id,'"]'));target.css("left",0);let distance=target.data("startPosition").left;$selected.each((function(){let $this=(0,_jquery.default)(this),newLeft=$this.data("startPosition").left-distance;$this.css("left",newLeft+"px")}))}if(positions.find((x=>x.top<0))){positions.sort(((a,b)=>a.top-b.top));let id=positions.find((x=>x.top<0)).id,target=$videoWrapper.find('#canvas .annotation-wrapper[data-item="'.concat(id,'"]'));target.css("top",0);let distance=target.data("startPosition").top;$selected.each((function(){let $this=(0,_jquery.default)(this),newTop=$this.data("startPosition").top-distance;$this.css("top",newTop+"px")}))}if(positions.find((x=>x.right>(0,_jquery.default)("#canvas").width()))){positions.sort(((a,b)=>a.right-b.right));let id=positions.find((x=>x.right>(0,_jquery.default)("#canvas").width())).id,target=$videoWrapper.find('#canvas .annotation-wrapper[data-item="'.concat(id,'"]'));target.css("left",(0,_jquery.default)("#canvas").width()-target.width()-1+"px");let distance=target.data("startPosition").left-target.position().left;$selected.each((function(){let $this=(0,_jquery.default)(this),newLeft=$this.data("startPosition").left-distance;$this.css("left",newLeft+"px")}))}if(positions.find((x=>x.bottom>(0,_jquery.default)("#canvas").height()))){positions.sort(((a,b)=>a.bottom-b.bottom));let id=positions.find((x=>x.bottom>(0,_jquery.default)("#canvas").height())).id,target=$videoWrapper.find('#canvas .annotation-wrapper[data-item="'.concat(id,'"]'));target.css("top",(0,_jquery.default)("#canvas").height()-target.height()-1+"px");let distance=target.data("startPosition").top-target.position().top;$selected.each((function(){let $this=(0,_jquery.default)(this),newTop=$this.data("startPosition").top-distance;$this.css("top",newTop+"px")}))}getItems(!1),updatePositionInfo((0,_jquery.default)(this)),$selected=$selected.map((function(){return(0,_jquery.default)(this).data("item")})).get(),saveTracking($selected)}}}),$videoWrapper.find("#canvas .annotation-wrapper.resizable").resizable({containment:"#canvas",handles:"all",grid:[1,1],minHeight:1,minWidth:1,resize:function(event){if(self.isEditMode()){let type=(0,_jquery.default)(this).data("type");"file"==type||"audio"==type||"stopwatch"==type||"navigation"==type||"textblock"==type?recalculatingTextSize((0,_jquery.default)(this),"textblock"!=type,"textblock"==type):"shape"==type&&event.ctrlKey&&(0,_jquery.default)(this).resizable("option","aspectRatio",1),updatePositionInfo((0,_jquery.default)(this))}},stop:function(){if(self.isEditMode()){let type=(0,_jquery.default)(this).data("type");"file"==type||"navigation"==type||"textblock"==type?recalculatingTextSize((0,_jquery.default)(this),"textblock"!=type,"textblock"==type):"shape"==type&&(0,_jquery.default)(this).resizable("option","aspectRatio",!1),recalculatingSize((0,_jquery.default)(this)),getItems(!1),saveTracking([(0,_jquery.default)(this).data("item")]),(0,_jquery.default)(this).trigger("click")}}})),"shape"!=type&&wrapper.on("mouseover",(function(){if(!(0,_jquery.default)(this).hasClass("resizable"))return;let aspectRatio=(0,_jquery.default)(this).find(".annotation-content").width()/(0,_jquery.default)(this).find(".annotation-content").height();wrapper.width()/wrapper.height()==aspectRatio||"image"!=type&&"video"!=type||(0,_jquery.default)(this).height(wrapper.width()/aspectRatio);try{(0,_jquery.default)(this).resizable("option","aspectRatio",(0,_jquery.default)(this).find(".annotation-content").outerWidth()/(0,_jquery.default)(this).find(".annotation-content").outerHeight())}catch(e){}})),actives&&actives.includes(id)&&(wrapper.addClass("active"),1==actives.length&&setTimeout((function(){wrapper.trigger("mouseover"),wrapper.trigger("click")}),500))})),self.isEditMode()||($videoWrapper.off("click","#canvas .annotation-wrapper").on("click","#canvas .annotation-wrapper",(function(e){e.stopImmediatePropagation();let wrapper=(0,_jquery.default)(this);switch(wrapper.data("type")){case"video":var video=wrapper.find("video")[0];video.paused||video.ended||0===video.currentTime?video.play():video.pause();break;case"navigation":case"image":case"shape":var navigation=wrapper.find(".annotation-content");self.isBetweenStartAndEnd(navigation.data("timestamp"))&&(self.player.seek(navigation.data("timestamp")),self.player.play());break;case"hotspot":var viewertype=wrapper.data("toggle"),hotspotid=wrapper.data("item"),hotspot=items.find((x=>x.id==hotspotid));if("modal"==viewertype){let title=hotspot.properties.formattedtitle,content=hotspot.properties.content.text,url=hotspot.properties.url,modal='<div class="modal fade" id="annotation-modal" role="dialog"\n                                aria-labelledby="annotation-modal"\n                             aria-hidden="true" data-backdrop="static" data-keyboard="false">\n                             <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">\n                                <div class="modal-content rounded-lg">\n                                    <div class="modal-header d-flex align-items-center shadow-sm pr-0" id="title">\n                                        <h5 class="modal-title text-truncate mb-0">'.concat(title,'</h5>\n                                        <button class="btn mx-2 p-0 close" aria-label="Close" data-dismiss="modal">\n                                            <i class="bi bi-x-lg fa-fw" style="font-size: x-large;"></i>\n                                        </button>\n                                    </div>\n                                    <div class="modal-body" id="content">\n                                    <div class="loader"></div>\n                                    </div>\n                                    ').concat(""!=url?'<div class="modal-footer bg-light p-2 rounded-bottom">\n                                        <a href="'.concat(url,'" class="d-block w-100 text-right rotatex-360" target="_blank">\n                                        <i class="bi bi-arrow-right"><i></i></i></a></div>'):"","\n                                    </div>\n                                </div>\n                                </div>");(0,_jquery.default)("#wrapper").append(modal),(0,_jquery.default)("#annotation-modal").modal("show"),(0,_jquery.default)("#annotation-modal").on("hide.bs.modal",(function(){(0,_jquery.default)("#annotation-modal").remove()})),(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(async function(){(0,_jquery.default)("#annotation-modal .modal-body").fadeIn(300);let $body=(0,_jquery.default)("#annotation-modal .modal-body");const html=await self.formatContent(content,annotation.contextid);$body.html(html),(0,_events.notifyFilterContentUpdated)($body)}))}else wrapper.popover("show")}})),$playerWrapper.off("click",".popover-dismiss").on("click",".popover-dismiss",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)(this).closest(".popover").remove()})))}};let vwrapper=document.querySelector("#video-wrapper");new ResizeObserver((()=>{let existingwrapper=(0,_jquery.default)("#video-wrapper").find("#canvas .annotation-wrapper");0!=existingwrapper.length&&existingwrapper.each((function(){let wrapper=(0,_jquery.default)(this),type=wrapper.data("type");setTimeout((()=>{if("textblock"==type||"audio"==type||"stopwatch"==type||"file"==type||"navigation"==type)recalculatingTextSize(wrapper,"textblock"!=type,"textblock"==type);else if("video"==type){recalculatingSize(wrapper);let aspectRatio=wrapper.find(".annotation-content").width()/wrapper.find(".annotation-content").height();wrapper.width()/wrapper.height()!=aspectRatio&&(0,_jquery.default)(this).height(wrapper.width()/aspectRatio)}}),100),(0,_jquery.default)("#canvas").css("font-size",(0,_jquery.default)("#canvas").width()/75+"px")}))})).observe(vwrapper);let items=[],tracking=[],trackingIndex=0;""!=data.items&&null!==data.items&&(items=JSON.parse(data.items),tracking.push({items:JSON.stringify(items),actives:null,at:(new Date).getTime()}));let draftitemid=data.draftitemid;if(renderItems(items,null,!1),this.isEditMode()){(0,_jquery.default)("#inlineannotation-btns").remove();let inlineannotationitems=[{icon:"bi bi-image",type:"media",mediatype:"image",label:M.util.get_string("image","ivplugin_inlineannotation")},{icon:"bi bi-film",type:"media",mediatype:"video",label:M.util.get_string("video","ivplugin_inlineannotation")},{icon:"bi bi-volume-up",type:"media",mediatype:"audio",label:M.util.get_string("audio","ivplugin_inlineannotation")},{icon:"bi bi-alphabet-uppercase",type:"textblock",mediatype:"textblock",label:M.util.get_string("text","ivplugin_inlineannotation")},{icon:"bi bi-circle-square",type:"shape",mediatype:"shape",label:M.util.get_string("shape","ivplugin_inlineannotation")},{icon:"bi bi-stopwatch",type:"stopwatch",mediatype:"stopwatch",label:M.util.get_string("stopwatch","ivplugin_inlineannotation")},{icon:"bi bi-file-earmark-arrow-down",type:"media",mediatype:"file",label:M.util.get_string("inlinefile","ivplugin_inlineannotation")},{icon:"bi bi-sign-turn-right",type:"navigation",mediatype:"navigation",label:M.util.get_string("navigation","ivplugin_inlineannotation")},{icon:"bi bi-plus-circle",type:"hotspot",mediatype:"hotspot",label:M.util.get_string("hotspot","ivplugin_inlineannotation")}];const dataForTemplate={id:annotation.id,items:inlineannotationitems};_templates.default.render("ivplugin_inlineannotation/toolbar",dataForTemplate).then((html=>$videoWrapper.before(html))).catch((()=>{})),self.enableColorPicker()}if((0,_jquery.default)(document).one("iv:playerSeek iv:playerPlaying",(function(e){let newTime=e.detail.time;Math.floor(newTime)!=annotation.timestamp&&((0,_jquery.default)("#inlineannotation-btns").remove(),(0,_jquery.default)(".inlineannotation-popover").remove(),$videoWrapper.find("#canvas").remove())})),$playerWrapper.off("click","#canvas").on("click","#canvas",(function(e){e.preventDefault(),e.stopImmediatePropagation(),self.isEditMode()?($videoWrapper.find("#canvas .annotation-wrapper").removeClass("active"),(0,_jquery.default)("#inlineannotation-btns .btn").removeClass("active rotatey-360"),(0,_jquery.default)("#edit-btns").attr("data-active","").addClass("d-none").removeClass("d-flex")):self.player.play()})),!self.isEditMode())return;const saveTracking=actives=>{trackingIndex<tracking.length-1&&(tracking=tracking.slice(0,trackingIndex+1)),tracking.push({items:JSON.stringify(items),actives:actives,at:(new Date).getTime()}),tracking.sort(((a,b)=>a.at-b.at)),trackingIndex=tracking.length-1,(0,_jquery.default)("#inlineannotation-btns #undo").removeAttr("disabled"),(0,_jquery.default)("#inlineannotation-btns #redo").attr("disabled","disabled"),1==tracking.length&&(0,_jquery.default)("#inlineannotation-btns #undo").attr("disabled","disabled")},sortItemsByLayer=(ids,order)=>{ids=ids.map((x=>x.toString()));let targetItems=items.filter((item=>{const id=item.id.toString();return ids.includes(id)}));return"desc"==order?targetItems.sort(((a,b)=>b.position["z-index"]-a.position["z-index"])):targetItems.sort(((a,b)=>a.position["z-index"]-b.position["z-index"])),targetItems.map((item=>item.id))},getTopLayer=itms=>{if(0==itms.length)return 5;let ids=itms.map((item=>item.id)),sorted=sortItemsByLayer(ids,"desc"),zindex=itms.find((item=>item.id==sorted[0])).position["z-index"];return Number(zindex)},getItems=updateid=>{let newItems=[];$videoWrapper.find("#canvas .annotation-wrapper").each((function(index,element){const id=(0,_jquery.default)(element).data("item");let item={type:(0,_jquery.default)(element).data("type"),position:recalculatingSize((0,_jquery.default)(element))};item.id=id,item.properties=items.find((x=>x.id==id)).properties,updateid&&(item.id=(new Date).getTime()+index,(0,_jquery.default)(element).attr("data-item",item.id)),newItems.push(item)})),items=newItems,draftStatus="draft"};$playerWrapper.off("click","#inlineannotation-btns #save").on("click","#inlineannotation-btns #save",(function(e){e.stopImmediatePropagation(),getItems(!1);let cleanItems=JSON.stringify(items).replace(/</g,"&lt;").replace(/>/g,"&gt;"),updateId=$videoWrapper.find("#canvas").data("id");_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quickeditfield",sesskey:M.cfg.sesskey,id:updateId,field:"content",contextid:annotation.contextid,draftitemid:draftitemid,value:cleanItems,cmid:self.cmid,token:self.token},success:function(data){let updated=JSON.parse(data);draftStatus=null,tracking=[],(0,_jquery.default)("#inlineannotation-btns #redo, #inlineannotation-btns #undo").attr("disabled","disabled"),(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"edit"})}})})),(0,_jquery.default)(document).off("click","#inlineannotation-btns #closetoolbar").on("click","#inlineannotation-btns #closetoolbar",(function(e){e.stopImmediatePropagation(),"draft"==draftStatus?_notification.default.saveCancel(M.util.get_string("unsavedchange","ivplugin_inlineannotation"),M.util.get_string("unsavedchangeconfirm","ivplugin_inlineannotation"),M.util.get_string("save","ivplugin_inlineannotation"),(function(){(0,_jquery.default)("#inlineannotation-btns #save").trigger("click"),draftStatus=null,tracking=[],(0,_jquery.default)("#inlineannotation-btns #closetoolbar").trigger("click")}),(function(){(0,_jquery.default)("#inlineannotation-btns").remove(),(0,_jquery.default)('#canvas[data-id="'+annotation.id+'"]').remove()})):((0,_jquery.default)("#inlineannotation-btns").remove(),(0,_jquery.default)('#canvas[data-id="'+annotation.id+'"]').remove())})),(0,_jquery.default)(document).off("click","#inlineannotation-btns #hideshow").on("click","#inlineannotation-btns #hideshow",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)('#canvas[data-id="'+annotation.id+'"]').toggle(),(0,_jquery.default)(this).find("i").toggleClass("bi-eye bi-eye-slash")}));const handleFormData=(newItem,type,add)=>{switch(type){case"audio":case"file":case"navigation":case"stopwatch":add&&(newItem.position.height="40px",newItem.position.width="130px");break;case"textblock":add&&(newItem.position.fontSize="16px",newItem.position.lineHeight="20px");break;case"shape":add&&(newItem.position.height="100px",newItem.position.width="100px");break;case"video":case"image":newItem.position.height="auto";break;case"hotspot":add&&(newItem.position.width="5%")}items.push(newItem),saveTracking([newItem.id]),renderItems([newItem],[newItem.id],!0)};$playerWrapper.off("click","#inlineannotation-btns .add-ia").on("click","#inlineannotation-btns .add-ia",(function(e){e.preventDefault(),e.stopImmediatePropagation();let annoid=$videoWrapper.find("#canvas").data("id"),type=(0,_jquery.default)(this).attr("data-mediatype");if("stopwatch"==type&&items.find((x=>"stopwatch"==x.type)))return void self.addNotification(M.util.get_string("onlyonestopwatch","ivplugin_inlineannotation"),"danger");let iaform=new _modalform.default({formClass:"ivplugin_inlineannotation\\items\\"+(0,_jquery.default)(this).attr("data-type"),args:{contextid:annotation.contextid,id:0,type:type,annotationid:annoid},modalConfig:{title:M.util.get_string("addinlineannotation","ivplugin_inlineannotation",M.util.get_string(type,"ivplugin_inlineannotation"))}});iaform.show(),iaform.addEventListener(iaform.events.LOADED,(()=>{iaform.modal.modal.draggable({handle:".modal-header"}),"navigation"!=type&&"image"!=type&&"shape"!=type||(0,_jquery.default)(document).on("change",'[name="timestamp"]',(function(e){e.preventDefault();let parts=(0,_jquery.default)(this).val().split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);if(!self.isBetweenStartAndEnd(timestamp)){let message=M.util.get_string("timemustbebetweenstartandendtime","ivplugin_inlineannotation",{start:self.convertSecondsToHMS(self.start),end:self.convertSecondsToHMS(self.end)});return self.addNotification(message),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}if(self.isInSkipSegment(timestamp))return self.addNotification(M.util.get_string("interactionisbetweentheskipsegment","ivplugin_inlineannotation")),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}))})),iaform.addEventListener(iaform.events.FORM_SUBMITTED,(e=>{e.stopImmediatePropagation(),getItems(!1);const highestOrder=getTopLayer(items);let left=100*Math.random(),top=100*Math.random(),newItem={id:(new Date).getTime(),type:type,position:{width:"30%",left:left+"px",top:top+"px","z-index":highestOrder+1},properties:e.detail};handleFormData(newItem,type,!0)}))})),$playerWrapper.off("click","#inlineannotation-btns #edit").on("click","#inlineannotation-btns #edit",(function(e){e.preventDefault(),e.stopImmediatePropagation();let annnoid=$videoWrapper.find("#canvas").data("id"),active=(0,_jquery.default)("#edit-btns").attr("data-active");getItems(!1);let item=items.find((x=>x.id==active)),type=item.type,formdata={...item.properties};formdata.contextid=annotation.contextid,formdata.id=item.id,formdata.annotationid=annnoid,formdata.type=type;let editform=new _modalform.default({formClass:"ivplugin_inlineannotation\\items\\"+("image"==type||"video"==type||"audio"==type||"file"==type?"media":type),args:formdata,modalConfig:{title:M.util.get_string("editinlineannotation","ivplugin_inlineannotation",M.util.get_string(type,"ivplugin_inlineannotation"))}});editform.show(),editform.addEventListener(editform.events.LOADED,(()=>{editform.modal.modal.draggable({handle:".modal-header"}),"navigation"!=type&&"image"!=type&&"shape"!=type||(0,_jquery.default)(document).on("change",'[name="timestamp"]',(function(e){e.preventDefault();let parts=(0,_jquery.default)(this).val().split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);if(!self.isBetweenStartAndEnd(timestamp)){let message=M.util.get_string("timemustbebetweenstartandendtime","mod_interactivevideo",{start:self.convertSecondsToHMS(self.start),end:self.convertSecondsToHMS(self.end)});return self.addNotification(message),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}if(self.isInSkipSegment(timestamp))return self.addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo")),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}))})),editform.addEventListener(editform.events.FORM_SUBMITTED,(e=>{e.stopImmediatePropagation(),getItems(!1),item=items.find((x=>x.id==active)),item.properties=e.detail,$videoWrapper.find('.annotation-wrapper[data-item="'.concat(active,'"]')).remove(),items=items.filter((x=>x.id!=active)),handleFormData(item,type,!1)}))})),$videoWrapper.off("click","#canvas .annotation-wrapper").on("click","#canvas .annotation-wrapper",(function(e){if(e.preventDefault(),e.stopImmediatePropagation(),e.ctrlKey||e.metaKey?(0,_jquery.default)(this).hasClass("active")?(0,_jquery.default)(this).removeClass("active"):((0,_jquery.default)(this).addClass("active"),this.focus()):($videoWrapper.find("#canvas .annotation-wrapper").removeClass("active"),(0,_jquery.default)(this).addClass("active"),this.focus(),recalculatingSize((0,_jquery.default)(this))),!isNaN(Number((0,_jquery.default)(this).data("group")))){let group=(0,_jquery.default)(this).data("group");$videoWrapper.find('#canvas .annotation-wrapper[data-group="'.concat(group,'"]')).addClass("active")}recalculatingSize((0,_jquery.default)(this));var activewrapper=$videoWrapper.find("#canvas .annotation-wrapper.active");if(0==activewrapper.length)(0,_jquery.default)("#edit-btns").attr("data-active","").addClass("d-none").removeClass("d-flex"),(0,_jquery.default)("#inlineannotation-btns #edit").attr("disabled","disabled"),(0,_jquery.default)("#inlineannotation-btns #edit").removeAttr("disabled");else{let dataActive=activewrapper.map((function(){return(0,_jquery.default)(this).data("item")})).get();(0,_jquery.default)("#edit-btns").attr("data-active",dataActive).addClass("d-flex").removeClass("d-none"),activewrapper.length>1?((0,_jquery.default)("#inlineannotation-btns #edit").attr("disabled","disabled"),(0,_jquery.default)("#edit-btns #position").addClass("d-none")):((0,_jquery.default)("#inlineannotation-btns #edit").removeAttr("disabled"),(0,_jquery.default)("#edit-btns #position").removeClass("d-none"))}let grouping=activewrapper.map((function(){return isNaN((0,_jquery.default)(this).data("group"))||""==(0,_jquery.default)(this).data("group")?"":(0,_jquery.default)(this).data("group")})).get();grouping=[...new Set(grouping)],activewrapper.length<2?(0,_jquery.default)("#inlineannotation-btns #ungroup, #inlineannotation-btns #group").attr("disabled","disabled").addClass("d-none"):1==grouping.length?isNaN(grouping[0])||""==grouping[0]?((0,_jquery.default)("#inlineannotation-btns #ungroup").attr("disabled","disabled").addClass("d-none"),(0,_jquery.default)("#inlineannotation-btns #group").removeAttr("disabled").removeClass("d-none")):((0,_jquery.default)("#inlineannotation-btns #ungroup").removeAttr("disabled").removeClass("d-none"),(0,_jquery.default)("#inlineannotation-btns #group").attr("disabled","disabled").addClass("d-none")):grouping.length>1&&(0,_jquery.default)("#inlineannotation-btns #ungroup, #inlineannotation-btns #group").removeAttr("disabled").removeClass("d-none")})),$videoWrapper.off("dblclick","#canvas .annotation-wrapper").on("dblclick","#canvas .annotation-wrapper",(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)(this).trigger("click"),(0,_jquery.default)("#inlineannotation-btns #edit").trigger("click")})),(0,_jquery.default)(document).off("click","#inlineannotation-btns #undo").on("click","#inlineannotation-btns #undo",(async function(e){if(e.preventDefault(),e.stopImmediatePropagation(),0==trackingIndex)return;trackingIndex--;const instance=tracking[trackingIndex];items=JSON.parse(instance.items),renderItems(items,instance.actives,!1),0==trackingIndex?((0,_jquery.default)("#inlineannotation-btns #undo").attr("disabled","disabled"),(0,_jquery.default)("#inlineannotation-btns #redo").removeAttr("disabled")):((0,_jquery.default)("#inlineannotation-btns #undo").removeAttr("disabled"),trackingIndex==tracking.length-1?(0,_jquery.default)("#inlineannotation-btns #redo").attr("disabled","disabled"):(0,_jquery.default)("#inlineannotation-btns #redo").removeAttr("disabled"))})),(0,_jquery.default)(document).off("click","#inlineannotation-btns #redo").on("click","#inlineannotation-btns #redo",(async function(e){if(e.preventDefault(),e.stopImmediatePropagation(),trackingIndex==tracking.length-1)return;trackingIndex++;const instance=tracking[trackingIndex];items=JSON.parse(instance.items),renderItems(items,instance.actives,!1),trackingIndex==tracking.length-1?((0,_jquery.default)("#inlineannotation-btns #redo").attr("disabled","disabled"),(0,_jquery.default)("#inlineannotation-btns #undo").removeAttr("disabled")):((0,_jquery.default)("#inlineannotation-btns #redo").removeAttr("disabled"),0==trackingIndex?(0,_jquery.default)("#inlineannotation-btns #undo").attr("disabled","disabled"):(0,_jquery.default)("#inlineannotation-btns #undo").removeAttr("disabled"))}));const updateOrder=(active,direction)=>{getItems(!1),items.sort(((a,b)=>b.position["z-index"]-a.position["z-index"]));let activeIndex=items.findIndex((x=>x.id==active)),activeItem=items[activeIndex],currentzIndex=activeItem.position["z-index"],affectedItem=null,affectedItemIndex=null;if("up"==direction){if(0==activeIndex)return;affectedItemIndex=activeIndex-1,affectedItem=items[affectedItemIndex],activeItem.position["z-index"]=affectedItem.position["z-index"],affectedItem.position["z-index"]=currentzIndex}else{if(activeIndex==items.length-1)return;affectedItemIndex=activeIndex+1,affectedItem=items[affectedItemIndex],activeItem.position["z-index"]=affectedItem.position["z-index"],affectedItem.position["z-index"]=currentzIndex}items[activeIndex]=activeItem,items[affectedItemIndex]=affectedItem,(0,_jquery.default)('.annotation-wrapper[data-item="'.concat(active,'"]')).css(activeItem.position),(0,_jquery.default)('.annotation-wrapper[data-item="'.concat(affectedItem.id,'"]')).css(affectedItem.position),saveTracking([active])};(0,_jquery.default)(document).off("click","#inlineannotation-btns #group").on("click","#inlineannotation-btns #group",(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)(this).attr("disabled","disabled").addClass("d-none"),(0,_jquery.default)("#inlineannotation-btns #ungroup").removeAttr("disabled").removeClass("d-none"),getItems(!1);let active=(0,_jquery.default)("#canvas .annotation-wrapper.active").map((function(){return(0,_jquery.default)(this).data("item")})).get();const group=(new Date).getTime();active.forEach(((item,i)=>{let activeItem=(0,_jquery.default)('#canvas .annotation-wrapper[data-item="'.concat(item,'"]')),targetIndex=items.findIndex((x=>x.id==item)),target=JSON.parse(JSON.stringify(items[targetIndex]));target.position.group=group,items[targetIndex]=target,activeItem.remove(),renderItems([target],null,!0),i==active.length-1&&renderItems([],active,!0)})),saveTracking(active)})),(0,_jquery.default)(document).off("click","#inlineannotation-btns #ungroup").on("click","#inlineannotation-btns #ungroup",(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)(this).attr("disabled","disabled").addClass("d-none"),(0,_jquery.default)("#inlineannotation-btns #group").removeAttr("disabled").removeClass("d-none"),getItems(!1);let active=(0,_jquery.default)("#canvas .annotation-wrapper.active").map((function(){return(0,_jquery.default)(this).data("item")})).get();active.forEach(((item,i)=>{let activeItem=(0,_jquery.default)('#canvas .annotation-wrapper[data-item="'.concat(item,'"]')),targetIndex=items.findIndex((x=>x.id==item)),target=JSON.parse(JSON.stringify(items[targetIndex]));delete target.position.group,items[targetIndex]=target,activeItem.remove(),renderItems([target],null,!0),i==active.length-1&&renderItems([],active,!0)})),saveTracking(active)})),$playerWrapper.off("click","#inlineannotation-btns #up").on("click","#inlineannotation-btns #up",(function(e){e.preventDefault(),e.stopImmediatePropagation();let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(",");const topLayer=getTopLayer(items);if(active.length>1){active=sortItemsByLayer(active,"desc");let indexes=[];if(items.sort(((a,b)=>b.position["z-index"]-a.position["z-index"])),active.forEach((item=>{indexes.push(items.findIndex((x=>x.id==item)))})),indexes.sort(((a,b)=>a-b)),Math.abs(indexes[0]-indexes[indexes.length-1])==active.length-1&&Number(items[indexes[0]].position["z-index"])==topLayer)return}active.forEach((item=>{updateOrder(item,"up")})),getItems(!1),updatePositionInfo((0,_jquery.default)('.annotation-wrapper[data-item="'.concat(active[0],'"]')))})),$playerWrapper.off("click","#inlineannotation-btns #down").on("click","#inlineannotation-btns #down",(function(e){e.preventDefault(),e.stopImmediatePropagation();let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(",");const bottomLayer=(itms=>{if(0==itms.length)return 5;let ids=itms.map((item=>item.id)),sorted=sortItemsByLayer(ids,"asc"),zindex=itms.find((item=>item.id==sorted[0])).position["z-index"];return Number(zindex)})(items);if(active.length>1){active=sortItemsByLayer(active,"asc");let indexes=[];if(items.sort(((a,b)=>a.position["z-index"]-b.position["z-index"])),active.forEach((item=>{indexes.push(items.findIndex((x=>x.id==item)))})),indexes.sort(((a,b)=>a-b)),Math.abs(indexes[0]-indexes[indexes.length-1])==active.length-1&&Number(items[indexes[0]].position["z-index"])==bottomLayer)return}active.forEach((item=>{updateOrder(item,"down")})),getItems(!1),updatePositionInfo((0,_jquery.default)('.annotation-wrapper[data-item="'.concat(active[0],'"]')))})),$playerWrapper.off("click","#inlineannotation-btns #delete").on("click","#inlineannotation-btns #delete",(function(e){e.preventDefault(),e.stopImmediatePropagation();let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(","),active.forEach((item=>{(0,_jquery.default)('#canvas .annotation-wrapper[data-item="'.concat(item,'"]')).remove(),(0,_jquery.default)("#edit-btns").attr("data-active","").addClass("d-none").removeClass("d-flex")})),getItems(!1),saveTracking(null)})),$playerWrapper.off("click","#inlineannotation-btns #copy").on("click","#inlineannotation-btns #copy",(function(e){e.preventDefault(),e.stopImmediatePropagation(),getItems(!1);const highestOrder=getTopLayer(items);let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(","),active=sortItemsByLayer(active,"asc");let newItems=[];for(let i=0;i<active.length;i++){let a=active[i],activeItem=(0,_jquery.default)('#canvas .annotation-wrapper[data-item="'.concat(a,'"]'));activeItem.removeClass("active");const item=items.find((x=>x.id==a));let newItem=JSON.parse(JSON.stringify(item));if(newItem.position=recalculatingSize(activeItem),item.position.group&&(newItem.position.group=Number(item.position.group)+1),newItem.id=(new Date).getTime()+i,newItems.push(newItem),newItem.position["z-index"]=Number(highestOrder)+i+1,items.push(newItem),i==active.length-1){const newItemIds=newItems.map((x=>x.id));(0,_jquery.default)("#edit-btns").attr("data-active",newItemIds.join(",")).addClass("d-flex").removeClass("d-none"),renderItems(newItems,newItemIds,!0),getItems(!1),document.querySelector(".annotation-wrapper.active").focus(),updatePositionInfo((0,_jquery.default)('.annotation-wrapper[data-item="'.concat(newItem.id,'"]'))),saveTracking(newItemIds)}}})),$playerWrapper.on("keydown","#canvas .annotation-wrapper",(function(e){let active=(0,_jquery.default)("#edit-btns").attr("data-active");active=active.split(",");for(let i=0;i<active.length;i++){let a=active[i],activeItem=(0,_jquery.default)('#canvas .annotation-wrapper[data-item="'.concat(a,'"]'));if(null!=activeItem){let position=activeItem.position();position["z-index"]=parseInt(activeItem.css("z-index"));let ctrl=e.ctrlKey||e.metaKey,step=1;switch(e.preventDefault(),e.stopImmediatePropagation(),e.key){case"ArrowUp":position.top>0&&(position.top=position.top-step,saveTracking(active));break;case"ArrowDown":position.top+activeItem.outerHeight()<$videoWrapper.find("#canvas").height()&&(position.top=position.top+step,saveTracking(active));break;case"ArrowLeft":position.left>0&&(position.left=position.left-step,saveTracking(active));break;case"ArrowRight":position.left+activeItem.outerWidth()<$videoWrapper.find("#canvas").width()&&(position.left=position.left+step,saveTracking(active));break;case"Delete":return void(0,_jquery.default)("#inlineannotation-btns #delete").trigger("click");case"d":return void(ctrl&&(0,_jquery.default)("#inlineannotation-btns #copy").trigger("click"));default:return}activeItem.css(position),recalculatingSize(activeItem)}}})),(0,_jquery.default)(document).on("annotationdeleted",(function(e){let deleted=e.originalEvent.detail.annotation,annoid=$videoWrapper.find("#canvas").data("id");annoid==deleted.id&&($videoWrapper.find("#canvas[data-id='".concat(annoid,"']")).remove(),(0,_jquery.default)("#inlineannotation-btns").remove())})),window.addEventListener("beforeunload",(e=>{if(null!==draftStatus){const confirmationMessage=M.util.get_string("unsavedchanges","mod_interactivevideo");return e.returnValue=confirmationMessage,confirmationMessage}return!0}))}async runInteraction(annotation){this.player.pause(),this.renderContainer(annotation),this.isEditMode()&&(annotation.editmode=!0);const content=await this.render(annotation,"json");this.postContentRender(annotation,content)}}return _exports.default=InlineAnnotation,_exports.default}));

//# sourceMappingURL=main.min.js.map