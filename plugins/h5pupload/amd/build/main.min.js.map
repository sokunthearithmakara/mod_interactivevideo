{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main class for the H5P Upload plugin.\n *\n * @module     ivplugin_h5pupload/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\nexport default class H5pUpload extends Base {\n    renderContainer(annotation) {\n        $(`#message[data-id='${annotation.id}']`).addClass('hasiframe');\n        if (annotation.completiontracking\n            && (annotation.completiontracking == 'complete'\n                || annotation.completiontracking == 'completepass'\n                || annotation.completiontracking == 'completefull')) {\n            // Disable the mark-done and mark-undone buttons.\n            $(`#message[data-id='${annotation.id}'] #completiontoggle`).prop('disabled', true);\n            if (annotation.completed == true) {\n                $(`#message[data-id='${annotation.id}'] #completiontoggle span`)\n                    .text(`${M.util.get_string('completioncompleted', 'mod_interactivevideo')}`);\n            } else {\n                $(`#message[data-id='${annotation.id}'] #completiontoggle span`)\n                    .text(`${M.util.get_string('completionincomplete', 'mod_interactivevideo')}`);\n            }\n        }\n    }\n    postContentRender(annotation, callback) {\n        // $(`#message[data-id='${annotation.id}'] iframe`);\n        if (annotation.completiontracking\n            && (annotation.completiontracking == 'complete'\n                || annotation.completiontracking == 'completepass'\n                || annotation.completiontracking == 'completefull') && !annotation.completed) {\n            return callback;\n        }\n        return true;\n    }\n    runInteraction(annotation) {\n        var annoid = annotation.id;\n        var self = this;\n        const xAPICheck = (annotation) => {\n            var H5P;\n            var iframeinterval = setInterval(function() {\n                try { // Try to get the H5P object.\n                    H5P = document.querySelector(`#message[data-id='${annoid}'] iframe`).contentWindow.H5P;\n                } catch (e) {\n                    H5P = null;\n                }\n\n                if (typeof H5P !== 'undefined' && H5P !== null) {\n                    if (self.isEditMode()) {\n                        $(`#message[data-id='${annotation.id}'] #title .xapi`).remove();\n                        $(`#message[data-id='${annotation.id}'] #title .btns`)\n                            .prepend(`<div class=\"xapi alert-secondary d-inline px-2 rounded-pill\">\n                            ${M.util.get_string('xapicheck', 'ivplugin_h5pupload')}</div>`);\n                    }\n                    H5P.externalDispatcher.on('xAPI', function(event) {\n                        if ((event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/completed'\n                            || event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/answered')\n                            && event.data.statement.object.id.indexOf('subContentId') < 0) {\n                            if (self.isEditMode()) {\n                                $(`#message[data-id='${annotation.id}'] #title .btns .xapi`).remove();\n                                $(`#message[data-id='${annotation.id}'] #title .btns`)\n                                    .prepend(`<div class=\"xapi alert-success d-inline px-2 rounded-pill\">\n                                    <i class=\"fa fa-check mr-2\"></i>\n                                    ${M.util.get_string('xapieventdetected', 'ivplugin_h5pupload')}\n                                    </div>`);\n                                var audio = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/pop.mp3');\n                                audio.play();\n                                return;\n                            }\n                            var complete = false;\n                            if (annotation.completiontracking == 'completepass'\n                                && event.data.statement.result && event.data.statement.result.score.scaled >= 0.5) {\n                                complete = true;\n                            } else if (annotation.completiontracking == 'completefull'\n                                && event.data.statement.result && event.data.statement.result.score.scaled == 1) {\n                                complete = true;\n                            } else if (annotation.completiontracking == 'complete') {\n                                complete = true;\n                            }\n                            if (complete && !annotation.completed) {\n                                self.toggleCompletion(annoid, 'mark-done', 'automatic');\n                            }\n                        }\n                    });\n\n                    clearInterval(iframeinterval);\n                }\n\n            }, 1000);\n        };\n\n        // Apply content\n        const applyContent = (annotation) => {\n            this.render(annotation, 'html').then((data) => {\n                $(`#message[data-id='${annotation.id}'] .modal-body`).attr('id', 'content').html(data).fadeIn(300);\n                if (annotation.completed) {\n                    this.postContentRender(annotation);\n                } else {\n                    this.postContentRender(annotation, xAPICheck(annotation));\n                }\n                return;\n            }).catch(() => {\n                // Do nothing.\n            });\n        };\n\n        this.renderViewer(annotation).then(() => {\n            this.renderContainer(annotation);\n            applyContent(annotation);\n            return;\n        }).catch(() => {\n            // Do nothing.\n        });\n\n        this.enableManualCompletion();\n\n        if (annotation.displayoptions == 'popup') {\n            $('#annotation-modal').on('shown.bs.modal', function() {\n                self.setModalDraggable('#annotation-modal .modal-dialog');\n            });\n        }\n    }\n}"],"names":["H5pUpload","Base","renderContainer","annotation","id","addClass","completiontracking","prop","completed","text","M","util","get_string","postContentRender","callback","runInteraction","annoid","self","this","applyContent","render","then","data","attr","html","fadeIn","H5P","iframeinterval","setInterval","document","querySelector","contentWindow","e","isEditMode","remove","prepend","externalDispatcher","on","event","statement","verb","object","indexOf","Audio","cfg","wwwroot","play","complete","result","score","scaled","toggleCompletion","clearInterval","xAPICheck","catch","renderViewer","enableManualCompletion","displayoptions","setModalDraggable"],"mappings":";;;;;;;uKAwBqBA,kBAAkBC,cACnCC,gBAAgBC,gCACT,qBAAoBA,WAAWC,QAAQC,SAAS,cAC/CF,WAAWG,oBAC0B,YAAjCH,WAAWG,oBACyB,gBAAjCH,WAAWG,oBACsB,gBAAjCH,WAAWG,yCAEf,qBAAoBH,WAAWC,0BAA0BG,KAAK,YAAY,GACjD,GAAxBJ,WAAWK,8BACR,qBAAoBL,WAAWC,+BAC7BK,KAAM,GAAEC,EAAEC,KAAKC,WAAW,sBAAuB,+CAEnD,qBAAoBT,WAAWC,+BAC7BK,KAAM,GAAEC,EAAEC,KAAKC,WAAW,uBAAwB,4BAInEC,kBAAkBV,WAAYW,kBAEtBX,WAAWG,qBAC0B,YAAjCH,WAAWG,oBACyB,gBAAjCH,WAAWG,oBACsB,gBAAjCH,WAAWG,sBAA0CH,WAAWK,YAChEM,SAIfC,eAAeZ,gBACPa,OAASb,WAAWC,GACpBa,KAAOC,WAuDLC,aAAgBhB,kBACbiB,OAAOjB,WAAY,QAAQkB,MAAMC,2BAC/B,qBAAoBnB,WAAWC,oBAAoBmB,KAAK,KAAM,WAAWC,KAAKF,MAAMG,OAAO,KAC1FtB,WAAWK,eACNK,kBAAkBV,iBAElBU,kBAAkBV,WA5DhBA,CAAAA,iBACXuB,IACAC,eAAiBC,aAAY,eAEzBF,IAAMG,SAASC,cAAe,qBAAoBd,mBAAmBe,cAAcL,IACrF,MAAOM,GACLN,IAAM,KAGN,MAAOA,MACHT,KAAKgB,mCACF,qBAAoB9B,WAAWC,qBAAqB8B,6BACpD,qBAAoB/B,WAAWC,qBAC7B+B,QAAS,8FACRzB,EAAEC,KAAKC,WAAW,YAAa,gCAEzCc,IAAIU,mBAAmBC,GAAG,QAAQ,SAASC,WACF,4CAAhCA,MAAMhB,KAAKiB,UAAUC,KAAKpC,IACQ,2CAAhCkC,MAAMhB,KAAKiB,UAAUC,KAAKpC,KAC1BkC,MAAMhB,KAAKiB,UAAUE,OAAOrC,GAAGsC,QAAQ,gBAAkB,EAAG,IAC3DzB,KAAKgB,uCACF,qBAAoB9B,WAAWC,2BAA2B8B,6BAC1D,qBAAoB/B,WAAWC,qBAC7B+B,QAAS,0KAERzB,EAAEC,KAAKC,WAAW,oBAAqB,0EAEjC,IAAI+B,MAAMjC,EAAEkC,IAAIC,QAAU,wCAChCC,WAGNC,UAAW,GACsB,gBAAjC5C,WAAWG,oBACRgC,MAAMhB,KAAKiB,UAAUS,QAAUV,MAAMhB,KAAKiB,UAAUS,OAAOC,MAAMC,QAAU,IAEtC,gBAAjC/C,WAAWG,oBACfgC,MAAMhB,KAAKiB,UAAUS,QAAsD,GAA5CV,MAAMhB,KAAKiB,UAAUS,OAAOC,MAAMC,QAE5B,YAAjC/C,WAAWG,sBAJlByC,UAAW,GAOXA,WAAa5C,WAAWK,WACxBS,KAAKkC,iBAAiBnC,OAAQ,YAAa,iBAKvDoC,cAAczB,mBAGnB,MAUwC0B,CAAUlD,gBAGlDmD,OAAM,eAKRC,aAAapD,YAAYkB,MAAK,UAC1BnB,gBAAgBC,YACrBgB,aAAahB,eAEdmD,OAAM,cAIJE,yBAE4B,SAA7BrD,WAAWsD,oCACT,qBAAqBpB,GAAG,kBAAkB,WACxCpB,KAAKyC,kBAAkB"}