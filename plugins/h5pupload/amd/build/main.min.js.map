{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main class for the H5P Upload plugin.\n *\n * @module     ivplugin_h5pupload/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\nexport default class H5pUpload extends Base {\n    /**\n     * Render the container for the annotation\n     * @param {Object} annotation The annotation object\n     * @returns {void}\n     */\n    renderContainer(annotation) {\n        let $message = $(`#message[data-id='${annotation.id}']`);\n        super.renderContainer(annotation);\n        let $completiontoggle = $message.find('#completiontoggle');\n        switch (annotation.completiontracking) {\n            case 'complete':\n                $completiontoggle.before(`<i class=\"bi bi-info-circle-fill mr-2\" data-toggle=\"tooltip\" data-container=\"#wrapper\"\n                    data-trigger=\"hover\"\n                     data-title=\"${M.util.get_string(\"completiononcomplete\", \"mod_interactivevideo\")}\"></i>`);\n                break;\n            case 'completepass':\n                $completiontoggle.before(`<i class=\"bi bi-info-circle-fill mr-2\" data-toggle=\"tooltip\" data-container=\"#wrapper\"\n    data-trigger=\"hover\"\n     data-title=\"${M.util.get_string(\"completiononcompletepass\", \"mod_interactivevideo\")}\"></i>`);\n                break;\n            case 'completefull':\n                $completiontoggle.before(`<i class=\"bi bi-info-circle-fill mr-2\" data-toggle=\"tooltip\" data-container=\"#wrapper\"\n            data-trigger=\"hover\" data-title=\"${M.util.get_string(\"completiononcompletefull\", \"mod_interactivevideo\")}\"></i>`);\n                break;\n        }\n        $message.find('[data-toggle=\"tooltip\"]').tooltip();\n        return $message;\n    }\n\n    /**\n     * Handles the rendering of content after an annotation is posted.\n     *\n     * This function adds a class to the message element, sets an interval to check for an iframe,\n     * and modifies the iframe's background and height properties. It also handles completion tracking.\n     *\n     * @param {Object} annotation - The annotation object containing details about the annotation.\n     * @param {Function} callback - The callback function to be executed if certain conditions are met.\n     * @returns {boolean|Function} - Returns true if the annotation does not require manual completion tracking,\n     *                               otherwise returns the callback function.\n     */\n    postContentRender(annotation, callback) {\n        $(`#message[data-id='${annotation.id}']`).addClass('hasiframe');\n        let interval = setInterval(() => {\n            if ($(`#message[data-id='${annotation.id}'] iframe`).length) {\n                clearInterval(interval);\n                const iframe = document.querySelector(`#message[data-id='${annotation.id}'] iframe`);\n                iframe.style.background = 'none';\n                let contentDocument = iframe.contentDocument;\n                let html = contentDocument.querySelector('html');\n                html.style.height = 'unset';\n            }\n        }, 1000);\n        if (annotation.hascompletion == 1 && annotation.completiontracking == 'manual'\n            && !annotation.completed && annotation.completiontracking != 'view') {\n            return callback;\n        }\n        return true;\n    }\n    /**\n     * Executes the interaction for a given annotation.\n     *\n     * @param {Object} annotation - The annotation object containing interaction details.\n     * @param {number} annotation.id - The unique identifier for the annotation.\n     * @param {string} annotation.completiontracking - The method of completion tracking for the annotation.\n     * @param {boolean} annotation.hascompletion - Indicates if the annotation has completion tracking.\n     * @param {boolean} annotation.completed - Indicates if the annotation is already completed.\n     * @param {string} annotation.displayoptions - The display options for the annotation (e.g., 'popup').\n     *\n     * @returns {Promise<void>} - A promise that resolves when the interaction is fully executed.\n     */\n    async runInteraction(annotation) {\n        this.player.pause();\n\n        var annoid = annotation.id;\n        var self = this;\n\n        /**\n         * Monitors an annotation for xAPI events and updates the UI accordingly.\n         *\n         * @param {Object} annotation - The annotation object to monitor.\n         * @param {string} annotation.id - The ID of the annotation.\n         * @param {string} annotation.completiontracking - The completion tracking type for the annotation.\n         * @param {boolean} annotation.completed - Indicates if the annotation is completed.\n         *\n         * @returns {void}\n         */\n        const xAPICheck = (annotation) => {\n            var H5P;\n            var iframeinterval = setInterval(function() {\n                try { // Try to get the H5P object.\n                    H5P = document.querySelector(`#message[data-id='${annoid}'] iframe`).contentWindow.H5P;\n                } catch (e) {\n                    H5P = null;\n                }\n\n                if (typeof H5P !== 'undefined' && H5P !== null) {\n                    clearInterval(iframeinterval);\n                    if (self.isEditMode()) {\n                        $(`#message[data-id='${annotation.id}'] #title .xapi`).remove();\n                        $(`#message[data-id='${annotation.id}'] #title .btns`)\n                            .prepend(`<div class=\"xapi alert-secondary d-inline px-2 rounded-pill\">\n                            ${M.util.get_string('xapicheck', 'ivplugin_h5pupload')}</div>`);\n                    }\n                    let statements = [];\n                    H5P.externalDispatcher.on('xAPI', function(event) {\n                        if (event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/completed'\n                            || event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/answered') {\n                            statements.push(event.data.statement);\n                        }\n                        if ((event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/completed'\n                            || event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/answered')\n                            && event.data.statement.object.id.indexOf('subContentId') < 0) {\n                            if (self.isEditMode()) {\n                                $(`#message[data-id='${annotation.id}'] #title .btns .xapi`).remove();\n                                $(`#message[data-id='${annotation.id}'] #title .btns`)\n                                    .prepend(`<div class=\"xapi alert-success d-inline px-2 rounded-pill\">\n                                    <i class=\"fa fa-check mr-2\"></i>\n                                    ${M.util.get_string('xapieventdetected', 'ivplugin_h5pupload')}\n                                    </div>`);\n                                var audio = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/pop.mp3');\n                                audio.play();\n                                return;\n                            }\n                            var complete = false;\n                            let textclass = '';\n                            if (annotation.completiontracking == 'completepass'\n                                && event.data.statement.result && event.data.statement.result.score.scaled >= 0.5) {\n                                complete = true;\n                            } else if (annotation.completiontracking == 'completefull'\n                                && event.data.statement.result && event.data.statement.result.score.scaled == 1) {\n                                complete = true;\n                            } else if (annotation.completiontracking == 'complete') {\n                                complete = true;\n                            }\n                            if (event.data.statement.result.score.scaled < 0.5) {\n                                textclass = 'fa fa-check text-danger';\n                            } else if (event.data.statement.result.score.scaled < 1 ) {\n                                textclass = 'fa fa-check text-success';\n                            } else {\n                                textclass = 'bi bi-check2-all text-success';\n                            }\n                            if (complete && !annotation.completed) {\n                                let details = {};\n                                const completeTime = new Date();\n                                details.xp = annotation.xp;\n                                details.duration = completeTime.getTime() - $('#video-wrapper').data('timestamp');\n                                details.timecompleted = completeTime.getTime();\n                                const completiontime = completeTime.toLocaleString();\n                                let duration = self.formatTime(details.duration / 1000);\n                                details.reportView = `<span data-toggle=\"tooltip\" data-html=\"true\"\n                 data-title='<span class=\"d-flex flex-column align-items-start\"><span><i class=\"bi bi-calendar mr-2\"></i>\n                 ${completiontime}</span><span><i class=\"bi bi-stopwatch mr-2\"></i>${duration}</span>\n                 <span><i class=\"bi bi-list-check mr-2\"></i>\n                 ${event.data.statement.result.score.raw}/${event.data.statement.result.score.max}</span></span>'>\n                 <i class=\"${textclass}\"></i><br><span>${annotation.xp}</span></span>`;\n                                details.details = statements;\n                                self.toggleCompletion(annoid, 'mark-done', 'automatic', details);\n                            }\n                        }\n                    });\n                }\n            }, 100);\n        };\n\n        // Apply content\n        const applyContent = async (annotation) => {\n            const data = await this.render(annotation, 'html');\n            $(`#message[data-id='${annotation.id}'] .modal-body`).attr('id', 'content').html(data).fadeIn(300);\n            if (annotation.hascompletion == 0) {\n                return;\n            }\n            if (!annotation.completed && annotation.completiontracking == 'view') {\n                this.toggleCompletion(annotation.id, 'mark-done', 'automatic');\n                return;\n            }\n            if (annotation.completed) {\n                this.postContentRender(annotation);\n            } else {\n                this.postContentRender(annotation, xAPICheck(annotation));\n            }\n        };\n\n        await this.renderViewer(annotation);\n        this.renderContainer(annotation);\n        applyContent(annotation);\n\n        this.enableManualCompletion(annotation);\n\n        if (annotation.displayoptions == 'popup') {\n            $('#annotation-modal').on('shown.bs.modal', function() {\n                self.setModalDraggable('#annotation-modal .modal-dialog');\n            });\n        }\n    }\n}"],"names":["H5pUpload","Base","renderContainer","annotation","$message","id","$completiontoggle","find","completiontracking","before","M","util","get_string","tooltip","postContentRender","callback","addClass","interval","setInterval","length","clearInterval","iframe","document","querySelector","style","background","contentDocument","height","hascompletion","completed","player","pause","annoid","self","this","renderViewer","async","data","render","attr","html","fadeIn","H5P","iframeinterval","contentWindow","e","isEditMode","remove","prepend","statements","externalDispatcher","on","event","statement","verb","push","object","indexOf","Audio","cfg","wwwroot","play","complete","textclass","result","score","scaled","details","completeTime","Date","xp","duration","getTime","timecompleted","completiontime","toLocaleString","formatTime","reportView","raw","max","toggleCompletion","xAPICheck","applyContent","enableManualCompletion","displayoptions","setModalDraggable"],"mappings":"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"}