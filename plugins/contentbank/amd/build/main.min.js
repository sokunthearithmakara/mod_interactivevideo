define("ivplugin_contentbank/main",["exports","jquery","ivplugin_contentbank/util","core_form/modalform","mod_interactivevideo/type/base"],(function(_exports,_jquery,_util,_modalform,_base){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Main class for content bank
   *
   * @module     ivplugin_contentbank/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_util=_interopRequireDefault(_util),_modalform=_interopRequireDefault(_modalform),_base=_interopRequireDefault(_base);class ContentBank extends _base.default{onEditFormLoaded(form,event){let self=this,body=form.modal.modal.find(".modal-body");return _util.default.init(M.cfg.courseContextId),body.off("click","#refreshcontentbank").on("click","#refreshcontentbank",(function(e){e.preventDefault(),(0,_jquery.default)(this).find("i").addClass("fa-spin");const currentid=(0,_jquery.default)("[name=contentid]").val();(0,_jquery.default)(".contentbank-container").html('<div class="d-flex justify-content-center align-items-center"\n            style="height: 150px;"><div class="spinner-grow text-secondary" role="status">\n            <span class="sr-only">Loading...</span></div></div>'),_util.default.refreshContentBank(currentid,M.cfg.courseContextId,(0,_jquery.default)(this).data("editable"),(function(){(0,_jquery.default)("#refreshcontentbank i").removeClass("fa-spin")}))})),body.off("click","#uploadcontentbank").on("click","#uploadcontentbank",(function(e){e.preventDefault();const uploadForm=new _modalform.default({formClass:"core_contentbank\\form\\upload_files",args:{contextid:M.cfg.courseContextId},modalConfig:{title:M.util.get_string("uploadcontent","ivplugin_contentbank")}});uploadForm.addEventListener(uploadForm.events.FORM_SUBMITTED,(e=>{self.addNotification(M.util.get_string("contentuploaded","ivplugin_contentbank"),"success");const contentid=e.detail.returnurl.match(/id=(\d+)/)[1];(0,_jquery.default)("[name=contentid]").val(contentid),setTimeout((function(){(0,_jquery.default)("#refreshcontentbank").trigger("click")}),1e3)})),uploadForm.addEventListener(uploadForm.events.ERROR,(()=>{self.addNotification(M.util.get_string("contentuploaderror","ivplugin_contentbank"))})),uploadForm.show()})),{form:form,event:event}}postContentRender(annotation,callback){return(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).addClass("hascontentbank"),!(1==annotation.hascompletion&&"manual"!=annotation.completiontracking&&!annotation.completed)||callback}renderContainer(annotation){super.renderContainer(annotation);let $message=(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']"));$message.find(".modal-body").addClass("p-0");let $completiontoggle=$message.find("#completiontoggle");switch($message.find("#title .info").remove(),annotation.completiontracking){case"complete":$completiontoggle.before('<i class="bi bi-info-circle-fill mr-2" data-toggle="tooltip" data-container="#wrapper"\n                    data-trigger="hover"\n                     data-title="'.concat(M.util.get_string("completiononcomplete","mod_interactivevideo"),'"></i>'));break;case"completepass":$completiontoggle.before('<i class="bi bi-info-circle-fill mr-2" data-toggle="tooltip" data-container="#wrapper"\n    data-trigger="hover"\n     data-title="'.concat(M.util.get_string("completiononcompletepass","mod_interactivevideo"),'"></i>'));break;case"completefull":$completiontoggle.before('<i class="bi bi-info-circle-fill mr-2" data-toggle="tooltip" data-container="#wrapper"\n            data-trigger="hover" data-title="'.concat(M.util.get_string("completiononcompletefull","mod_interactivevideo"),'"></i>'))}return $message.find('[data-toggle="tooltip"]').tooltip(),$message}resizeIframe(annotation){const modalbody=document.querySelector("#message[data-id='".concat(annotation.id,"'] .modal-body"));new ResizeObserver((()=>{const iframe=modalbody.querySelector("iframe.h5p-player");if(iframe){const height=iframe.scrollHeight;modalbody.style.height="".concat(height+2e3,"px")}})).observe(modalbody)}async runInteraction(annotation){await this.player.pause();const annoid=annotation.id;let $message,self=this;await this.renderViewer(annotation),$message=this.renderContainer(annotation),async function(annotation){const data=await self.render(annotation);$message.find(".modal-body").html(data).attr("id","content").fadeIn(300),1!=annotation.hascompletion||self.isEditMode()||(annotation.completed||"view"!=annotation.completiontracking||self.toggleCompletion(annoid,"mark-done","automatic"),function(annotation){let listenToEvents=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const detectH5P=()=>{let H5P;try{H5P=document.querySelector("#message[data-id='".concat(annoid,"'] iframe")).contentWindow.H5P}catch(e){H5P=null}if(null!=H5P){if(!listenToEvents)return;self.isEditMode()&&($message.find("#title .btns .xapi").remove(),$message.find("#title .btns").prepend('<div class="xapi alert-secondary px-2\n                         rounded-pill">'.concat(M.util.get_string("xapicheck","ivplugin_contentbank"),"</div>")));let statements=[];try{H5P.externalDispatcher.on("xAPI",(function(event){if("http://adlnet.gov/expapi/verbs/completed"!=event.data.statement.verb.id&&"http://adlnet.gov/expapi/verbs/answered"!=event.data.statement.verb.id||statements.push(event.data.statement),("http://adlnet.gov/expapi/verbs/completed"==event.data.statement.verb.id||"http://adlnet.gov/expapi/verbs/answered"==event.data.statement.verb.id)&&event.data.statement.object.id.indexOf("subContentId")<0){if(self.isEditMode())return(0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] #title .btns .xapi")).remove(),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] #title .btns")).prepend('<div class="xapi alert-success d-inline px-2 rounded-pill">\n                                        <i class="fa fa-check mr-2"></i>\n                                        '.concat(M.util.get_string("xapieventdetected","ivplugin_h5pupload"),"\n                                        </div>")),void new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/pop.mp3").play();let complete=!1,textclass="";if(("completepass"==annotation.completiontracking&&event.data.statement.result&&event.data.statement.result.score.scaled>=.5||"completefull"==annotation.completiontracking&&event.data.statement.result&&1==event.data.statement.result.score.scaled||"complete"==annotation.completiontracking)&&(complete=!0),textclass=event.data.statement.result.score.scaled<.5?"fa fa-check text-danger":event.data.statement.result.score.scaled<1?"fa fa-check text-success":"bi bi-check2-all text-success",complete&&!annotation.completed){let details={};const completeTime=new Date;details.xp=annotation.xp,"1"==annotation.char1&&(details.xp=(event.data.statement.result.score.scaled*annotation.xp).toFixed(2)),details.duration=completeTime.getTime()-(0,_jquery.default)("#video-wrapper").data("timestamp"),details.timecompleted=completeTime.getTime();const completiontime=completeTime.toLocaleString();let duration=self.formatTime(details.duration/1e3);details.reportView='<span data-toggle="tooltip" data-html="true"\n                     data-title=\'<span class="d-flex flex-column align-items-start"><span><i class="bi bi-calendar mr-2"></i>\n                     '.concat(completiontime,'</span><span><i class="bi bi-stopwatch mr-2"></i>').concat(duration,'</span>\n                     <span><i class="bi bi-list-check mr-2"></i>\n                     ').concat(event.data.statement.result.score.raw,"/").concat(event.data.statement.result.score.max,"</span></span>'>\n                     <i class=\"").concat(textclass,'"></i><br><span>').concat(Number(details.xp),"</span></span>"),details.details=statements,self.toggleCompletion(annoid,"mark-done","automatic",details)}}}))}catch(e){requestAnimationFrame(detectH5P)}}else requestAnimationFrame(detectH5P)};requestAnimationFrame(detectH5P)}(annotation,!annotation.completed&&"manual"!=annotation.completiontracking))}(annotation),this.enableManualCompletion(annotation),this.resizeIframe(annotation),"popup"==annotation.displayoptions&&(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(function(){self.setModalDraggable("#annotation-modal .modal-dialog")}))}}return _exports.default=ContentBank,_exports.default}));

//# sourceMappingURL=main.min.js.map