{"version":3,"file":"util.min.js","sources":["../src/util.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Content bank utility functions\n *\n * @module     ivplugin_contentbank/util\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\n/**\n * Fetches content from the content bank and updates the target element if provided.\n *\n * @param {number} id - The ID of the content item to fetch.\n * @param {number} contextid - The context ID where the content item resides.\n * @param {string} [target] - The optional target element selector to update with the fetched content.\n * @returns {Promise} A promise that resolves with the response or updates the target element with the fetched content.\n */\nconst getcontent = (id, contextid, target) => {\n    Ajax.call([{\n        args: {\n            id: id,\n            contextid: contextid,\n        },\n        contextid: contextid,\n        methodname: 'ivplugin_contentbank_getitem',\n    }])[0].then((response) => {\n        if (target) {\n            return $(target).html(response.item);\n        } else {\n            return response;\n        }\n    }).catch(() => {\n        // Do nothing.\n    });\n};\n\n/**\n * Initializes event listeners for content bank interactions.\n *\n * @param {number} contextid - The context ID for the content bank.\n *\n * This function sets up click event handlers for elements within the content bank container.\n * It handles the selection of content items, updates the preview area, and manages xAPI event detection.\n *\n * Event Listeners:\n * - Click on content item details: Selects the item and updates the hidden input with the content ID.\n * - Click on content item view: Selects the item, updates the preview area, and sets up xAPI event detection.\n *\n * xAPI Event Detection:\n * - Monitors for xAPI events (completed, answered) emitted by the content.\n * - Displays a notification if such events are detected.\n */\nconst init = (contextid) => {\n    $(document).off('click', '.contentbank-container .contentbank-item .contentbank-item-details')\n        .on('click', '.contentbank-container .contentbank-item .contentbank-item-details', function(e) {\n            e.preventDefault();\n            $('.contentbank-container .contentbank-item').removeClass('selected');\n            $(this).closest('.contentbank-item').addClass('selected');\n            $('#contentbank-preview').empty();\n            const id = $(this).closest('.contentbank-item').data('contentid');\n            $('[name=contentid]').val(id);\n        });\n\n    $(document).off('click', '.contentbank-container .contentbank-item .contentbankview')\n        .on('click', '.contentbank-container .contentbank-item .contentbankview', function(e) {\n            e.preventDefault();\n            $('.contentbank-container .contentbank-item').removeClass('selected');\n            let targetContentbank = $(this).closest('.contentbank-item');\n            targetContentbank.addClass('selected');\n            const id = targetContentbank.data('contentid');\n            $('#contentbank-preview').empty();\n            $('#contentbank-preview').attr('data-contentid', id);\n            $('[name=contentid]').val(id);\n            // Preview selected content.\n            getcontent(id, contextid, '#contentbank-preview');\n\n            // Handle xAPI event. We want user to be able to check if the content emits xAPI events (completed, answered)\n            // because some content types may not emit these events. Then user can decide\n            // if they want students to mark it complete manually or automatically.\n            const xapicheck = M.util.get_string('xapicheck', 'ivplugin_contentbank');\n            let H5P;\n\n            const checkH5P = () => {\n                try { // Try to get the H5P object.\n                    H5P = document.querySelector('#contentbank-preview iframe.h5p-player').contentWindow.H5P;\n                } catch (e) {\n                    H5P = null;\n                }\n\n                if (typeof H5P !== 'undefined' && H5P !== null) {\n                    if (H5P.externalDispatcher === undefined) {\n                        requestAnimationFrame(checkH5P);\n                        return;\n                    }\n                    $(\"#contentbank-preview .xapi\").remove();\n                    $(`#contentbank-preview[data-contentid=${id}]`)\n                        .prepend(`<div class=\"xapi float-right alert-secondary d-inline px-2 text-center rounded-pill mb-2\">\n                ${xapicheck}</div>`);\n                    H5P.externalDispatcher.on('xAPI', function(event) {\n                        if ((event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/completed'\n                            || event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/answered')\n                            && event.data.statement.object.id.indexOf('subContentId') < 0) {\n                            $(\"#contentbank-preview .xapi\").remove();\n                            $(\"#contentbank-preview\")\n                                .prepend(`<div class=\"xapi float-right alert-success d-inline px-2 text-center rounded-pill mb-2\">\n                        <i class=\"fa fa-check mr-2\"></i>${M.util.get_string('xapieventdetected', 'ivplugin_contentbank')}</div>`);\n                            const audio = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/pop.mp3');\n                            audio.play();\n                        }\n                    });\n                } else {\n                    requestAnimationFrame(checkH5P);\n                }\n            };\n\n            requestAnimationFrame(checkH5P);\n        });\n};\n\n/**\n * Refreshes the content bank by fetching and displaying content items.\n *\n * @param {number} id - The ID of the content to be highlighted.\n * @param {number} coursecontextid - The context ID of the course.\n * @param {boolean} [edit=true] - Whether to show edit options for the content items.\n * @param {Function} [callback] - Optional callback function to be executed after refreshing the content bank.\n * @returns {Promise<void>} - A promise that resolves when the content bank is refreshed.\n */\nconst refreshContentBank = async(id, coursecontextid, edit = true, callback) => {\n    $('#contentbank-preview').empty();\n    let contentbankitems = await Ajax.call([{\n        args: {\n            contextid: coursecontextid\n        },\n        contextid: coursecontextid,\n        methodname: 'ivplugin_contentbank_getitems',\n    }])[0];\n\n    let contents = JSON.parse(contentbankitems.contents);\n    let contentbank = $('.modal-body form .contentbank-container');\n    contentbank.empty();\n    contents.forEach(function(content) {\n        const editurl = M.cfg.wwwroot + '/contentbank/edit.php?contextid='\n            + coursecontextid + '&id=' + content.id + '&plugin=' + content.type;\n        let html = '<div class=\"contentbank-item d-flex align-items-center p-1 '\n            + (content.id == id ? \"selected\" : \"\") + ' \" data-contentid=\"' + content.id\n            + '\"><div class=\"contentbank-item-details d-flex align-items-center\">';\n        if (content.icon) {\n            html += '<img class=\"contentbank-item-icon mr-2\" src=\"' + content.icon + '\"/>';\n        } else {\n            html += '<div class=\"contentbank-item-icon mr-2\"></div>';\n        }\n\n        html += '<div class=\"contentbank-item-name w-100\">' + content.name + '</div></div>';\n        html += `<div class=\"btn btn-sm ml-auto contentbankview\" data-toggle=\"tooltip\" data-container=\"#wrapper\"\n                 data-trigger=\"hover\" data-title=\"${M.util.get_string('preview', 'ivplugin_contentbank')}\">\n                 <i class=\"bi bi-eye-fill\"></i></div>`;\n        if (edit) {\n            html += `<a class=\"btn btn-sm ml-2\" target=\"_blank\" href=\"${editurl}\"\n                     data-toggle=\"tooltip\" data-container=\"#wrapper\" data-trigger=\"hover\"\n                      data-title=\"${M.util.get_string('edit', 'ivplugin_contentbank')}\">\n                     <i class=\"bi bi-pencil-square\"></i></a>`;\n        }\n\n        html += `</div>`;\n\n\n        contentbank.append(html);\n    });\n\n    if (callback) {\n        callback();\n    }\n};\n\nexport default {init, getcontent, refreshContentBank};"],"names":["getcontent","id","contextid","target","call","args","methodname","then","response","html","item","catch","init","document","off","on","e","preventDefault","removeClass","this","closest","addClass","empty","data","val","targetContentbank","attr","xapicheck","M","util","get_string","H5P","checkH5P","querySelector","contentWindow","undefined","externalDispatcher","requestAnimationFrame","remove","prepend","event","statement","verb","object","indexOf","Audio","cfg","wwwroot","play","refreshContentBank","async","coursecontextid","edit","callback","contentbankitems","Ajax","contents","JSON","parse","contentbank","forEach","content","editurl","type","icon","name","append"],"mappings":";;;;;;;uKAgCMA,WAAa,CAACC,GAAIC,UAAWC,wBAC1BC,KAAK,CAAC,CACPC,KAAM,CACFJ,GAAIA,GACJC,UAAWA,WAEfA,UAAWA,UACXI,WAAY,kCACZ,GAAGC,MAAMC,UACLL,QACO,mBAAEA,QAAQM,KAAKD,SAASE,MAExBF,WAEZG,OAAM,uBAgJE,CAACC,KA3HFV,gCACRW,UAAUC,IAAI,QAAS,sEACpBC,GAAG,QAAS,sEAAsE,SAASC,GACxFA,EAAEC,qCACA,4CAA4CC,YAAY,gCACxDC,MAAMC,QAAQ,qBAAqBC,SAAS,gCAC5C,wBAAwBC,cACpBrB,IAAK,mBAAEkB,MAAMC,QAAQ,qBAAqBG,KAAK,iCACnD,oBAAoBC,IAAIvB,2BAGhCY,UAAUC,IAAI,QAAS,6DACpBC,GAAG,QAAS,6DAA6D,SAASC,GAC/EA,EAAEC,qCACA,4CAA4CC,YAAY,gBACtDO,mBAAoB,mBAAEN,MAAMC,QAAQ,qBACxCK,kBAAkBJ,SAAS,kBACrBpB,GAAKwB,kBAAkBF,KAAK,iCAChC,wBAAwBD,4BACxB,wBAAwBI,KAAK,iBAAkBzB,wBAC/C,oBAAoBuB,IAAIvB,IAE1BD,WAAWC,GAAIC,UAAW,8BAKpByB,UAAYC,EAAEC,KAAKC,WAAW,YAAa,4BAC7CC,UAEEC,SAAW,SAETD,IAAMlB,SAASoB,cAAc,0CAA0CC,cAAcH,IACvF,MAAOf,GACLe,IAAM,QAGN,MAAOA,IAAqC,SACbI,IAA3BJ,IAAIK,+BACJC,sBAAsBL,8BAGxB,8BAA8BM,2EACSrC,SACpCsC,8HACPZ,qBACEI,IAAIK,mBAAmBrB,GAAG,QAAQ,SAASyB,WACF,4CAAhCA,MAAMjB,KAAKkB,UAAUC,KAAKzC,IACQ,2CAAhCuC,MAAMjB,KAAKkB,UAAUC,KAAKzC,KAC1BuC,MAAMjB,KAAKkB,UAAUE,OAAO1C,GAAG2C,QAAQ,gBAAkB,EAAG,qBAC7D,8BAA8BN,6BAC9B,wBACGC,oKACyBX,EAAEC,KAAKC,WAAW,oBAAqB,mCACvD,IAAIe,MAAMjB,EAAEkB,IAAIC,QAAU,wCAClCC,gBAIdX,sBAAsBL,WAI9BK,sBAAsBL,cA4DZhC,WAAAA,WAAYiD,mBA/CPC,eAAMjD,GAAIkD,qBAAiBC,gEAAaC,oEAC7D,wBAAwB/B,YACtBgC,uBAAyBC,cAAKnD,KAAK,CAAC,CACpCC,KAAM,CACFH,UAAWiD,iBAEfjD,UAAWiD,gBACX7C,WAAY,mCACZ,GAEAkD,SAAWC,KAAKC,MAAMJ,iBAAiBE,UACvCG,aAAc,mBAAE,2CACpBA,YAAYrC,QACZkC,SAASI,SAAQ,SAASC,eAChBC,QAAUlC,EAAEkB,IAAIC,QAAU,mCAC1BI,gBAAkB,OAASU,QAAQ5D,GAAK,WAAa4D,QAAQE,SAC/DtD,KAAO,+DACJoD,QAAQ5D,IAAMA,GAAK,WAAa,IAAM,sBAAwB4D,QAAQ5D,GACvE,qEACF4D,QAAQG,KACRvD,MAAQ,gDAAkDoD,QAAQG,KAAO,MAEzEvD,MAAQ,iDAGZA,MAAQ,4CAA8CoD,QAAQI,KAAO,eACrExD,mKAC4CmB,EAAEC,KAAKC,WAAW,UAAW,qFAErEsB,OACA3C,iEAA4DqD,mJAEpClC,EAAEC,KAAKC,WAAW,OAAQ,6FAItDrB,eAGAkD,YAAYO,OAAOzD,SAGnB4C,UACAA"}