{"version":3,"file":"util.min.js","sources":["../src/util.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Content bank utility functions\n *\n * @module     ivplugin_contentbank/util\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\nconst getcontent = (id, contextid, target) => {\n    Ajax.call([{\n        args: {\n            id: id,\n            contextid: contextid,\n        },\n        contextid: contextid,\n        methodname: 'ivplugin_contentbank_getitem',\n    }])[0].then((response) => {\n        if (target) {\n            return $(target).html(response.item);\n        } else {\n            return response;\n        }\n    }).catch(() => {\n        // Do nothing.\n    });\n};\n\nconst init = (contextid) => {\n    $(document).on('click', '.contentbank-container .contentbank-item .contentbank-item-details', function(e) {\n        e.preventDefault();\n        $('.contentbank-container .contentbank-item').removeClass('selected');\n        $(this).closest('.contentbank-item').addClass('selected');\n        $('#contentbank-preview').empty();\n        var id = $(this).closest('.contentbank-item').data('contentid');\n        $('[name=contentid]').val(id);\n    });\n\n    $(document).on('click', '.contentbank-container .contentbank-item .contentbankview', function(e) {\n        e.preventDefault();\n        $('.contentbank-container .contentbank-item').removeClass('selected');\n        var targetContentbank = $(this).closest('.contentbank-item');\n        targetContentbank.addClass('selected');\n        var id = targetContentbank.data('contentid');\n        $('#contentbank-preview').empty();\n        $('#contentbank-preview').attr('data-contentid', id);\n        $('[name=contentid]').val(id);\n        // Preview selected content\n        getcontent(id, contextid, '#contentbank-preview');\n\n        // Handle xAPI event. We want user to be able to check if the content emits xAPI events (completed, answered)\n        // because some content types may not emit these events. Then user can decide\n        // if they want students to mark it complete manually or automatically.\n        var xapicheck = M.util.get_string('xapicheck', 'ivplugin_contentbank');\n        var H5P;\n        var iframeinterval = setInterval(function() {\n\n            try { // Try to get the H5P object.\n                H5P = document.querySelector('#contentbank-preview iframe.h5p-player').contentWindow.H5P;\n            } catch (e) {\n                H5P = null;\n            }\n\n            if (typeof H5P !== 'undefined' && H5P !== null) {\n                $(\"#contentbank-preview .xapi\").remove();\n                $(`#contentbank-preview[data-contentid=${id}]`)\n                    .prepend(`<div class=\"xapi float-right alert-secondary d-inline px-2 text-center rounded-pill mb-2\">\n                ${xapicheck}</div>`);\n                H5P.externalDispatcher.on('xAPI', function(event) {\n                    if ((event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/completed'\n                        || event.data.statement.verb.id == 'http://adlnet.gov/expapi/verbs/answered')\n                        && event.data.statement.object.id.indexOf('subContentId') < 0) {\n                        $(\"#contentbank-preview .xapi\").remove();\n                        $(\"#contentbank-preview\")\n                            .prepend(`<div class=\"xapi float-right alert-success d-inline px-2 text-center rounded-pill mb-2\">\n                        <i class=\"fa fa-check mr-2\"></i>${M.util.get_string('xapieventdetected', 'ivplugin_contentbank')}</div>`);\n                        var audio = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/pop.mp3');\n                        audio.play();\n                    }\n                });\n\n                clearInterval(iframeinterval);\n            }\n\n        }, 1000);\n    });\n};\n\nconst refreshContentBank = async (id, coursecontextid, edit = true, callback) => {\n    $('#contentbank-preview').empty();\n    let contentbankitems = await Ajax.call([{\n        args: {\n            contextid: coursecontextid\n        },\n        contextid: coursecontextid,\n        methodname: 'ivplugin_contentbank_getitems',\n    }])[0];\n\n    var contents = JSON.parse(contentbankitems.contents);\n    var contentbank = $('.modal-body form .contentbank-container');\n    contentbank.empty();\n    contents.forEach(function(content) {\n        var editurl = M.cfg.wwwroot + '/contentbank/edit.php?contextid='\n            + coursecontextid + '&id=' + content.id + '&plugin=' + content.type;\n        var html = '<div class=\"contentbank-item d-flex align-items-center p-1 '\n            + (content.id == id ? \"selected\" : \"\") + ' \" data-contentid=\"' + content.id\n            + '\"><div class=\"contentbank-item-details d-flex align-items-center\">';\n        if (content.icon) {\n            html += '<img class=\"contentbank-item-icon mr-2\" src=\"' + content.icon + '\"/>';\n        } else {\n            html += '<div class=\"contentbank-item-icon mr-2\"></div>';\n        }\n\n        html += '<div class=\"contentbank-item-name w-100\">' + content.name + '</div></div>';\n        html += `<div class=\"btn btn-sm ml-auto contentbankview\" data-toggle=\"tooltip\" data-container=\"#wrapper\"\n                 data-trigger=\"hover\" data-title=\"${M.util.get_string('preview', 'ivplugin_contentbank')}\">\n                 <i class=\"bi bi-eye-fill\"></i></div>`;\n        if (edit) {\n            html += `<a class=\"btn btn-sm ml-2\" target=\"_blank\" href=\"${editurl}\"\n                     data-toggle=\"tooltip\" data-container=\"#wrapper\" data-trigger=\"hover\"\n                      data-title=\"${M.util.get_string('edit', 'ivplugin_contentbank')}\">\n                     <i class=\"bi bi-pencil-square\"></i></a>`;\n        }\n\n        html += `</div>`;\n\n\n        contentbank.append(html);\n    });\n\n    if (callback) {\n        callback();\n    }\n};\n\nexport default {init, getcontent, refreshContentBank};"],"names":["getcontent","id","contextid","target","call","args","methodname","then","response","html","item","catch","init","document","on","e","preventDefault","removeClass","this","closest","addClass","empty","data","val","targetContentbank","attr","H5P","xapicheck","M","util","get_string","iframeinterval","setInterval","querySelector","contentWindow","remove","prepend","externalDispatcher","event","statement","verb","object","indexOf","Audio","cfg","wwwroot","play","clearInterval","refreshContentBank","async","coursecontextid","edit","callback","contentbankitems","Ajax","contents","JSON","parse","contentbank","forEach","content","editurl","type","icon","name","append"],"mappings":";;;;;;;uKAwBMA,WAAa,CAACC,GAAIC,UAAWC,wBAC1BC,KAAK,CAAC,CACPC,KAAM,CACFJ,GAAIA,GACJC,UAAWA,WAEfA,UAAWA,UACXI,WAAY,kCACZ,GAAGC,MAAMC,UACLL,QACO,mBAAEA,QAAQM,KAAKD,SAASE,MAExBF,WAEZG,OAAM,uBAgHE,CAACC,KA3GFV,gCACRW,UAAUC,GAAG,QAAS,sEAAsE,SAASC,GACnGA,EAAEC,qCACA,4CAA4CC,YAAY,gCACxDC,MAAMC,QAAQ,qBAAqBC,SAAS,gCAC5C,wBAAwBC,YACtBpB,IAAK,mBAAEiB,MAAMC,QAAQ,qBAAqBG,KAAK,iCACjD,oBAAoBC,IAAItB,2BAG5BY,UAAUC,GAAG,QAAS,6DAA6D,SAASC,GAC1FA,EAAEC,qCACA,4CAA4CC,YAAY,gBACtDO,mBAAoB,mBAAEN,MAAMC,QAAQ,qBACxCK,kBAAkBJ,SAAS,gBACvBnB,GAAKuB,kBAAkBF,KAAK,iCAC9B,wBAAwBD,4BACxB,wBAAwBI,KAAK,iBAAkBxB,wBAC/C,oBAAoBsB,IAAItB,IAE1BD,WAAWC,GAAIC,UAAW,4BAMtBwB,IADAC,UAAYC,EAAEC,KAAKC,WAAW,YAAa,wBAE3CC,eAAiBC,aAAY,eAGzBN,IAAMb,SAASoB,cAAc,0CAA0CC,cAAcR,IACvF,MAAOX,GACLW,IAAM,KAGN,MAAOA,0BACL,8BAA8BS,6BAC7B,uCAAsClC,OACpCmC,QAAS,+GACZT,mBACFD,IAAIW,mBAAmBvB,GAAG,QAAQ,SAASwB,QACF,4CAAhCA,MAAMhB,KAAKiB,UAAUC,KAAKvC,IACQ,2CAAhCqC,MAAMhB,KAAKiB,UAAUC,KAAKvC,KAC1BqC,MAAMhB,KAAKiB,UAAUE,OAAOxC,GAAGyC,QAAQ,gBAAkB,wBAC1D,8BAA8BP,6BAC9B,wBACGC,QAAS,qJACoBR,EAAEC,KAAKC,WAAW,oBAAqB,iCAC7D,IAAIa,MAAMf,EAAEgB,IAAIC,QAAU,wCAChCC,WAIdC,cAAchB,mBAGnB,SAmDW/B,WAAAA,WAAYgD,mBA/CPC,eAAOhD,GAAIiD,qBAAiBC,gEAAaC,oEAC9D,wBAAwB/B,YACtBgC,uBAAyBC,cAAKlD,KAAK,CAAC,CACpCC,KAAM,CACFH,UAAWgD,iBAEfhD,UAAWgD,gBACX5C,WAAY,mCACZ,OAEAiD,SAAWC,KAAKC,MAAMJ,iBAAiBE,UACvCG,aAAc,mBAAE,2CACpBA,YAAYrC,QACZkC,SAASI,SAAQ,SAASC,aAClBC,QAAUjC,EAAEgB,IAAIC,QAAU,mCACxBK,gBAAkB,OAASU,QAAQ3D,GAAK,WAAa2D,QAAQE,KAC/DrD,KAAO,+DACJmD,QAAQ3D,IAAMA,GAAK,WAAa,IAAM,sBAAwB2D,QAAQ3D,GACvE,qEACF2D,QAAQG,KACRtD,MAAQ,gDAAkDmD,QAAQG,KAAO,MAEzEtD,MAAQ,iDAGZA,MAAQ,4CAA8CmD,QAAQI,KAAO,eACrEvD,MAAS,sJACmCmB,EAAEC,KAAKC,WAAW,UAAW,mFAErEqB,OACA1C,MAAS,oDAAmDoD,0IAEpCjC,EAAEC,KAAKC,WAAW,OAAQ,2FAItDrB,MAAS,SAGTiD,YAAYO,OAAOxD,SAGnB2C,UACAA"}