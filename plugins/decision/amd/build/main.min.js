define("ivplugin_decision/main",["exports","jquery","mod_interactivevideo/type/base","core_form/dynamicform","core/event_dispatcher"],(function(_exports,_jquery,_base,_dynamicform,_event_dispatcher){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Main module for the decision plugin.
   *
   * @module     ivplugin_decision/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_base=_interopRequireDefault(_base),_dynamicform=_interopRequireDefault(_dynamicform);class Decision extends _base.default{init(){if(!this.isEditMode()){const decisions=this.annotations.filter((d=>"decision"==d.type));if(0==decisions.filter((d=>1!=d.char1)).length)return;let self=this;(0,_jquery.default)(document).on("timeupdate",(function(e){const cantSkip=decisions.filter((d=>1!=d.char1&&!d.viewed));if(cantSkip.sort(((a,b)=>a.timestamp-b.timestamp)),0==cantSkip.length)return;const t=Number(e.originalEvent.detail.time),firstCantSkip=cantSkip[0];t>Number(firstCantSkip.timestamp)&&self.player.seek(Number(firstCantSkip.timestamp)-.05)}))}}addAnnotation(annotations,timestamp,coursemodule){(0,_jquery.default)("#addcontent, #importcontent").addClass("no-pointer-events");let self=this;if(this.annotations=annotations,!this.isBetweenStartAndEnd(timestamp)){const message=M.util.get_string("interactioncanonlybeaddedbetweenstartandendtime","mod_interactivevideo",{start:self.convertSecondsToHMS(self.start),end:self.convertSecondsToHMS(self.end)});return void self.addNotification(message)}if(self.isAlreadyAdded(timestamp))return void self.addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"));if(self.isInSkipSegment(timestamp))return void self.addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo"));const startHMS=self.convertSecondsToHMS(self.start),endHMS=self.convertSecondsToHMS(self.end),timestampHMS=timestamp>0?self.convertSecondsToHMS(timestamp):startHMS,data={id:0,timestamp:timestamp>0?timestamp:self.start,timestampassist:timestampHMS,title:self.prop.title,start:startHMS,end:endHMS,contextid:M.cfg.contextid,type:self.prop.name,courseid:self.course,cmid:coursemodule,annotationid:self.interaction,hascompletion:self.prop.hascompletion?1:0};(0,_jquery.default)("#annotationwrapper table").hide(),(0,_jquery.default)("#annotationwrapper").append('<div id="form" class="w-100 p-3"></div>'),(0,_jquery.default)("#contentmodal").modal("hide"),(0,_jquery.default)("#addcontentdropdown a").removeClass("active");const selector=document.querySelector("#annotationwrapper #form"),decisionform=new _dynamicform.default(selector,self.prop.form);decisionform.load(data),self.onEditFormLoaded(decisionform),self.validateTimestampFieldValue("timestampassist","timestamp"),(0,_jquery.default)(document).off("click","#cancel-submit").on("click","#cancel-submit",(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)("#annotationwrapper #form").remove(),(0,_jquery.default)("#annotationwrapper table").show(),(0,_jquery.default)("#addcontent, #importcontent").removeClass("no-pointer-events")})),(0,_jquery.default)(document).off("click","#submitform-submit").on("click","#submitform-submit",(function(e){e.preventDefault(),e.stopImmediatePropagation();decisionform.trigger(decisionform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||decisionform.submitFormAjax()})),decisionform.addEventListener(decisionform.events.SERVER_VALIDATION_ERROR,(e=>{e.stopImmediatePropagation(),self.onEditFormLoaded(decisionform),self.validateTimestampFieldValue("timestampassist","timestamp")})),decisionform.addEventListener(decisionform.events.FORM_SUBMITTED,(e=>{e.preventDefault(),e.stopImmediatePropagation(),_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_item",id:e.detail.id,sesskey:M.cfg.sesskey,contextid:M.cfg.courseContextId,token:self.token,cmid:self.cm},success:function(data){const newAnnotation=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:newAnnotation,action:"add"})}}),(0,_jquery.default)("#annotationwrapper #form").remove(),(0,_jquery.default)("#annotationwrapper table").show(),(0,_jquery.default)("#addcontent, #importcontent").removeClass("no-pointer-events")}))}editAnnotation(annotations,id){(0,_jquery.default)("#addcontent, #importcontent").addClass("no-pointer-events"),this.annotations=annotations;let self=this;const annotation=annotations.find((x=>x.id==id)),timestamp=annotation.timestamp,timestampassist=this.convertSecondsToHMS(timestamp);annotation.timestampassist=timestampassist,annotation.start=this.convertSecondsToHMS(this.start),annotation.end=this.convertSecondsToHMS(this.end),annotation.contextid=M.cfg.contextid,(0,_jquery.default)("#annotationwrapper table").hide(),(0,_jquery.default)("#annotationwrapper").append('<div id="form" class="w-100 p-3"></div>');const selector=document.querySelector("#annotationwrapper #form"),decisionform=new _dynamicform.default(selector,self.prop.form);decisionform.load(annotation),self.onEditFormLoaded(decisionform),self.validateTimestampFieldValue("timestampassist","timestamp"),(0,_jquery.default)(document).off("click","#cancel-submit").on("click","#cancel-submit",(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)("#annotationwrapper #form").remove(),(0,_jquery.default)("#annotationwrapper table").show(),(0,_jquery.default)("#addcontent, #importcontent").removeClass("no-pointer-events")})),(0,_jquery.default)(document).off("click","#submitform-submit").on("click","#submitform-submit",(function(e){e.preventDefault(),e.stopImmediatePropagation();decisionform.trigger(decisionform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||decisionform.submitFormAjax()})),decisionform.addEventListener(decisionform.events.SERVER_VALIDATION_ERROR,(e=>{e.stopImmediatePropagation(),self.onEditFormLoaded(decisionform),self.validateTimestampFieldValue("timestampassist","timestamp")})),decisionform.addEventListener(decisionform.events.FORM_SUBMITTED,(e=>{e.preventDefault(),e.stopImmediatePropagation(),this.annotations=this.annotations.filter((x=>x.id!=id)),_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_item",id:e.detail.id,sesskey:M.cfg.sesskey,contextid:M.cfg.courseContextId,token:self.token,cmid:self.cm}}).done((function(data){const updated=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"edit"})})),(0,_jquery.default)("#annotationwrapper #form").remove(),(0,_jquery.default)("#annotationwrapper table").show(),(0,_jquery.default)("#addcontent, #importcontent").removeClass("no-pointer-events")}))}onEditFormLoaded(form,event){let self=this,body=(0,_jquery.default)("#annotationwrapper #form");const checkContentField=()=>{if((0,_jquery.default)("[name=content]").length>0){let dest=(0,_jquery.default)("[name=content]").val();""==dest||0==JSON.parse(dest).length?(0,_jquery.default)("#destination-list").append('<div class="input-group mb-1 d-none">\n                <div class="input-group-prepend">\n                    <label class="input-group-text">\n                    <i class="bi bi-grip-vertical fs-unset cursor-move"></i></label>\n                </div>\n                <input type="text" class="form-control">\n                <input type="text" value="'.concat(this.convertSecondsToHMS(this.start),'"\n                placeholder="00:00:00" style="max-width: 120px;" class="form-control timestamp-input">\n                <div class="input-group-append">\n                <button class="btn goto-dest btn-secondary px-2" type="button"><i class="bi bi-play-fill fs-25px"></i></button>\n                <button class="btn add-dest btn-secondary" type="button"><i class="bi bi-plus-lg fs-unset"></i></button>\n                <button class="btn btn-danger delete-dest disabled" disabled type="button">\n                    <i class="bi bi-trash3-fill fs-unset"></i></button></div></div>')):(dest=JSON.parse(dest),dest.forEach(((d,i)=>{(0,_jquery.default)("#destination-list").append('<div class="input-group mb-1">\n                    <div class="input-group-prepend">\n                    <label class="input-group-text">\n                    <i class="bi bi-grip-vertical cursor-move fs-unset"></i></label>\n                    </div>\n                    <input type="text" class="form-control" value="'.concat(d.title,'">\n                    <input type="text" value="').concat(this.convertSecondsToHMS(d.timestamp),'"\n                    placeholder="00:00:00" style="max-width: 120px;" class="form-control timestamp-input">\n                    <div class="input-group-append">\n                    <button class="btn goto-dest btn-secondary px-2" type="button"><i class="bi bi-play-fill fs-25px"></i></button>\n                    <button class="btn add-dest btn-secondary" type="button"><i class="bi bi-plus-lg fs-unset"></i></button>\n                    <button class="btn btn-danger delete-dest ').concat(0==i?"disabled":"",'" ').concat(0==i?"disabled":"",'\n                    type="button"><i class="bi bi-trash3-fill fs-unset"></i></button></div></div>'))})),(0,_jquery.default)('.input-group [type="text"]').trigger("input")),(0,_jquery.default)("#destination-list").sortable({items:".input-group",cursor:"move",update:function(){(0,_jquery.default)('.input-group [type="text"]').trigger("input")},stop:function(){(0,_jquery.default)(".input-group .delete-dest").removeAttr("disabled"),(0,_jquery.default)(".input-group .delete-dest").removeClass("disabled"),(0,_jquery.default)(".input-group .delete-dest").first().attr("disabled",!0),(0,_jquery.default)(".input-group .delete-dest").first().addClass("disabled")}})}else requestAnimationFrame(checkContentField)};return requestAnimationFrame(checkContentField),body.off("click","#add-destination").on("click","#add-destination",(function(){(0,_jquery.default)("#destination-list .input-group").last().find(".add-dest").trigger("click")})),body.off("click",".input-group .add-dest").on("click",".input-group .add-dest",(async function(e){e.stopImmediatePropagation();let $parent=(0,_jquery.default)(this).closest(".input-group"),$row=$parent.clone();$row.removeClass("d-none"),$row.find("input").val("");let currentTime=await self.player.getCurrentTime();$row.find("input.timestamp-input").val(self.convertSecondsToHMS(currentTime)),$row.find(".delete-dest").removeClass("disabled").removeAttr("disabled"),$parent.after($row),$parent.find('[type="text"]').trigger("input")})),body.off("click",".input-group .delete-dest").on("click",".input-group .delete-dest",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)(this).closest(".input-group").remove(),(0,_jquery.default)('.input-group [type="text"]').trigger("input")})),body.off("click",".input-group .goto-dest").on("click",".input-group .goto-dest",(function(e){e.stopImmediatePropagation();const parts=(0,_jquery.default)(this).closest(".input-group").find("input.timestamp-input").val().split(":"),seconds=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);seconds>=self.start&&seconds<=self.end&&self.player.seek(seconds)})),body.on("input",'.input-group [type="text"]',(function(){let dest=[];(0,_jquery.default)("#destination-list .input-group").each((function(){const title=(0,_jquery.default)(this).find('input[type="text"]'),timestamp=(0,_jquery.default)(this).find(".timestamp-input");if(""!=title.val()&&""!=timestamp.val()&&!title.hasClass("is-invalid")&&!timestamp.hasClass("is-invalid")){const parts=timestamp.val().split(":"),seconds=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);dest.push({title:title.val(),timestamp:seconds})}})),0==dest.length?(0,_jquery.default)("[name=content").val(""):(0,_jquery.default)("[name=content").val(JSON.stringify(dest))})),{form:form,event:event}}async runInteraction(annotation){(0,_jquery.default)(".tooltip").remove(),this.player.pause();let self=this,dest=JSON.parse(annotation.content);if(dest=dest.filter((d=>!self.isSkipped(d.timestamp))),self.isEditMode()||(annotation.viewed=!0,this.annotations=this.annotations.filter((d=>d.id!=annotation.id)),this.annotations.push(annotation)),0==dest.length)return window.console.log("No destination found"),void this.player.play();let newannotation=JSON.parse(JSON.stringify(annotation));newannotation.content=JSON.stringify(dest);const data=await this.render(newannotation,"json");let $html='<div class="position-absolute decision text-center mx-auto w-100">\n            <h5 class="pt-5 pb-3 bg-white" id="decision-q">\n            <i class="mb-2 bi bi-signpost-split-fill" style="font-size: 2em"></i><br>'.concat(newannotation.formattedtitle,"</h5>");data.forEach(((dest,order)=>{$html+='<a href="javascript:void(0)" data-timestamp="'.concat(dest.timestamp,'"\n                 data-order="').concat(order,'" class="decision-option btn btn-outline-secondary btn-rounded mb-2 d-flex\n                  justify-content-between align-items-center mx-auto"><span class="text-truncate">').concat(dest.title,'</span>\n                  <i class="bi bi-chevron-right"></i></a>')})),$html+="</div>";let $message=(0,_jquery.default)('<div id="message" style="z-index:1005;display:none;" data-id="'.concat(annotation.id,'">\n            <div class="modal-body p-0 border" id="content">').concat($html,"</div></div>"));(0,_jquery.default)("#video-wrapper").find("#message").remove(),(0,_jquery.default)("#video-wrapper").append($message),$message.fadeIn(300,"swing",(function(){1==annotation.char1&&$message.append('<button class="btn btn-secondary btn-rounded position-absolute"\n                     id="close-decision" style="right: 1rem; top: 1rem;">\n                     '.concat(M.util.get_string("skip","ivplugin_decision"),'\n                     <i class="ml-2 bi bi-chevron-right"></i></button>')),(0,_jquery.default)(document).off("click","#close-decision").on("click","#close-decision",(function(e){e.preventDefault(),e.stopImmediatePropagation(),self.player.play(),(0,_jquery.default)("#taskinfo").fadeIn(300),(0,_jquery.default)('[data-region="chapterlists"], #controller').removeClass("no-pointer-events")})),self.isEditMode()||((0,_jquery.default)("#taskinfo").fadeOut(300),(0,_jquery.default)('[data-region="chapterlists"], #controller').addClass("no-pointer-events")),self.player.pause()})),(0,_jquery.default)(document).off("click","#message[data-id='".concat(annotation.id,"'] .decision-option")).on("click","#message[data-id='".concat(annotation.id,"'] .decision-option"),(function(e){e.preventDefault(),e.stopImmediatePropagation();let time=Number((0,_jquery.default)(this).data("timestamp"));time<this.start?time=this.start:time>this.end&&(time=this.end),self.player.seek(time),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).fadeOut(300),self.player.play(),(0,_jquery.default)("#taskinfo").fadeIn(300),(0,_jquery.default)('[data-region="chapterlists"], #controller').removeClass("no-pointer-events")}))}}return _exports.default=Decision,_exports.default}));

//# sourceMappingURL=main.min.js.map