{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main module for the decision plugin.\n *\n * @module     ivplugin_decision/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\n\nexport default class Decision extends Base {\n    /**\n     * Initialize the interaction type\n     * @returns {void}\n     */\n    init() {\n        $(document).on('timeupdate', (e) => {\n            const decisions = this.annotations.filter((d) => d.type == 'decision');\n            const cantSkip = decisions.filter((d) => d.char1 != 1 && !d.viewed);\n            cantSkip.sort((a, b) => a.timestamp - b.timestamp);\n\n            if (cantSkip.length == 0) {\n                return;\n            }\n            const t = Number(e.originalEvent.detail.time);\n            const firstCantSkip = cantSkip[0];\n            if (t >= Number(firstCantSkip.timestamp)) {\n                this.player.seek(Number(firstCantSkip.timestamp));\n            }\n        });\n\n        // We want to hide the interactions on the navigation if decision elements do not allow skipping.\n    }\n    /**\n     * Render the item on the video navigation\n     * @param {Object} annotation The annotation object\n     * @returns {void}\n     */\n    renderItemOnVideoNavigation(annotation) {\n        if (annotation.timestamp < this.start || annotation.timestamp > this.end) {\n            return;\n        }\n        var percentage = ((Number(annotation.timestamp) - this.start) / this.totaltime) * 100;\n        if (this.isVisible(annotation)) {\n            $(\"#video-nav ul\").append(`<li class=\"annotation ${annotation.completed ? \"completed\" : \"\"}\n        ${annotation.type} ${this.isClickable(annotation) ? '' : 'no-pointer-events'} li-draggable\n         ${this.isSkipped(annotation.timestamp) ? 'skipped' : ''}\"\n         data-timestamp=\"${annotation.timestamp}\"\n        data-id=\"${annotation.id}\" style=\"left: calc(${percentage}% - 5px)\">\n        <i data-toggle=\"tooltip\" data-trigger=\"hover\" data-html=\"true\" data-original-title='<i class=\"${this.prop.icon} mr-1\"></i>\n        ${annotation.formattedtitle}' class=\"${this.prop.icon}\"></i></li>`);\n        }\n    }\n\n    onEditFormLoaded(form, event) {\n        let self = this;\n        let body = super.onEditFormLoaded(form, event);\n\n        var int = setInterval(() => {\n            if ($('[name=content').length > 0) {\n                clearInterval(int);\n                var dest = $('[name=content').val();\n                if (dest == '') {\n                    $('#destination-list').append(`<div class=\"input-group mb-1\">\n    <input type=\"text\" class=\"form-control\">\n    <input type=\"text\" value=\"${this.convertSecondsToHMS(this.start)}\"\n     placeholder=\"00:00:00\" style=\"max-width: 120px;\" class=\"form-control timestamp-input\">\n    <div class=\"input-group-append\">\n    <button class=\"btn add-dest btn-secondary\" type=\"button\"><i class=\"bi bi-plus-lg\"></i></button>\n    <button class=\"btn btn-danger disabled\" disabled type=\"button\"><i class=\"bi bi-trash3-fill\"></i></button>\n        </div></div>`);\n                } else {\n                    dest = JSON.parse(dest);\n                    dest.forEach((d, i) => {\n                        $('#destination-list').append(`<div class=\"input-group mb-1\">\n    <input type=\"text\" class=\"form-control\" value=\"${d.title}\">\n    <input type=\"text\" value=\"${this.convertSecondsToHMS(d.timestamp)}\"\n     placeholder=\"00:00:00\" style=\"max-width: 120px;\" class=\"form-control timestamp-input\">\n    <div class=\"input-group-append\">\n    <button class=\"btn add-dest btn-secondary\" type=\"button\"><i class=\"bi bi-plus-lg\"></i></button>\n    <button class=\"btn btn-danger ${i == 0 ? 'disabled' : 'delete-dest'}\" ${i == 0 ? 'disabled' : ''}\n     type=\"button\"><i class=\"bi bi-trash3-fill\"></i></button></div></div>`);\n                    });\n                    $('.input-group [type=\"text\"]').trigger('input');\n                }\n            }\n        }, 100);\n\n        body.on('click', '.input-group .add-dest', function (e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            var target = $(this).closest('.input-group');\n            target.after(`<div class=\"input-group mb-1\">\n                            <input type=\"text\" class=\"form-control\">\n                            <input value=\"${self.convertSecondsToHMS(self.start)}\"\n                             placeholder=\"00:00:00\" type=\"text\" style=\"max-width: 120px;\"\n                             class=\"form-control timestamp-input\">\n                            <div class=\"input-group-append\">\n                            <button class=\"btn add-dest btn-secondary\" type=\"button\"><i class=\"bi bi-plus-lg\"></i></button>\n                            <button class=\"btn btn-danger delete-dest\" type=\"button\">\n                            <i class=\"bi bi-trash3-fill\"></i></button>\n                            </div>\n                        </div>`);\n            $('[type=\"text\"]').trigger('input');\n        });\n\n        body.on('click', '.input-group .delete-dest', function (e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $(this).closest('.input-group').remove();\n            $('[type=\"text\"]').trigger('input');\n        });\n\n        body.on('input', '.input-group [type=\"text\"]', function () {\n            var dest = [];\n            $('#destination-list .input-group').each(function () {\n                var title = $(this).find('input[type=\"text\"]');\n                var timestamp = $(this).find('.timestamp-input');\n                if (title.val() != '' && timestamp.val() != ''\n                    && !title.hasClass('is-invalid') && !timestamp.hasClass('is-invalid')) {\n                    var parts = timestamp.val().split(':');\n                    var seconds = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n                    dest.push({\n                        title: title.val(),\n                        timestamp: seconds\n                    });\n                }\n            });\n            $('[name=content').val(JSON.stringify(dest));\n        });\n        return { form, event };\n    }\n    /**\n     * Run the interaction\n     * @param {object} annotation The annotation object\n     * @returns {void}\n     */\n    runInteraction(annotation) {\n        this.player.pause();\n        let self = this;\n        var dest = JSON.parse(annotation.content);\n        dest = dest.filter((d) => {\n            return !self.isSkipped(d.timestamp);\n        });\n\n        if (dest.length == 0) {\n            this.player.play();\n            return;\n        }\n\n        if (!self.isEditMode()) {\n            annotation.viewed = true;\n            this.annotations = this.annotations.filter((d) => d.id != annotation.id);\n            this.annotations.push(annotation);\n        }\n\n        let newannotation = { ...annotation };\n        newannotation.content = JSON.stringify(dest);\n        this.render(newannotation, 'json').then((data) => {\n            let $html = `<div class=\"position-absolute decision text-center mx-auto w-100\">\n            <h5 class=\"pt-5 pb-3 bg-white\" id=\"decision-q\">\n            <i class=\"mb-2 bi bi-signpost-split-fill\" style=\"font-size: 2em\"></i><br>${newannotation.formattedtitle}</h5>`;\n\n            data.forEach((dest, order) => {\n                $html += `<a href=\"javascript:void(0)\" data-timestamp=\"${dest.timestamp}\"\n                 data-order=\"${order}\" class=\"decision-option btn btn-outline-secondary btn-rounded mb-2 d-flex\n                  justify-content-between align-items-center mx-auto\"><span class=\"text-truncate\">${dest.title}</span>\n                  <i class=\"bi bi-chevron-right\"></i></a>`;\n            });\n            $html += '</div>';\n            let $message = $(`<div id=\"message\" style=\"z-index:5;display:none;\" data-id=\"${annotation.id}\">\n            <div class=\"modal-body p-0\" id=\"content\">${$html}</div></div>`);\n            $('#video-wrapper').append($message);\n            $message.fadeIn(300, 'swing', function () {\n                if (annotation.char1 == 1) {\n                    $message.append(`<button class=\"btn btn-secondary btn-rounded position-absolute\"\n                     id=\"close-decision\" style=\"right: 1rem; top: 1rem;\">\n                     ${M.util.get_string('skip', 'ivplugin_decision')}\n                     <i class=\"ml-2 bi bi-chevron-right\"></i></button>`);\n                }\n                $(document).on('click', '#close-decision', function (e) {\n                    e.preventDefault();\n                    e.stopImmediatePropagation();\n                    self.player.play();\n                    $('#video-nav').fadeIn(300);\n                    $('[data-region=\"chapterlists\"], #controler').removeClass('no-pointer-events');\n                });\n\n                if (!$('body').hasClass('page-interactions')) {\n                    $('#video-nav').fadeOut(300);\n                    $('[data-region=\"chapterlists\"], #controler').addClass('no-pointer-events');\n                }\n            });\n            return $message;\n        }).catch(() => {\n            // Do nothing\n        });\n\n        $(document).on('click', `#message[data-id='${annotation.id}'] .decision-option`, function (e) {\n            e.preventDefault();\n            var time = Number($(this).data('timestamp'));\n            if (time < this.start) {\n                time = this.start;\n            } else if (time > this.end) {\n                time = this.end;\n            }\n            self.player.seek(time);\n            $(`#message[data-id='${annotation.id}']`).fadeOut(300);\n            self.player.play();\n            $('#video-nav').fadeIn(300);\n            $('[data-region=\"chapterlists\"], #controler').removeClass('no-pointer-events');\n        });\n    }\n}"],"names":["Decision","Base","init","document","on","e","cantSkip","this","annotations","filter","d","type","char1","viewed","sort","a","b","timestamp","length","t","Number","originalEvent","detail","time","firstCantSkip","player","seek","renderItemOnVideoNavigation","annotation","start","end","percentage","totaltime","isVisible","append","completed","isClickable","isSkipped","id","prop","icon","formattedtitle","onEditFormLoaded","form","event","self","body","super","int","setInterval","clearInterval","dest","val","convertSecondsToHMS","JSON","parse","forEach","i","title","trigger","preventDefault","stopImmediatePropagation","closest","after","remove","each","find","hasClass","parts","split","seconds","push","stringify","runInteraction","pause","content","play","isEditMode","newannotation","render","then","data","$html","order","$message","fadeIn","M","util","get_string","removeClass","fadeOut","addClass","catch"],"mappings":";;;;;;;uKAyBqBA,iBAAiBC,cAKlCC,2BACMC,UAAUC,GAAG,cAAeC,UAEpBC,SADYC,KAAKC,YAAYC,QAAQC,GAAgB,YAAVA,EAAEC,OACxBF,QAAQC,GAAiB,GAAXA,EAAEE,QAAeF,EAAEG,YAC5DP,SAASQ,MAAK,CAACC,EAAGC,IAAMD,EAAEE,UAAYD,EAAEC,YAEjB,GAAnBX,SAASY,oBAGPC,EAAIC,OAAOf,EAAEgB,cAAcC,OAAOC,MAClCC,cAAgBlB,SAAS,GAC3Ba,GAAKC,OAAOI,cAAcP,iBACrBQ,OAAOC,KAAKN,OAAOI,cAAcP,eAWlDU,4BAA4BC,iBACpBA,WAAWX,UAAYV,KAAKsB,OAASD,WAAWX,UAAYV,KAAKuB,UAGjEC,YAAeX,OAAOQ,WAAWX,WAAaV,KAAKsB,OAAStB,KAAKyB,UAAa,IAC9EzB,KAAK0B,UAAUL,iCACb,iBAAiBM,OAAQ,yBAAwBN,WAAWO,UAAY,YAAc,eAC1FP,WAAWjB,QAAQJ,KAAK6B,YAAYR,YAAc,GAAK,8CACtDrB,KAAK8B,UAAUT,WAAWX,WAAa,UAAY,iCACnCW,WAAWX,gCACnBW,WAAWU,yBAAyBP,+HACiDxB,KAAKgC,KAAKC,4BACxGZ,WAAWa,0BAA0BlC,KAAKgC,KAAKC,oBAIrDE,iBAAiBC,KAAMC,WACfC,KAAOtC,KACPuC,KAAOC,MAAML,iBAAiBC,KAAMC,WAEpCI,IAAMC,aAAY,SACd,mBAAE,iBAAiB/B,OAAS,EAAG,CAC/BgC,cAAcF,SACVG,MAAO,mBAAE,iBAAiBC,MAClB,IAARD,yBACE,qBAAqBjB,OAAQ,+GAEnB3B,KAAK8C,oBAAoB9C,KAAKsB,0XAO1CsB,KAAOG,KAAKC,MAAMJ,OACbK,SAAQ,CAAC9C,EAAG+C,yBACX,qBAAqBvB,OAAQ,sFACFxB,EAAEgD,0CACvBnD,KAAK8C,oBAAoB3C,EAAEO,0RAIlB,GAALwC,EAAS,WAAa,kBAAuB,GAALA,EAAS,WAAa,wGAG5E,8BAA8BE,QAAQ,aAGjD,YAEHb,KAAK1C,GAAG,QAAS,0BAA0B,SAAUC,GACjDA,EAAEuD,iBACFvD,EAAEwD,4BACW,mBAAEtD,MAAMuD,QAAQ,gBACtBC,MAAO,mJAEkBlB,KAAKQ,oBAAoBR,KAAKhB,4lBAS5D,iBAAiB8B,QAAQ,YAG/Bb,KAAK1C,GAAG,QAAS,6BAA6B,SAAUC,GACpDA,EAAEuD,iBACFvD,EAAEwD,+CACAtD,MAAMuD,QAAQ,gBAAgBE,6BAC9B,iBAAiBL,QAAQ,YAG/Bb,KAAK1C,GAAG,QAAS,8BAA8B,eACvC+C,KAAO,uBACT,kCAAkCc,MAAK,eACjCP,OAAQ,mBAAEnD,MAAM2D,KAAK,sBACrBjD,WAAY,mBAAEV,MAAM2D,KAAK,uBACV,IAAfR,MAAMN,OAAkC,IAAnBnC,UAAUmC,QAC3BM,MAAMS,SAAS,gBAAkBlD,UAAUkD,SAAS,cAAe,KACnEC,MAAQnD,UAAUmC,MAAMiB,MAAM,KAC9BC,QAA6B,KAAnBlD,OAAOgD,MAAM,IAAgC,GAAnBhD,OAAOgD,MAAM,IAAWhD,OAAOgD,MAAM,IAC7EjB,KAAKoB,KAAK,CACNb,MAAOA,MAAMN,MACbnC,UAAWqD,kCAIrB,iBAAiBlB,IAAIE,KAAKkB,UAAUrB,UAEnC,CAAER,KAAAA,KAAMC,MAAAA,OAOnB6B,eAAe7C,iBACNH,OAAOiD,YACR7B,KAAOtC,SACP4C,KAAOG,KAAKC,MAAM3B,WAAW+C,YAKd,IAJnBxB,KAAOA,KAAK1C,QAAQC,IACRmC,KAAKR,UAAU3B,EAAEO,cAGpBC,wBACAO,OAAOmD,OAIX/B,KAAKgC,eACNjD,WAAWf,QAAS,OACfL,YAAcD,KAAKC,YAAYC,QAAQC,GAAMA,EAAE4B,IAAMV,WAAWU,UAChE9B,YAAY+D,KAAK3C,iBAGtBkD,cAAgB,IAAKlD,YACzBkD,cAAcH,QAAUrB,KAAKkB,UAAUrB,WAClC4B,OAAOD,cAAe,QAAQE,MAAMC,WACjCC,MAAS,yNAE8DJ,cAAcrC,sBAEzFwC,KAAKzB,SAAQ,CAACL,KAAMgC,SAChBD,OAAU,gDAA+C/B,KAAKlC,4CAC/CkE,sLACqEhC,KAAKO,6EAG7FwB,OAAS,aACLE,UAAW,mBAAG,8DAA6DxD,WAAWU,8DAC/C4C,+CACzC,kBAAkBhD,OAAOkD,UAC3BA,SAASC,OAAO,IAAK,SAAS,WACF,GAApBzD,WAAWhB,OACXwE,SAASlD,OAAQ,oKAEdoD,EAAEC,KAAKC,WAAW,OAAQ,oHAG/BrF,UAAUC,GAAG,QAAS,mBAAmB,SAAUC,GACjDA,EAAEuD,iBACFvD,EAAEwD,2BACFhB,KAAKpB,OAAOmD,2BACV,cAAcS,OAAO,yBACrB,4CAA4CI,YAAY,yBAGzD,mBAAE,QAAQtB,SAAS,2CAClB,cAAcuB,QAAQ,yBACtB,4CAA4CC,SAAS,yBAGxDP,YACRQ,OAAM,6BAIPzF,UAAUC,GAAG,QAAU,qBAAoBwB,WAAWU,yBAAyB,SAAUjC,GACvFA,EAAEuD,qBACErC,KAAOH,QAAO,mBAAEb,MAAM0E,KAAK,cAC3B1D,KAAOhB,KAAKsB,MACZN,KAAOhB,KAAKsB,MACLN,KAAOhB,KAAKuB,MACnBP,KAAOhB,KAAKuB,KAEhBe,KAAKpB,OAAOC,KAAKH,0BACd,qBAAoBK,WAAWU,QAAQoD,QAAQ,KAClD7C,KAAKpB,OAAOmD,2BACV,cAAcS,OAAO,yBACrB,4CAA4CI,YAAY"}