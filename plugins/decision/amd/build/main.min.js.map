{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main module for the decision plugin.\n *\n * @module     ivplugin_decision/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\n\nexport default class Decision extends Base {\n    /**\n     * Initialize the interaction type\n     * @returns {void}\n     */\n    init() {\n        if (!this.isEditMode()) {\n            $(document).on('timeupdate', (e) => {\n                const decisions = this.annotations.filter((d) => d.type == 'decision');\n                const cantSkip = decisions.filter((d) => d.char1 != 1 && !d.viewed);\n                cantSkip.sort((a, b) => a.timestamp - b.timestamp);\n\n                if (cantSkip.length == 0) {\n                    return;\n                }\n                const t = Number(e.originalEvent.detail.time);\n                const firstCantSkip = cantSkip[0];\n                if (t >= Number(firstCantSkip.timestamp)) {\n                    this.player.seek(Number(firstCantSkip.timestamp));\n                }\n            });\n        }\n\n        // We want to hide the interactions on the navigation if decision elements do not allow skipping.\n    }\n\n    onEditFormLoaded(form, event) {\n        let self = this;\n        let body = super.onEditFormLoaded(form, event);\n\n        var int = setInterval(() => {\n            if ($('[name=content').length > 0) {\n                clearInterval(int);\n                var dest = $('[name=content').val();\n                if (dest == '') {\n                    $('#destination-list').append(`<div class=\"input-group mb-1\">\n                        <div class=\"input-group-prepend\">\n                            <label class=\"input-group-text\">\n                            <i class=\"bi bi-grip-vertical fs-unset cursor-move\"></i></label>\n                        </div>\n                        <input type=\"text\" class=\"form-control\">\n                        <input type=\"text\" value=\"${this.convertSecondsToHMS(this.start)}\"\n                        placeholder=\"00:00:00\" style=\"max-width: 120px;\" class=\"form-control timestamp-input\">\n                        <div class=\"input-group-append\">\n                        <button class=\"btn add-dest btn-secondary\" type=\"button\"><i class=\"bi bi-plus-lg fs-unset\"></i></button>\n                        <button class=\"btn btn-danger disabled\" disabled type=\"button\">\n                            <i class=\"bi bi-trash3-fill fs-unset\"></i></button></div></div>`);\n                } else {\n                    dest = JSON.parse(dest);\n                    dest.forEach((d, i) => {\n                        $('#destination-list').append(`<div class=\"input-group mb-1\">\n                            <div class=\"input-group-prepend\">\n                            <label class=\"input-group-text\">\n                            <i class=\"bi bi-grip-vertical cursor-move fs-unset\"></i></label>\n                        </div>\n                            <input type=\"text\" class=\"form-control\" value=\"${d.title}\">\n                            <input type=\"text\" value=\"${this.convertSecondsToHMS(d.timestamp)}\"\n                            placeholder=\"00:00:00\" style=\"max-width: 120px;\" class=\"form-control timestamp-input\">\n                            <div class=\"input-group-append\">\n                            <button class=\"btn add-dest btn-secondary\" type=\"button\"><i class=\"bi bi-plus-lg fs-unset\"></i></button>\n                            <button class=\"btn btn-danger delete-dest ${i == 0 ? 'disabled' : ''}\" ${i == 0 ? 'disabled' : ''}\n                            type=\"button\"><i class=\"bi bi-trash3-fill fs-unset\"></i></button></div></div>`);\n                    });\n                    $('.input-group [type=\"text\"]').trigger('input');\n                }\n\n                $('#destination-list').sortable({\n                    items: '.input-group',\n                    cursor: 'move',\n                    update: function() {\n                        $('.input-group [type=\"text\"]').trigger('input');\n                    },\n                    stop: function() {\n                        $('.input-group .delete-dest').removeAttr('disabled');\n                        $('.input-group .delete-dest').removeClass('disabled');\n                        $('.input-group .delete-dest').first().attr('disabled', true);\n                        $('.input-group .delete-dest').first().addClass('disabled');\n                    }\n                });\n            }\n        }, 100);\n\n        body.on('click', '.input-group .add-dest', function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            var target = $(this).closest('.input-group');\n            target.after(`<div class=\"input-group mb-1\">\n                            <input type=\"text\" class=\"form-control\">\n                            <input value=\"${self.convertSecondsToHMS(self.start)}\"\n                             placeholder=\"00:00:00\" type=\"text\" style=\"max-width: 120px;\"\n                             class=\"form-control timestamp-input\">\n                            <div class=\"input-group-append\">\n                            <button class=\"btn add-dest btn-secondary\" type=\"button\"><i class=\"bi bi-plus-lg\"></i></button>\n                            <button class=\"btn btn-danger delete-dest\" type=\"button\">\n                            <i class=\"bi bi-trash3-fill\"></i></button>\n                            </div>\n                        </div>`);\n            $('[type=\"text\"]').trigger('input');\n        });\n\n        body.on('click', '.input-group .delete-dest', function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $(this).closest('.input-group').remove();\n            $('[type=\"text\"]').trigger('input');\n        });\n\n        body.on('input', '.input-group [type=\"text\"]', function() {\n            var dest = [];\n            $('#destination-list .input-group').each(function() {\n                var title = $(this).find('input[type=\"text\"]');\n                var timestamp = $(this).find('.timestamp-input');\n                if (title.val() != '' && timestamp.val() != ''\n                    && !title.hasClass('is-invalid') && !timestamp.hasClass('is-invalid')) {\n                    var parts = timestamp.val().split(':');\n                    var seconds = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n                    dest.push({\n                        title: title.val(),\n                        timestamp: seconds\n                    });\n                }\n            });\n            $('[name=content').val(JSON.stringify(dest));\n        });\n        return {form, event};\n    }\n    /**\n     * Run the interaction\n     * @param {object} annotation The annotation object\n     * @returns {void}\n     */\n    async runInteraction(annotation) {\n        // Dismiss all tooltips.\n        $('.tooltip').remove();\n        this.player.pause();\n        let self = this;\n        var dest = JSON.parse(annotation.content);\n        dest = dest.filter((d) => {\n            return !self.isSkipped(d.timestamp);\n        });\n\n        if (dest.length == 0) {\n            this.player.play();\n            return;\n        }\n\n        if (!self.isEditMode()) {\n            annotation.viewed = true;\n            this.annotations = this.annotations.filter((d) => d.id != annotation.id);\n            this.annotations.push(annotation);\n        }\n\n        let newannotation = JSON.parse(JSON.stringify(annotation));\n        newannotation.content = JSON.stringify(dest);\n        const data = await this.render(newannotation, 'json');\n        let $html = `<div class=\"position-absolute decision text-center mx-auto w-100\">\n            <h5 class=\"pt-5 pb-3 bg-white\" id=\"decision-q\">\n            <i class=\"mb-2 bi bi-signpost-split-fill\" style=\"font-size: 2em\"></i><br>${newannotation.formattedtitle}</h5>`;\n\n        data.forEach((dest, order) => {\n            $html += `<a href=\"javascript:void(0)\" data-timestamp=\"${dest.timestamp}\"\n                 data-order=\"${order}\" class=\"decision-option btn btn-outline-secondary btn-rounded mb-2 d-flex\n                  justify-content-between align-items-center mx-auto\"><span class=\"text-truncate\">${dest.title}</span>\n                  <i class=\"bi bi-chevron-right\"></i></a>`;\n        });\n        $html += '</div>';\n        let $message = $(`<div id=\"message\" style=\"z-index:1005;display:none;\" data-id=\"${annotation.id}\">\n            <div class=\"modal-body p-0\" id=\"content\">${$html}</div></div>`);\n        $('#video-wrapper').append($message);\n        $message.fadeIn(300, 'swing', function() {\n            if (annotation.char1 == 1) {\n                $message.append(`<button class=\"btn btn-secondary btn-rounded position-absolute\"\n                     id=\"close-decision\" style=\"right: 1rem; top: 1rem;\">\n                     ${M.util.get_string('skip', 'ivplugin_decision')}\n                     <i class=\"ml-2 bi bi-chevron-right\"></i></button>`);\n            }\n            $(document).on('click', '#close-decision', function(e) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                self.player.play();\n                $('#taskinfo').fadeIn(300);\n                $('[data-region=\"chapterlists\"], #controller').removeClass('no-pointer-events');\n            });\n\n            if (!self.isEditMode()) {\n                $('#taskinfo').fadeOut(300);\n                $('[data-region=\"chapterlists\"], #controller').addClass('no-pointer-events');\n            }\n        });\n\n        $(document).on('click', `#message[data-id='${annotation.id}'] .decision-option`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            var time = Number($(this).data('timestamp'));\n            if (time < this.start) {\n                time = this.start;\n            } else if (time > this.end) {\n                time = this.end;\n            }\n            self.player.seek(time);\n            $(`#message[data-id='${annotation.id}']`).fadeOut(300);\n            self.player.play();\n            $('#taskinfo').fadeIn(300);\n            $('[data-region=\"chapterlists\"], #controller').removeClass('no-pointer-events');\n        });\n    }\n}"],"names":["Decision","Base","init","this","isEditMode","document","on","e","cantSkip","annotations","filter","d","type","char1","viewed","sort","a","b","timestamp","length","t","Number","originalEvent","detail","time","firstCantSkip","player","seek","onEditFormLoaded","form","event","self","body","super","int","setInterval","clearInterval","dest","val","append","convertSecondsToHMS","start","JSON","parse","forEach","i","title","trigger","sortable","items","cursor","update","stop","removeAttr","removeClass","first","attr","addClass","preventDefault","stopImmediatePropagation","closest","after","remove","each","find","hasClass","parts","split","seconds","push","stringify","annotation","pause","content","isSkipped","play","id","newannotation","data","render","$html","formattedtitle","order","$message","fadeIn","M","util","get_string","fadeOut","end"],"mappings":"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"}