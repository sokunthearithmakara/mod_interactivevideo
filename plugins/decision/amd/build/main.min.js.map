{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main module for the decision plugin.\n *\n * @module     ivplugin_decision/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\n\nexport default class Decision extends Base {\n    /**\n     * Initializes the decision plugin for interactive videos.\n     *\n     * This method sets up event listeners and handles the logic for decision points\n     * within the video. If the video is not in edit mode, it filters out decision\n     * annotations and prevents skipping certain decision points based on their\n     * properties.\n     *\n     * @method init\n     * @memberof DecisionPlugin\n     * @instance\n     *\n     * @example\n     * // Initialize the decision plugin\n     * decisionPlugin.init();\n     */\n    init() {\n        if (!this.isEditMode()) {\n            const decisions = this.annotations.filter((d) => d.type == 'decision');\n            const notSkip = decisions.filter((d) => d.char1 != 1);\n            if (notSkip.length == 0) {\n                return;\n            }\n            var self = this;\n            $(document).on('timeupdate', function(e) {\n                const cantSkip = decisions.filter((d) => d.char1 != 1 && !d.viewed);\n                cantSkip.sort((a, b) => a.timestamp - b.timestamp);\n                if (cantSkip.length == 0) {\n                    return;\n                }\n                const t = Number(e.originalEvent.detail.time);\n                const firstCantSkip = cantSkip[0];\n                if (t > Number(firstCantSkip.timestamp)) {\n                    self.player.seek(Number(firstCantSkip.timestamp));\n                    self.player.pause();\n                }\n            });\n        }\n\n        // We want to hide the interactions on the navigation if decision elements do not allow skipping.\n    }\n\n    /**\n     * Handles the loading of the edit form and initializes the destination list.\n     *\n     * @param {HTMLElement} form - The form element that is being edited.\n     * @param {Event} event - The event that triggered the form load.\n     * @returns {Object} An object containing the form and event.\n     */\n    onEditFormLoaded(form, event) {\n        let self = this;\n        let body = super.onEditFormLoaded(form, event);\n\n        var int = setInterval(() => {\n            if ($('[name=content').length > 0) {\n                clearInterval(int);\n                var dest = $('[name=content').val();\n                if (dest == '') {\n                    $('#destination-list').append(`<div class=\"input-group mb-1\">\n                        <div class=\"input-group-prepend\">\n                            <label class=\"input-group-text\">\n                            <i class=\"bi bi-grip-vertical fs-unset cursor-move\"></i></label>\n                        </div>\n                        <input type=\"text\" class=\"form-control\">\n                        <input type=\"text\" value=\"${this.convertSecondsToHMS(this.start)}\"\n                        placeholder=\"00:00:00\" style=\"max-width: 120px;\" class=\"form-control timestamp-input\">\n                        <div class=\"input-group-append\">\n                        <button class=\"btn add-dest btn-secondary\" type=\"button\"><i class=\"bi bi-plus-lg fs-unset\"></i></button>\n                        <button class=\"btn btn-danger delete-dest disabled\" disabled type=\"button\">\n                            <i class=\"bi bi-trash3-fill fs-unset\"></i></button></div></div>`);\n                } else {\n                    dest = JSON.parse(dest);\n                    dest.forEach((d, i) => {\n                        $('#destination-list').append(`<div class=\"input-group mb-1\">\n                            <div class=\"input-group-prepend\">\n                            <label class=\"input-group-text\">\n                            <i class=\"bi bi-grip-vertical cursor-move fs-unset\"></i></label>\n                        </div>\n                            <input type=\"text\" class=\"form-control\" value=\"${d.title}\">\n                            <input type=\"text\" value=\"${this.convertSecondsToHMS(d.timestamp)}\"\n                            placeholder=\"00:00:00\" style=\"max-width: 120px;\" class=\"form-control timestamp-input\">\n                            <div class=\"input-group-append\">\n                            <button class=\"btn add-dest btn-secondary\" type=\"button\"><i class=\"bi bi-plus-lg fs-unset\"></i></button>\n                            <button class=\"btn btn-danger delete-dest ${i == 0 ? 'disabled' : ''}\" ${i == 0 ? 'disabled' : ''}\n                            type=\"button\"><i class=\"bi bi-trash3-fill fs-unset\"></i></button></div></div>`);\n                    });\n                    $('.input-group [type=\"text\"]').trigger('input');\n                }\n\n                $('#destination-list').sortable({\n                    items: '.input-group',\n                    cursor: 'move',\n                    update: function() {\n                        $('.input-group [type=\"text\"]').trigger('input');\n                    },\n                    stop: function() {\n                        $('.input-group .delete-dest').removeAttr('disabled');\n                        $('.input-group .delete-dest').removeClass('disabled');\n                        $('.input-group .delete-dest').first().attr('disabled', true);\n                        $('.input-group .delete-dest').first().addClass('disabled');\n                    }\n                });\n            }\n        }, 100);\n\n        body.on('click', '.input-group .add-dest', function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let $thisrow = $(this);\n            let $parent = $thisrow.closest('.input-group');\n            let $row = $parent.clone();\n            $row.find('input').val('');\n            $row.find('input.timestamp-input').val(self.convertSecondsToHMS(self.start));\n            $row.find('.delete-dest').removeClass('disabled').removeAttr('disabled');\n            $parent.after($row);\n            $parent.find('[type=\"text\"]').trigger('input');\n        });\n\n        body.on('click', '.input-group .delete-dest', function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $(this).closest('.input-group').remove();\n            $('.input-group [type=\"text\"]').trigger('input');\n        });\n\n        body.on('input', '.input-group [type=\"text\"]', function() {\n            var dest = [];\n            $('#destination-list .input-group').each(function() {\n                var title = $(this).find('input[type=\"text\"]');\n                var timestamp = $(this).find('.timestamp-input');\n                if (title.val() != '' && timestamp.val() != ''\n                    && !title.hasClass('is-invalid') && !timestamp.hasClass('is-invalid')) {\n                    var parts = timestamp.val().split(':');\n                    var seconds = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n                    dest.push({\n                        title: title.val(),\n                        timestamp: seconds\n                    });\n                }\n            });\n            $('[name=content').val(JSON.stringify(dest));\n        });\n        return {form, event};\n    }\n\n    /**\n     * Run the interaction\n     * @param {object} annotation The annotation object\n     * @returns {void}\n     */\n    async runInteraction(annotation) {\n        // Dismiss all tooltips.\n        $('.tooltip').remove();\n        this.player.pause();\n        let self = this;\n        var dest = JSON.parse(annotation.content);\n        dest = dest.filter((d) => {\n            return !self.isSkipped(d.timestamp);\n        });\n\n        if (dest.length == 0) {\n            this.player.play();\n            return;\n        }\n\n        if (!self.isEditMode()) {\n            annotation.viewed = true;\n            this.annotations = this.annotations.filter((d) => d.id != annotation.id);\n            this.annotations.push(annotation);\n        }\n\n        let newannotation = JSON.parse(JSON.stringify(annotation));\n        newannotation.content = JSON.stringify(dest);\n        const data = await this.render(newannotation, 'json');\n        let $html = `<div class=\"position-absolute decision text-center mx-auto w-100\">\n            <h5 class=\"pt-5 pb-3 bg-white\" id=\"decision-q\">\n            <i class=\"mb-2 bi bi-signpost-split-fill\" style=\"font-size: 2em\"></i><br>${newannotation.formattedtitle}</h5>`;\n\n        data.forEach((dest, order) => {\n            $html += `<a href=\"javascript:void(0)\" data-timestamp=\"${dest.timestamp}\"\n                 data-order=\"${order}\" class=\"decision-option btn btn-outline-secondary btn-rounded mb-2 d-flex\n                  justify-content-between align-items-center mx-auto\"><span class=\"text-truncate\">${dest.title}</span>\n                  <i class=\"bi bi-chevron-right\"></i></a>`;\n        });\n        $html += '</div>';\n        let $message = $(`<div id=\"message\" style=\"z-index:1005;display:none;\" data-id=\"${annotation.id}\">\n            <div class=\"modal-body p-0 border\" id=\"content\">${$html}</div></div>`);\n        $('#video-wrapper').find(\"#message\").remove();\n        $('#video-wrapper').append($message);\n        $message.fadeIn(300, 'swing', function() {\n            if (annotation.char1 == 1) {\n                $message.append(`<button class=\"btn btn-secondary btn-rounded position-absolute\"\n                     id=\"close-decision\" style=\"right: 1rem; top: 1rem;\">\n                     ${M.util.get_string('skip', 'ivplugin_decision')}\n                     <i class=\"ml-2 bi bi-chevron-right\"></i></button>`);\n            }\n            $(document).on('click', '#close-decision', function(e) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                self.player.play();\n                $('#taskinfo').fadeIn(300);\n                $('[data-region=\"chapterlists\"], #controller').removeClass('no-pointer-events');\n            });\n\n            if (!self.isEditMode()) {\n                $('#taskinfo').fadeOut(300);\n                $('[data-region=\"chapterlists\"], #controller').addClass('no-pointer-events');\n            }\n        });\n\n        $(document).on('click', `#message[data-id='${annotation.id}'] .decision-option`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            var time = Number($(this).data('timestamp'));\n            if (time < this.start) {\n                time = this.start;\n            } else if (time > this.end) {\n                time = this.end;\n            }\n            self.player.seek(time);\n            $(`#message[data-id='${annotation.id}']`).fadeOut(300);\n            self.player.play();\n            $('#taskinfo').fadeIn(300);\n            $('[data-region=\"chapterlists\"], #controller').removeClass('no-pointer-events');\n        });\n    }\n}"],"names":["Decision","Base","init","this","isEditMode","decisions","annotations","filter","d","type","char1","length","self","document","on","e","cantSkip","viewed","sort","a","b","timestamp","t","Number","originalEvent","detail","time","firstCantSkip","player","seek","pause","onEditFormLoaded","form","event","body","super","int","setInterval","clearInterval","dest","val","append","convertSecondsToHMS","start","JSON","parse","forEach","i","title","trigger","sortable","items","cursor","update","stop","removeAttr","removeClass","first","attr","addClass","preventDefault","stopImmediatePropagation","$parent","closest","$row","clone","find","after","remove","each","hasClass","parts","split","seconds","push","stringify","annotation","content","isSkipped","play","id","newannotation","data","render","$html","formattedtitle","order","$message","fadeIn","M","util","get_string","fadeOut","end"],"mappings":"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"}