define("ivplugin_iframe/main",["exports","jquery","mod_interactivevideo/type/base"],(function(_exports,_jquery,_base){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Main class for the iframe plugin
   *
   * @module     ivplugin_iframe/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_base=_interopRequireDefault(_base);class Iframe extends _base.default{onEditFormLoaded(form,event){const preview=(embed,ratio)=>{(0,_jquery.default)(".preview-iframe").html(embed),(0,_jquery.default)(".preview-iframe").css("padding-bottom",ratio)};return(0,_jquery.default)(document).off("input",'[name="iframeurl"]').on("input",'[name="iframeurl"]',(function(e){if(e.preventDefault(),e.stopPropagation(),(0,_jquery.default)(".preview-iframe").html("").css("padding-bottom","0"),(0,_jquery.default)('[name="char1"], [name="content"]').val(""),""===(0,_jquery.default)('[name="iframeurl"]').val())return;const fallback=url=>{(0,_jquery.default)('[name="char1"]').val("56.25%"),(0,_jquery.default)('[name="content"]').val('<iframe src="'.concat(url,'" frameborder="0" allowfullscreen></iframe>')),preview('<iframe src="'.concat(url,'" frameborder="0" allowfullscreen></iframe>'),"56.25%")};_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/plugins/iframe/ajax.php",type:"GET",data:{action:"getproviders",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid},success:function(data){const providers=data;let url=(0,_jquery.default)('[name="iframeurl"]').val(),providerUrl=url.split("/")[2];const domain=providerUrl.split(".");providerUrl=domain.length>2?domain[1]+"."+domain[2]:domain[0]+"."+domain[1];const provider=providers.find((function(provider){return provider.provider_url.includes(providerUrl)}));if(provider){if(provider){let urlendpoint=provider.endpoints[0].url.replace("{format}","json");urlendpoint=urlendpoint.includes("?")?urlendpoint+"&url="+url:urlendpoint+"?url="+url,urlendpoint.includes("format=json")||(urlendpoint+="&format=json"),_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/plugins/iframe/ajax.php",data:{url:urlendpoint,sesskey:M.cfg.sesskey,action:"getoembedinfo",contextid:M.cfg.contextid},method:"POST",dataType:"text",success:function(res){let data;try{data=JSON.parse(res)}catch(e){return void fallback(url)}if(!data.html)return void fallback(url);let ratio="56.25%";data.width&&0!=data.width&&"100%"!=data.width?ratio=data.height/data.width*100+"%":data.height&&0!==data.height&&(ratio=data.height+"px"),(0,_jquery.default)('[name="char1"]').val(ratio),data.html=data.html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");let embed=(0,_jquery.default)(data.html);(0,_jquery.default)('[name="content"]').val(data.html),preview(embed,ratio)},error:function(){fallback(url)}})}}else fallback(url)}})})),(0,_jquery.default)(document).off("input","[name=content]").on("input","[name=content]",(function(e){e.preventDefault(),""!==(0,_jquery.default)(this).val()?preview((0,_jquery.default)(this).val(),"100%"):(0,_jquery.default)(".preview-iframe").html("").css("padding-bottom","0")})),{form:form,event:event}}renderContainer(annotation){(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).addClass("hasiframe"),super.renderContainer(annotation)}postContentRender(annotation){const checkIframe=()=>{(0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] iframe")).length>0?setTimeout((()=>{(0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] iframe")).css("background","none")}),1e3):requestAnimationFrame(checkIframe)};requestAnimationFrame(checkIframe)}async displayReportView(annotation){const data=await this.render(annotation,"html");let $message=(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']"));$message.addClass("hasiframe"),$message.find(".modal-body").html(data),$message.find(".modal-body").attr("id","content"),this.postContentRender(annotation)}}return _exports.default=Iframe,_exports.default}));

//# sourceMappingURL=main.min.js.map