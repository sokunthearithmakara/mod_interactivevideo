{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main class for the iframe plugin\n *\n * @module     ivplugin_iframe/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\nexport default class Iframe extends Base {\n    /**\n     * Called when the edit form is loaded.\n     * @param {Object} form The form object\n     * @param {Event} event The event object\n     * @return {void}\n     */\n    onEditFormLoaded(form, event) {\n        const preview = (embed, ratio) => {\n            $('.preview-iframe').html(embed);\n            $('.preview-iframe').css('padding-bottom', ratio);\n        };\n        $(document).on('input', '[name=\"iframeurl\"]', function(e) {\n            e.preventDefault();\n            e.stopPropagation();\n            $('.preview-iframe').html('').css('padding-bottom', '0');\n            $('[name=\"char1\"], [name=\"content\"]').val('');\n            if ($('[name=\"iframeurl\"]').val() === '') {\n                return;\n            }\n            const fallback = (url) => {\n                $('[name=\"char1\"]').val('56.25%');\n                $('[name=\"content\"]').val(`<iframe src=\"${url}\" frameborder=\"0\" allowfullscreen></iframe>`);\n                preview(`<iframe src=\"${url}\" frameborder=\"0\" allowfullscreen></iframe>`, '56.25%');\n            };\n            $.ajax({\n                url: M.cfg.wwwroot + '/mod/interactivevideo/plugins/iframe/ajax.php',\n                type: 'GET',\n                data: {\n                    action: 'getproviders',\n                    sesskey: M.cfg.sesskey,\n                },\n                success: function(data) {\n                    var providers = data;\n                    var url = $('[name=\"iframeurl\"]').val();\n                    // Format the url to match the provider_url\n                    var providerUrl = url.split('/')[2];\n                    var domain = providerUrl.split('.');\n                    if (domain.length > 2) {\n                        providerUrl = domain[1] + '.' + domain[2];\n                    } else {\n                        providerUrl = domain[0] + '.' + domain[1];\n                    }\n                    var provider = providers.find(function(provider) {\n                        return provider.provider_url.includes(providerUrl);\n                    });\n                    if (!provider) {\n                        fallback(url);\n                        return;\n                    }\n                    if (provider) {\n                        // Reformat the url to match the endpoints scheme\n                        var urlendpoint = provider.endpoints[0].url.replace('{format}', 'json');\n                        if (urlendpoint.includes('?')) {\n                            urlendpoint = urlendpoint + '&url=' + url;\n                        } else {\n                            urlendpoint = urlendpoint + '?url=' + url;\n                        }\n                        if (!urlendpoint.includes('format=json')) {\n                            urlendpoint = urlendpoint + '&format=json';\n                        }\n                        $.ajax({\n                            url: M.cfg.wwwroot + '/mod/interactivevideo/plugins/iframe/ajax.php',\n                            data: {\n                                url: urlendpoint,\n                                sesskey: M.cfg.sesskey,\n                                action: 'getoembedinfo',\n                            },\n                            method: \"POST\",\n                            dataType: \"text\",\n                            success: function(res) {\n                                var data;\n                                try {\n                                    data = JSON.parse(res);\n                                } catch (e) {\n                                    fallback(url);\n                                    return;\n                                }\n\n                                if (!data.html) {\n                                    fallback(url);\n                                    return;\n                                }\n\n                                var ratio = '56.25%';\n\n                                if (!data.width || data.width == 0 || data.width == '100%') {\n                                    if (data.height && data.height !== 0) {\n                                        ratio = data.height + 'px';\n                                    }\n                                } else {\n                                    ratio = (data.height / data.width * 100) + '%';\n                                }\n\n                                $('[name=\"char1\"]').val(ratio);\n                                // Remove any script tags from the html to avoid errors with requirejs from data.html using regex\n                                data.html = data.html.replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '');\n                                var embed = $(data.html);\n                                $('[name=\"content\"]').val(data.html);\n                                preview(embed, ratio);\n                            },\n                            error: function() {\n                                fallback(url);\n                            }\n                        });\n                    }\n                }\n            });\n        });\n\n        $(document).on('input', '[name=content]', function(e) {\n            e.preventDefault();\n            if ($(this).val() === '') {\n                $('.preview-iframe').html('').css('padding-bottom', '0');\n                return;\n            }\n            preview($(this).val(), '100%');\n        });\n        return {form, event};\n    }\n\n    /**\n     * Override the renderContainer method\n     * @param {Object} annotation The annotation object\n     * @return {void}\n     */\n    renderContainer(annotation) {\n        $(`#message[data-id='${annotation.id}']`).addClass('hasiframe');\n        super.renderContainer(annotation);\n    }\n\n    /**\n     * Override the postContentRender method\n     * @param {Object} annotation The annotation object\n     * @return {void}\n     */\n    postContentRender(annotation) {\n        var interval = setInterval(() => {\n            if ($(`#message[data-id='${annotation.id}'] iframe`).length > 0) {\n                clearInterval(interval);\n                // Remove the loading background because some iframe has transparent content\n                setTimeout(() => {\n                    $(`#message[data-id='${annotation.id}'] iframe`).css('background', 'none');\n                }, 1000);\n            }\n        }, 1000);\n    }\n\n    /**\n     * Override the displayReportView method\n     * @param {Object} annotation The annotation object\n     * @return {void}\n     */\n    async displayReportView(annotation) {\n        const data = await this.render(annotation, 'html');\n        let $message = $(`#message[data-id='${annotation.id}']`);\n        $message.addClass('hasiframe');\n        $message.find(`.modal-body`).html(data);\n        $message.find(`.modal-body`).attr('id', 'content');\n        this.postContentRender(annotation);\n    }\n}"],"names":["Iframe","Base","onEditFormLoaded","form","event","preview","embed","ratio","html","css","document","on","e","preventDefault","stopPropagation","val","fallback","url","ajax","M","cfg","wwwroot","type","data","action","sesskey","success","providers","providerUrl","split","domain","length","provider","find","provider_url","includes","urlendpoint","endpoints","replace","method","dataType","res","JSON","parse","width","height","error","this","renderContainer","annotation","id","addClass","postContentRender","interval","setInterval","clearInterval","setTimeout","render","$message","attr"],"mappings":";;;;;;;uKAwBqBA,eAAeC,cAOhCC,iBAAiBC,KAAMC,aACbC,QAAU,CAACC,MAAOC,6BAClB,mBAAmBC,KAAKF,2BACxB,mBAAmBG,IAAI,iBAAkBF,kCAE7CG,UAAUC,GAAG,QAAS,sBAAsB,SAASC,MACnDA,EAAEC,iBACFD,EAAEE,sCACA,mBAAmBN,KAAK,IAAIC,IAAI,iBAAkB,yBAClD,oCAAoCM,IAAI,IACJ,MAAlC,mBAAE,sBAAsBA,mBAGtBC,SAAYC,0BACZ,kBAAkBF,IAAI,8BACtB,oBAAoBA,2BAAoBE,oDAC1CZ,+BAAwBY,mDAAkD,2BAE5EC,KAAK,CACHD,IAAKE,EAAEC,IAAIC,QAAU,gDACrBC,KAAM,MACNC,KAAM,CACFC,OAAQ,eACRC,QAASN,EAAEC,IAAIK,SAEnBC,QAAS,SAASH,UACVI,UAAYJ,KACZN,KAAM,mBAAE,sBAAsBF,MAE9Ba,YAAcX,IAAIY,MAAM,KAAK,GAC7BC,OAASF,YAAYC,MAAM,KAE3BD,YADAE,OAAOC,OAAS,EACFD,OAAO,GAAK,IAAMA,OAAO,GAEzBA,OAAO,GAAK,IAAMA,OAAO,OAEvCE,SAAWL,UAAUM,MAAK,SAASD,iBAC5BA,SAASE,aAAaC,SAASP,mBAErCI,aAIDA,SAAU,KAENI,YAAcJ,SAASK,UAAU,GAAGpB,IAAIqB,QAAQ,WAAY,SAE5DF,YADAA,YAAYD,SAAS,KACPC,YAAc,QAAUnB,IAExBmB,YAAc,QAAUnB,KAEzBkB,SAAS,iBACtBC,aAA4B,gCAE9BlB,KAAK,CACHD,IAAKE,EAAEC,IAAIC,QAAU,gDACrBE,KAAM,CACFN,IAAKmB,YACLX,QAASN,EAAEC,IAAIK,QACfD,OAAQ,iBAEZe,OAAQ,OACRC,SAAU,OACVd,QAAS,SAASe,SACVlB,SAEAA,KAAOmB,KAAKC,MAAMF,KACpB,MAAO7B,eACLI,SAASC,QAIRM,KAAKf,UAKND,MAAQ,SAEPgB,KAAKqB,OAAuB,GAAdrB,KAAKqB,OAA4B,QAAdrB,KAAKqB,MAKvCrC,MAASgB,KAAKsB,OAAStB,KAAKqB,MAAQ,IAAO,IAJvCrB,KAAKsB,QAA0B,IAAhBtB,KAAKsB,SACpBtC,MAAQgB,KAAKsB,OAAS,0BAM5B,kBAAkB9B,IAAIR,OAExBgB,KAAKf,KAAOe,KAAKf,KAAK8B,QAAQ,sDAAuD,QACjFhC,OAAQ,mBAAEiB,KAAKf,0BACjB,oBAAoBO,IAAIQ,KAAKf,MAC/BH,QAAQC,MAAOC,YAnBXS,SAASC,MAqBjB6B,MAAO,WACH9B,SAASC,cAvDjBD,SAASC,+BA+DvBP,UAAUC,GAAG,QAAS,kBAAkB,SAASC,GAC/CA,EAAEC,iBACoB,MAAlB,mBAAEkC,MAAMhC,MAIZV,SAAQ,mBAAE0C,MAAMhC,MAAO,4BAHjB,mBAAmBP,KAAK,IAAIC,IAAI,iBAAkB,QAKrD,CAACN,KAAAA,KAAMC,MAAAA,OAQlB4C,gBAAgBC,4DACWA,WAAWC,UAAQC,SAAS,mBAC7CH,gBAAgBC,YAQ1BG,kBAAkBH,gBACVI,SAAWC,aAAY,MACnB,+CAAuBL,WAAWC,iBAAenB,OAAS,IAC1DwB,cAAcF,UAEdG,YAAW,qDACgBP,WAAWC,iBAAezC,IAAI,aAAc,UACpE,QAER,6BAQiBwC,kBACd1B,WAAawB,KAAKU,OAAOR,WAAY,YACvCS,UAAW,+CAAuBT,WAAWC,UACjDQ,SAASP,SAAS,aAClBO,SAASzB,oBAAoBzB,KAAKe,MAClCmC,SAASzB,oBAAoB0B,KAAK,KAAM,gBACnCP,kBAAkBH"}