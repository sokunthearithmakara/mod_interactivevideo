{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main class for skip segment\n *\n * @module     ivplugin_skipsegment/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\nimport {dispatchEvent} from 'core/event_dispatcher';\nimport Ajax from 'core/ajax';\nexport default class SkipSegment extends Base {\n    init() {\n        if (!this.isEditMode()) {\n            var self = this;\n            var skipsegment = this.annotations.filter((annotation) => annotation.type == 'skipsegment');\n            $(document).on('timeupdate', function(e) {\n                var t = e.originalEvent.detail.time;\n                skipsegment.forEach((annotation) => {\n                    if (annotation.timestamp < t && annotation.title > t) {\n                        self.runInteraction(annotation);\n                    }\n                });\n            });\n        }\n    }\n    renderEditItem(annotations, listItem, item) {\n        listItem = super.renderEditItem(annotations, listItem, item);\n        listItem.find('[data-editable]').removeAttr('data-editable');\n        listItem.find('.btn.copy').remove();\n        listItem.find('.title').replaceWith(`<span class=\"skipend timestamp\n            bg-light px-2 py-1 rounded-sm text-truncate\"\n            data-timestamp=\"${item.title}\">${this.convertSecondsToHMS(item.title, this.totaltime < 3600, true)}</span>`);\n        if (this.isSkipped(item.timestamp)) {\n            listItem.find('.skipend').after(`<span class=\"badge badge-warning ml-2\">\n                            ${M.util.get_string('skipped', 'ivplugin_skipsegment')}</span>`);\n        }\n        return listItem;\n    }\n\n    async addAnnotation(annotations, timestamp, coursemodule) {\n        let self = this;\n        let data = {\n            title: timestamp + 5 > this.end ? this.end : timestamp + 5,\n            timestamp: timestamp,\n            contextid: M.cfg.contextid,\n            type: self.prop.name,\n            courseid: self.course,\n            cmid: coursemodule,\n            annotationid: self.interaction,\n            hascompletion: self.prop.hascompletion ? 1 : 0,\n            advanced: JSON.stringify({\n                \"visiblebeforecompleted\": \"1\",\n                \"visibleaftercompleted\": null,\n                \"clickablebeforecompleted\": \"1\",\n                \"clickableaftercompleted\": null,\n                \"replaybehavior\": \"1\",\n            }),\n        };\n        let ajax = await Ajax.call([{\n            methodname: 'ivplugin_skipsegment_add_skip',\n            args: {\n                skipdata: JSON.stringify(data),\n            },\n            contextid: M.cfg.contextid,\n        }])[0];\n\n        let newAnnotation = JSON.parse(ajax.data);\n        dispatchEvent('annotationupdated', {\n            annotation: newAnnotation,\n            action: 'add'\n        });\n\n        $('#contentmodal').modal('hide');\n\n    }\n\n    onEditFormLoaded(form, event) {\n        var self = this;\n        var body = super.onEditFormLoaded(form, event);\n        body.on('change', '[name=titleassist]', function(e) {\n            e.preventDefault();\n            const originalValue = $(this).data('initial-value');\n            // Make sure the timestamp format is hh:mm:ss\n            if (!self.validateTimestampFormat($(this).val())) {\n                self.addNotification(M.util.get_string('invalidtimestampformat', 'ivplugin_skipsegment'));\n                $(this).val(originalValue);\n                return;\n            }\n\n            // Convert the timestamp to seconds\n            var parts = $(this).val().split(':');\n            var timestamp = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n            if (!self.isBetweenStartAndEnd(timestamp)) {\n                var message = M.util.get_string('interactioncanonlybeaddedbetweenstartandendtime', 'mod_interactivevideo', {\n                    \"start\": self.convertSecondsToHMS(self.start),\n                    \"end\": self.convertSecondsToHMS(self.end),\n                });\n                self.addNotification(message);\n                $(this).val(originalValue);\n                return;\n            }\n\n            // Make sure the title assist is not the same as the timestamp assist or less than the timestamp assist\n            if (timestamp <= Number($('[name=timestamp]').val())) {\n                self.addNotification(M.util.get_string('segmentendmustbegreaterthantimestamp', 'mod_interactivevideo'));\n                $(this).val(originalValue);\n                return;\n            }\n\n            $('[name=title]').val(timestamp);\n        });\n        return {form, event};\n    }\n\n    renderItemOnVideoNavigation(annotation) {\n        if (annotation.timestamp < this.start || annotation.timestamp > this.end) {\n            return;\n        }\n        var percentage = ((Number(annotation.timestamp) - this.start) / this.totaltime) * 100;\n        var length = (Number(annotation.title) - Number(annotation.timestamp)) / this.totaltime * 100;\n        if (this.isVisible(annotation) && !this.isEditMode()) {\n            $(\"#video-nav ul\").append(`<li class=\"annotation ${annotation.type}\n             ${this.isClickable(annotation) ? '' : 'no-pointer-events'} position-absolute bg-dark progress-bar-striped progress-bar\"\n              data-timestamp=\"${annotation.timestamp}\" data-id=\"${annotation.id}\"\n               style=\"left: ${percentage}%; width: ${length}%;\" data-toggle=\"tooltip\"\n               data-container=\"#wrapper\" data-trigger=\"hover\"\n         data-html=\"true\" data-original-title='<i class=\"${this.prop.icon}\"></i>'></li>`);\n        }\n        if (this.isEditMode()) {\n            $(\"#video-timeline-wrapper\").append(`<div class=\"position-absolute skipsegment cursor-pointer\"\n                 data-timestamp=\"${annotation.timestamp}\" data-id=\"${annotation.id}\"\n                 style=\"height: 100%; left: ${percentage}%; width: ${length}%;background: rgba(0,0,0,0.75);\">\n                 <div class=\"position-absolute w-100 text-center px-1 delete-skipsegment\">\n                 <i class=\"bi bi-trash3 text-muted fs-unset\"></i></div></div>`);\n        }\n    }\n    async runInteraction(annotation) {\n        $('.video-block').append(`<div id=\"skipsegment\" class=\"text-white position-absolute p-3 hide\"\n         style=\"bottom: 0;right: 0;text-shadow: 1px 2px 3px gray;line-height: 1rem;\">\n         <i class=\"${this.prop.icon}\" style=\"font-size: xxx-large;\"></i></div>`);\n        $('#skipsegment').fadeIn(300);\n        await this.player.seek(Number(annotation.title));\n        var percentage = (Number(annotation.title) - this.start) / this.totaltime * 100;\n        $('#video-nav #progress').replaceWith(`<div id=\"progress\"\n         style=\"width: ${percentage > 100 ? 100 : percentage}%;\"></div>`);\n        this.player.play();\n        setTimeout(() => {\n            $('#skipsegment').fadeOut(300);\n            setTimeout(() => {\n                $('#skipsegment').remove();\n            }, 300);\n        }, 1000);\n\n    }\n}"],"names":["SkipSegment","Base","init","this","isEditMode","self","skipsegment","annotations","filter","annotation","type","document","on","e","t","originalEvent","detail","time","forEach","timestamp","title","runInteraction","renderEditItem","listItem","item","super","find","removeAttr","remove","replaceWith","convertSecondsToHMS","totaltime","isSkipped","after","M","util","get_string","coursemodule","data","end","contextid","cfg","prop","name","courseid","course","cmid","annotationid","interaction","hascompletion","advanced","JSON","stringify","ajax","Ajax","call","methodname","args","skipdata","newAnnotation","parse","action","modal","onEditFormLoaded","form","event","preventDefault","originalValue","validateTimestampFormat","val","addNotification","parts","split","Number","isBetweenStartAndEnd","message","start","renderItemOnVideoNavigation","percentage","length","isVisible","append","isClickable","id","icon","fadeIn","player","seek","play","setTimeout","fadeOut"],"mappings":"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"}