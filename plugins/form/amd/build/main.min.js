define("ivplugin_form/main",["exports","jquery","mod_interactivevideo/type/base","core/event_dispatcher","mod_interactivevideo/libraries/jquery-ui","core/templates","core_form/dynamicform","mod_interactivevideo/report","core_filters/events"],(function(_exports,_jquery,_base,_event_dispatcher,_jqueryUi,_templates,_dynamicform,_report,_events){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Main class for the form plugin.
   *
   * @module     ivplugin_form/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_base=_interopRequireDefault(_base),_templates=_interopRequireDefault(_templates),_dynamicform=_interopRequireDefault(_dynamicform);class Form extends _base.default{postEditCallback(){}async renderViewer(annotation){let self=this;if(this.isEditMode()){let formfields=[{icon:"bi bi-alphabet-uppercase",type:"header",label:M.util.get_string("headerfield","ivplugin_form")},{icon:"bi bi-text-paragraph",type:"html",label:M.util.get_string("htmlfield","ivplugin_form")},{icon:"bi bi-hr",type:"linebreak",label:M.util.get_string("linebreakfield","ivplugin_form")},{icon:"bi bi-input-cursor-text",type:"text",label:M.util.get_string("textfield","ivplugin_form")},{icon:"bi bi-textarea-resize",type:"textarea",label:M.util.get_string("textareafield","ivplugin_form")},{icon:"bi bi-card-text",type:"editor",label:M.util.get_string("editorfield","ivplugin_form")},{icon:"bi bi-menu-button-wide",type:"select",label:M.util.get_string("selectfield","ivplugin_form")},{icon:"bi bi-check2-square",type:"advcheckbox",label:M.util.get_string("advcheckboxfield","ivplugin_form")},{icon:"bi bi-record-circle",type:"radio",label:M.util.get_string("radiofield","ivplugin_form")},{icon:"bi bi-calendar",type:"date_selector",label:M.util.get_string("dateselectorfield","ivplugin_form")},{icon:"bi bi-stopwatch",type:"duration",label:M.util.get_string("durationfield","ivplugin_form")},{icon:"bi bi-file-earmark-arrow-up",type:"filemanager",label:M.util.get_string("filemanagerfield","ivplugin_form")}];const dataForTemplate={id:annotation.id,items:formfields},template=await _templates.default.render("ivplugin_form/formedit_modal",dataForTemplate);(0,_jquery.default)(template).appendTo("body"),(0,_jquery.default)("#form-modal").modal("show"),(0,_jquery.default)("#form-modal").on("hidden.bs.modal",(function(){(0,_jquery.default)(this).remove()})),(0,_jquery.default)("#form-modal").on("shown.bs.modal",(async function(){const content=await self.render(annotation,"json");self.postContentRender(annotation,formfields,content)}))}else{await super.renderViewer(annotation);const content=await self.render(annotation,"json");(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#content").append('<div id="formmeta" class="mb-3 d-flex"></div><div id="form-preview"></div>'),this.postContentRender(annotation,"",content)}}postContentRender(annotation,formfields,content){let reportpage=arguments.length>3&&void 0!==arguments[3]&&arguments[3],self=this;0!=annotation.text1&&(0,_jquery.default)(`#message[data-id='${annotation.id}'] #formmeta`).append(`<div class="duedate">${M.util.get_string("duedate","ivplugin_form")}: ${content.duedate}</div>`);const fetchData=()=>new Promise(((resolve,reject)=>{_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_log",sesskey:M.cfg.sesskey,userid:this.userid,cm:annotation.annotationid,annotationid:annotation.id,contextid:M.cfg.contextid,cmid:self.cmid,token:self.token},success:function(data){let log=JSON.parse(data);resolve(log)},error:function(error){reject(error)}})}));let formjson=[];const renderList=data=>{(0,_jquery.default)("#form-field-list").empty(),data&&data.forEach((item=>{let icon=formfields.find((field=>field.type===item.type)).icon;(0,_jquery.default)("#form-field-list").append(`<li class="list-group-item d-flex align-items-start justify-content-between p-0"\n                         data-id="${item.id}" data-properties='${JSON.stringify(item)}' data-type="${item.type}">\n                                    <div class="d-flex align-items-start pt-1">\n                                    <i class="bi bi-grip-vertical px-2 cursor-move"></i>\n                                    <i class="${icon} mr-2"></i>\n                                    <div class="d-inline-block field-label">${item.formattedlabel}</div></div>\n                                    <div class="ml-auto d-flex">\n                                        <button class="btn btn-sm rounded-0"\n                                         id="edit" title="${M.util.get_string("edit","mod_interactivevideo")}">\n                                         <i class="bi bi-pencil-square"></i></button>\n                                        <button class="btn btn-sm rounded-0"\n                                         id="copy" title="${M.util.get_string("clone","mod_interactivevideo")}">\n                                         <i class="bi bi-copy"></i></button>\n                                        <button class="btn btn-sm rounded-0 text-danger"\n                                         id="delete" title="${M.util.get_string("delete","mod_interactivevideo")}">\n                                         <i class="bi bi-trash3"></i></button>\n                                        </div>\n                                </li>`)}))};let previewform;const previewForm=function(data){let id=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#form-preview").empty();const selector=document.querySelector(`#message[data-id='${annotation.id}'] #form-preview`);if(previewform=new _dynamicform.default(selector,"ivplugin_form\\submitform_form"),null!==data&&0!=data.length){if((0,_jquery.default)("#form-preview").addClass("loader"),formdata.formjson=JSON.stringify(data),previewform.load(formdata),id){let interval=setInterval((()=>{let element=document.querySelector("#form-preview form");if(element){clearInterval(interval),(0,_jquery.default)(`#form-preview #fitem_field-${id},\n                             #form-preview fieldset[id^=id_field-${id}],\n                             #form-preview div#field-${id}, #form-preview [data-groupname=field-${id}],\n                             #form-preview [id^=fitem_id_field-${id}]`).addClass("field-highlight"),element.querySelector("#form-preview .field-highlight").scrollIntoView({behavior:"smooth",block:"center"})}}),100)}}else(0,_jquery.default)("#form-preview").removeClass("loader")};content&&""!=content.fields&&null!==content.fields&&(formjson=content.fields);let formdata={};if(reportpage)return formdata={id:annotation.id,contextid:M.cfg.contextid,type:"form",courseid:M.cfg.courseId,annotationid:0,editing:0,formjson:JSON.stringify(formjson)},void previewForm(formjson);if(formdata={id:annotation.id,contextid:M.cfg.contextid,type:self.prop.name,courseid:self.course,annotationid:self.interaction,editing:self.isEditMode()?1:0,formjson:JSON.stringify(formjson)},this.isEditMode()&&renderList(formjson),this.isEditMode()?previewForm(formjson):annotation.completed?fetchData().then((log=>{if(log){const submission=JSON.parse(log.text1),newformjson=formjson.map((item=>(item.value=submission["field-"+item.id],item.default=submission["field-"+item.id],item)));formdata.reviewing=1,formdata.submissionid=submission.id,previewForm(newformjson),1==annotation.char2&&(0==annotation.text1||annotation.text1>(new Date).getTime()/1e3)&&(0,_jquery.default)("#formmeta").append(`<button class="btn btn-primary ml-auto btn-sm" id="editsubmission">\n                                    <i class="bi bi bi-pencil-square mr-2"></i>${M.util.get_string("edit","mod_interactivevideo")}\n                                    </button>`)}else(0==annotation.text1||annotation.text1>(new Date).getTime()/1e3)&&previewForm(formjson)})).catch((()=>{})):0==annotation.text1||annotation.text1>(new Date).getTime()/1e3?previewForm(formjson):(0,_jquery.default)("#formmeta").replaceWith(`<div class="alert alert-warning">\n                        ${M.util.get_string("formnolongeravailable","ivplugin_form")}</div>`),this.isEditMode()){const getFormJson=()=>{formjson=(0,_jquery.default)("#form-field-list").find("li").map((function(){return JSON.parse((0,_jquery.default)(this).attr("data-properties"))})).get()};(0,_jquery.default)("#form-field-list").sortable({handle:".bi-grip-vertical",placeholder:"ui-state-highlight",stop:function(){getFormJson(),renderList(formjson),previewForm(formjson)}}),(0,_jquery.default)(document).on("click","button.add-field",(function(e){e.preventDefault(),e.stopImmediatePropagation();let type=(0,_jquery.default)(this).data("type"),typeString=M.util.get_string(type+"field","ivplugin_form"),newfieldmodal=`<div class="modal fade" id="newfield-modal" aria-labelledby="newfield-modal"\n                 aria-hidden="true" style="background: rgba(0,0,0,0.5);">\n                    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title">${M.util.get_string("addformfield","ivplugin_form",typeString.toLowerCase())}</h5>\n                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>\n                            <div class="modal-body loader">\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-secondary" data-dismiss="modal">${M.util.get_string("close","mod_interactivevideo")}</button>\n                                <button type="button" class="btn btn-primary" id="newfield-submit">${M.util.get_string("save","mod_interactivevideo")}</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>`;(0,_jquery.default)("body").append(newfieldmodal),(0,_jquery.default)("#newfield-modal").modal("show"),(0,_jquery.default)("#newfield-modal").on("hidden.bs.modal",(function(){(0,_jquery.default)(this).remove(),(0,_jquery.default)("body").addClass("modal-open")})),(0,_jquery.default)("#newfield-modal").on("shown.bs.modal",(function(){let formfieldform=new _dynamicform.default(document.querySelector("#newfield-modal .modal-body"),"ivplugin_form\\form_fields\\"+type),fields=[];null!==formjson&&(fields=formjson.map((item=>({id:item.id,label:item.label,type:item.type})))),formfieldform.load({contextid:M.cfg.contextid,type:type,annotationid:annotation.id,fields:JSON.stringify(fields)}),document.querySelector("#newfield-submit").addEventListener("click",(e=>{e.preventDefault();formfieldform.trigger(formfieldform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||formfieldform.submitFormAjax()})),formfieldform.addEventListener(formfieldform.events.FORM_SUBMITTED,(e=>{e.preventDefault();const response=e.detail;formjson.push(response),renderList(formjson),previewForm(formjson,response.id),(0,_jquery.default)("#newfield-modal").modal("hide")})),self.setModalDraggable("#newfield-modal .modal-dialog")}))})),(0,_jquery.default)(document).on("click","#form-field-list button#edit",(function(e){e.preventDefault(),e.stopImmediatePropagation();let type=(0,_jquery.default)(this).closest("li").attr("data-type"),formfielddata=JSON.parse((0,_jquery.default)(this).closest("li").attr("data-properties")),fields=formjson.map((item=>({id:item.id,label:item.label,type:item.type})));formfielddata.fields=JSON.stringify(fields);let typeString=M.util.get_string(type+"field","ivplugin_form"),editform=`<div class="modal fade" id="editfield-modal"\n                 aria-labelledby="editfield-modal" aria-hidden="true" style="background: rgba(0,0,0,0.5);">\n                    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title">${M.util.get_string("editformfield","ivplugin_form",typeString.toLowerCase())}</h5>\n                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>\n                            <div class="modal-body loader">\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-secondary" data-dismiss="modal">${M.util.get_string("close","mod_interactivevideo")}</button>\n                                <button type="button" class="btn btn-primary" id="editfield-submit">${M.util.get_string("save","mod_interactivevideo")}</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>`;(0,_jquery.default)("body").append(editform),(0,_jquery.default)("#editfield-modal").modal("show"),(0,_jquery.default)("#editfield-modal").on("hidden.bs.modal",(function(){(0,_jquery.default)(this).remove(),(0,_jquery.default)("body").addClass("modal-open")})),(0,_jquery.default)("#editfield-modal").on("shown.bs.modal",(function(){let formfieldform=new _dynamicform.default(document.querySelector("#editfield-modal .modal-body"),"ivplugin_form\\form_fields\\"+type);formfieldform.load(formfielddata),document.querySelector("#editfield-submit").addEventListener("click",(e=>{e.preventDefault();formfieldform.trigger(formfieldform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||formfieldform.submitFormAjax()})),formfieldform.addEventListener(formfieldform.events.FORM_SUBMITTED,(e=>{e.preventDefault();const response=e.detail,index=formjson.findIndex((item=>item.id==response.id));-1!==index&&(formjson[index]=response),renderList(formjson),previewForm(formjson,response.id),(0,_jquery.default)("#editfield-modal").modal("hide")})),self.setModalDraggable("#editfield-modal .modal-dialog")}))})),(0,_jquery.default)(document).on("click","#form-field-list button#copy",(function(e){e.preventDefault(),e.stopImmediatePropagation();let formfielddata=JSON.parse((0,_jquery.default)(this).closest("li").attr("data-properties"));const index=formjson.findIndex((item=>item.id==formfielddata.id));-1!==index&&(formfielddata.id=Math.floor((new Date).getTime()/1e3),formjson.splice(index+1,0,formfielddata)),renderList(formjson),previewForm(formjson,formfielddata.id)})),(0,_jquery.default)(document).on("click","#form-field-list button#delete",(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).closest("li").attr("data-id");formjson=formjson.filter((item=>item.id!=id)),renderList(formjson),previewForm(formjson)})),(0,_jquery.default)(document).on("click","button#save",(function(e){e.preventDefault(),e.stopImmediatePropagation(),getFormJson();let json=formjson.map((item=>(delete item.annotationid,delete item.contextid,delete item.formattedlabel,item))),cleanItems=JSON.stringify(json).replace(/</g,"&lt;").replace(/>/g,"&gt;");_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quickeditfield",sesskey:M.cfg.sesskey,id:annotation.id,field:"content",contextid:M.cfg.contextid,draftitemid:0,value:cleanItems,cmid:self.cmid,token:self.token},success:function(data){let updated=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"edit"})}})})),(0,_jquery.default)(document).on("click","#form-field-list li .field-label",(function(){let id=(0,_jquery.default)(this).closest("li").attr("data-id");(0,_jquery.default)(`#form-preview #fitem_field-${id}, #form-preview fieldset[id^=id_field-${id}],\n                     #form-preview div#field-${id}, #form-preview [data-groupname=field-${id}],\n                      #form-preview [id^=fitem_id_field-${id}]`).addClass("field-highlight");let $collapsible=(0,_jquery.default)(".field-highlight").closest("fieldset.collapsible");$collapsible&&$collapsible.find('[data-toggle="collapse"]').hasClass("collapsed")&&$collapsible.find('[data-toggle="collapse"]').trigger("click"),document.querySelector("#form-preview .field-highlight").scrollIntoView({behavior:"smooth",block:"center"})})),(0,_jquery.default)(document).on("mouseover","#form-field-list li",(function(){(0,_jquery.default)("#form-preview .field-highlight").removeClass("field-highlight");const id=(0,_jquery.default)(this).attr("data-id");(0,_jquery.default)(`#form-preview #fitem_field-${id}, #form-preview fieldset[id^=id_field-${id}],\n                     #form-preview div#field-${id}, #form-preview [data-groupname=field-${id}],\n                      #form-preview [id^=fitem_id_field-${id}]`).addClass("field-highlight")})),(0,_jquery.default)(document).on("mouseout","#form-field-list li",(function(){(0,_jquery.default)("#form-preview .field-highlight").removeClass("field-highlight")})),(0,_jquery.default)(document).on("mouseover","#form-preview .fitem",(function(){(0,_jquery.default)("#form-field-list li").removeClass("field-highlight");let id,group=(0,_jquery.default)(this).attr("data-groupname");if(group)id=group.replace("field-","");else try{id=(0,_jquery.default)(this).attr("id").match(/\d{10}/)[0]}catch(e){id=(0,_jquery.default)(this).closest("[data-groupname]").attr("data-groupname").replace("field-","")}(0,_jquery.default)(`#form-field-list li[data-id=${id}]`).addClass("field-highlight")})),(0,_jquery.default)(document).on("mouseout","#form-preview .fitem",(function(){(0,_jquery.default)("#form-field-list li").removeClass("field-highlight")})),(0,_jquery.default)(document).on("click","#form-preview i#edit",(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).data("id");(0,_jquery.default)(`#form-field-list li[data-id=${id}] button#edit`).trigger("click")})),(0,_jquery.default)(document).on("click","#form-preview i#delete",(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).data("id");(0,_jquery.default)(`#form-field-list li[data-id=${id}] button#delete`).trigger("click")})),(0,_jquery.default)(document).on("click","#form-preview i#copy",(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).data("id");(0,_jquery.default)(`#form-field-list li[data-id=${id}] button#copy`).trigger("click")}))}else{if(annotation.completiontracking&&"manual"!=annotation.completiontracking){let $message=(0,_jquery.default)(`#message[data-id='${annotation.id}']`);$message.find("#completiontoggle").prop("disabled",!0),1==annotation.completed?$message.find("#completiontoggle span").text(`${M.util.get_string("completioncompleted","mod_interactivevideo")}`):$message.find("#completiontoggle span").text(`${M.util.get_string("completionincomplete","mod_interactivevideo")}`)}(0,_jquery.default)(document).on("click",`#message[data-id='${annotation.id}'] #submitform-submit`,(async e=>{e.preventDefault(),e.stopImmediatePropagation();previewform.trigger(previewform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||previewform.submitFormAjax(),previewform.addEventListener(previewform.events.FORM_SUBMITTED,(()=>{self.toggleCompletion(annotation.id,"mark-done","automatic"),formdata.reviewing=1,1==annotation.char2&&(0==annotation.text1||annotation.text1>(new Date).getTime()/1e3)&&(0,_jquery.default)("#editsubmission").show(),previewForm(formjson)}))})),(0,_jquery.default)(document).on("click",`#message[data-id='${annotation.id}'] #editsubmission`,(e=>{e.preventDefault(),e.stopImmediatePropagation(),formdata.reviewing=0,(0,_jquery.default)("#editsubmission").hide(),previewForm(formjson)})),(0,_jquery.default)(document).on("click",`#message[data-id='${annotation.id}'] #cancel-submit`,(e=>{e.preventDefault(),e.stopImmediatePropagation(),formdata.reviewing=1,(0,_jquery.default)("#editsubmission").show(),previewForm(formjson)}))}}completionCallback(annotations,thisItem,action,type){let msg="formupdated";thisItem.completed||(msg="formsubmitted"),super.completionCallback(annotations,thisItem,action,type),"automatic"==type&&this.addNotification(M.util.get_string(msg,"ivplugin_form"),"success")}renderForm(annotation,f,response,node){let self=this;let formdata={id:annotation.id,contextid:M.cfg.contextid,type:"form",courseid:M.cfg.courseId,annotationid:0,editing:0};const render=ff=>{(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find(`${node} #form-preview`).addClass("loader").empty();let newformjson=ff;if(null!==response){const submission=JSON.parse(response.text1);newformjson=ff.map((item=>(item.value=submission["field-"+item.id],item.default=submission["field-"+item.id],item))),formdata.reviewing=1,formdata.submissionid=submission.id}formdata.formjson=JSON.stringify(newformjson);new _dynamicform.default(document.querySelector(`#message[data-id='${annotation.id}'] ${node} #form-preview`),"ivplugin_form\\submitform_form").load(formdata)};f?render(f):(void self.render(annotation,"json").then((content=>new Promise((resolve=>{resolve(content.fields)})))).catch((()=>{}))).then((fields=>render(fields))).catch((()=>{}))}runInteraction(annotation){this.player.pause();let self=this;this.isEditMode()&&(annotation.editmode=!0),this.renderViewer(annotation),this.enableManualCompletion(),"popup"==annotation.displayoptions&&(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(function(){self.setModalDraggable("#annotation-modal .modal-dialog")}))}displayReportView(annotation,tabledata){let self=this,$message=(0,_jquery.default)(`#message[data-id='${annotation.id}']`);$message.closest(".modal").addClass("modal-fullscreen"),$message.find("#content").html('<div class="tab-content" id="myTabContent">\n            <div class="tab-pane fade" id="formtab" role="tabpanel">\n            <div id="formmeta" class="mb-3 d-flex"></div><div id="form-preview"></div></div>\n            <div class="tab-pane fade show active" id="responsetab" role="tabpanel"></div>\n            </div><div class="shadow z-index-1 h-100 bg-white overflow-auto" id="responseview">\n            <div class="modal-header d-flex bg-white align-items-center pr-0 sticky-top" id="title">\n                                            <h5 class="modal-title text-truncate mb-0"><div class="d-flex align-items-center p-1">\n                                                <select id="submission-list"\n                                                class="custom-select rounded-sm mr-1"></select>\n                                                <button class="btn p-0 previous">\n                                                <i class="bi bi-chevron-left fa-fw fs-25px"></i>\n                                                </button>\n                                                <button class="btn p-0 next">\n                                                <i class="bi bi-chevron-right fa-fw fs-25px"></i>\n                                                </button>\n                                            </div></h5>\n                                            <div class="d-flex align-items-center">\n                                                <button class="btn mx-2 p-0 close">\n                                                <i class="bi bi-x-lg fa-fw fs-25px"></i>\n                                                </button>\n                                            </div>\n                                        </div>\n            <div id="form-preview"></div>\n            </div>'),$message.find(".btns").prepend(`<button class="rotatey-180 btn btn-sm mr-2 border-0" data-toggle="tab" data-target="#formtab">\n            <i class="bi bi-input-cursor-text fs-25px"  data-toggle="tooltip"\n             title="${M.util.get_string("form","ivplugin_form")}"></i></button>\n            <button class="rotatey-180 btn btn-sm mr-2 border-0" data-toggle="tab" data-target="#responsetab">\n            <i class="bi bi-table fs-25px" data-toggle="tooltip"\n             title="${M.util.get_string("responses","ivplugin_form")}"></i>\n            </button>`),this.render(annotation,"json").then((async ct=>{let logs=[],users=[];const fields=JSON.stringify([...ct.fields]);let formfields=ct.fields,userids=tabledata.map((item=>item.id)),logdata=await this.getLogs(annotation,userids);logs=logdata,logs.map((x=>{const completiondata=tabledata.find((y=>y.id==x.userid));return x.completiondata=completiondata,x}));let heading=[{title:M.util.get_string("id","mod_interactivevideo"),class:"exportable"},{title:M.util.get_string("timesubmitted","mod_interactivevideo"),class:"exportable time"},{title:M.util.get_string("participant","mod_interactivevideo"),class:""},{title:M.util.get_string("firstname","mod_interactivevideo"),class:"exportable"},{title:M.util.get_string("lastname","mod_interactivevideo"),class:"exportable"},{title:M.util.get_string("email","mod_interactivevideo"),class:"exportable"}],validfields=[];formfields.forEach((f=>{if("header"!=f.type&&"html"!=f.type&&"linebreak"!=f.type){let head=f.formattedlabel;f.helptext.text&&""!=f.helptext.text&&(head=`<span>${f.formattedlabel}\n                            <i class="ml-2 bi bi-info-circle-fill text-secondary helptext" data-fieldid="${f.id}"\n                             data-toggle="popover">\n                            </i></span>`),heading.push({title:head,class:"exportable not-sortable"}),validfields.push(f)}}));let rows=[];logs.forEach((l=>{let submission=JSON.parse(l.text1),row=[l.id,`<a href="javascript:void(0)" class="viewsubmission" data-id="${l.id}">${l.formattedtimecreated}</a>`,`<span class="text-truncate">${l.completiondata.picture}</span>`,l.completiondata.firstname,l.completiondata.lastname,l.completiondata.email];validfields.forEach((async f=>{let response=submission["field-"+f.id];if(null!=response)switch(f.type){case"text":case"textarea":row.push(response);break;case"editor":row.push(response.text);break;case"select":var res=[];(options=f.options.split("\n")).forEach((option=>{let choices=(option=option.trim()).split("="),value=choices[0];response.indexOf(value)>-1&&res.push(choices[1])})),row.push(res.join(", "));break;case"radio":(options=f.options.split("\n")).forEach((option=>{let choices=(option=option.trim()).split("="),value=choices[0];response!=value||row.push(choices[1])}));break;case"advcheckbox":res=[];var options=f.options.split("\n"),selected=Object.values(response);selected=selected.filter((item=>""!=item)),options.forEach((option=>{let choices=(option=option.trim()).split("="),value=choices[0];selected.indexOf(value)>-1&&res.push(choices[1])})),row.push(res.join(", "));break;case"date_selector":var date;response.day<9?date+="0"+response.day:date+=response.day,date+="/",response.month<9?date+="0"+response.month:date+=response.month,date+="/",date+=response.year,response.hour&&response.minute&&(date+=" ",response.hour<9?date+="0"+response.hour:date+=response.hour,date+=":",response.minute<9?date+="0"+response.minute:date+=response.minute),row.push(date);break;case"duration":response?row.push(response.number+" "+M.util.get_string(response.timeunit,"ivplugin_form")):row.push("");break;case"filemanager":if(response.length>0){const files=response.map((file=>{const filename=file.split("/").pop();return`<a href="${file}" target="_blank" class="text-truncate">\n                                    ${decodeURIComponent(filename.replace("field-"+f.id+"_",""))}<span class="d-none">\n                                    [${file}]</span></a>`}));row.push(files.join(",<br>"))}else row.push("")}else row.push("")})),rows.push(row)})),users=logs.map((l=>({id:l.id,fullname:`${l.completiondata.firstname} ${l.completiondata.lastname}`}))),users.sort(((a,b)=>a.fullname.localeCompare(b.fullname))),users.forEach((user=>{(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#submission-list").append(`<option value="${user.id}">${user.fullname}</option>`)})),(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#responsetab").html(`<div id="formresponsetable" class="table-responsive">\n                    <table class="table table-bordered table-striped w-100">\n                    <thead>\n                        <tr>\n                            ${heading.map((h=>`<th class="${h.class} text-truncate">${h.title}</th>`)).join("")}\n                        </tr>\n                    </thead>\n                    <tbody>\n                    </tbody>\n                    </table>\n                    </div>`),(0,_report.renderAnnotationLogs)({heading:heading,rows:rows},"#formresponsetable"),$message.find(".btns").on("click",'[data-toggle="tab"]',(function(){(0,_jquery.default)('[data-toggle="tab"]').removeClass("active"),(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#responseview #form-preview, .tab-content #form-preview").empty(),"#formtab"==(0,_jquery.default)(this).data("target")&&self.renderForm(annotation,JSON.parse(fields),null,"#formtab")})),(0,_jquery.default)(document).on("click",`#message[data-id='${annotation.id}'] table .helptext`,(async function(e){(0,_jquery.default)(".popover").remove(),e.preventDefault(),e.stopImmediatePropagation();let $this=(0,_jquery.default)(this),contentid=(0,_jquery.default)(this).attr("data-fieldid"),field=formfields.find((field=>field.id==contentid)),content=field.helptext.text;$this.popover({content:'<div class="loader"></div>',title:`<span class="mr-2">${field.formattedlabel}</span><i class="bi bi-x-circle-fill ml-auto popover-dismiss cursor-pointer" style="font-size:1.5em;"></i>`,placement:"top",html:!0,trigger:"focus",template:`<div class="popover inlineannotation-popover id-${contentid}"\n                     role="tooltip"><div class="arrow"></div><h3 class="popover-header d-flex justify-content-between"></h3>\n                     <div class="popover-body rounded"></div></div>`}),$this.popover("show"),$this.on("shown.bs.popover",(async function(){let $body=(0,_jquery.default)(`.popover.id-${contentid} .popover-body`);const html=await self.formatContent(content,M.cfg.contextid);$body.html(html),(0,_events.notifyFilterContentUpdated)($body),$this.popover("update")}))})),(0,_jquery.default)(document).on("click",".popover-dismiss",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)(this).closest(".popover").remove()})),(0,_jquery.default)(document).on("click",`#message[data-id='${annotation.id}'] .viewsubmission`,(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).attr("data-id");(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#responseview").addClass("show"),(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#submission-list").val(id).trigger("change")})),(0,_jquery.default)(document).on("change",`#message[data-id='${annotation.id}'] #submission-list`,(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).val(),log=logs.find((item=>item.id==id));self.renderForm(annotation,formfields,log,"#responseview");let index=users.findIndex((item=>item.id==id));index>0?(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find(".previous").prop("disabled",!1):(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find(".previous").prop("disabled",!0),index<users.length-1?(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find(".next").prop("disabled",!1):(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find(".next").prop("disabled",!0)})),(0,_jquery.default)(document).on("click",`#message[data-id='${annotation.id}'] #responseview .close`,(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#responseview").removeClass("show")})),(0,_jquery.default)(document).on("click",`#message[data-id='${annotation.id}'] #responseview .previous`,(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#submission-list").val(),index=users.findIndex((item=>item.id==id)),prev=users[index-1];(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#submission-list").val(prev.id).trigger("change")})),(0,_jquery.default)(document).on("click",`#message[data-id='${annotation.id}'] #responseview .next`,(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#submission-list").val(),index=users.findIndex((item=>item.id==id)),next=users[index+1];(0,_jquery.default)(`#message[data-id='${annotation.id}']`).find("#submission-list").val(next.id).trigger("change")}))})).catch((()=>{}))}}return _exports.default=Form,_exports.default}));

//# sourceMappingURL=main.min.js.map