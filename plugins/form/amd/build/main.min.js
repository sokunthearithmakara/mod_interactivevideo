define("ivplugin_form/main",["exports","jquery","mod_interactivevideo/type/base","core/ajax","core/event_dispatcher","mod_interactivevideo/libraries/jquery-ui","core/templates","core_form/dynamicform","mod_interactivevideo/report","core_filters/events","core/notification"],(function(_exports,_jquery,_base,_ajax,_event_dispatcher,_jqueryUi,_templates,_dynamicform,_report,_events,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Main class for the form plugin.
   *
   * @module     ivplugin_form/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_base=_interopRequireDefault(_base),_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_dynamicform=_interopRequireDefault(_dynamicform),_notification=_interopRequireDefault(_notification);class Form extends _base.default{postEditCallback(){}async renderViewer(annotation){let self=this;if(this.isEditMode()){let formfields=[{icon:"bi bi-alphabet-uppercase",type:"header",label:M.util.get_string("headerfield","ivplugin_form")},{icon:"bi bi-text-paragraph",type:"html",label:M.util.get_string("htmlfield","ivplugin_form")},{icon:"bi bi-hr",type:"linebreak",label:M.util.get_string("linebreakfield","ivplugin_form")},{},{icon:"bi bi-input-cursor-text",type:"text",label:M.util.get_string("textfield","ivplugin_form")},{icon:"bi bi-textarea-resize",type:"textarea",label:M.util.get_string("textareafield","ivplugin_form")},{icon:"bi bi-card-text",type:"editor",label:M.util.get_string("editorfield","ivplugin_form")},{icon:"bi bi-menu-button-wide",type:"select",label:M.util.get_string("selectfield","ivplugin_form")},{icon:"bi bi-check2-square",type:"advcheckbox",label:M.util.get_string("advcheckboxfield","ivplugin_form")},{icon:"bi bi-record-circle",type:"radio",label:M.util.get_string("radiofield","ivplugin_form")},{},{icon:"bi bi-calendar3-event",type:"date",label:M.util.get_string("dateselectorfield","ivplugin_form")},{icon:"bi bi-calendar3-week",type:"week",label:M.util.get_string("weekfield","ivplugin_form")},{icon:"bi bi-calendar3",type:"month",label:M.util.get_string("monthfield","ivplugin_form")},{icon:"bi bi-clock",type:"time",label:M.util.get_string("timefield","ivplugin_form")},{icon:"bi bi-stopwatch",type:"duration",label:M.util.get_string("durationfield","ivplugin_form")},{},{icon:"bi bi-sliders2",type:"range",label:M.util.get_string("rangefield","ivplugin_form")},{},{icon:"bi bi-file-earmark-arrow-up",type:"filemanager",label:M.util.get_string("filemanagerfield","ivplugin_form")}];const dataForTemplate={id:annotation.id,items:formfields},template=await _templates.default.render("ivplugin_form/formedit_modal",dataForTemplate);(0,_jquery.default)(template).appendTo("body"),(0,_jquery.default)("#form-modal").modal("show"),(0,_jquery.default)("#form-modal").on("hidden.bs.modal",(function(){(0,_jquery.default)(this).remove()})),(0,_jquery.default)("#form-modal").on("shown.bs.modal",(async function(){let content=await self.render(annotation,"json");self.postContentRender(annotation,formfields,content)})),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#content").append('<div id="formjson" class="d-none"></div>')}else{await super.renderViewer(annotation);let content=await self.render(annotation,"json");(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#content").append('<div id="formmeta" class="mb-3 d-flex"></div><div id="form-preview"></div>\n                    <div id="formjson" class="d-none"></div>'),this.postContentRender(annotation,"",content)}}postFormRender(){(0,_jquery.default)('form .fitem [data-type="time"]').attr("type","time"),(0,_jquery.default)('form .fitem [data-type="week"]').attr("type","week"),(0,_jquery.default)('form .fitem [data-type="month"]').attr("type","month"),(0,_jquery.default)('form .fitem [data-type="date"]').attr("type","date"),(0,_jquery.default)("form .fitem textarea:visible").trigger("input"),(0,_jquery.default)('form .fitem [data-type="datetime"]').attr("type","datetime-local"),(0,_jquery.default)('form .fitem [data-type="range"]').attr("type","range").removeClass("form-control").addClass("form-control-range"),(0,_jquery.default)(document).off("click","form .fitem .filemanager.fm-noitems").on("click","form .fitem .filemanager.fm-noitems",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)("#wrapper").hasClass("fullscreen")&&setTimeout((()=>{(0,_jquery.default)('.moodle-dialogue-base[aria-hidden="false"]').appendTo("#wrapper"),(0,_jquery.default)('body > .moodle-dialogue-base[aria-hidden="false"]').remove()}),300)}))}repeatableValues(node){(0,_jquery.default)("".concat(node,' form .fitem [data-type="keyvalue"]')).each((function(){let $this=(0,_jquery.default)(this),dataId=$this.attr("data-id");(0,_jquery.default)("div#".concat(dataId,"-repeatable")).remove();let defaultValues=(0,_jquery.default)('input[type="hidden"][data-type="default"][data-id='.concat(dataId,"]")).val().split(","),value=$this.val(),isRadio="true"==(0,_jquery.default)(this).attr("data-radio"),rows=value.split("\n"),html="";""!=value&&rows.length>0?rows.forEach((function(row,i){let rowvalues=row.split("="),key=rowvalues[0].trim(),val=rowvalues[1].trim();""!=key&&""!=val&&(html+='<div class="input-group mb-1 w-100 flex-nowrap align-items-center">\n                        <div class="input-group-text border-0 rounded-0 pl-0">\n                            <i class="bi bi-grip-vertical mr-2 cursor-move"></i>\n                            <input type="checkbox" '.concat(defaultValues.includes(key)?"checked":"",'>\n                        </div>\n                        <input type="text" class="form-control key" value="').concat(key,'">\n                        <input type="text" value="').concat(val,'" class="form-control value">\n                        <div class="input-group-append">\n                        <button class="btn add-row btn-secondary" type="button"><i class="bi bi-plus-lg"></i></button>\n                        <button class="btn btn-danger delete-row rounded-0" ').concat(0==i?"disabled":"",' type="button">\n                        <i class="bi bi-trash3-fill"></i></button>\n                        </div></div>'))})):html='<div class="input-group mb-1 w-100 flex-nowrap align-items-center">\n                        <div class="input-group-text border-0 rounded-0 pl-0">\n                            <i class="bi bi-grip-vertical mr-2 cursor-move"></i>\n                            <input type="checkbox"/>\n                        </div>\n                        <input type="text" class="form-control key">\n                        <input type="text" class="form-control value">\n                        <div class="input-group-append">\n                        <button class="btn add-row btn-secondary" type="button"><i class="bi bi-plus-lg"></i></button>\n                        <button class="btn btn-danger delete-row rounded-0 disabled" disabled type="button">\n                        <i class="bi bi-trash3-fill"></i></button>\n                        </div></div>',$this.after('<div id="'.concat(dataId,'-repeatable" data-radio="').concat(isRadio,'" data-id="').concat(dataId,'"\n                 class="w-100 repeatable">').concat(html,"</div>")),$this.addClass("d-none"),(0,_jquery.default)("form .fitem #".concat(dataId,"-repeatable")).sortable({placeholder:"ui-state-highlight",handle:".bi-grip-vertical",stop:function(){(0,_jquery.default)("".concat(node," form .repeatable .delete-row")).removeClass("disabled").removeAttr("disabled"),(0,_jquery.default)("".concat(node," form .repeatable .delete-row")).first().addClass("disabled").attr("disabled","disabled"),(0,_jquery.default)("".concat(node," form .repeatable input[type=text]")).trigger("input")}})})),(0,_jquery.default)(document).on("click","".concat(node," .repeatable .add-row"),(function(e){e.preventDefault(),e.stopImmediatePropagation();let $parent=(0,_jquery.default)(this).closest(".input-group"),$row=$parent.clone();$row.find("input").val(""),$row.find('input[type="checkbox"]').prop("checked",!1),$row.find(".delete-row").removeClass("disabled").removeAttr("disabled"),$parent.after($row)})),(0,_jquery.default)(document).on("click","".concat(node," .repeatable .delete-row"),(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)(this).closest(".input-group").remove(),(0,_jquery.default)("".concat(node," form .repeatable input[type=text]")).trigger("input")})),(0,_jquery.default)(document).on("input change","".concat(node," form .repeatable input"),(function(){let $this=(0,_jquery.default)(this),$parent=$this.closest(".repeatable"),$inputs=$parent.find(".input-group"),values={},defaultValues=[];"true"==$parent.attr("data-radio")&&"checkbox"==$this.attr("type")&&$inputs.find('input[type="checkbox"]').not(this).prop("checked",!1),$inputs.each((function(){let $input=(0,_jquery.default)(this);if(""!=$input.find("input.key").val()&&""!=$input.find("input.value").val()){$input.find('input[type="checkbox"]').prop("checked")&&defaultValues.push($input.find("input.key").val().trim()),values[$input.find("input.key").val().trim()]=$input.find("input.value").val().trim()}}));let rows=Object.keys(values).map((key=>key+"="+values[key]));(0,_jquery.default)('textarea[data-id="'+$parent.attr("data-id")+'"]').val(rows.join("\n")),defaultValues=[...new Set(defaultValues)],(0,_jquery.default)('input[type="hidden"][data-type="default"][data-id="'+$parent.attr("data-id")+'"]').val(defaultValues.join(","))}))}postContentRender(annotation,formfields,content){var _this=this;let reportpage=arguments.length>3&&void 0!==arguments[3]&&arguments[3],self=this;const $message=(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']"));0!=annotation.text1&&$message.find("#formmeta").append('<div class="duedate">'.concat(M.util.get_string("duedate","ivplugin_form"),": ").concat(content.duedate,"</div>"));const fetchData=()=>new Promise(((resolve,reject)=>{_ajax.default.call([{args:{userid:this.userid,cmid:annotation.annotationid,annotationid:annotation.id,contextid:M.cfg.contextid},contextid:M.cfg.contextid,methodname:"ivplugin_form_get_log"}])[0].then((response=>{resolve(JSON.parse(response.record))})).catch((err=>{reject(err)}))}));let formjson=[];const renderList=fields=>{(0,_jquery.default)("#form-field-list").empty(),fields&&fields.forEach((item=>{let icon=formfields.find((field=>field.type===item.type)).icon;(0,_jquery.default)("#form-field-list").append('<li class="list-group-item d-flex align-items-start justify-content-between p-0"\n                         data-id="'.concat(item.id,'" data-type="').concat(item.type,'">\n                                    <div class="d-flex align-items-start pt-1">\n                                    <i class="bi bi-grip-vertical px-2 cursor-move"></i>\n                                    <i class="').concat(icon,' mr-2"></i>\n                                    <div class="d-inline-block field-label cursor-pointer">').concat(item.formattedlabel,'</div></div>\n                                    <div class="ml-auto d-flex">\n                                        <button class="btn btn-sm rounded-0 editfield"\n                                         title="').concat(M.util.get_string("edit","mod_interactivevideo"),'">\n                                         <i class="bi bi-pencil-square"></i></button>\n                                        <button class="btn btn-sm rounded-0 copyfield"\n                                         title="').concat(M.util.get_string("clone","mod_interactivevideo"),'">\n                                         <i class="bi bi-copy"></i></button>\n                                        <button class="btn btn-sm rounded-0 text-danger deletefield"\n                                         title="').concat(M.util.get_string("delete","mod_interactivevideo"),'">\n                                         <i class="bi bi-trash3"></i></button>\n                                        </div>\n                                </li>'))})),$message.find("#formjson").text(JSON.stringify(fields))};let tracking=[],trackingIndex=0;const saveTracking=(fields,actives)=>{trackingIndex<tracking.length-1&&(tracking=tracking.slice(0,trackingIndex+1)),tracking.push({items:JSON.stringify(fields),actives:actives,at:(new Date).getTime()}),tracking.sort(((a,b)=>a.at-b.at)),trackingIndex=tracking.length-1,(0,_jquery.default)("#save-close #undo").removeAttr("disabled"),(0,_jquery.default)("#save-close #redo").attr("disabled","disabled"),1==tracking.length&&(0,_jquery.default)("#save-close #undo").attr("disabled","disabled"),(0,_jquery.default)("#save-close #save").removeAttr("disabled")};let previewform=null;const activateFieldsSortable=()=>{(0,_jquery.default)("#form-preview form").sortable({items:".fitem.row:not(.femptylabel):not([hidden]), fieldset.collapsible",connectWith:"#form-preview form .fcontainer"}),(0,_jquery.default)("#form-preview form .fcontainer").sortable({items:".fitem.row:not(.femptylabel):not([hidden])",connectWith:"#form-preview form .fcontainer, #form-preview form"}),(0,_jquery.default)("#form-preview form, #form-preview form .fcontainer").sortable("option",{placeholder:"ui-state-highlight",forcePlaceholderSize:!0,cursor:"move",forceHelperSize:!0,tolerance:"pointer"})},previewForm=function(data){let id=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,updateDraft=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];$message.find("#form-preview").empty();const selector=document.querySelector("#message[data-id='".concat(annotation.id,"'] #form-preview"));if(previewform=new _dynamicform.default(selector,"ivplugin_form\\submitform_form"),null===data||0==data.length)return void(0,_jquery.default)("#form-preview").removeClass("loader");(0,_jquery.default)("#form-preview").addClass("loader"),formdata.formjson=JSON.stringify(data),previewform.load(formdata);let interval=setInterval((()=>{$message.find("#form-preview form").length>0&&(clearInterval(interval),self.postFormRender())}),100);if(id){let interval=setInterval((()=>{let element=document.querySelector("#form-preview form");if(element){clearInterval(interval),(0,_jquery.default)("#form-preview #fitem_field-".concat(id,",\n                             #form-preview fieldset[id^=id_field-").concat(id,"],\n                             #form-preview div#field-").concat(id,", #form-preview [data-groupname=field-").concat(id,"],\n                             #form-preview [id^=fitem_id_field-").concat(id,"]")).addClass("field-highlight");let field=element.querySelector("#form-preview .field-highlight"),isHeader=(0,_jquery.default)(".field-highlight").hasClass("collapsible");field&&field.scrollIntoView({behavior:"smooth",block:isHeader?"start":"center"})}}),100)}if(updateDraft&&saveTracking(data,id),!self.isEditMode()&&"popup"==$message.attr("data-placement")){const interval=setInterval((()=>{if($message.find("#form-preview form").length>0){clearInterval(interval);let $actionbtns=$message.find("#form-preview #form-action-btns"),$clone=$actionbtns.clone();$actionbtns.remove();let footer='<div class="modal-footer">\n                            '.concat($clone.html(),"\n                            </div>");$message.find(".modal-content .modal-footer").remove(),$message.find(".modal-content").append(footer)}}),100)}if(_this.isEditMode()){let interval=setInterval((()=>{(0,_jquery.default)("#form-preview form").length>0&&(clearInterval(interval),activateFieldsSortable())}),100)}};content&&""!=content.fields&&null!==content.fields&&(formjson=content.fields);let formdata={};if(reportpage)return formdata={id:annotation.id,contextid:M.cfg.contextid,type:"form",courseid:M.cfg.courseId,annotationid:0,editing:0,formjson:JSON.stringify(formjson)},void previewForm(formjson);if(formdata={id:annotation.id,contextid:M.cfg.contextid,type:self.prop.name,courseid:self.course,annotationid:self.interaction,completionid:self.completionid,editing:self.isEditMode()?1:0,formjson:JSON.stringify(formjson)},$message.on("click","#submitform-submit",(e=>{e.preventDefault(),e.stopImmediatePropagation();previewform.trigger(previewform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||previewform.submitFormAjax(),previewform.addEventListener(previewform.events.SERVER_VALIDATION_ERROR,(e=>{e.stopImmediatePropagation(),self.addNotification(M.util.get_string("formvalidationerror","ivplugin_form"),"danger"),previewform.notifyResetFormChanges(),self.postFormRender()})),previewform.addEventListener(previewform.events.CLIENT_VALIDATION_ERROR,(e=>{e.stopImmediatePropagation(),self.addNotification(M.util.get_string("formvalidationerror","ivplugin_form"),"danger"),previewform.notifyResetFormChanges()})),previewform.addEventListener(previewform.events.FORM_SUBMITTED,(e=>{e.preventDefault(),e.stopImmediatePropagation();let details={};const completeTime=new Date;details.xp=annotation.xp,details.duration=completeTime.getTime()-(0,_jquery.default)("#video-wrapper").data("timestamp"),details.timecompleted=completeTime.getTime();const completiontime=completeTime.toLocaleString();let duration=self.formatTime(details.duration/1e3);details.reportView='<span data-toggle="tooltip" data-html="true" class="cursor-pointer"\n                 data-title=\'<span class="d-flex flex-column align-items-start"><span><i class="bi bi-calendar mr-2"></i>\n                 '.concat(completiontime,'</span><span><i class="bi bi-stopwatch mr-2"></i>').concat(duration,'</span></span>\'>\n                 <i class="bi bi-list-check text-success"></i><br><span>').concat(annotation.xp,"</span></span>"),self.toggleCompletion(annotation.id,"mark-done","automatic",details),formdata.reviewing=1,1==annotation.char2&&(0==annotation.text1||annotation.text1>(new Date).getTime()/1e3)&&(0,_jquery.default)("#editsubmission").show()}))})),$message.on("click","#editsubmission",(e=>{e.preventDefault(),e.stopImmediatePropagation(),formdata.reviewing=0,(0,_jquery.default)("#editsubmission").hide(),formjson=$message.find("#formjson").text(),formjson=JSON.parse(formjson),previewForm(formjson)})),$message.on("click","#cancel-submit",(e=>{e.preventDefault(),e.stopImmediatePropagation(),$message.find(".modal-content .modal-footer").remove(),formdata.reviewing=1,(0,_jquery.default)("#editsubmission").show(),previewForm(formjson)})),this.isEditMode()?(previewForm(formjson,null,!0),$message.find("#formjson").text(JSON.stringify(formjson)),renderList(formjson)):annotation.completed?fetchData().then((log=>{if(log){let submission=JSON.parse(log.text1),newformjson=formjson.map((item=>(item.value=submission["field-"+item.id],item.default=submission["field-"+item.id],"radio"==item.type&&(item.othertext=submission["field-"+item.id+"-otheroptiontext"]),item)));formdata.reviewing=1,formdata.submissionid=submission.id,$message.find("#formjson").text(JSON.stringify(formjson)),previewForm(newformjson),1==annotation.char2&&(0==annotation.text1||annotation.text1>(new Date).getTime()/1e3)&&(0,_jquery.default)("#formmeta").append('<button class="btn btn-primary ml-auto btn-sm" id="editsubmission">\n                                    <i class="bi bi bi-pencil-square mr-2"></i>'.concat(M.util.get_string("edit","mod_interactivevideo"),"\n                                    </button>"))}else(0==annotation.text1||annotation.text1>(new Date).getTime()/1e3)&&previewForm(formjson)})).catch((()=>{})):0==annotation.text1||annotation.text1>(new Date).getTime()/1e3?previewForm(formjson):(0,_jquery.default)("#formmeta").replaceWith('<div class="alert alert-warning">\n                        '.concat(M.util.get_string("formnolongeravailable","ivplugin_form"),"</div>")),this.isEditMode()){const saveFormJson=ff=>{$message.find("#formjson").text(JSON.stringify(ff))},getFormJson=()=>{let currentFormFields=JSON.parse($message.find("#formjson").text()),updatedFormJson=$message.find("#form-field-list li").map((function(){const id=(0,_jquery.default)(this).attr("data-id");return currentFormFields.find((item=>item.id==id))})).get();saveFormJson(updatedFormJson),formjson=updatedFormJson};(0,_jquery.default)("#form-field-list").sortable({placeholder:"ui-state-highlight",cursor:"move",stop:function(event,ui){const id=ui.item.attr("data-id");getFormJson(),renderList(formjson),previewForm(formjson,id,!0)}}),$message.on("click","button.add-field",(function(e){e.preventDefault(),e.stopImmediatePropagation();let type=(0,_jquery.default)(this).data("type"),typeString=M.util.get_string(type+"field","ivplugin_form"),newfieldmodal='<div class="modal fade" id="newfield-modal" aria-labelledby="newfield-modal"\n                 aria-hidden="true" style="background: rgba(0,0,0,0.5);">\n                    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title">'.concat(M.util.get_string("addformfield","ivplugin_form",typeString),'</h5>\n                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n                                <i class="bi bi-x-lg fs-25px"></i>\n                                </button>\n                            </div>\n                            <div class="modal-body loader">\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-secondary" data-dismiss="modal">').concat(M.util.get_string("close","mod_interactivevideo"),'</button>\n                                <button type="button" class="btn btn-primary" id="newfield-submit">').concat(M.util.get_string("save","mod_interactivevideo"),"</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>");(0,_jquery.default)("body").append(newfieldmodal),(0,_jquery.default)("#newfield-modal").modal("show"),(0,_jquery.default)("#newfield-modal").on("hidden.bs.modal",(function(){(0,_jquery.default)(this).remove(),(0,_jquery.default)("body").addClass("modal-open")})),(0,_jquery.default)("#newfield-modal").on("shown.bs.modal",(function(){let formfieldform=new _dynamicform.default(document.querySelector("#newfield-modal .modal-body"),"ivplugin_form\\form_fields\\"+type),fields=[];null!==formjson&&(fields=formjson.map((item=>({id:item.id,label:item.label,type:item.type})))),formfieldform.load({contextid:M.cfg.contextid,type:type,annotationid:annotation.id,fields:JSON.stringify(fields)}),document.querySelector("#newfield-submit").addEventListener("click",(e=>{e.preventDefault(),e.stopImmediatePropagation();formfieldform.trigger(formfieldform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||formfieldform.submitFormAjax()})),formfieldform.addEventListener(formfieldform.events.FORM_SUBMITTED,(e=>{e.preventDefault(),e.stopImmediatePropagation();const response=e.detail;formjson=JSON.parse($message.find("#formjson").text());const active=(0,_jquery.default)("#form-preview form .fitem.row.field-active");if(active.length>0){let id=active.attr("id");id=id.split("field-")[1],id=id.split("_")[0];let index=formjson.findIndex((item=>item.id==id));formjson.splice(index+1,0,response)}else formjson.push(response);renderList(formjson),previewForm(formjson,response.id,!0),(0,_jquery.default)("#newfield-modal").modal("hide")})),self.setModalDraggable("#newfield-modal .modal-dialog");let formInterval=setInterval((()=>{(0,_jquery.default)("#newfield-modal .modal-body").find("form").length>0&&(clearInterval(formInterval),self.postFormRender(),"advcheckbox"!=type&&"radio"!=type&&"select"!=type||self.repeatableValues("#newfield-modal"))}),100);(0,_jquery.default)(formfieldform).on("core_form_dynamicform_clientvalidationerror core_form_dynamicform_validationerror",(function(e){e.preventDefault(),e.stopImmediatePropagation(),self.postFormRender(),"advcheckbox"!=type&&"radio"!=type&&"select"!=type||self.repeatableValues("#newfield-modal"),self.addNotification(M.util.get_string("formvalidationerror","ivplugin_form"),"danger")}))}))})),$message.on("click","#form-field-list button.editfield",(function(e){e.preventDefault(),e.stopImmediatePropagation();let type=(0,_jquery.default)(this).closest("li").attr("data-type"),fieldid=(0,_jquery.default)(this).closest("li").attr("data-id");formjson=JSON.parse($message.find("#formjson").text());let formfielddata=formjson.find((item=>item.id==fieldid)),fields=formjson.map((item=>({id:item.id,label:item.label,type:item.type})));formfielddata.fields=JSON.stringify(fields);let typeString=M.util.get_string(type+"field","ivplugin_form"),editform='<div class="modal fade" id="editfield-modal"\n                 aria-labelledby="editfield-modal" aria-hidden="true" style="background: rgba(0,0,0,0.5);">\n                    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title">'.concat(M.util.get_string("editformfield","ivplugin_form",typeString),'</h5>\n                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n                                <i class="bi bi-x-lg fs-25px"></i>\n                                </button>\n                            </div>\n                            <div class="modal-body loader">\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-secondary" data-dismiss="modal">').concat(M.util.get_string("close","mod_interactivevideo"),'</button>\n                                <button type="button" class="btn btn-primary" id="editfield-submit">').concat(M.util.get_string("save","mod_interactivevideo"),"</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>");(0,_jquery.default)("body").append(editform),(0,_jquery.default)("#editfield-modal").modal("show"),(0,_jquery.default)("#editfield-modal").on("hidden.bs.modal",(function(){(0,_jquery.default)(this).remove(),(0,_jquery.default)("body").addClass("modal-open")})),(0,_jquery.default)("#editfield-modal").on("shown.bs.modal",(function(){let formfieldform=new _dynamicform.default(document.querySelector("#editfield-modal .modal-body"),"ivplugin_form\\form_fields\\"+type);formfieldform.load(formfielddata),document.querySelector("#editfield-submit").addEventListener("click",(e=>{e.preventDefault(),e.stopImmediatePropagation();formfieldform.trigger(formfieldform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||formfieldform.submitFormAjax()})),formfieldform.addEventListener(formfieldform.events.FORM_SUBMITTED,(e=>{e.preventDefault(),e.stopImmediatePropagation();const response=e.detail,index=formjson.findIndex((item=>item.id==response.id));-1!==index&&(formjson[index]=response),renderList(formjson),previewForm(formjson,response.id,!0),(0,_jquery.default)("#editfield-modal").modal("hide")})),self.setModalDraggable("#editfield-modal .modal-dialog");let formInterval=setInterval((()=>{(0,_jquery.default)("#editfield-modal .modal-body").find("form").length>0&&(clearInterval(formInterval),"advcheckbox"!=type&&"radio"!=type&&"select"!=type||self.repeatableValues("#editfield-modal"),self.postFormRender())}),100);(0,_jquery.default)(formfieldform).on("core_form_dynamicform_clientvalidationerror core_form_dynamicform_validationerror",(function(e){e.preventDefault(),e.stopImmediatePropagation(),self.postFormRender(),"advcheckbox"!=type&&"radio"!=type&&"select"!=type||self.repeatableValues("#editfield-modal"),self.addNotification(M.util.get_string("formvalidationerror","ivplugin_form"),"danger")}))}))})),$message.on("click","#form-field-list button.copyfield",(function(e){e.preventDefault(),e.stopImmediatePropagation();let fieldid=(0,_jquery.default)(this).closest("li").attr("data-id");formjson=JSON.parse($message.find("#formjson").text());let formfielddata=JSON.parse(JSON.stringify(formjson.find((item=>item.id==fieldid))));const index=formjson.findIndex((item=>item.id==formfielddata.id));-1!==index&&(formfielddata.id=Math.floor((new Date).getTime()/1e3),formjson.splice(index+1,0,formfielddata)),renderList(formjson),previewForm(formjson,formfielddata.id,!0)})),$message.on("click","#form-field-list button.deletefield",(function(e){e.preventDefault(),e.stopImmediatePropagation();let currentFormFields=JSON.parse($message.find("#formjson").text());const $this=(0,_jquery.default)(this);_notification.default.saveCancel(M.util.get_string("deletefield","ivplugin_form"),M.util.get_string("deletefieldconfirm","ivplugin_form"),M.util.get_string("delete","mod_interactivevideo"),(function(){let li=$this.closest("li"),id=li.attr("data-id");li.remove(),(0,_jquery.default)("#form-preview #fitem_field-".concat(id,",\n                            #form-preview fieldset[id^=id_field-").concat(id,"],\n                            #form-preview div#field-").concat(id,", #form-preview [data-groupname=field-").concat(id,"],\n                            #form-preview [id^=fitem_id_field-").concat(id,"]")).addClass("field-highlight");let isHeader=(0,_jquery.default)(".field-highlight").hasClass("collapsible"),ff=currentFormFields.filter((item=>item.id!=id));renderList(ff),isHeader?previewForm(ff,id,!0):((0,_jquery.default)(".field-highlight").fadeOut(300,"linear",(function(){(0,_jquery.default)(this).remove()})),saveTracking(ff,id))}),null)})),$message.on("click","button#save",(function(e){e.preventDefault(),e.stopImmediatePropagation(),getFormJson();let formJsonCopy=JSON.parse(JSON.stringify(formjson)),json=formJsonCopy.map((item=>(delete item.annotationid,delete item.contextid,delete item.formattedlabel,item))),cleanItems=JSON.stringify(json).replace(/</g,"&lt;").replace(/>/g,"&gt;");_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quickeditfield",sesskey:M.cfg.sesskey,id:annotation.id,field:"content",contextid:M.cfg.contextid,draftitemid:0,value:cleanItems,cmid:self.cmid,token:self.token},success:function(data){let updated=JSON.parse(data);tracking=[],tracking.push({items:JSON.stringify(formJsonCopy),actives:null,at:(new Date).getTime()}),(0,_jquery.default)("#save-close #redo, #save-close #undo").attr("disabled","disabled"),(0,_jquery.default)("#save-close #save").attr("disabled","disabled"),(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"edit"})}})})),$message.on("click","#form-field-list li .field-label",(function(){let id=(0,_jquery.default)(this).closest("li").attr("data-id"),type=(0,_jquery.default)(this).closest("li").attr("data-type");(0,_jquery.default)("#form-preview #fitem_field-".concat(id,", #form-preview fieldset[id^=id_field-").concat(id,"],\n                     #form-preview div#field-").concat(id,", #form-preview [data-groupname=field-").concat(id,"],\n                      #form-preview [id^=fitem_id_field-").concat(id,"]")).addClass("field-highlight");let $collapsible=(0,_jquery.default)(".field-highlight").closest("fieldset.collapsible");$collapsible&&$collapsible.find('[data-toggle="collapse"]').hasClass("collapsed")&&$collapsible.find('[data-toggle="collapse"]').trigger("click");let field=document.querySelector("#form-preview .field-highlight");field&&field.scrollIntoView({behavior:"smooth",block:"header"==type?"start":"center"})})),$message.on("mouseover","#form-field-list li",(function(){(0,_jquery.default)("#form-preview .field-highlight").removeClass("field-highlight");const id=(0,_jquery.default)(this).attr("data-id");(0,_jquery.default)("#form-preview #fitem_field-".concat(id,", #form-preview fieldset[id^=id_field-").concat(id,"],\n                     #form-preview div#field-").concat(id,", #form-preview [data-groupname=field-").concat(id,"],\n                      #form-preview [id^=fitem_id_field-").concat(id,"]")).addClass("field-highlight")})),$message.on("mouseout","#form-field-list li",(function(){(0,_jquery.default)("#form-preview .field-highlight").removeClass("field-highlight")})),$message.on("mouseover","#form-preview .fitem",(function(){(0,_jquery.default)("#form-field-list li").removeClass("field-highlight");let id,group=(0,_jquery.default)(this).attr("data-groupname");if(group)id=group.replace("field-","");else try{id=(0,_jquery.default)(this).attr("id").match(/\d{10}/)[0]}catch(e){id=(0,_jquery.default)(this).closest("[data-groupname]").attr("data-groupname").replace("field-","")}(0,_jquery.default)("#form-field-list li[data-id=".concat(id,"]")).addClass("field-highlight")})),$message.on("mouseout","#form-preview .fitem",(function(){(0,_jquery.default)("#form-field-list li").removeClass("field-highlight")})),$message.on("click","#form-preview i.edit",(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).data("id");(0,_jquery.default)("#form-field-list li[data-id=".concat(id,"] button.editfield")).trigger("click")})),$message.on("click","#form-preview i.delete",(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).data("id");(0,_jquery.default)("#form-field-list li[data-id=".concat(id,"] button.deletefield")).trigger("click")})),$message.on("click","#form-preview i.copy",(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).data("id");(0,_jquery.default)("#form-field-list li[data-id=".concat(id,"] button.copyfield")).trigger("click")})),$message.on("click","#save-close #undo",(async function(e){if(e.preventDefault(),e.stopImmediatePropagation(),0==trackingIndex)return;trackingIndex--;const instance=tracking[trackingIndex];formjson=JSON.parse(instance.items),renderList(formjson),previewForm(formjson,instance.actives,!1),0==trackingIndex?((0,_jquery.default)("#save-close #undo").attr("disabled","disabled"),(0,_jquery.default)("#save-close #redo").removeAttr("disabled")):((0,_jquery.default)("#save-close #undo").removeAttr("disabled"),trackingIndex==tracking.length-1?(0,_jquery.default)("#save-close #redo").attr("disabled","disabled"):(0,_jquery.default)("#save-close #redo").removeAttr("disabled"))})),$message.on("click","#save-close #redo",(async function(e){if(e.preventDefault(),e.stopImmediatePropagation(),trackingIndex==tracking.length-1)return;trackingIndex++;const instance=tracking[trackingIndex];formjson=JSON.parse(instance.items),renderList(formjson),previewForm(formjson,instance.actives,!1),trackingIndex==tracking.length-1?((0,_jquery.default)("#save-close #redo").attr("disabled","disabled"),(0,_jquery.default)("#save-close #undo").removeAttr("disabled")):((0,_jquery.default)("#save-close #redo").removeAttr("disabled"),0==trackingIndex?(0,_jquery.default)("#save-close #undo").attr("disabled","disabled"):(0,_jquery.default)("#save-close #undo").removeAttr("disabled"))})),$message.on("click","#save-close #close",(async function(e){e.preventDefault(),e.stopImmediatePropagation(),tracking.length>1?_notification.default.saveCancel(M.util.get_string("savechanges","mod_interactivevideo"),M.util.get_string("savechangesconfirm","mod_interactivevideo"),M.util.get_string("save","mod_interactivevideo"),(function(){(0,_jquery.default)("#save-close #save").trigger("click")}),(function(){tracking=[],(0,_jquery.default)("#save-close #redo, #save-close #undo").attr("disabled","disabled"),(0,_jquery.default)("#save-close #save").attr("disabled","disabled"),(0,_jquery.default)("#form-modal").modal("hide")})):(0,_jquery.default)("#form-modal").modal("hide")})),$message.on("sortstart","#form-preview form, #form-preview form .fcontainer",(function(){(0,_jquery.default)(this).addClass("no-pointer"),(0,_jquery.default)("#form-preview form .fcontainer").addClass("empty-container")})),$message.on("sortreceive","#form-preview form, #form-preview form .fcontainer",(function(event,ui){ui.item.hasClass("collapsible")&&ui.item.parent().hasClass("fcontainer")&&((0,_jquery.default)(ui.sender).sortable("cancel"),self.addNotification(M.util.get_string("sectioninsectionisnotsupported","ivplugin_form"),"danger"))})),$message.on("sortstop","#form-preview form, #form-preview form .fcontainer",(function(event,ui){let id=ui.item.attr("id");id=id.split("field-")[1],id=id.split("_")[0],ui.item.trigger("click");let currentFormFields=JSON.parse($message.find("#formjson").text());(0,_jquery.default)(this).removeClass("no-pointer"),(0,_jquery.default)("#form-preview form .fcontainer").removeClass("empty-container");let sortables=$message.find("#form-preview form").find(".fitem:not(.femptylabel):not([hidden]), fieldset.collapsible"),fieldsets=$message.find("#form-preview form").find("fieldset.collapsible"),fields=sortables.map((function(){return(0,_jquery.default)(this).attr("id")})).get(),fieldsetsIds=fieldsets.map((function(){return(0,_jquery.default)(this).attr("id")})).get(),newFormJson=[];fields.forEach((x=>{let y=x.split("field-")[1];y=y.split("_")[0];let row=currentFormFields.find((f=>f.id==y));if(fieldsetsIds.includes(x)){let $next=(0,_jquery.default)("#".concat(x)).next(),endId=0;$next&&$next.hasClass("fitem")&&!$next.hasClass("femptylabel")&&(endId=$next.attr("id")),0!=endId&&endId?(endId=endId.split("field-")[1],endId=endId.split("_")[0],row.closeat=endId):row.closeat=""}newFormJson.push(row)})),formjson=newFormJson,renderList(formjson),saveTracking(formjson,id)})),$message.on("click","#form-preview .fitem.row",(function(){(0,_jquery.default)("#form-preview .field-active").removeClass("field-active"),(0,_jquery.default)(this).addClass("field-active")}))}else if(annotation.completiontracking&&"manual"!=annotation.completiontracking){let $message=(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']"));$message.find("#completiontoggle").prop("disabled",!0),1==annotation.completed?$message.find("#completiontoggle span").text("".concat(M.util.get_string("completioncompleted","mod_interactivevideo"))):$message.find("#completiontoggle span").text("".concat(M.util.get_string("completionincomplete","mod_interactivevideo")))}}completionCallback(annotations,thisItem,action,type){let msg="formupdated";thisItem.completed||(msg="formsubmitted"),super.completionCallback(annotations,thisItem,action,type),"automatic"==type&&this.addNotification(M.util.get_string(msg,"ivplugin_form"),"success");let annotation=annotations.find((item=>item.id==thisItem.id));this.runInteraction(annotation)}renderForm(annotation,f,response,node){let self=this;let formdata={id:annotation.id,contextid:M.cfg.contextid,type:"form",courseid:M.cfg.courseId,annotationid:0,editing:0};const render=ff=>{(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("".concat(node," #form-preview")).addClass("loader").empty();let newformjson=ff;if(null!==response){let submission=JSON.parse(response.text1);newformjson=ff.map((item=>(item.value=submission["field-"+item.id],item.default=submission["field-"+item.id],item))),formdata.reviewing=1,formdata.submissionid=submission.id}formdata.formjson=JSON.stringify(newformjson),new _dynamicform.default(document.querySelector("#message[data-id='".concat(annotation.id,"'] ").concat(node," #form-preview")),"ivplugin_form\\submitform_form").load(formdata);let interval=setInterval((()=>{(0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] ").concat(node," #form-preview form")).length>0&&(clearInterval(interval),self.postFormRender())}),100)};f?render(f):(async()=>{const content=await self.render(annotation,"json");return new Promise((resolve=>{resolve(content.fields)}))})().then((fields=>(window.console.log(fields),render(fields)))).catch((()=>{}))}runInteraction(annotation){this.player.pause();let self=this;this.isEditMode()&&(annotation.editmode=!0),this.renderViewer(annotation),this.enableManualCompletion(annotation),"popup"==annotation.displayoptions&&(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(function(){self.setModalDraggable("#annotation-modal .modal-dialog")}))}displayReportView(annotation,tabledata){let self=this,$message=(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']"));$message.closest(".modal").addClass("modal-fullscreen"),$message.find("#content").html('<div class="tab-content" id="myTabContent">\n            <div class="tab-pane fade" id="formtab" role="tabpanel">\n            <div id="formmeta" class="mb-3 d-flex"></div><div id="form-preview"></div></div>\n            <div class="tab-pane fade show active loading" id="responsetab" role="tabpanel"></div>\n            </div><div class="shadow z-index-1 h-100 bg-white overflow-auto" id="responseview">\n            <div class="modal-header d-flex bg-white align-items-center pr-0 sticky-top" id="title">\n                <h5 class="modal-title text-truncate mb-0">\n                    <div class="d-flex align-items-center p-1">\n                        <select id="submission-list" class="custom-select rounded-sm mr-1"></select>\n                        <button class="btn p-0 previous"><i class="bi bi-chevron-left fa-fw fs-25px"></i></button>\n                        <button class="btn p-0 next"><i class="bi bi-chevron-right fa-fw fs-25px"></i></button>\n                    </div>\n                </h5>\n                <div class="d-flex align-items-center">\n                    <button class="btn mx-2 p-0" id="print">\n                        <i class="bi bi-printer fa-fw fs-25px"></i>\n                    </button>\n                    <button class="btn mx-2 p-0 close">\n                        <i class="bi bi-x-lg fa-fw fs-25px"></i>\n                    </button>\n                </div>\n            </div>\n            <div id="form-preview"></div>\n            </div>'),$message.find(".btns").prepend('<button class="rotatey-180 btn btn-sm mr-2 border-0" data-toggle="tab" data-target="#formtab">\n            <i class="bi bi-input-cursor-text fs-25px"  data-toggle="tooltip"\n             title="'.concat(M.util.get_string("form","ivplugin_form"),'"></i></button>\n            <button class="rotatey-180 btn btn-sm mr-2 border-0" data-toggle="tab" data-target="#responsetab">\n            <i class="bi bi-table fs-25px" data-toggle="tooltip"\n             title="').concat(M.util.get_string("responses","ivplugin_form"),'"></i>\n            </button>')),(0,_jquery.default)(document).on("click","#print",(function(){var divContents=document.querySelector("#responseview #form-preview").innerHTML,originalContents=document.body.innerHTML;document.body.innerHTML=divContents,window.print(),document.body.innerHTML=originalContents})),this.render(annotation,"json").then((async ct=>{let logs=[],users=[];const fields=JSON.stringify([...ct.fields]);let formfields=ct.fields,userids=tabledata.map((item=>item.id)),logdata=await this.getLogs(annotation,userids);logs=logdata,logs.map((x=>{const completiondata=tabledata.find((y=>y.id==x.userid));return x.completiondata=completiondata,x}));let heading=[{title:M.util.get_string("id","mod_interactivevideo"),class:"exportable"},{title:M.util.get_string("timesubmitted","mod_interactivevideo"),class:"exportable time"},{title:M.util.get_string("participant","mod_interactivevideo"),class:""},{title:M.util.get_string("firstname","mod_interactivevideo"),class:"exportable"},{title:M.util.get_string("lastname","mod_interactivevideo"),class:"exportable"},{title:M.util.get_string("email","mod_interactivevideo"),class:"exportable"}],validfields=[];formfields.forEach((f=>{if("header"!=f.type&&"html"!=f.type&&"linebreak"!=f.type){let head=f.formattedlabel;f.helptext.text&&""!=f.helptext.text&&(head="<span>".concat(f.formattedlabel,'\n                            <i class="ml-2 bi bi-info-circle-fill text-secondary helptext cursor-pointer" data-fieldid="').concat(f.id,'"\n                             data-toggle="popover">\n                            </i></span>')),heading.push({title:head,class:"exportable not-sortable"}),validfields.push(f)}}));let rows=[];logs.forEach((l=>{let submission=JSON.parse(l.text1),row=[l.id,'<a href="javascript:void(0)" class="viewsubmission" data-id="'.concat(l.id,'">').concat(l.formattedtimecreated,"</a>"),'<span class="text-truncate">'.concat(l.completiondata.picture,"</span>"),l.completiondata.firstname,l.completiondata.lastname,l.completiondata.email];validfields.forEach((async f=>{let response=submission["field-"+f.id];if(null!=response)switch(f.type){case"text":case"time":case"textarea":row.push(response);break;case"range":row.push(response+"/["+f.minlength+"-"+f.maxlength+"]");break;case"week":var wvalue=response.split("-"),week=wvalue[1].replace("W","");row.push("".concat(M.util.get_string("weekvalue","ivplugin_form",week),", ").concat(wvalue[0]));break;case"month":var mvalue=response.split("-"),month=M.util.get_string("month"+mvalue[1],"ivplugin_form");row.push("".concat(month," ").concat(mvalue[0]));break;case"date":var includeTime=response.includes("T"),dvalue=new Date(response).toLocaleDateString();includeTime&&(dvalue+=" "+new Date(response).toLocaleTimeString()),row.push(dvalue);break;case"editor":row.push(response.text);break;case"select":var res=[];f.options.split("\n").forEach((option=>{let choices=(option=option.trim()).split("="),value=choices[0];response.indexOf(value)>-1&&res.push(choices[1])})),row.push(res.join(", "));break;case"radio":var ans="",roptions=f.options.split("\n");if("otheroption"==response){let othertext=submission["field-"+f.id+"-otheroptiontext"];row.push(M.util.get_string("otheroption","ivplugin_form")+(""!=othertext?": "+othertext:""));break}roptions.forEach((option=>{let choices=(option=option.trim()).split("="),value=choices[0];response!=value||(ans=choices[1])})),row.push(ans);break;case"advcheckbox":var ares=[],aoptions=f.options.split("\n");1==f.allowother&&aoptions.push("otheroption=".concat(M.util.get_string("otheroption","ivplugin_form")));var optionObj={};aoptions.forEach((option=>{let opt=option.split("=");optionObj[opt[0].trim()]=opt[1].trim()}));var keys=Object.keys(response);(keys=keys.filter((item=>""!=response[item]&&void 0!==response[item]))).forEach((key=>{if(optionObj[key]){let v=response[key];"otheroption"==key&&(v=M.util.get_string("otheroption","ivplugin_form")+(""!=response.otheroptiontext?": "+response.otheroptiontext:"")),ares.push(v)}})),row.push(ares.join(", <br>"));break;case"date_selector":var dsdate=response.year+"-";response.month<9?dsdate+="0"+response.month:dsdate+=response.month,dsdate+="-",response.day<9?dsdate+="0"+response.day:dsdate+=response.day,response.hour&&response.minute&&(dsdate+="T",response.hour<9?dsdate+="0"+response.hour:dsdate+=response.hour,dsdate+=":",response.minute<9?dsdate+="0"+response.minute:dsdate+=response.minute);var inclTime=dsdate.includes("T"),dsvalue=new Date(dsdate).toLocaleDateString();inclTime&&(dsvalue+=" "+new Date(dsdate).toLocaleTimeString()),row.push(dsvalue);break;case"duration":response?row.push(response.number+" "+M.util.get_string(response.timeunit,"ivplugin_form")):row.push("");break;case"filemanager":if(response.length>0){const files=response.map((file=>{const filename=file.split("/").pop();return'<a href="'.concat(file,'" target="_blank" class="text-truncate">').concat(decodeURIComponent(filename.replace("field-"+f.id+"_","")),'<span class="d-none"><br>\n[').concat(file,"]\n                                        </span></a>")}));row.push(files.join(",<br>"))}else row.push("")}else row.push("")})),rows.push(row)})),users=logs.map((l=>({id:l.id,fullname:"".concat(l.completiondata.firstname," ").concat(l.completiondata.lastname)}))),users.sort(((a,b)=>a.fullname.localeCompare(b.fullname))),users.forEach((user=>{(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#submission-list").append('<option value="'.concat(user.id,'">').concat(user.fullname,"</option>"))})),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#responsetab").html('<div id="formresponsetable" class="table-responsive">\n                    <table class="table table-bordered table-striped w-100">\n                    <thead>\n                        <tr>\n                            '.concat(heading.map((h=>'<th class="'.concat(h.class,' text-truncate">').concat(h.title,"</th>"))).join(""),"\n                        </tr>\n                    </thead>\n                    <tbody>\n                    </tbody>\n                    </table>\n                    </div>")),(0,_report.renderAnnotationLogs)({heading:heading,rows:rows},"#formresponsetable",annotation.formattedtitle),$message.find(".btns").on("click",'[data-toggle="tab"]',(function(){(0,_jquery.default)('[data-toggle="tab"]').removeClass("active"),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#responseview #form-preview, .tab-content #form-preview").empty(),"#formtab"==(0,_jquery.default)(this).data("target")&&self.renderForm(annotation,JSON.parse(fields),null,"#formtab")})),(0,_jquery.default)(document).on("click","#message[data-id='".concat(annotation.id,"'] table .helptext"),(async function(e){(0,_jquery.default)(".popover").remove(),e.preventDefault(),e.stopImmediatePropagation();let $this=(0,_jquery.default)(this),contentid=(0,_jquery.default)(this).attr("data-fieldid"),field=formfields.find((field=>field.id==contentid)),content=field.helptext.text;$this.popover({content:'<div class="loader"></div>',title:'<span class="mr-2">'.concat(field.formattedlabel,"</span>")+'<i class="bi bi-x-circle-fill ml-auto popover-dismiss cursor-pointer" style="font-size:1.5em;"></i>',placement:"top",html:!0,trigger:"focus",template:'<div class="popover inlineannotation-popover id-'.concat(contentid,'"\n                     role="tooltip"><div class="arrow"></div><h3 class="popover-header d-flex justify-content-between"></h3>\n                     <div class="popover-body rounded"></div></div>')}),$this.popover("show"),$this.on("shown.bs.popover",(async function(){let $body=(0,_jquery.default)(".popover.id-".concat(contentid," .popover-body"));const html=await self.formatContent(content,M.cfg.contextid);$body.html(html),(0,_events.notifyFilterContentUpdated)($body),$this.popover("update")}))})),(0,_jquery.default)(document).on("click",".popover-dismiss",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)(this).closest(".popover").remove()})),(0,_jquery.default)(document).on("click","#message[data-id='".concat(annotation.id,"'] .viewsubmission"),(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).attr("data-id");(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#responseview").addClass("show"),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#submission-list").val(id).trigger("change")})),(0,_jquery.default)(document).on("change","#message[data-id='".concat(annotation.id,"'] #submission-list"),(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)(this).val(),log=logs.find((item=>item.id==id));self.renderForm(annotation,formfields,log,"#responseview");let index=users.findIndex((item=>item.id==id));index>0?(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find(".previous").prop("disabled",!1):(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find(".previous").prop("disabled",!0),index<users.length-1?(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find(".next").prop("disabled",!1):(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find(".next").prop("disabled",!0)})),(0,_jquery.default)(document).on("click","#message[data-id='".concat(annotation.id,"'] #responseview .close"),(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#responseview").removeClass("show")})),(0,_jquery.default)(document).on("click","#message[data-id='".concat(annotation.id,"'] #responseview .previous"),(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#submission-list").val(),index=users.findIndex((item=>item.id==id)),prev=users[index-1];(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#submission-list").val(prev.id).trigger("change")})),(0,_jquery.default)(document).on("click","#message[data-id='".concat(annotation.id,"'] #responseview .next"),(function(e){e.preventDefault(),e.stopImmediatePropagation();let id=(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#submission-list").val(),index=users.findIndex((item=>item.id==id)),next=users[index+1];(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).find("#submission-list").val(next.id).trigger("change")}))})).catch((()=>{}))}async getCompletionData(annotation,userid){let self=this,response=await _ajax.default.call([{args:{userid:userid,cmid:annotation.annotationid,annotationid:annotation.id,contextid:M.cfg.contextid},contextid:M.cfg.contextid,methodname:"ivplugin_form_get_log"}])[0];window.console.log(response),response=JSON.parse(response.record),window.console.log(response);let modal='<div class="modal fade '.concat((0,_jquery.default)("body").hasClass("iframe")?"modal-fullscreen":"",'"\n        id="annotation-modal" role="dialog" aria-labelledby="annotation-modal"\n    aria-hidden="true" data-backdrop="static" data-keyboard="false">\n    <div id="message" data-id="').concat(annotation.id,'" data-placement="popup"\n     class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">\n                               <div class="modal-content rounded-lg">\n                                   <div class="modal-header d-flex align-items-center shadow-sm pr-0" id="title">\n                                       <button class="btn mx-2 p-0 ml-auto" data-dismiss="modal" aria-label="Close">\n                                        <i class="bi bi-x-lg fa-fw fs-25px"></i>\n                                        </button>\n                                   </div>\n                                   <div class="modal-body" id="form-preview"></div>\n                                   </div>\n                               </div>\n                               </div>');(0,_jquery.default)("body").append(modal),(0,_jquery.default)("#annotation-modal").modal("show"),(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(function(){self.renderForm(annotation,null,response,".modal-content")})),(0,_jquery.default)("#annotation-modal").on("hidden.bs.modal",(function(){(0,_jquery.default)("#annotation-modal").remove()}))}}return _exports.default=Form,_exports.default}));

//# sourceMappingURL=main.min.js.map