{"version":3,"file":"wistia.min.js","sources":["../../src/player/wistia.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Wistia Player class\n * Doc: https://docs.wistia.com/docs/javascript-player-api\n *\n * @module     mod_interactivevideo/player/wistia\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport {dispatchEvent} from 'core/event_dispatcher';\nlet player;\n\nclass Wistia {\n    constructor(url, start, end, showControls) {\n        this.type = 'wistia';\n        this.start = start;\n        this.frequency = 0.3;\n        this.support = {\n            playbackrate: true,\n            quality: true,\n        };\n        var regex = /(?:https?:\\/\\/)?(?:www\\.)?(?:wistia\\.com)\\/medias\\/([^\\/]+)/g;\n        var match = regex.exec(url);\n        var videoId = match[1];\n        this.videoId = videoId;\n        $(\"#player\").html(`<div class=\"wistia_embed wistia_async_${videoId} wmode=transparent\n             controlsVisibleOnLoad=${showControls} playButton=${showControls} videoFoam=true\n              fullscreenButton=false volume=0\" style=\"height:100%;width:100%\"></div>`);\n        var self = this;\n        $.get('https://fast.wistia.com/oembed.json?url=' + url)\n            .then(function(data) {\n                self.posterImage = data.thumbnail_url;\n            });\n        var ready = false;\n        var wistiaOptions = {\n            id: videoId,\n            onReady: function(video) {\n                player = video;\n                end = !end ? video.duration() : Math.min(end, video.duration());\n                if (start > 0) {\n                    video.play();\n                    video.time(start);\n                    video.pause();\n                    video.on(\"pause\", () => {\n                        if (!ready) {\n                            ready = true;\n                            dispatchEvent('iv:playerReady');\n                        }\n                    });\n\n                } else {\n                    ready = true;\n                    dispatchEvent('iv:playerReady');\n                }\n                video.volume(1);\n\n                video.on(\"pause\", () => {\n                    if (!ready) {\n                        return;\n                    }\n                    dispatchEvent('iv:playerPaused');\n                });\n\n                video.on(\"seek\", (e) => {\n                    if (!ready) {\n                        return;\n                    }\n                    dispatchEvent('iv:playerSeek', {time: e});\n                });\n\n                video.bind('play', () => {\n                    if (!ready) {\n                        return;\n                    }\n                    dispatchEvent('iv:playerPlaying');\n                    if (video.time() > end) {\n                        dispatchEvent('iv:playerEnded');\n                        video.time(start);\n                        video.pause();\n                    }\n                });\n\n                video.on('timechange', (s) => {\n                    if (!ready) {\n                        return;\n                    }\n                    if (s > end) {\n                        dispatchEvent('iv:playerEnded');\n                        video.time(start);\n                        video.pause();\n                    }\n                });\n\n                video.on(\"error\", (e) => {\n                    dispatchEvent('iv:playerError', {error: e});\n                });\n\n                video.on(\"playbackratechange\", (e) => {\n                    dispatchEvent('iv:playerRateChange', {rate: e});\n                });\n\n            },\n            onError: function(e) {\n                dispatchEvent('iv:playerError', {error: e});\n            }\n        };\n\n        if (!window._wq) {\n            // Add wistia script\n            var tag = document.createElement('script');\n            tag.src = \"https://fast.wistia.com/assets/external/E-v1.js\";\n            var firstScriptTag = document.getElementsByTagName('script')[0];\n            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\n\n            var interval = setInterval(() => {\n                if (window._wq) {\n                    clearInterval(interval);\n                    window._wq.push(wistiaOptions);\n                }\n            }, 1000);\n        } else {\n            window._wq.push(wistiaOptions);\n        }\n    }\n    play() {\n        player.play();\n    }\n    pause() {\n        player.pause();\n    }\n    stop(starttime) {\n        player.pause();\n        player.time(starttime);\n    }\n    seek(time) {\n        return player.time(time);\n    }\n    getCurrentTime() {\n        return player.time();\n    }\n    getDuration() {\n        return player.duration();\n    }\n    isPaused() {\n        return player.state() === 'paused';\n    }\n    isPlaying() {\n        return player.state() === 'playing';\n    }\n    isEnded() {\n        return player.state() === 'ended';\n    }\n    ratio() {\n        if (player.aspect() > 16 / 9) {\n            return player.aspect();\n        } else {\n            return 16 / 9;\n        }\n    }\n    destroy() {\n        player.remove();\n    }\n    getState() {\n        return player.state();\n    }\n    setRate(rate) {\n        player.playbackRate(rate);\n    }\n    mute() {\n        player.mute();\n    }\n    unMute() {\n        player.unmute();\n    }\n    originalPlayer() {\n        return player;\n    }\n    setQuality(quality) {\n        player.videoQuality(quality);\n        return quality;\n    }\n    getQualities() {\n        return {\n            qualities: ['default', '360', '540', '720', '1080', '2160'],\n            currentQuality: player.videoQuality() == 'auto' ? 'default' : player.videoQuality(),\n        };\n    }\n}\n\nexport default Wistia;"],"names":["player","constructor","url","start","end","showControls","type","frequency","support","playbackrate","quality","videoId","exec","html","self","this","get","then","data","posterImage","thumbnail_url","ready","wistiaOptions","id","onReady","video","Math","min","duration","play","time","pause","on","volume","e","bind","s","error","rate","onError","window","_wq","push","tag","document","createElement","src","firstScriptTag","getElementsByTagName","parentNode","insertBefore","interval","setInterval","clearInterval","stop","starttime","seek","getCurrentTime","getDuration","isPaused","state","isPlaying","isEnded","ratio","aspect","destroy","remove","getState","setRate","playbackRate","mute","unMute","unmute","originalPlayer","setQuality","videoQuality","getQualities","qualities","currentQuality"],"mappings":";;;;;;;;SAyBIA,kKAGAC,YAAYC,IAAKC,MAAOC,IAAKC,mBACpBC,KAAO,cACPH,MAAQA,WACRI,UAAY,QACZC,QAAU,CACXC,cAAc,EACdC,SAAS,OAITC,QAFQ,+DACMC,KAAKV,KACH,QACfS,QAAUA,4BACb,WAAWE,KAAM,yCAAwCF,iEAC9BN,2BAA2BA,yHAEpDS,KAAOC,qBACTC,IAAI,2CAA6Cd,KAC9Ce,MAAK,SAASC,MACXJ,KAAKK,YAAcD,KAAKE,qBAE5BC,OAAQ,EACRC,cAAgB,CAChBC,GAAIZ,QACJa,QAAS,SAASC,OACdzB,OAASyB,MACTrB,IAAOA,IAAyBsB,KAAKC,IAAIvB,IAAKqB,MAAMG,YAAvCH,MAAMG,WACfzB,MAAQ,GACRsB,MAAMI,OACNJ,MAAMK,KAAK3B,OACXsB,MAAMM,QACNN,MAAMO,GAAG,SAAS,KACTX,QACDA,OAAQ,sCACM,wBAKtBA,OAAQ,sCACM,mBAElBI,MAAMQ,OAAO,GAEbR,MAAMO,GAAG,SAAS,KACTX,2CAGS,sBAGlBI,MAAMO,GAAG,QAASE,IACTb,2CAGS,gBAAiB,CAACS,KAAMI,OAG1CT,MAAMU,KAAK,QAAQ,KACVd,4CAGS,oBACVI,MAAMK,OAAS1B,0CACD,kBACdqB,MAAMK,KAAK3B,OACXsB,MAAMM,aAIdN,MAAMO,GAAG,cAAeI,IACff,OAGDe,EAAIhC,0CACU,kBACdqB,MAAMK,KAAK3B,OACXsB,MAAMM,YAIdN,MAAMO,GAAG,SAAUE,wCACD,iBAAkB,CAACG,MAAOH,OAG5CT,MAAMO,GAAG,sBAAuBE,wCACd,sBAAuB,CAACI,KAAMJ,QAIpDK,QAAS,SAASL,uCACA,iBAAkB,CAACG,MAAOH,SAI3CM,OAAOC,IAcRD,OAAOC,IAAIC,KAAKpB,mBAdH,KAETqB,IAAMC,SAASC,cAAc,UACjCF,IAAIG,IAAM,sDACNC,eAAiBH,SAASI,qBAAqB,UAAU,GAC7DD,eAAeE,WAAWC,aAAaP,IAAKI,oBAExCI,SAAWC,aAAY,KACnBZ,OAAOC,MACPY,cAAcF,UACdX,OAAOC,IAAIC,KAAKpB,kBAErB,MAKXO,OACI7B,OAAO6B,OAEXE,QACI/B,OAAO+B,QAEXuB,KAAKC,WACDvD,OAAO+B,QACP/B,OAAO8B,KAAKyB,WAEhBC,KAAK1B,aACM9B,OAAO8B,KAAKA,MAEvB2B,wBACWzD,OAAO8B,OAElB4B,qBACW1D,OAAO4B,WAElB+B,iBAC8B,WAAnB3D,OAAO4D,QAElBC,kBAC8B,YAAnB7D,OAAO4D,QAElBE,gBAC8B,UAAnB9D,OAAO4D,QAElBG,eACQ/D,OAAOgE,SAAW,GAAK,EAChBhE,OAAOgE,SAEP,GAAK,EAGpBC,UACIjE,OAAOkE,SAEXC,kBACWnE,OAAO4D,QAElBQ,QAAQ9B,MACJtC,OAAOqE,aAAa/B,MAExBgC,OACItE,OAAOsE,OAEXC,SACIvE,OAAOwE,SAEXC,wBACWzE,OAEX0E,WAAWhE,gBACPV,OAAO2E,aAAajE,SACbA,QAEXkE,qBACW,CACHC,UAAW,CAAC,UAAW,MAAO,MAAO,MAAO,OAAQ,QACpDC,eAAyC,QAAzB9E,OAAO2E,eAA2B,UAAY3E,OAAO2E"}