{"version":3,"file":"wistia.min.js","sources":["../../src/player/wistia.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Wistia Player class\n * Doc: https://docs.wistia.com/docs/javascript-player-api\n *\n * @module     mod_interactivevideo/player/wistia\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport {dispatchEvent} from 'core/event_dispatcher';\nlet player;\n\nclass Wistia {\n    /**\n     * Constructs a new Wistia player instance.\n     *\n     * @param {string} url - The URL of the Wistia video.\n     * @param {number} start - The start time of the video in seconds.\n     * @param {number} end - The end time of the video in seconds.\n     * @param {object} opts - The options for the player.\n     */\n    constructor(url, start, end, opts = {}) {\n        const showControls = opts.showControls || false;\n        const node = opts.node || 'player';\n        this.type = 'wistia';\n        this.start = start;\n        this.frequency = 0.3;\n        this.support = {\n            playbackrate: true,\n            quality: true,\n        };\n        if (!showControls) {\n            $('body').addClass('no-original-controls');\n        }\n        // Wistia does not load the video if the player is not visible, so we need to make sure the node parent is visible.\n        $(`#${node}`).parent().removeClass('d-none');\n        const regex = /(?:https?:\\/\\/)?(?:www\\.)?(?:wistia\\.com)\\/medias\\/([^/]+)/g;\n        const match = regex.exec(url);\n        const videoId = match[1];\n        this.videoId = videoId;\n        $(`#${node}`).html(`<div class=\"wistia_embed wistia_async_${videoId} wmode=transparent\n             controlsVisibleOnLoad=${showControls} playButton=${showControls} videoFoam=false silentAutoPlay=allow playsinline=true\n              fullscreenButton=false time=${start} fitStrategy=contain\" style=\"height:100%;width:100%\"></div>`);\n        let self = this;\n        $.get('https://fast.wistia.com/oembed.json?url=' + url)\n            .then(function(data) {\n                self.posterImage = data.thumbnail_url;\n                self.title = data.title;\n                return self.posterImage;\n            }).catch(() => {\n                return;\n            });\n        let ready = false;\n        const wistiaOptions = {\n            id: videoId,\n            onReady: async function(video) {\n                player = video;\n                end = !end ? video.duration() : Math.min(end, video.duration());\n                self.aspectratio = self.ratio();\n                self.end = end;\n                dispatchEvent('iv:playerLoaded', {\n                    tracks: null,\n                    qualities: self.getQualities(),\n                });\n                if (start > 0) {\n                    video.play();\n                    await video.time(start);\n                    await video.pause();\n                    video.on(\"pause\", () => {\n                        if (!ready) {\n                            ready = true;\n                            dispatchEvent('iv:playerReady');\n                        }\n                    });\n                } else {\n                    ready = true;\n                    dispatchEvent('iv:playerReady');\n                }\n                video.unmute();\n\n                video.on(\"pause\", () => {\n                    if (!ready) {\n                        return;\n                    }\n                    dispatchEvent('iv:playerPaused');\n                });\n\n                video.on(\"seek\", (e) => {\n                    if (!ready) {\n                        return;\n                    }\n                    dispatchEvent('iv:playerSeek', {time: e});\n                });\n\n                video.bind('play', () => {\n                    if (!ready) {\n                        return;\n                    }\n                    dispatchEvent('iv:playerPlaying');\n                    if (video.time() > end) {\n                        dispatchEvent('iv:playerEnded');\n                        video.time(start);\n                        video.pause();\n                    }\n                });\n\n                video.on('timechange', (s) => {\n                    if (!ready) {\n                        return;\n                    }\n                    if (s > end) {\n                        dispatchEvent('iv:playerEnded');\n                        video.time(start);\n                        video.pause();\n                    }\n                });\n\n                video.on(\"error\", (e) => {\n                    dispatchEvent('iv:playerError', {error: e});\n                });\n\n                video.on(\"playbackratechange\", (e) => {\n                    dispatchEvent('iv:playerRateChange', {rate: e});\n                });\n\n            },\n            onError: function(e) {\n                dispatchEvent('iv:playerError', {error: e});\n            }\n        };\n\n        if (!window._wq) {\n            // Add wistia script\n            var tag = document.createElement('script');\n            tag.src = \"https://fast.wistia.com/assets/external/E-v1.js\";\n            tag.async = true;\n            tag.as = \"script\";\n            tag.rel = \"preload\";\n            var firstScriptTag = document.getElementsByTagName('script')[0];\n            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\n\n            var interval = setInterval(() => {\n                if (window._wq) {\n                    clearInterval(interval);\n                    window._wq.push(wistiaOptions);\n                }\n            }, 1000);\n        } else {\n            window._wq.push(wistiaOptions);\n        }\n    }\n    /**\n     * Plays the Wistia video player.\n     *\n     * This method triggers the play action on the Wistia player instance.\n     */\n    play() {\n        player.play();\n    }\n    /**\n     * Pauses the Wistia video player.\n     *\n     * This method calls the `pause` function on the Wistia player instance,\n     * effectively pausing the video playback.\n     */\n    async pause() {\n        await player.pause();\n    }\n    /**\n     * Stops the video playback and sets the playback time to the specified start time.\n     *\n     * @param {number} starttime - The time (in seconds) to set the video playback to after pausing.\n     */\n    stop(starttime) {\n        player.pause();\n        player.time(starttime);\n    }\n    /**\n     * Seeks the video player to a specified time.\n     *\n     * @param {number} time - The time in seconds to seek to.\n     * @returns {number} The time that was sought to.\n     */\n    seek(time) {\n        player.time(time);\n        dispatchEvent('iv:playerSeek', {time: time});\n        return time;\n    }\n    /**\n     * Retrieves the current playback time of the video player.\n     *\n     * @returns {number} The current time of the video in seconds.\n     */\n    getCurrentTime() {\n        return player.time();\n    }\n    /**\n     * Retrieves the duration of the video.\n     *\n     * @returns {number} The duration of the video in seconds.\n     */\n    getDuration() {\n        return player.duration();\n    }\n    /**\n     * Checks if the video player is currently paused.\n     *\n     * @returns {boolean} True if the player is paused, false otherwise.\n     */\n    isPaused() {\n        return player.state() === 'paused';\n    }\n    /**\n     * Checks if the video player is currently playing.\n     *\n     * @returns {boolean} True if the player is in the 'playing' state, otherwise false.\n     */\n    isPlaying() {\n        return player.state() === 'playing';\n    }\n    /**\n     * Checks if the video player has reached the end of the video.\n     *\n     * @returns {boolean} True if the video has ended, otherwise false.\n     */\n    isEnded() {\n        return player.state() === 'ended';\n    }\n    /**\n     * Calculates the aspect ratio for the video player.\n     * If the player's aspect ratio is greater than 16:9, it returns the player's aspect ratio.\n     * Otherwise, it returns the default aspect ratio of 16:9.\n     *\n     * @returns {number} The aspect ratio of the video player.\n     */\n    ratio() {\n        return player.aspect();\n    }\n\n    /**\n     * Destroys the Wistia player instance by removing it from the DOM.\n     */\n    destroy() {\n        player.remove();\n    }\n    /**\n     * Retrieves the current state of the player.\n     *\n     * @returns {Object} The current state of the player.\n     */\n    getState() {\n        return player.state();\n    }\n    /**\n     * Sets the playback rate of the video player.\n     *\n     * @param {number} rate - The desired playback rate.\n     */\n    setRate(rate) {\n        player.playbackRate(rate);\n    }\n    /**\n     * Mutes the Wistia player.\n     */\n    mute() {\n        player.mute();\n    }\n    /**\n     * Unmutes the video player.\n     */\n    unMute() {\n        player.unmute();\n    }\n    /**\n     * Returns the original Wistia player instance.\n     *\n     * @returns {Object} The Wistia player instance.\n     */\n    originalPlayer() {\n        return player;\n    }\n    /**\n     * Sets the video quality for the player and dispatches a quality change event.\n     *\n     * @param {string} quality - The desired video quality to set.\n     * @returns {string} The quality that was set.\n     */\n    setQuality(quality) {\n        player.videoQuality(quality);\n        dispatchEvent('iv:playerQualityChange', {quality: quality});\n        return quality;\n    }\n    /**\n     * Retrieves the available video qualities and the current quality setting.\n     *\n     * @returns {Object} An object containing:\n     * - `qualities` {Array<string>}: List of available video quality options.\n     * - `qualitiesLabel` {Array<string>}: List of labels corresponding to the video quality options.\n     * - `currentQuality` {string|number}: The current video quality setting.\n     */\n    getQualities() {\n        return {\n            qualities: ['auto', '360', '540', '720', '1080', '2160'],\n            qualitiesLabel: ['Auto', '360p', '540p', '720p', '1080p', '4k'],\n            currentQuality: player.videoQuality() == 'auto' ? 0 : player.videoQuality(),\n        };\n    }\n}\n\nexport default Wistia;"],"names":["player","constructor","url","start","end","opts","showControls","node","type","frequency","support","playbackrate","quality","addClass","parent","removeClass","videoId","exec","html","self","this","get","then","data","posterImage","thumbnail_url","title","catch","ready","wistiaOptions","id","onReady","async","video","Math","min","duration","aspectratio","ratio","tracks","qualities","getQualities","play","time","pause","on","unmute","e","bind","s","error","rate","onError","window","_wq","push","tag","document","createElement","src","as","rel","firstScriptTag","getElementsByTagName","parentNode","insertBefore","interval","setInterval","clearInterval","stop","starttime","seek","getCurrentTime","getDuration","isPaused","state","isPlaying","isEnded","aspect","destroy","remove","getState","setRate","playbackRate","mute","unMute","originalPlayer","setQuality","videoQuality","qualitiesLabel","currentQuality"],"mappings":"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"}