{"version":3,"file":"vimeo.min.js","sources":["../../src/player/vimeo.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Vimeo Player class\n *\n * @module     mod_interactivevideo/player/vimeo\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport { dispatchEvent } from 'core/event_dispatcher';\nlet player;\n\nclass Vimeo {\n    constructor(url, start, end, showControls) {\n        this.type = 'vimeo';\n        this.start = start;\n        this.frequency = 0.27;\n        this.support = {\n            playbackrate: true,\n            quality: false,\n        };\n        // Documented at https://developer.vimeo.com/player/sdk/reference\n        var VimeoPlayer;\n        var regex = /(?:https?:\\/\\/)?(?:www\\.)?(?:vimeo\\.com)\\/(?:video\\/|)([^\\/]+)/g;\n        this.videoId = regex.exec(url)[1];\n        // Get poster image using oEmbed\n        var posterUrl = 'https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/' + this.videoId;\n        var self = this;\n        fetch(posterUrl)\n            .then(response => response.json())\n            .then(data => {\n                var poster = data.thumbnail_url;\n                // Change the dimensions of the poster image to 16:9\n                poster = poster.replace(/_\\d+x\\d+/, '_720x405');\n                self.posterImage = poster;\n            });\n\n        var option = {\n            url: url,\n            width: 1080,\n            height: 720,\n            autoplay: false,\n            quality: showControls ? '540p' : 'auto', // Reduce quality in editor\n            controls: showControls,\n            loop: false,\n            muted: false,\n            playsinline: true,\n            background: false,\n            byline: false,\n            portrait: false,\n            title: false,\n            transparent: false,\n            responsive: false,\n            start_time: start,\n            end_time: end,\n            pip: false,\n            fullscreen: false,\n            watch_full_video: false,\n            play_button_position: 'bottom',\n            keyboard: false,\n        };\n\n        const vimeoEvents = (player) => {\n            player.on('error', function (e) {\n                dispatchEvent('iv:playerError', { error: e });\n            });\n\n            player.on('loaded', function () {\n                player.getDuration().then(function (duration) {\n                    end = !end ? duration : Math.min(end, duration);\n                });\n                dispatchEvent('iv:playerReady');\n            });\n\n            player.on('timeupdate', async function () {\n                let isEnded = await player.getEnded();\n                let currentTime = await player.getCurrentTime();\n                if (isEnded || (end && currentTime >= end)) {\n                    dispatchEvent('iv:playerEnded');\n                    player.pause();\n                } else if (await player.getPaused()) {\n                    dispatchEvent('iv:playerPaused');\n                } else {\n                    dispatchEvent('iv:playerPlaying');\n                }\n            });\n\n            player.on('seeked', function (e) {\n                dispatchEvent('iv:playerSeek', { time: e.seconds });\n            });\n\n            player.on('playbackratechange', function (e) {\n                dispatchEvent('iv:playerRateChange', { rate: e.playbackRate });\n            });\n        };\n        if (!VimeoPlayer) {\n            require(['https://player.vimeo.com/api/player.js'], function (Player) {\n                VimeoPlayer = Player;\n                player = new Player('player', option);\n                vimeoEvents(player);\n            });\n        } else {\n            player = new VimeoPlayer('player', option);\n            vimeoEvents(player);\n        }\n    }\n    play() {\n        player.play();\n    }\n    pause() {\n        player.pause();\n    }\n    stop(starttime) {\n        player.setCurrentTime(starttime);\n        player.pause();\n    }\n    seek(time) {\n        return new Promise((resolve) => {\n            player.setCurrentTime(time);\n            resolve();\n        });\n    }\n    getCurrentTime() {\n        return new Promise((resolve) => {\n            player.getCurrentTime().then(function (time) {\n                resolve(time);\n            });\n        });\n    }\n    getDuration() {\n        return new Promise((resolve) => {\n            player.getDuration().then(function (duration) {\n                resolve(duration);\n            });\n        });\n    }\n    isPaused() {\n        return new Promise((resolve) => {\n            player.getPaused().then(function (paused) {\n                resolve(paused);\n            });\n        });\n    }\n    isPlaying() {\n        return new Promise((resolve) => {\n            player.getPaused().then(function (paused) {\n                resolve(!paused);\n            });\n        });\n    }\n    isEnded() {\n        player.getEnded().then(function (ended) {\n            return Promise.resolve(ended);\n        });\n    }\n    ratio() {\n        return new Promise((resolve) => {\n            // If wide video, use that ratio; otherwise, 16:9\n            player.getVideoWidth().then(function (width) {\n                player.getVideoHeight().then(function (height) {\n                    if (width / height > 16 / 9) {\n                        resolve(width / height);\n                    } else {\n                        resolve(16 / 9);\n                    }\n                });\n            });\n        });\n    }\n    destroy() {\n        player.destroy();\n    }\n    getState() {\n        return new Promise((resolve) => {\n            player.getPaused().then(function (paused) {\n                resolve(paused ? 'paused' : 'playing');\n            });\n        });\n    }\n    setRate(rate) {\n        player.setPlaybackRate(rate);\n    }\n    mute() {\n        player.setVolume(0);\n    }\n    unMute() {\n        player.setVolume(1);\n    }\n    originalPlayer() {\n        return player;\n    }\n    setQuality(quality) {\n        player.setQuality(quality);\n        return quality;\n    }\n    getQuality() {\n        return player.getQualities();\n    }\n}\n\nexport default Vimeo;"],"names":["player","constructor","url","start","end","showControls","VimeoPlayer","type","frequency","support","playbackrate","quality","videoId","exec","posterUrl","this","self","fetch","then","response","json","data","poster","thumbnail_url","replace","posterImage","option","width","height","autoplay","controls","loop","muted","playsinline","background","byline","portrait","title","transparent","responsive","start_time","end_time","pip","fullscreen","watch_full_video","play_button_position","keyboard","vimeoEvents","on","e","error","getDuration","duration","Math","min","async","isEnded","getEnded","currentTime","getCurrentTime","pause","getPaused","time","seconds","rate","playbackRate","require","Player","play","stop","starttime","setCurrentTime","seek","Promise","resolve","isPaused","paused","isPlaying","ended","ratio","getVideoWidth","getVideoHeight","destroy","getState","setRate","setPlaybackRate","mute","setVolume","unMute","originalPlayer","setQuality","getQuality","getQualities"],"mappings":"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"}