{"version":3,"file":"dailymotion.min.js","sources":["../../src/player/dailymotion.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * DailyMotion Player class\n *\n * @module     mod_interactivevideo/player/dailymotion\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport { dispatchEvent } from 'core/event_dispatcher';\nimport $ from 'jquery';\nlet player;\n\nclass DailyMotion {\n    constructor(url, start, end, showControls, customStart = false) {\n        this.type = 'dailymotion';\n        this.start = start;\n        this.frequency = 0.27;\n        // Documented at https://developer.dailymotion.com/player#player-parameters.\n        var reg = /(?:https?:\\/\\/)?(?:www\\.)?(?:dai\\.ly|dailymotion\\.com)\\/(?:embed\\/video\\/|video\\/|)([^\\/]+)/g;\n        var match = reg.exec(url);\n        var videoId = match[1];\n        this.videoId = videoId;\n        var self = this;\n        fetch(`https://api.dailymotion.com/video/${videoId}?fields=thumbnail_720_url`)\n            .then(response => response.json())\n            .then(data => {\n                self.posterImage = data.thumbnail_720_url;\n                return;\n            })\n            .catch(() => {\n                // Do nothing.\n            });\n        var ready = false;\n        var dmOptions = {\n            video: videoId,\n            params: {\n                startTime: start,\n            },\n        };\n        let dailymotion;\n        const dailymotionEvents = (player) => {\n            if (showControls) {\n                player.setQuality(480);\n            }\n            player.getState().then(function (state) {\n                end = !end ? state.videoDuration : Math.min(end, state.videoDuration);\n                return;\n            }).catch(() => {\n                // Do nothing.\n            });\n            // Handle Dailymotion behavior. Video always start from the start time,\n            // So if you seek before starting the video, it will just start from the beginning.\n            // So, to deal with this, we have to start the video as soon as the player is ready.\n            // Let it plays on mute which sometimes include ads. When the ad is done, the VIDEO_START event will fire.\n            // That's when we let user know, player is ready.\n            if (customStart) {\n                player.setMute(true);\n                player.play();\n                player.on(dailymotion.events.VIDEO_START, function () {\n                    if (ready == true) { // When the video is replayed, it will fire VIDEO_START event again.\n                        player.setMute(true);\n                    }\n                    setTimeout(() => {\n                        player.seek(start);\n                        player.setMute(false);\n                        if (!ready) {\n                            player.pause();\n                            ready = true;\n                            dispatchEvent('iv:playerReady');\n                        }\n                    }, 1000);\n                });\n            } else {\n                ready = true;\n                dispatchEvent('iv:playerReady');\n            }\n\n            // Show ads to user so they know ad is playing, not because something is wrong.\n            player.on(dailymotion.events.AD_START, function () {\n                $(\".video-block\").css('background', 'transparent');\n            });\n\n            player.on(dailymotion.events.VIDEO_SEEKEND, function (e) {\n                dispatchEvent('iv:playerSeek', e.videoTime);\n            });\n\n            player.on(dailymotion.events.VIDEO_END, function () {\n                player.seek(start);\n                player.pause();\n                dispatchEvent('iv:playerEnded');\n            });\n\n            player.on(dailymotion.events.VIDEO_TIMECHANGE, function (e) {\n                if (!ready) {\n                    return;\n                }\n\n                if (e.videoTime >= end) {\n                    dispatchEvent('iv:playerEnded');\n                    player.pause();\n                } else if (e.playerIsPlaying === false) {\n                    dispatchEvent('iv:playerPaused');\n                } else if (e.playerIsPlaying === true) {\n                    dispatchEvent('iv:playerPlaying');\n                }\n            });\n\n            player.on(dailymotion.events.PLAYER_ERROR, function (e) {\n                dispatchEvent('iv:playerError', { error: e });\n            });\n        };\n\n        if (!window.dailymotion) {\n            // Add dailymotion script.\n            var tag = document.createElement('script');\n            if (showControls) {\n                tag.src = \"https://geo.dailymotion.com/libs/player/xsyje.js\";\n            } else {\n                tag.src = \"https://geo.dailymotion.com/libs/player/xsyj8.js\";\n            }\n            var firstScriptTag = document.getElementsByTagName('script')[0];\n            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\n\n            window.dailymotion = {\n                onScriptLoaded: () => {\n                    dailymotion = window.dailymotion;\n                    dailymotion.createPlayer(\"player\", dmOptions).then(function (pl) {\n                        player = pl;\n                        dailymotionEvents(player);\n                        return;\n                    }).catch(() => {\n                        // Do nothing.\n                    });\n                }\n            };\n        } else {\n            dailymotion.createPlayer(\"player\", dmOptions).then(function (pl) {\n                player = pl;\n                dailymotionEvents(player);\n                dailymotion = window.dailymotion;\n                return;\n            }).catch(() => {\n                // Do nothing.\n            });\n        }\n    }\n    play() {\n        player.play();\n    }\n    pause() {\n        player.pause();\n    }\n    stop(starttime) {\n        player.seek(starttime);\n        player.pause();\n    }\n    seek(time) {\n        return new Promise((resolve) => {\n            player.seek(time);\n            dispatchEvent('iv:playerSeek', { time: time });\n            resolve();\n        });\n    }\n    getCurrentTime() {\n        return new Promise((resolve) => {\n            player.getState().then(function (state) {\n                resolve(state.videoTime);\n            });\n        });\n    }\n    getDuration() {\n        return new Promise((resolve) => {\n            player.getState().then(function (state) {\n                resolve(state.videoDuration);\n            });\n        });\n    }\n    isPaused() {\n        return new Promise((resolve) => {\n            player.getState().then(function (state) {\n                resolve(!state.playerIsPlaying);\n            });\n        });\n    }\n    isPlaying() {\n        return new Promise((resolve) => {\n            player.getState().then(function (state) {\n                resolve(state.playerIsPlaying);\n            });\n        });\n    }\n    isEnded() {\n        player.getState().then(function (state) {\n            return Promise.resolve(state.playerIsReplayScreen);\n        });\n    }\n    ratio() {\n        return new Promise((resolve) => {\n            // If wide video, use that ratio; otherwise, 16:9.\n            player.getState().then(function (state) {\n                var ratio = state.playerAspectRatio.split(':');\n                if (ratio[0] / ratio[1] > 16 / 9) {\n                    resolve(ratio[0] / ratio[1]);\n                } else {\n                    resolve(16 / 9);\n                }\n            });\n        });\n    }\n    destroy() {\n        player.destroy();\n    }\n    getState() {\n        return new Promise((resolve) => {\n            player.getState().then(function (state) {\n                resolve(state);\n            });\n        });\n    }\n    setRate(rate) {\n        player.setPlaybackRate(rate);\n    }\n    mute() {\n        player.setMute(true);\n    }\n    unMute() {\n        player.setMute(false);\n    }\n    originalPlayer() {\n        return player;\n    }\n    setQuality(quality) {\n        player.setQuality(quality);\n    }\n}\n\nexport default DailyMotion;"],"names":["player","constructor","url","start","end","showControls","customStart","type","frequency","videoId","exec","self","this","fetch","then","response","json","data","posterImage","thumbnail_720_url","catch","ready","dmOptions","video","params","startTime","dailymotion","dailymotionEvents","setQuality","getState","state","Math","min","videoDuration","setMute","play","on","events","VIDEO_START","setTimeout","seek","pause","AD_START","css","VIDEO_SEEKEND","e","videoTime","VIDEO_END","VIDEO_TIMECHANGE","playerIsPlaying","PLAYER_ERROR","error","window","createPlayer","pl","tag","document","createElement","src","firstScriptTag","getElementsByTagName","parentNode","insertBefore","onScriptLoaded","stop","starttime","time","Promise","resolve","getCurrentTime","getDuration","isPaused","isPlaying","isEnded","playerIsReplayScreen","ratio","playerAspectRatio","split","destroy","setRate","rate","setPlaybackRate","mute","unMute","originalPlayer","quality"],"mappings":"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"}