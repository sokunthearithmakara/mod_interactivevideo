{"version":3,"file":"displaycontent.min.js","sources":["../src/displaycontent.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Display content module\n *\n * @module     mod_interactivevideo/displaycontent\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Fragment from 'core/fragment';\nimport { dispatchEvent } from 'core/event_dispatcher';\n\nconst renderContent = async (annotation, format = 'html') => {\n    const args = {\n        ...annotation,\n        contextid: M.cfg.contextid\n    };\n    const fragment = await Fragment.loadFragment('mod_interactivevideo', 'getcontent', M.cfg.contextid, args);\n    if (format === 'html') {\n        return fragment;\n    } else {\n        return JSON.parse(fragment);\n    }\n};\n\nconst formatText = async (text, shorttext = false) => {\n    try {\n        const response = await $.ajax({\n            url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n            type: 'POST',\n            dataType: \"text\",\n            data: {\n                text: text,\n                contextid: M.cfg.contextid,\n                action: 'format_text',\n                sesskey: M.cfg.sesskey,\n                shorttext: shorttext,\n            }\n        });\n        return response;\n    } catch (error) {\n        throw new Error('Failed to format text');\n    }\n};\n\nconst defaultDisplayContent = async (annotation, player) => {\n    const isDarkMode = $('body').hasClass('darkmode');\n    // Play pop sound\n    const audio = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/pop.mp3');\n    audio.play();\n    let displayoptions = annotation.displayoptions;\n    if ($('body').hasClass('mobiletheme')) {\n        displayoptions = 'popup';\n    }\n    // If the wrapper is in fullscreen mode, display the message inline (on top of the video).\n    if ($('#wrapper').hasClass('fullscreen')) {\n        displayoptions = 'inline';\n    }\n\n    let completionbutton = \"\";\n    if (annotation.xp > 0) {\n        completionbutton += `<span class=\"badge\n         ${annotation.completed ? 'alert-success' : 'badge-secondary'} mr-2\">${annotation.xp} XP</span>`;\n    }\n    if (JSON.parse(annotation.prop).hascompletion) {\n        if (annotation.completed) {\n            completionbutton += `<button id=\"completiontoggle\" class=\"btn mark-undone btn-success btn-sm\"\n             data-id=\"${annotation.id}\"><i class=\"bi bi-check2\"></i>\n             <span class=\"ml-2 d-none d-sm-block\">\n             ${M.util.get_string('completionmarkincomplete', 'mod_interactivevideo')}</span></button>`;\n        } else {\n            completionbutton += `<button  id=\"completiontoggle\" class=\"btn mark-done btn-secondary btn-sm\"\n             data-id=\"${annotation.id}\"><i class=\"bi bi-circle\"></i>\n             <span class=\"ml-2 d-none d-sm-block\">\n             ${M.util.get_string('completionmarkcomplete', 'mod_interactivevideo')}</span></button>`;\n        }\n    }\n\n    // Append refresh button after the completion button\n    if (!$('body').hasClass('page-interactions')) {\n        completionbutton += `<button class=\"btn btn-secondary btn-sm ml-2 rotatez-360\" data-id=\"${annotation.id}\" id=\"refresh\">\n        <i class=\"bi bi-arrow-repeat\"></i></button>`;\n    } else {\n        completionbutton = ``;\n    }\n\n    let messageTitle = `<h5 class=\"modal-title text-truncate mb-0\">\n    <i class=\"${JSON.parse(annotation.prop).icon} mr-2 d-none d-md-inline\"></i>${annotation.formattedtitle}</h5>\n                            <div class=\"btns d-flex align-items-center\">\n                            ${completionbutton}\n                            <button class=\"btn mx-2 p-0 close\" aria-label=\"Close\" data-dismiss=\"modal\">\n                            <i class=\"bi bi-x-lg fa-fw fs-25px\"></i>\n                            </button>\n                            </div>`;\n\n    $('#annotation-modal').modal('hide');\n\n    // Handle annotation close event:: when user click on the close button of the annotation\n    $(document).on('click', `#message[data-id='${annotation.id}'] #title .close`, async function (e) {\n        e.preventDefault();\n        $(this).closest(\"#annotation-modal\").modal('hide');\n        const targetMessage = $(this).closest(\"#message\");\n        targetMessage.addClass('bottom-0');\n        setTimeout(function () {\n            targetMessage.remove();\n            dispatchEvent('interactionclose', {\n                annotation: annotation,\n            });\n        }, 100);\n        if (!$('body').hasClass('page-interactions')) {\n            player.play();\n        }\n    });\n\n    switch (displayoptions) {\n        case 'popup':\n            var modal = `<div class=\"modal fade ${$('body').hasClass('iframe') ? 'modal-fullscreen' : ''}\"\n             id=\"annotation-modal\" role=\"dialog\" aria-labelledby=\"annotation-modal\"\n         aria-hidden=\"true\" data-backdrop=\"static\" data-keyboard=\"false\">\n         <div id=\"message\" data-id=\"${annotation.id}\" data-placement=\"popup\"\n          class=\"modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable\" role=\"document\">\n                                    <div class=\"modal-content rounded-lg\">\n                                        <div class=\"modal-header d-flex align-items-center shadow-sm pr-0\" id=\"title\">\n                                            ${messageTitle}\n                                        </div>\n                                        <div class=\"modal-body\" id=\"content\"></div>\n                                        </div>\n                                    </div>\n                                    </div>`;\n            $('#wrapper').append(modal);\n            $('#annotation-modal').modal('show');\n            $('#annotation-modal').on('hide.bs.modal', function () {\n                $('#annotation-modal').remove();\n            });\n\n            $('#annotation-modal').on('shown.bs.modal', function () {\n                $('#annotation-modal .modal-body').fadeIn(300);\n                return Promise.resolve();\n            });\n            break;\n\n        case 'inline':\n            // Cover the video with a message on a white background div\n            $('#video-wrapper').append(`<div id=\"message\" style=\"z-index:5;top:100%\" data-placement=\"inline\"\n         data-id=\"${annotation.id}\">\n        <div id=\"title\" class=\"modal-header shadow-sm pr-0\">${messageTitle}</div><div class=\"modal-body\" id=\"content\">\n        </div></div>`);\n            $(`#message[data-id='${annotation.id}']`).animate({\n                top: '0',\n            }, 300, 'linear', function () {\n                return Promise.resolve();\n            });\n            break;\n        case 'bottom':\n            $('#annotation-content').empty();\n            // Display the content below the video\n            $('#annotation-content').append(`<div id=\"message\" class=\"fade show mt-3 ${!isDarkMode ? 'border' : ''}\n                 rounded-lg bg-white\" data-placement=\"bottom\" data-id=\"${annotation.id}\">\n                 <div id=\"title\" class=\"modal-header shadow-sm pr-0\">${messageTitle}</div>\n                <div class=\"modal-body\" id=\"content\"></div></div>`);\n            // Scroll to annotation-content\n            $('html, body, #page.drawers, .modal-body').animate({\n                scrollTop: $(\"#annotation-content\").offset().top\n            }, 1000, 'swing', function () {\n                return Promise.resolve();\n            });\n            break;\n    }\n\n};\n\nexport { renderContent, defaultDisplayContent, formatText };\n"],"names":["async","annotation","format","args","contextid","M","cfg","fragment","Fragment","loadFragment","JSON","parse","text","shorttext","$","ajax","url","wwwroot","type","dataType","data","action","sesskey","error","Error","player","isDarkMode","hasClass","Audio","play","displayoptions","completionbutton","xp","completed","prop","hascompletion","id","util","get_string","messageTitle","icon","formattedtitle","modal","document","on","e","preventDefault","this","closest","targetMessage","addClass","setTimeout","remove","append","fadeIn","Promise","resolve","animate","top","empty","scrollTop","offset"],"mappings":";;;;;;;yPA0BsBA,eAAOC,gBAAYC,8DAAS,aACxCC,KAAO,IACNF,WACHG,UAAWC,EAAEC,IAAIF,WAEfG,eAAiBC,kBAASC,aAAa,uBAAwB,aAAcJ,EAAEC,IAAIF,UAAWD,YACrF,SAAXD,OACOK,SAEAG,KAAKC,MAAMJ,+BAIPP,eAAOY,UAAMC,mFAEDC,gBAAEC,KAAK,CAC1BC,IAAKX,EAAEC,IAAIW,QAAU,iCACrBC,KAAM,OACNC,SAAU,OACVC,KAAM,CACFR,KAAMA,KACNR,UAAWC,EAAEC,IAAIF,UACjBiB,OAAQ,cACRC,QAASjB,EAAEC,IAAIgB,QACfT,UAAWA,aAIrB,MAAOU,aACC,IAAIC,MAAM,0DAIMxB,MAAOC,WAAYwB,gBACvCC,YAAa,mBAAE,QAAQC,SAAS,YAExB,IAAIC,MAAMvB,EAAEC,IAAIW,QAAU,wCAClCY,WACFC,eAAiB7B,WAAW6B,gBAC5B,mBAAE,QAAQH,SAAS,iBACnBG,eAAiB,UAGjB,mBAAE,YAAYH,SAAS,gBACvBG,eAAiB,cAGjBC,iBAAmB,GACnB9B,WAAW+B,GAAK,IAChBD,kBAAqB,gCAClB9B,WAAWgC,UAAY,gBAAkB,2BAA2BhC,WAAW+B,gBAElFtB,KAAKC,MAAMV,WAAWiC,MAAMC,gBACxBlC,WAAWgC,UACXF,kBAAqB,mGACT9B,WAAWmC,sGAEpB/B,EAAEgC,KAAKC,WAAW,2BAA4B,0CAEjDP,kBAAqB,oGACT9B,WAAWmC,sGAEpB/B,EAAEgC,KAAKC,WAAW,yBAA0B,4CAKlD,mBAAE,QAAQX,SAAS,qBAIpBI,iBAAoB,GAHpBA,kBAAqB,sEAAqE9B,WAAWmC,6EAMrGG,aAAgB,8DACR7B,KAAKC,MAAMV,WAAWiC,MAAMM,qCAAqCvC,WAAWwC,8HAE9DV,wSAMxB,qBAAqBW,MAAM,4BAG3BC,UAAUC,GAAG,QAAU,qBAAoB3C,WAAWmC,sBAAsBpC,eAAgB6C,GAC1FA,EAAEC,qCACAC,MAAMC,QAAQ,qBAAqBN,MAAM,cACrCO,eAAgB,mBAAEF,MAAMC,QAAQ,YACtCC,cAAcC,SAAS,YACvBC,YAAW,WACPF,cAAcG,6CACA,mBAAoB,CAC9BnD,WAAYA,eAEjB,MACE,mBAAE,QAAQ0B,SAAS,sBACpBF,OAAOI,UAIPC,oBACC,YACGY,MAAS,2BAAyB,mBAAE,QAAQf,SAAS,UAAY,mBAAqB,4MAGhE1B,WAAWmC,uXAIHG,gTAMhC,YAAYc,OAAOX,2BACnB,qBAAqBA,MAAM,4BAC3B,qBAAqBE,GAAG,iBAAiB,+BACrC,qBAAqBQ,gCAGzB,qBAAqBR,GAAG,kBAAkB,qCACtC,iCAAiCU,OAAO,KACnCC,QAAQC,uBAIlB,6BAEC,kBAAkBH,OAAQ,2FACpBpD,WAAWmC,qEAC+BG,qGAE/C,qBAAoBtC,WAAWmC,QAAQqB,QAAQ,CAC9CC,IAAK,KACN,IAAK,UAAU,kBACPH,QAAQC,uBAGlB,6BACC,uBAAuBG,4BAEvB,uBAAuBN,OAAQ,2CAA2C3B,WAAwB,GAAX,oFAC5BzB,WAAWmC,8EACbG,6GAGzD,0CAA0CkB,QAAQ,CAChDG,WAAW,mBAAE,uBAAuBC,SAASH,KAC9C,IAAM,SAAS,kBACPH,QAAQC"}