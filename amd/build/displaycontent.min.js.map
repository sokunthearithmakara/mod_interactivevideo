{"version":3,"file":"displaycontent.min.js","sources":["../src/displaycontent.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Display content module\n *\n * @module     mod_interactivevideo/displaycontent\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Fragment from 'core/fragment';\nimport {dispatchEvent} from 'core/event_dispatcher';\n\n/**\n * Return main formatted content of the annotation\n * @param {Object} annotation - The annotation object\n * @param {String} [format='html'] - The format of the content, either 'html' or 'json'\n * @returns {Promise<String|Object>} - The formatted content as a string or parsed JSON object\n */\nconst renderContent = async function(annotation, format = 'html') {\n    const annotationArgs = {\n        ...annotation,\n        contextid: annotation.contextid\n    };\n    let fragment;\n    try {\n        fragment = await Fragment.loadFragment('mod_interactivevideo', 'getcontent', annotation.contextid, annotationArgs);\n    } catch (error) {\n        throw new Error(JSON.stringify(error));\n    }\n    if (format === 'html') {\n        return fragment;\n    } else {\n        return JSON.parse(fragment);\n    }\n};\n\n/**\n * Format content text\n * @param {String} text unformatted text\n * @param {Boolean} shorttext short string or text\n * @returns formatted text\n */\nconst formatText = async function(text, shorttext = false) {\n    try {\n        const response = await $.ajax({\n            url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n            type: 'POST',\n            dataType: \"text\",\n            data: {\n                text: text,\n                contextid: M.cfg.contextid,\n                action: 'format_text',\n                sesskey: M.cfg.sesskey,\n                shorttext: shorttext,\n            }\n        });\n        return response;\n    } catch (error) {\n        throw new Error('Failed to format text');\n    }\n};\n\n/**\n * Displays the content of an annotation based on the specified display options.\n *\n * @async\n * @function defaultDisplayContent\n * @param {Object} annotation - The annotation object containing details to be displayed.\n * @param {Object} player - The video player instance.\n * @returns {Promise<void>}\n *\n * @example\n * const annotation = {\n *   id: 1,\n *   displayoptions: 'popup',\n *   hascompletion: 1,\n *   xp: 10,\n *   completed: false,\n *   formattedtitle: 'Sample Annotation',\n *   prop: '{\"icon\": \"bi bi-info-circle\"}'\n * };\n * const player = videojs('my-video');\n * defaultDisplayContent(annotation, player);\n */\nconst defaultDisplayContent = async function(annotation, player) {\n    const isDarkMode = $('body').hasClass('darkmode');\n\n    // Play pop sound\n    const audio = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/pop.mp3');\n    audio.play();\n\n    let displayoptions = annotation.displayoptions;\n\n    // If the theme is mobile, display the message as a popup.\n    if ($('body').hasClass('mobiletheme') && displayoptions == 'inline') {\n        displayoptions = 'popup';\n    }\n\n    if ($('body').hasClass('embed-mode')) {\n        displayoptions = 'inline';\n    }\n\n    // If the wrapper is in fullscreen mode, display the message inline (on top of the video).\n    if ($('#wrapper').hasClass('fullscreen')) {\n        displayoptions = 'inline';\n    }\n\n    // Add completion button if the annotation has completion criteria.\n    let completionbutton = \"\";\n    // Display the xp badge conditionally.\n    if (annotation.hascompletion == 1 && annotation.xp > 0) {\n        const earned = annotation.earned == annotation.xp ? annotation.earned : annotation.earned + '/' + annotation.xp;\n        completionbutton += `<span class=\"badge ${annotation.completed ? 'alert-success' : 'badge-secondary'} mr-2\">\n        ${annotation.completed ? earned : Number(annotation.xp)} XP</span>`;\n    }\n    // Display the completion button conditionally.\n    if (annotation.hascompletion == 1) {\n        if (annotation.completed) {\n            completionbutton += `<button id=\"completiontoggle\" class=\"btn mark-undone btn-success btn-sm border-0\"\n             data-id=\"${annotation.id}\"><i class=\"bi bi-check2\"></i>\n             <span class=\"ml-2 d-none d-sm-block\">\n             ${M.util.get_string('completionmarkincomplete', 'mod_interactivevideo')}</span></button>`;\n        } else {\n            completionbutton += `<button  id=\"completiontoggle\" class=\"btn mark-done btn-secondary btn-sm border-0\"\n             data-id=\"${annotation.id}\"><i class=\"bi bi-circle\"></i>\n             <span class=\"ml-2 d-none d-sm-block\">\n             ${M.util.get_string('completionmarkcomplete', 'mod_interactivevideo')}</span></button>`;\n        }\n    }\n\n    // Append refresh button after the completion button.\n    if (!$('body').hasClass('page-interactions')) {\n        completionbutton += `<button class=\"btn btn-secondary btn-sm ml-2 rotatez-360 border-0\"\n         data-id=\"${annotation.id}\" id=\"refresh\">\n        <i class=\"bi bi-arrow-repeat\"></i></button>`;\n    } else {\n        completionbutton = ``;\n    }\n\n    // Message title.\n    let messageTitle = `<h5 class=\"modal-title text-truncate mb-0\">\n    <i class=\"${JSON.parse(annotation.prop).icon} mr-2 d-none d-md-inline\"></i>${annotation.formattedtitle}</h5>\n                            <div class=\"btns d-flex align-items-center\">\n                            ${completionbutton}\n                            <button class=\"btn mx-2 p-0 border-0\" id=\"close-${annotation.id}\" aria-label=\"Close\">\n                            <i class=\"bi bi-x-lg fa-fw fs-25px\"></i>\n                            </button>\n                            </div>`;\n\n    // Hide existing modal if it shows.\n    $('#annotation-modal').modal('hide');\n\n    // Handle annotation close event:: when user click on the close button of the annotation.\n    $(document).off('click', `#close-${annotation.id}`).on('click', `#close-${annotation.id}`, async function(e) {\n        e.preventDefault();\n        $(this).closest(\"#annotation-modal\").modal('hide');\n        const targetMessage = $(this).closest(\"#message\");\n        targetMessage.addClass('bottom-0');\n        setTimeout(function() {\n            targetMessage.remove();\n            dispatchEvent('interactionclose', {\n                annotation: annotation,\n            });\n        }, 100);\n\n        if (!$('body').hasClass('page-interactions')) { // Do not auto resume if on interactions page.\n            if (player.end != await player.getCurrentTime()) {\n                player.play();\n            }\n        }\n    });\n\n    const handlePopupDisplay = (annotation, messageTitle) => {\n        let modal = `<div class=\"modal fade ${$('body').hasClass('iframe') ? 'modal-fullscreen' : ''}\"\n             id=\"annotation-modal\" role=\"dialog\" aria-labelledby=\"annotation-modal\"\n         aria-hidden=\"true\" data-backdrop=\"static\" data-keyboard=\"false\">\n         <div id=\"message\" data-id=\"${annotation.id}\" data-placement=\"popup\"\n          class=\"modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable ${annotation.type}\" role=\"document\">\n                <div class=\"modal-content rounded-lg\">\n                    <div class=\"modal-header d-flex align-items-center shadow-sm pr-0\" id=\"title\">\n                        ${messageTitle}\n                    </div>\n                    <div class=\"modal-body\" id=\"content\"></div>\n                    </div>\n                </div>\n        </div>`;\n        $('#wrapper').append(modal);\n        $('#annotation-modal').modal('show');\n\n        $('#annotation-modal').on('hide.bs.modal', function() {\n            $('#annotation-modal').remove();\n        });\n\n        $('#annotation-modal').on('shown.bs.modal', function() {\n            $('#annotation-modal .modal-body').fadeIn(300);\n            return Promise.resolve();\n        });\n    };\n\n    const handleInlineDisplay = (annotation, messageTitle) => {\n        $('#video-wrapper').append(`<div id=\"message\" style=\"z-index:105;top:100%\" data-placement=\"inline\"\n         data-id=\"${annotation.id}\" class=\"${annotation.type}\">\n        <div id=\"title\" class=\"modal-header shadow-sm pr-0\">${messageTitle}</div><div class=\"modal-body\" id=\"content\">\n        </div></div>`);\n        $(`#message[data-id='${annotation.id}']`).animate({\n            top: '0',\n        }, 300, 'linear', function() {\n            return Promise.resolve();\n        });\n    };\n\n    const handleBottomDisplay = (annotation, messageTitle, isDarkMode) => {\n        $('#annotation-content').empty();\n        $('#annotation-content').append(`<div id=\"message\" class=\"fade show mt-3 ${!isDarkMode ? 'border' : ''}\n                 rounded-lg bg-white ${annotation.type}\" data-placement=\"bottom\" data-id=\"${annotation.id}\">\n                 <div id='title' class='modal-header shadow-sm pr-0'>${messageTitle}</div>\n                <div class=\"modal-body\" id=\"content\"></div></div>`);\n        $('html, body, #page.drawers, .modal-body').animate({\n            scrollTop: $(\"#annotation-content\").offset().top\n        }, 1000, 'swing', function() {\n            return Promise.resolve();\n        });\n    };\n\n    switch (displayoptions) {\n        case 'popup':\n            handlePopupDisplay(annotation, messageTitle);\n            break;\n        case 'inline':\n            handleInlineDisplay(annotation, messageTitle);\n            break;\n        case 'bottom':\n            handleBottomDisplay(annotation, messageTitle, isDarkMode);\n            break;\n    }\n};\n\nexport {renderContent, defaultDisplayContent, formatText};\n"],"names":["async","annotation","format","annotationArgs","contextid","fragment","Fragment","loadFragment","error","Error","JSON","stringify","parse","text","shorttext","$","ajax","url","M","cfg","wwwroot","type","dataType","data","action","sesskey","player","isDarkMode","hasClass","Audio","play","displayoptions","completionbutton","hascompletion","xp","earned","completed","Number","id","util","get_string","messageTitle","prop","icon","formattedtitle","modal","document","off","on","e","preventDefault","this","closest","targetMessage","addClass","setTimeout","remove","end","getCurrentTime","append","fadeIn","Promise","resolve","handlePopupDisplay","animate","top","handleInlineDisplay","empty","scrollTop","offset","handleBottomDisplay"],"mappings":"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"}