define("mod_interactivevideo/report",["exports","jquery","core/notification","core/toast","mod_interactivevideo/libraries/jszip","mod_interactivevideo/libraries/jquery.dataTables","mod_interactivevideo/libraries/dataTables.bootstrap4","mod_interactivevideo/libraries/dataTables.buttons","mod_interactivevideo/libraries/buttons.bootstrap4","mod_interactivevideo/libraries/buttons.html5"],(function(_exports,_jquery,_notification,_toast,_jszip,_jquery2,_dataTables,_dataTables2,_buttons,_buttons2){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Handle report page
   *
   * @module     mod_interactivevideo/report
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.renderAnnotationLogs=_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_notification=_interopRequireDefault(_notification),_jszip=_interopRequireDefault(_jszip);_exports.init=(cmid,groupid)=>{window.JSZip=_jszip.default;const getContentTypes=_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"getallcontenttypes",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid}}),getReportData=_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",data:{action:"getreportdatabygroup",cmid:cmid,sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,ctxid:M.cfg.courseContextId,groupid:groupid}});let contentTypes,tabledata,itemsdata=(0,_jquery.default)("#itemsdata").text();itemsdata=JSON.parse(itemsdata),_jquery.default.when(getContentTypes,getReportData).done(((ct,data)=>{contentTypes=JSON.parse(ct[0]);var datatableOptions={data:data=data[0],deferRender:!0,rowId:"id",pageLength:25,order:[[1,"asc"]],columns:[{data:"id",visible:!1},{data:"picture",render:function(data,type,row){let deletebutton='<button title="'.concat(M.util.get_string("reset","mod_interactivevideo"),'"\n                         class="btn btn-sm text-danger reset m-1" data-record="').concat(row.completionid,'" data-userid="').concat(row.id,'">\n                         <i class="bi bi-trash3"></i></button>');return'<div class="text-truncate d-flex align-items-center justify-content-between">'.concat(data,"\n                        ").concat(row.completionpercentage>0?deletebutton:"","</div>")},className:"bg-white sticky-left-0"},{data:"firstname",className:"exportable"},{data:"lastname",className:"exportable"},{data:"email",className:"exportable"},{data:"timecreated",render:function(data,type){if(data&&0!=data){var date=new Date(1e3*data);return"display"===type?date.toLocaleString():"filter"===type||"sort"===type?date.getTime():data}return"display"===type?M.util.get_string("notstarted","mod_interactivevideo"):0},className:"exportable"},{data:"timecompleted",render:function(data,type,row){if(data&&0!=data){var date=new Date(1e3*data);return"display"===type?date.toLocaleString():"filter"===type||"sort"===type?date.getTime():data}return row.timecreated?"display"===type?M.util.get_string("inprogress","mod_interactivevideo"):0:""},className:"exportable"},{data:"completionpercentage",render:function(data){return data?data+"%":""},className:"exportable"},{data:"xp",render:function(data){return data||""},className:"exportable"}],language:{lengthMenu:"_MENU_",zeroRecords:M.util.get_string("nofound","mod_interactivevideo"),search:'<span class="d-none d-md-inline">'.concat(M.util.get_string("search","mod_interactivevideo"),"</span>"),info:M.util.get_string("datatableinfo","mod_interactivevideo"),infoEmpty:M.util.get_string("datatableinfoempty","mod_interactivevideo"),infoFiltered:M.util.get_string("datatableinfofiltered","mod_interactivevideo"),paginate:{first:M.util.get_string("first","mod_interactivevideo"),last:M.util.get_string("last","mod_interactivevideo"),next:M.util.get_string("next","mod_interactivevideo"),previous:M.util.get_string("previous","mod_interactivevideo")}},stateSaveParams:function(settings,data){return data.search.search="",data.start=0,data.columns.forEach((function(column){column.search.search=""})),data},stateSave:!0,dom:"<'d-flex w-100 justify-content-between'<'d-flex align-items-start'Bl>'<''f>>t<'row mt-2'<'col-sm-6'i><'col-sm-6'p>>",buttons:[{extend:"copyHtml5",text:'<i class="bi bi-copy fa-fw fs-unset"></i>',className:"btn btn-sm",messageTop:null,title:null,exportOptions:{columns:[".exportable"],format:{body:function(data){const div=document.createElement("div");return div.innerHTML=data,(div.textContent||div.innerText||"").trim()}}}},{extend:"csvHtml5",text:'<i class="bi bi-filetype-csv fa-fw fs-unset"></i>',className:"btn btn-sm",exportOptions:{columns:[".exportable"],format:{body:function(data){const div=document.createElement("div");return div.innerHTML=data,(div.textContent||div.innerText||"").trim()}}}},{extend:"excelHtml5",text:'<i class="bi bi-file-earmark-excel fa-fw fs-unset"></i>',className:"btn btn-sm",exportOptions:{columns:[".exportable"],format:{body:function(data){const div=document.createElement("div");return div.innerHTML=data,(div.textContent||div.innerText||"").trim()}}}}],initComplete:function(){(0,_jquery.default)("table#completiontable").wrap("<div style='overflow:auto;position:relative' class='completiontablewrapper'></div>"),(0,_jquery.default)("#reporttable .dataTables_length ").addClass("d-inline ml-1"),(0,_jquery.default)("#reporttable .dataTables_filter").addClass("d-inline float-right"),(0,_jquery.default)("#reporttable .table-responsive").addClass("p-1"),(0,_jquery.default)("#reporttable .spinner-grow").remove(),(0,_jquery.default)("table#completiontable").removeClass("d-none")}};(0,_jquery.default)("#reporttable th.rotate").each((function(){const itemid=(0,_jquery.default)(this).data("item").toString(),ctype=(0,_jquery.default)(this).data("type");datatableOptions.columns.push({data:null,sortable:!1,className:"text-center exportable",render:function(data,rtype,row){if(!data.completeditems)return'<i class="fa fa-times"></i>';let completiondetails,completeditems=JSON.parse(data.completeditems);try{completiondetails=JSON.parse(data.completiondetails).map((x=>JSON.parse(x)))}catch(e){completiondetails=[]}if(completeditems){if(completeditems.indexOf(itemid)>-1){let details=completiondetails.find((x=>Number(x.id)==Number(itemid)));return details?'<span class="completion-detail '.concat(details.hasDetails?"cursor-pointer":"",'"\n                                 data-id="').concat(itemid,'" data-userid="').concat(row.id,'" data-type="').concat(ctype,'">').concat(details.reportView,"</span>"):""}return'<i class="fa fa-times"></i><span class="d-none">-</span>'}return'<i class="fa fa-times"></i><span class="d-none">-</span>'}})})),tabledata=(0,_jquery.default)("#completiontable").DataTable(datatableOptions),window.console.log(tabledata.data().toArray())})),(0,_jquery.default)(document).on("click","[data-item] a",(function(){let annotationid=(0,_jquery.default)(this).closest("th").data("item"),theAnnotation=itemsdata.find((x=>x.id==annotationid)),tabledatajson=tabledata.rows().data().toArray();var seconds,h,m,s,modal='<div class="modal fade" id="annotation-modal" role="dialog"\n            aria-labelledby="annotation-modal"\n         aria-hidden="true" data-backdrop="static" data-keyboard="false">\n         <div id="message" data-id="'.concat(theAnnotation.id,'" data-placement="popup"\n          class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">\n            <div class="modal-content rounded-lg">\n                <div class="modal-header d-flex align-items-center shadow-sm" id="title">\n                    <h5 class="modal-title text-truncate mb-0">').concat(theAnnotation.formattedtitle+" @ "+(seconds=theAnnotation.timestamp,h=Math.floor(seconds/3600),m=Math.floor(seconds%3600/60),s=Math.floor(seconds%3600%60),(h>0?h+":":"")+(m<10?"0":"")+m+":"+(s<10?"0":"")+s),'</h5>\n                    <div class="btns d-flex align-items-center">\n                        <button class="btn close-modal p-0" aria-label="Close" data-dismiss="modal">\n                        <i class="bi bi-x-lg fa-fw fs-25px"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="modal-body" id="content">\n                <div class="loader w-100 mt-5"></div>\n                </div>\n                </div>\n            </div>\n            </div>');(0,_jquery.default)("body").append(modal),(0,_jquery.default)("#annotation-modal").modal("show"),(0,_jquery.default)("#annotation-modal").on("hide.bs.modal",(function(){(0,_jquery.default)("#annotation-modal").remove()})),(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(function(){(0,_jquery.default)("#annotation-modal .modal-body").fadeIn(300);let amdmodule=contentTypes.find((x=>x.name===theAnnotation.type)).amdmodule;require([amdmodule+""],(function(Module){theAnnotation.completed=!0,(new Module).displayReportView(theAnnotation,tabledatajson)})),(0,_jquery.default)(this).find(".close-modal").focus()}))})),(0,_jquery.default)(document).on("click","td .reset",(function(e){e.preventDefault();const recordid=(0,_jquery.default)(this).data("record");let $this=(0,_jquery.default)(this);_notification.default.deleteCancel(M.util.get_string("deletecompletion","mod_interactivevideo"),M.util.get_string("areyousureyouwanttoresetthecompletiondata","mod_interactivevideo"),M.util.get_string("delete","mod_interactivevideo"),(function(){_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"delete_progress_by_id",recordid:recordid,contextid:M.cfg.contextid,sesskey:M.cfg.sesskey},success:function(response){if("deleted"==response){let targetdata=tabledata.row($this.closest("tr")).data();targetdata.completionpercentage=0,targetdata.timecompleted=0,targetdata.xp=0,targetdata.timecreated=0,targetdata.completeditems=null,targetdata.completiondetails=null,targetdata.completionid=null,tabledata.row($this.closest("tr")).data(targetdata).draw(),(0,_toast.add)(M.util.get_string("completionresetsuccess","mod_interactivevideo"),{type:"success"})}},error:function(){(0,_toast.add)(M.util.get_string("completionreseterror","mod_interactivevideo"),{type:"error"})}})}),null)})),(0,_jquery.default)(document).on("click","td .completion-detail",(function(){let id=(0,_jquery.default)(this).data("id"),userid=(0,_jquery.default)(this).data("userid"),type=(0,_jquery.default)(this).data("type"),amdmodule=contentTypes.find((x=>x.name===type)).amdmodule,theAnnotation=itemsdata.find((x=>x.id==id));require([amdmodule+""],(function(Module){(new Module).getCompletionData(theAnnotation,userid)}))}))};_exports.renderAnnotationLogs=(data,node,title)=>{let tableOptions={data:data.rows,deferRender:!0,pageLength:25,order:[[0,"asc"]],columnDefs:[{targets:"not-sortable",sortable:!1}],language:{lengthMenu:"_MENU_",zeroRecords:M.util.get_string("nofound","mod_interactivevideo"),search:M.util.get_string("search","mod_interactivevideo"),info:M.util.get_string("datatableinfo","mod_interactivevideo"),infoEmpty:M.util.get_string("datatableinfoempty","mod_interactivevideo"),infoFiltered:M.util.get_string("datatableinfofiltered","mod_interactivevideo"),paginate:{first:M.util.get_string("first","mod_interactivevideo"),last:M.util.get_string("last","mod_interactivevideo"),next:M.util.get_string("next","mod_interactivevideo"),previous:M.util.get_string("previous","mod_interactivevideo")}},stateSaveParams:function(settings,data){return data.search.search="",data.start=0,data.columns.forEach((function(column){column.search.search=""})),data},stateSave:!0,dom:"Blft<'row'<'col-sm-6'i><'col-sm-6'p>>",buttons:[{extend:"copyHtml5",text:'<i class="bi bi-copy fa-fw fs-unset"></i>',className:"btn btn-sm",messageTop:null,title:null,exportOptions:{columns:[".exportable"]}},{extend:"csvHtml5",text:'<i class="bi bi-filetype-csv fa-fw fs-unset"></i>',title:title,className:"btn btn-sm",exportOptions:{columns:[".exportable"]}},{extend:"excelHtml5",text:'<i class="bi bi-file-earmark-excel fa-fw fs-unset"></i>',className:"btn btn-sm",title:title,exportOptions:{columns:[".exportable"]}}],initComplete:function(){(0,_jquery.default)("".concat(node," table")).wrap("<div style='overflow:auto;position:relative' class='completiontablewrapper'></div>"),(0,_jquery.default)("".concat(node," .dataTables_length")).addClass("d-inline ml-1"),(0,_jquery.default)("".concat(node," .dataTables_filter")).addClass("d-inline float-right"),(0,_jquery.default)("".concat(node," .table-responsive")).addClass("p-1")}};(0,_jquery.default)("".concat(node," table")).DataTable(tableOptions)}}));

//# sourceMappingURL=report.min.js.map