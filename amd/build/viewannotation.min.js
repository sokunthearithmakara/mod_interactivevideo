/**
 * View page module
 *
 * @module     mod_interactivevideo/viewannotation
 * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_interactivevideo/viewannotation",["jquery","core/event_dispatcher","core/toast","mod_interactivevideo/libraries/jquery-ui"],(function($,_ref,Toast){let annotations,totaltime,activityType,lastanno,contentTypes,displayoptions,releventAnnotations,player,{dispatchEvent:dispatchEvent}=_ref,ctRenderer={};const $videoNav=$("#video-nav"),renderAnnotationItems=async(annos,start,totaltime)=>{releventAnnotations=annos;let actualduration=totaltime;const skipsegments=annos.filter((x=>"skipsegment"==x.type));skipsegments.length>0&&skipsegments.forEach((x=>{const length=Number(x.title)-Number(x.timestamp);actualduration-=length}));const completableAnno=releventAnnotations.filter((x=>JSON.parse(x.prop).hascompletion)),actualAnnotationCounts=completableAnno.length,xp=completableAnno.map((x=>Number(x.xp))).reduce(((a,b)=>a+b),0),completedAnnos=completableAnno.filter((x=>x.completed)),xpEarned=completedAnnos.map((x=>Number(x.xp))).reduce(((a,b)=>a+b),0);var seconds;if($(".metadata").empty(),$(".metadata").append(`<span class="d-inline-block mr-3">\n            <i class="bi bi-stopwatch mr-2"></i>${seconds=Math.ceil(actualduration),seconds<60?seconds+"s":Math.floor(seconds/60)+"m "+seconds%60+"s"}</span>\n            <span class="d-inline-block mr-3">\n        <i class="bi bi-bullseye mr-2"></i>${completedAnnos.length} / ${actualAnnotationCounts}</span>\n        <span class="d-inline-block"><i class="bi bi-star mr-2"></i>${xpEarned} / ${xp}</span>`),$("#video-nav ul").empty(),0==annos.length)return;if(1==displayoptions.preventseeking&&$videoNav.addClass("no-pointer-events"),1==displayoptions.hidemainvideocontrols||1==displayoptions.hideinteractions)return void(1==displayoptions.hidemainvideocontrols&&$("#wrapper").addClass("no-videonav"));new Promise((resolve=>{annos.forEach((async x=>{ctRenderer[x.type].renderItemOnVideoNavigation(x)})),resolve()})).then((()=>{dispatchEvent("annotationitemsrendered",{annotations:annos}),$(".annolistinchapter").empty();const chapteritems=releventAnnotations.filter((x=>"skipsegment"!=x.type&&JSON.parse(x.prop).hascompletion));chapteritems.sort(((a,b)=>a.timestamp-b.timestamp)),chapteritems.forEach((x=>{$('[data-region="chapterlists"] li').each((function(){const cstart=$(this).data("start"),cend=$(this).data("end");x.timestamp>=cstart&&x.timestamp<cend&&$(this).find(".annolistinchapter").append(`<li class="border-bottom anno d-flex align-items-center justify-content-between\n                         px-3 py-2 ${x.completed?"completed":""}" data-id="${x.id}" data-timestamp="${x.timestamp}">\n                         <span class="text-nowrap">\n                         <i class="small bi ${x.completed?"bi-check-circle-fill text-success":"bi-circle"} mr-2"></i>\n                         <i class="${JSON.parse(x.prop).icon} mr-2"></i></span>\n                         <span class="flex-grow-1 text-truncate">${x.formattedtitle}</span>\n                         <span class="text-nowrap">${x.xp}<i class="bi bi-star ml-1"></i></span></li>`)}))}))})).then((()=>{dispatchEvent("chapterrendered",{annotations:releventAnnotations})})),$(document).on("annotationitemsrendered",(function(){$('#controler [data-toggle="tooltip"]').tooltip({container:"#controler",boundary:"window"}),1==displayoptions.disableinteractionclickuntilcompleted&&$videoNav.find("ul li:not(.completed):not(.chapter)").addClass("no-click"),1==displayoptions.disableinteractionclick&&$videoNav.find("ul li:not(.chapter)").addClass("no-click"),1==displayoptions.preventseeking&&($videoNav.find("ul li").addClass("no-click"),$videoNav.addClass("no-click"))}))};return{renderAnnotationItems:renderAnnotationItems,init:function(url,cmid,interaction,course,userid){let start=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,end=arguments.length>6?arguments[6]:void 0,completionpercentage=arguments.length>7?arguments[7]:void 0,gradeiteminstance=arguments.length>8?arguments[8]:void 0,grademax=arguments.length>9?arguments[9]:void 0,vtype=arguments.length>10?arguments[10]:void 0,preventskip=!(arguments.length>11&&void 0!==arguments[11])||arguments[11],moment=arguments.length>12&&void 0!==arguments[12]?arguments[12]:null,doptions=arguments.length>13&&void 0!==arguments[13]?arguments[13]:{},token=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;start=Number(start),isNaN(start)&&(start=0),end=Number(end),isNaN(end)&&(end=null),displayoptions=doptions;let playerReady=!1;const convertSecondsToHMS=seconds=>{const h=Math.floor(seconds/3600),m=Math.floor(seconds%3600/60),s=Math.floor(seconds%3600%60);return(h>0?h+":":"")+(m<10?"0":"")+m+":"+(s<10?"0":"")+s},replaceProgressBars=percentage=>{percentage=percentage>100?100:percentage,$videoNav.find("#progress").replaceWith(`<div id="progress" style="width: ${percentage}%;"></div>`),$videoNav.find("#seekhead").css("left",percentage+"%")},getAnnotations=callback=>{const annnoitems=$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_items",sesskey:M.cfg.sesskey,id:interaction,contextid:M.cfg.courseContextId,token:token,cmid:cmid}}),userprogress=$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_progress",sesskey:M.cfg.sesskey,id:interaction,uid:userid,token:token,cmid:cmid}}),getContentTypes=$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"getallcontenttypes",sesskey:M.cfg.sesskey,token:token,cmid:cmid}});$.when(annnoitems,userprogress,getContentTypes).done((function(annos,progress,ct){annotations=JSON.parse(annos[0]),progress=JSON.parse(progress[0]),contentTypes=JSON.parse(ct[0]),annotations=annotations.filter((x=>!!contentTypes.some((y=>y.name===x.type))&&("skipsegment"===x.type?!(x.timestamp>end||x.title<start):x.timestamp>=start&&x.timestamp<=end)));const completedItems=""==progress.completeditems?[]:JSON.parse(progress.completeditems);annotations=annotations.map((x=>{x.timestamp=Number(x.timestamp),x.xp=Number(x.xp),"skipsegment"==x.type&&(x.title=Number(x.title)),x.prop=JSON.stringify(contentTypes.find((y=>y.name==x.type))),x.completed=completedItems.indexOf(x.id)>-1,"skipsegment"==x.type&&(x.timestamp<start&&x.title>start&&(x.timestamp=start),x.title>end&&x.timestamp<end&&(x.title=end));const advanced=JSON.parse(x.advanced);return x.rerunnable=advanced&&"1"===advanced.replaybehavior,x})),annotations.sort(((a,b)=>a.timestamp-b.timestamp));const skipsegments=annotations.filter((x=>"skipsegment"==x.type));releventAnnotations=[],annotations.forEach((x=>{let shouldAdd=!0;skipsegments.forEach((y=>{Number(x.timestamp)>Number(y.timestamp)&&Number(x.timestamp)<Number(y.title)&&(shouldAdd=!1)})),shouldAdd&&releventAnnotations.push(x)})),releventAnnotations.length>0&&!releventAnnotations.find((x=>"chapter"==x.type))&&releventAnnotations.unshift({id:0,title:M.util.get_string("startchapter","mod_interactivevideo"),formattedtitle:M.util.get_string("startchapter","mod_interactivevideo"),timestamp:start,type:"chapter",prop:JSON.stringify(contentTypes.find((x=>"chapter"==x.name))),xp:0,completed:!0,hide:!0});new Promise((resolve=>{const chapterContentType=contentTypes.find((x=>"chapter"==x.name));contentTypes=contentTypes.filter((x=>releventAnnotations.map((y=>y.type)).includes(x.name))),0==contentTypes.length?($("#chaptertoggle, #chapter-container-left, #chapter-container-right").remove(),resolve(ctRenderer)):$("#chaptertoggle, #chapter-container-left, #chapter-container-right").removeClass("d-none"),contentTypes.find((x=>"chapter"==x.name))||contentTypes.push(chapterContentType);var count=0;contentTypes.forEach((x=>{require([x.amdmodule],(function(Type){ctRenderer[x.name]=new Type(player,releventAnnotations,interaction,course,userid,completionpercentage,gradeiteminstance,grademax,vtype,preventskip,totaltime,start,end,x,cmid,token);try{ctRenderer[x.name].init()}catch(error){}++count==contentTypes.length&&resolve(ctRenderer)}))}))})).then((()=>{renderAnnotationItems(releventAnnotations,0,totaltime),$("#play").removeClass("d-none"),$("#spinner").remove(),$("#video-info").toggleClass("d-none d-flex"),callback()}))}))},runInteraction=async annotation=>{if(player.pause(),lastanno=annotation,$("#annotation-modal").modal("hide"),$("#message").not("[data-placement=bottom]").remove(),$("#end-screen, #start-screen").fadeOut(300),preventskip){const theAnnotations=releventAnnotations.filter((x=>Number(x.timestamp)<Number(annotation.timestamp)&&0==x.completed&&1==JSON.parse(x.prop).hascompletion));if(theAnnotations.length>0){const theAnnotation=theAnnotations[0];return player.pause(),await player.seek(theAnnotation.timestamp-.7>start?theAnnotation.timestamp-.7:start),void Toast.add(M.util.get_string("youmustcompletethepreviousactivity","mod_interactivevideo"),{type:"danger"})}}activityType=ctRenderer[annotation.type],activityType.runInteraction(annotation)},shareMoment=async()=>{if(!moment)return;const urlParams=new URLSearchParams(window.location.search),time=Number(moment);if(time&&!isNaN(time)&&time>=start&&time<=end){$("#video-wrapper #start-screen").hide(0),await player.seek(time),player.play();const theAnnotation=releventAnnotations.find((x=>x.timestamp==time));theAnnotation&&runInteraction(theAnnotation),replaceProgressBars((time-start)/totaltime*100)}urlParams.delete("t");const newurl=window.location.protocol+"//"+window.location.host+window.location.pathname+"?"+urlParams.toString();window.history.replaceState(null,null,newurl)},onReady=()=>{player.posterImage&&$("#video-wrapper #start-screen").css({background:`url(${player.posterImage}) no-repeat center center / cover`}),$(".video-block").css("background","transparent"),player.getDuration().then((duration=>{end=end?Math.min(end,duration):duration,start=start>end?0:start,totaltime=end-start,getAnnotations(shareMoment),$("#duration").text(convertSecondsToHMS(totaltime))})),player.ratio().then((ratio=>{$("#video-wrapper").css("padding-bottom",1/ratio*100+"%")})),playerReady=!0,$("#start-screen #start").focus(),$("#seekhead").draggable({containment:"#video-nav",axis:"x",cursor:"col-resize",start:function(){$(this).addClass("active"),$("#taskinfo").addClass("no-pointer-events"),$("#message, #end-screen").remove()},drag:async function(event,ui){let timestamp=ui.position.left/$("#video-nav").width()*totaltime+start;await player.seek(timestamp),player.pause()},stop:async function(event,ui){setTimeout((function(){$("#taskinfo").removeClass("no-pointer-events")}),200),setTimeout((function(){$("#seekhead").removeClass("active")}),1e3);let percentage=ui.position.left/$("#video-nav").width();replaceProgressBars(100*percentage),player.play()}})},onPaused=()=>{playerReady&&(clearInterval(interval),$("#playpause").find("i").removeClass("bi-pause-fill").addClass("bi-play-fill"),$("#playpause").attr("data-original-title",M.util.get_string("play","mod_interactivevideo")))},onEnded=t=>{if(!playerReady)return;const time=t||end,theAnnotation=releventAnnotations.find((x=>x.timestamp==time));theAnnotation&&!lastanno&&(theAnnotation.completed&&!theAnnotation.rerunnable||(player.pause(),runInteraction(theAnnotation)),$videoNav.find('.annotation[data-id="'+theAnnotation.id+'"] .item').tooltip("show"),setTimeout((function(){$videoNav.find('.annotation[data-id="'+theAnnotation.id+'"] .item').tooltip("hide")}),2e3)),$("#restart").removeClass("d-none").fadeIn(300),$("#end-screen").removeClass("d-none").fadeIn(300),$("#progress").css("width","100%"),$("#seekhead").css("left","100%"),clearInterval(interval),player.pause(),$("#playpause").find("i").removeClass("bi-pause-fill").addClass("bi-play-fill"),$("#playpause").attr("data-original-title",M.util.get_string("play","mod_interactivevideo"))},onSeek=async t=>{if(playerReady){(t=t?Number(t):await player.getCurrentTime())>start&&t<end&&$("#end-screen, #start-screen").addClass("d-none");var percentage=(t-start)/totaltime*100;$("#currenttime").text(convertSecondsToHMS(t-start)),replaceProgressBars(percentage)}};let interval;const onPlaying=async()=>{if(!playerReady)return;$("body").hasClass("mobiletheme")&&!$("#wrapper").hasClass("fullscreen")&&$("#fullscreen").trigger("click"),$("#annotation-modal").modal("hide"),$("#message").not("[data-placement=bottom]").remove(),$("#end-screen, #start-screen").fadeOut(300),$("#restart").addClass("d-none"),$("#playpause").find("i").removeClass("bi-play-fill").addClass("bi-pause-fill"),$("#playpause").attr("data-original-title",M.util.get_string("pause","mod_interactivevideo"));const intervalFunction=async function(){const isPlaying=await player.isPlaying(),isEnded=await player.isEnded();if(!isPlaying||isEnded)return void clearInterval(interval);const t=await player.getCurrentTime();if(t>end||isEnded)return clearInterval(interval),void onEnded(end);dispatchEvent("timeupdate",{time:t});const time=Math.round(t);if(!lastanno||time!=lastanno.timestamp){{lastanno&&time>lastanno.timestamp&&(lastanno=null);let percentagePlayed=(t-start)/totaltime;$("#currenttime").text(convertSecondsToHMS(t-start)),percentagePlayed=percentagePlayed>1?1:percentagePlayed,$("#video-nav #progress").css("width",100*percentagePlayed+"%"),$("#video-nav #seekhead").css("left",100*percentagePlayed+"%");const theAnnotation=releventAnnotations.find((x=>(t-player.frequency<=x.timestamp&&t+player.frequency>=x.timestamp||time==x.timestamp)&&0!=x.id));theAnnotation&&(theAnnotation.completed&&!theAnnotation.rerunnable?($('#video-nav .annotation[data-id="'+theAnnotation.id+'"] .item').tooltip("show"),setTimeout((function(){$('#video-nav .annotation[data-id="'+theAnnotation.id+'"] .item').tooltip("hide")}),2e3)):(player.pause(),$("#video-nav #progress").css("width",(theAnnotation.timestamp-start)/totaltime*100+"%"),$("#video-nav #seekhead").css("left",(theAnnotation.timestamp-start)/totaltime*100+"%"),runInteraction(theAnnotation)))}$(document).on("keydown",(function(e){32==e.keyCode&&(e.preventDefault(),player.pause())}))}};"yt"==player.type||"wistia"==player.type?interval=setInterval(intervalFunction,100*player.frequency):intervalFunction()};require(["mod_interactivevideo/player/"+vtype],(function(VideoPlayer){player=new VideoPlayer(url,start,end,1==displayoptions.useoriginalvideocontrols,!0,!1)}));let $toast=$(".toast-wrapper").detach();$("#wrapper").append($toast),$(document).on("timeupdate",(async function(e){const t=e.originalEvent.detail.time;if(preventskip){const theAnnotations=releventAnnotations.filter((x=>Number(x.timestamp)<=t+player.frequency&&0==x.completed&&1==JSON.parse(x.prop).hascompletion));if(theAnnotations.length>0){const theAnnotation=theAnnotations[0];player.pause(),await player.seek(theAnnotation.timestamp-.7>start?theAnnotation.timestamp-.7:start),clearInterval(interval),Toast.add(M.util.get_string("youmustcompletethepreviousactivity","mod_interactivevideo"),{type:"danger"}),$videoNav.find("#progress").css("width",(theAnnotation.timestamp-start)/totaltime*100+"%"),$videoNav.find("#seekhead").css("left",(theAnnotation.timestamp-start)/totaltime*100+"%")}}})),$(document).on("click","#refresh",(function(e){e.preventDefault(),e.stopImmediatePropagation();const id=$(this).data("id"),annotation=releventAnnotations.find((x=>x.id==id));$(this).closest("#message").find("#content").empty(),runInteraction(annotation,!0)})),$(document).on("click","#fullscreen",(function(e){if(e.preventDefault(),!playerReady)return;let elem=document.getElementById("wrapper");$("#fullscreen").toggleClass("active"),$("#wrapper").hasClass("fullscreen")?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():elem.requestFullscreen?elem.requestFullscreen():elem.mozRequestFullScreen?elem.mozRequestFullScreen():elem.webkitRequestFullscreen?elem.webkitRequestFullscreen():elem.msRequestFullscreen&&elem.msRequestFullscreen()})),$(document).on("fullscreenchange",(function(){document.fullscreenElement?($("#wrapper, #interactivevideo-container").addClass("fullscreen"),$("#video-wrapper").css("padding-bottom","0")):($("#wrapper, #interactivevideo-container").removeClass("fullscreen"),player.ratio().then((ratio=>{$("#video-wrapper").css("padding-bottom",1/ratio*100+"%")}))),$("#wrapper #fullscreen i").toggleClass("bi-fullscreen bi-fullscreen-exit")})),$(document).on("visibilitychange",(function(){"hidden"==document.visibilityState&&player.pause()})),$(document).on("click","#controler #share",(function(e){e.preventDefault(),e.stopImmediatePropagation();const $this=$(this);$this.find("i").toggleClass("bi-share-fill bi-share"),player.getCurrentTime().then((time=>{const url=window.location.href,shareurl=url+(url.indexOf("?")>0?"&":"?")+"t="+Math.round(time);navigator.clipboard.writeText(shareurl).then((function(){$this.attr("data-original-title",M.util.get_string("copied","mod_interactivevideo")).tooltip("show"),setTimeout((function(){$this.attr("data-original-title",M.util.get_string("sharethismoment","mod_interactivevideo")).tooltip("hide"),$this.find("i").toggleClass("bi-share-fill bi-share")}),2e3)}))}))})),$(document).on("mouseenter","#video-nav #seek",(function(e){if(!playerReady)return;$(this).append('<div id="position"><div id="timelabel"></div></div>');let $position=$("#position");const parentOffset=$(this).offset(),relX=e.pageX-parentOffset.left;$position.css("left",relX+3+"px");var percentage=relX/$(this).width(),time=Math.round(percentage*end),formattedTime=convertSecondsToHMS(time);$position.find("#timelabel").text(formattedTime)})),$(document).on("mousemove","#video-nav #seek",(function(e){if(!playerReady)return;const parentOffset=$(this).offset(),relX=e.pageX-parentOffset.left;var percentage=relX/$(this).width(),time=Math.round(percentage*end),formattedTime=convertSecondsToHMS(time);$("#position").css("left",relX+3+"px"),$("#position #timelabel").text(formattedTime)})),$(document).on("mouseleave","#video-nav #seek",(function(){$("#position").remove()})),$(document).on("click","#video-nav .annotation",(async function(e){if(e.preventDefault(),e.stopImmediatePropagation(),$(this).hasClass("no-click"))return void Toast.add(M.util.get_string("youcannotviewthisannotationyet","mod_interactivevideo"),{type:"danger"});const timestamp=$(this).data("timestamp");player.play(),"yt"==player.type&&clearInterval(interval),await player.seek(Number(timestamp)),replaceProgressBars((timestamp-start)/totaltime*100);const id=$(this).data("id"),theAnnotation=releventAnnotations.find((x=>x.id==id));runInteraction(theAnnotation),lastanno=theAnnotation})),$(document).on("click","#video-nav",(async function(e){if(playerReady)if(e.preventDefault(),e.stopImmediatePropagation(),$(this).hasClass("no-click"))Toast.add(M.util.get_string("seekingdisabled","mod_interactivevideo"),{type:"danger"});else{lastanno=null,$("#start-screen").fadeOut(300),$("#end-screen").fadeOut(300);var percentage=e.offsetX/$(this).width();"yt"==player.type&&clearInterval(interval),player.pause(),await player.seek(percentage*totaltime+start),replaceProgressBars(100*percentage),player.play()}})),$(document).on("click","#start-screen #play",(async function(e){e.preventDefault(),$("#start-screen").fadeOut(300),$(this).addClass("d-none"),$videoNav.removeClass("d-none"),await player.seek(start),player.play()})),$(document).on("click","#end-screen #restart",(async function(e){e.preventDefault(),$("#message").remove(),lastanno=null,await player.seek(start),$videoNav.find("#progress").css("width","0%"),$videoNav.find("#seekhead").css("left","0%"),$("#end-screen").fadeOut(300),$(this).addClass("d-none"),$videoNav.removeClass("d-none"),replaceProgressBars(0),player.play()})),$(document).on("click","#video-wrapper .video-block",(async function(e){playerReady&&(clearInterval(interval),e.preventDefault(),player.isPlaying().then((async playing=>{playing?player.pause():player.play()})))})),$(document).on("click","#playpause",(function(e){playerReady&&(e.preventDefault(),$(this).tooltip("hide"),player.isPlaying().then((async playing=>{if(playing)player.pause();else{await player.getCurrentTime()>=end?$("#end-screen #restart").trigger("click"):player.play()}})))})),$(document).on("click","li.anno",(async function(e){e.preventDefault();const id=$(this).data("id");$(`li.annotation[data-id=${id}]`).trigger("click"),$(this).closest("#chapter-container-left").length>0&&$("#chaptertoggle .btn").trigger("click")})),$(document).on("click","#mute",(function(e){e.preventDefault(),$(this).tooltip("hide"),$(this).toggleClass("active"),$(this).hasClass("active")?(player.mute(),$(this).attr("data-original-title",M.util.get_string("unmute","mod_interactivevideo"))):(player.unMute(),$(this).attr("data-original-title",M.util.get_string("mute","mod_interactivevideo"))),$(this).find("i").toggleClass("bi-volume-mute bi-volume-up"),$(this).tooltip("show")})),$(document).on("interactionrun",(function(e){window.console.log(e)})),$(document).on("interactionclose",(function(e){window.console.log(e)})),$(document).on("interactionCompletionUpdated",(function(e){window.console.log(e)})),$(document).on("iv:playerReady",(function(){onReady()})),$(document).on("iv:playerPaused",(function(){onPaused()})),$(document).on("iv:playerPlaying",(function(){onPlaying()})),$(document).on("iv:playerEnded",(function(){onEnded()})),$(document).on("iv:playerSeek",(function(e){onSeek(e.detail.time)})),$(document).on("iv:playerError",(function(){Toast.add(M.util.get_string("thereisanissueloadingvideo","mod_interactivevideo"),{type:"danger"}),$("#spinner").remove()}))}}}));

//# sourceMappingURL=viewannotation.min.js.map