define("mod_interactivevideo/type/base",["exports","jquery","mod_interactivevideo/displaycontent","mod_interactivevideo/viewannotation","core/event_dispatcher","core/toast","core_form/modalform","mod_interactivevideo/libraries/jquery-ui"],(function(_exports,_jquery,_displaycontent,_viewannotation,_event_dispatcher,_toast,_modalform,_jqueryUi){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * TODO describe module base
   *
   * @module     mod_interactivevideo/type/base
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_modalform=_interopRequireDefault(_modalform);var _default=class{constructor(player,annotations,interaction,course,userid,completionpercentage,gradeiteminstance,grademax,vtype,preventskip,totaltime,start,end,properties){this.player=player,this.annotations=annotations,this.interaction=interaction,this.course=course,this.userid=userid,this.completionpercentage=completionpercentage,this.gradeiteminstance=gradeiteminstance,this.grademax=grademax,this.vtype=vtype,this.preventskip=preventskip,this.totaltime=totaltime,this.start=start,this.end=end,this.prop=properties}enableColorPicker(){(0,_jquery.default)(document).on("change",'input[type="color"]',(function(){const color=(0,_jquery.default)(this).val();(0,_jquery.default)(this).closest(".color-picker").css("background-color",color),(0,_jquery.default)(this).closest(".fitem").find('input[type="text"]').val(color)}))}formatContent(text){let shorttext=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,_displaycontent.formatText)(text,shorttext)}render(annotation){let format=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"html";return new Promise((resolve=>{resolve((0,_displaycontent.renderContent)(annotation,format))}))}addNotification(msg){let type=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"danger";(0,_toast.add)(msg,{type:type})}init(){}isSkipped(timestamp){return this.isInSkipSegment(timestamp)||!this.isBetweenStartAndEnd(timestamp)}convertSecondsToHMS(s){const hours=Math.floor(s/3600),minutes=Math.floor(s%3600/60),seconds=Math.floor(s%3600%60);return(hours<10?"0"+hours:hours)+":"+(minutes<10?"0"+minutes:minutes)+":"+(seconds<10?"0"+seconds:seconds)}renderEditItem(annotations,listItem,item){return this.annotations=annotations,listItem.removeAttr("id").removeClass("d-none"),listItem.attr("data-type",item.type),listItem.addClass(item.type+(this.isSkipped(item.timestamp)?" skipped":"")),listItem.attr("data-timestamp",item.timestamp).attr("data-id",item.id),listItem.find(".timestamp").text(this.convertSecondsToHMS(item.timestamp)).attr("data-timestamp",item.timestamp),listItem.find(".title").text(item.formattedtitle),this.prop.hascompletion?(listItem.find(".btn.xp span").text(item.xp),listItem.attr("data-xp",item.xp)):listItem.find(".btn.xp").remove(),listItem.find(".type-icon i").addClass(this.prop.icon),listItem.find(".type-icon").attr("title",this.prop.title),(Number(item.timestamp)>this.end||Number(item.timestamp)<this.start||this.isSkipped(item.timestamp))&&(listItem.find(".title").addClass("text-secondary"),listItem.attr("data-xp",0),listItem.find(".title").append(`<span class="badge badge-warning ml-2">\n                            ${M.util.get_string("skipped","mod_interactivevideo")}</span>`)),listItem.find("[data-field]").attr("data-id",item.id),listItem.find('[data-field="xp"]').val(item.xp),listItem.find('[data-field="title"]').val(item.title),listItem.find('[data-field="timestamp"]').val(this.convertSecondsToHMS(item.timestamp)),this.prop.allowmultiple||listItem.find(".btn.copy").remove(),listItem.appendTo("#annotation-list"),listItem}isBetweenStartAndEnd(timestamp){return timestamp<=this.end&&timestamp>=this.start}isAlreadyAdded(timestamp){return this.annotations.some((x=>x.timestamp==timestamp))}isInSkipSegment(timestamp){return this.annotations.some((x=>"skipsegment"==x.type&&Number(x.timestamp)<Number(timestamp)&&Number(x.title)>Number(timestamp)))}validateTimestampFormat(timestamp){return/^([0-9]{2}):([0-5][0-9]):([0-5][0-9])$/.test(timestamp)}validateTimestampFieldValue(fld,hiddenfield){var self=this;(0,_jquery.default)(document).on("change",`form [name=${fld}]`,(function(e){if(e.preventDefault(),!self.validateTimestampFormat((0,_jquery.default)(this).val()))return self.addNotification(M.util.get_string("invalidtimestampformat","mod_interactivevideo")),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"));var parts=(0,_jquery.default)(this).val().split(":"),timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);if(!self.isBetweenStartAndEnd(timestamp)){var message=M.util.get_string("timemustbebetweenstartandendtime","mod_interactivevideo",{start:self.convertSecondsToHMS(self.start),end:self.convertSecondsToHMS(self.end)});return self.addNotification(message),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))}return self.isAlreadyAdded(timestamp)?(self.addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo")),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))):self.isInSkipSegment(timestamp)?(self.addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo")),void(0,_jquery.default)(this).val((0,_jquery.default)(this).attr("data-initial-value"))):((0,_jquery.default)(`form [name=${hiddenfield}]`).val(timestamp),self.player.seek(timestamp,!0),void self.player.pause())}))}addAnnotation(annotations,timestamp,coursemodule){var self=this;if(this.annotations=annotations,!this.isBetweenStartAndEnd(timestamp)){var message=M.util.get_string("interactioncanonlybeaddedbetweenstartandendtime","mod_interactivevideo",{start:self.convertSecondsToHMS(self.start),end:self.convertSecondsToHMS(self.end)});return void self.addNotification(message)}if(self.isAlreadyAdded(timestamp))return void self.addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"));if(self.isInSkipSegment(timestamp))return void self.addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo"));const startHMS=self.convertSecondsToHMS(self.start),endHMS=self.convertSecondsToHMS(self.end),timestampHMS=timestamp>0?self.convertSecondsToHMS(timestamp):startHMS,data={id:0,timestamp:timestamp>0?timestamp:self.start,timestampassist:timestampHMS,start:startHMS,end:endHMS,contextid:M.cfg.contextid,type:self.prop.name,courseid:self.course,cmid:coursemodule,annotationid:self.interaction,hascompletion:self.prop.hascompletion?1:0};var form=new _modalform.default({formClass:self.prop.form,args:data,modalConfig:{title:M.util.get_string("addinteractiontitle","mod_interactivevideo",{name:self.prop.title.toLowerCase(),time:timestampHMS})}});(0,_jquery.default)("#contentmodal").modal("hide"),(0,_jquery.default)("#addcontentdropdown a").removeClass("active"),form.show(),form.addEventListener(form.events.LOADED,(e=>{setTimeout((()=>{(0,_jquery.default)("body").addClass("modal-open")}),500);try{self.onEditFormLoaded(form,e)}catch(error){}self.validateTimestampFieldValue("timestampassist","timestamp"),form.modal.modal.draggable({handle:".modal-header"})})),form.addEventListener(form.events.FORM_SUBMITTED,(e=>{_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_item",id:e.detail.id,sesskey:M.cfg.sesskey,contextid:M.cfg.courseContextId},success:function(data){var newAnnotation=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:newAnnotation,action:"add"})}})}))}cloneAnnotation(id){_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"copy_item",id:id,sesskey:M.cfg.sesskey,contextid:M.cfg.contextid},success:function(data){var newAnnotation=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:newAnnotation,action:"clone"})}})}editAnnotation(annotations,id){this.annotations=annotations;const annotation=annotations.find((x=>x.id==id)),timestamp=annotation.timestamp,timestampassist=this.convertSecondsToHMS(timestamp);annotation.timestampassist=timestampassist,annotation.start=this.convertSecondsToHMS(this.start),annotation.end=this.convertSecondsToHMS(this.end),annotation.hascompletion=this.prop.hascompletion?1:0,annotation.contextid=M.cfg.contextid;const title="skipsegment"===annotation.type?M.util.get_string("skipsegmentcontent","mod_interactivevideo").toLowerCase():annotation.formattedtitle,form=new _modalform.default({formClass:this.prop.form,args:annotation,modalConfig:{title:M.util.get_string("editinteractiontitle","mod_interactivevideo",{name:title,time:timestampassist})}});form.show(),form.addEventListener(form.events.LOADED,(e=>{try{this.onEditFormLoaded(form,e)}catch(error){}this.validateTimestampFieldValue("timestampassist","timestamp"),form.modal.modal.draggable({handle:".modal-header"})})),form.addEventListener(form.events.FORM_SUBMITTED,(e=>{this.annotations=this.annotations.filter((x=>x.id!=id)),_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_item",id:e.detail.id,sesskey:M.cfg.sesskey,contextid:M.cfg.courseContextId}}).done((function(data){var updated=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"edit"})}))}))}deleteAnnotation(annotations,id){this.annotations=annotations;const annotation=this.annotations.find((x=>x.id==id));_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"delete_item",sesskey:M.cfg.sesskey,id:id,contextid:M.cfg.contextid},success:function(){(0,_event_dispatcher.dispatchEvent)("annotationdeleted",{annotation:annotation})}})}interactionRunEvent(annotation,data){(0,_event_dispatcher.dispatchEvent)("interactionrun",{annotation:annotation,data:data})}onEditFormLoaded(form){return form.modal.modal.find(".modal-body")}postEditCallback(annotation){return this.runInteraction(annotation)}isEditMode(){return(0,_jquery.default)("body").hasClass("page-interactions")}isClickable(annotation){if(this.isEditMode())return!0;const advanced=JSON.parse(annotation.advanced);return"1"==advanced.clickablebeforecompleted&&!annotation.completed||"1"==advanced.clickableaftercompleted&&annotation.completed}isVisible(annotation){if(this.isEditMode())return!0;const advanced=JSON.parse(annotation.advanced);return"1"==advanced.visiblebeforecompleted&&!annotation.completed||"1"==advanced.visibleaftercompleted&&annotation.completed}renderItemOnVideoNavigation(annotation){if(annotation.timestamp<this.start||annotation.timestamp>this.end)return;const percentage=(Number(annotation.timestamp)-this.start)/this.totaltime*100;this.isVisible(annotation)&&(0,_jquery.default)("#video-nav ul").append(`<li class="annotation ${annotation.completed?"completed":""}\n        ${annotation.type} ${this.isClickable(annotation)?"":"no-pointer-events"}" data-timestamp="${annotation.timestamp}"\n        data-id="${annotation.id}" style="left: calc(${percentage}% - 5px)">\n        <div class="item" data-toggle="tooltip" data-container="#wrapper"\n        data-trigger="hover" data-html="true" data-original-title='<i class="${this.prop.icon} mr-1"></i>\n        ${annotation.formattedtitle}'></div></li>`)}renderViewer(annotation){return new Promise((resolve=>{resolve((0,_displaycontent.defaultDisplayContent)(annotation,this.player,this.start,this.end))}))}renderContainer(){}postContentRender(){}postContentRenderEditor(){}setModalDraggable(elem){(0,_jquery.default)(elem).draggable({handle:".modal-header"})}completionCallback(annotations,thisItem,action,type){const $toggleButton=(0,_jquery.default)(`#message[data-id='${thisItem.id}']`).find("#completiontoggle");let audio;return"manual"==type?($toggleButton.prop("disabled",!1),$toggleButton.find("i").removeClass("fa-spin bi-arrow-repeat").addClass("mark-done"==action?"bi-check2":"bi-circle"),$toggleButton.find("span").show()):"automatic"==type&&$toggleButton.find("i").toggleClass("bi-check2 bi-circle"),"mark-done"==action?($toggleButton.removeClass("btn-secondary mark-done").addClass("btn-success mark-undone"),audio=new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/point-awarded.mp3"),audio.play()):"mark-undone"==action&&($toggleButton.removeClass("btn-success mark-undone").addClass("btn-secondary mark-done"),audio=new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/pop.mp3"),audio.play()),$toggleButton.find("span").text(""),thisItem.xp>0&&("mark-undone"==action?this.addNotification(M.util.get_string("xplost","mod_interactivevideo",thisItem.xp),"info"):"mark-done"==action&&this.addNotification(M.util.get_string("xpearned","mod_interactivevideo",thisItem.xp),"success")),"manual"==type?"mark-done"==action?$toggleButton.find("span").text(`${M.util.get_string("completionmarkincomplete","mod_interactivevideo")}`):"mark-undone"==action&&$toggleButton.find("span").text(`${M.util.get_string("completionmarkcomplete","mod_interactivevideo")}`):"automatic"==type&&("mark-done"==action?$toggleButton.find("span").text(`${M.util.get_string("completioncompleted","mod_interactivevideo")}`):"mark-undone"==action&&$toggleButton.find("span").text(`${M.util.get_string("completionincomplete","mod_interactivevideo")}`)),"done"}toggleCompletion(id,action){let type=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"manual";if(this.isEditMode())return Promise.resolve();const gradableitems=this.annotations.filter((x=>"1"==x.hascompletion));window.console.log(gradableitems);var totalXp=gradableitems.map((x=>Number(x.xp))).reduce(((a,b)=>a+b),0),completedItems=gradableitems.filter((x=>x.completed)),earnedXp=completedItems.map((x=>Number(x.xp))).reduce(((a,b)=>a+b),0);completedItems=completedItems.map((x=>x.id));var thisItem=gradableitems.find((x=>x.id==id));"mark-done"==action?(completedItems.push(id.toString()),earnedXp+=Number(thisItem.xp)):"mark-undone"==action&&(completedItems=completedItems.filter((x=>x!=id)),earnedXp-=Number(thisItem.xp));let completed=0;return completedItems.length/gradableitems.length*100>=Number(this.completionpercentage)&&(completed=1),new Promise((resolve=>{_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"save_progress",sesskey:M.cfg.sesskey,id:this.interaction,uid:this.userid,percentage:completedItems.length/gradableitems.length*100,g:parseFloat(earnedXp/totalXp*this.grademax).toFixed(2),gradeiteminstance:this.gradeiteminstance,c:completed,xp:earnedXp,completeditems:JSON.stringify(completedItems)},success:()=>{var annotations=this.annotations.map((x=>(x.id==id&&(x.completed="mark-done"==action),x)));(0,_viewannotation.renderAnnotationItems)(annotations,this.start,this.totaltime),this.completionCallback(annotations,thisItem,action,type),(0,_event_dispatcher.dispatchEvent)("interactionCompletionUpdated",{annotations:annotations,completionpercentage:completedItems.length/gradableitems.length*100,grade:parseFloat(earnedXp/totalXp*this.grademax).toFixed(2),completed:completed,xp:earnedXp,completeditems:completedItems,target:thisItem,action:action,type:type}),resolve()}})}))}enableManualCompletion(){var self=this;(0,_jquery.default)(document).on("click","#message button#completiontoggle",(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)(this).attr("disabled",!0),(0,_jquery.default)(this).find("i").removeClass("bi-check2 bi-circle").addClass("fa-spin bi-arrow-repeat"),(0,_jquery.default)(this).find("span").hide();var annoid=(0,_jquery.default)(this).data("id");self.toggleCompletion(annoid,(0,_jquery.default)(this).hasClass("mark-done")?"mark-done":"mark-undone","manual")}))}runInteraction(annotation){const applyContent=annotation=>{this.render(annotation,"html").then((data=>{let $message=(0,_jquery.default)(`#message[data-id='${annotation.id}']`);$message.find(".modal-body").html(data),$message.find(".modal-body").attr("id","content"),this.postContentRender(annotation),this.interactionRunEvent(annotation,data)}))};if(this.renderViewer(annotation).then((()=>{this.renderContainer(annotation),applyContent(annotation)})),this.enableManualCompletion(),"popup"==annotation.displayoptions){let self=this;(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(function(){self.setModalDraggable("#annotation-modal .modal-dialog")}))}}getCompletionData(annotation,userid){return Promise.resolve({annotation:annotation,userid:userid})}displayReportView(annotation){this.render(annotation,"html").then((data=>{let $message=(0,_jquery.default)(`#message[data-id='${annotation.id}']`);$message.find(".modal-body").html(data),$message.find(".modal-body").attr("id","content"),this.postContentRender(annotation)}))}getLogs(annotation,userids){return new Promise((resolve=>{_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_logs_by_userids",annotationid:annotation.id,contextid:M.cfg.contextid,userids:userids,sesskey:M.cfg.sesskey},success:data=>{try{resolve(JSON.parse(data))}catch(error){resolve([])}}})}))}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=base.min.js.map