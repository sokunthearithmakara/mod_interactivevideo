/**
 * Edit interactions module
 *
 * @module     mod_interactivevideo/editannotation
 * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_interactivevideo/editannotation",["jquery","core/toast","core/notification","core/event_dispatcher"],(function($,addToast,Notification,_ref){let{dispatchEvent:dispatchEvent}=_ref;var player,totaltime,currentTime,ctRenderer=new Object,playerReady=!1;const replaceProgressBars=percentage=>{percentage=percentage>100?100:percentage,$("#video-nav #progress").replaceWith(`<div id="progress"  style="width: ${percentage}%;"></div>`)},renderVideoNav=async(annos,start,totaltime)=>{if(0==annos.length)return $("#taskinfo #completion-info").text("0/0"),void $("#video-nav ul").empty();$("#video-nav ul").empty(),annos.forEach((async x=>{var render=ctRenderer[x.type];await render.renderItemOnVideoNavigation(x)})),player.getCurrentTime().then((time=>{replaceProgressBars((time-start)/totaltime*100)})).catch((()=>{})),dispatchEvent("annotationitemsrendered",{annotations:annos})};return $(document).on("annotationitemsrendered",(function(){$('#wrapper [data-toggle="tooltip"]').tooltip()})),{init:function(url,coursemodule,interaction,course,start,end,coursecontextid){let type=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"yt";const addNotification=function(msg){let type=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";addToast.add(msg,{type:type})};start=Number(start),isNaN(start)&&(start=0),end=Number(end),isNaN(end)&&(end=null);var contentTypes,annotations=[];const convertSecondsToHMS=s=>{var hours=Math.floor(s/3600),minutes=Math.floor(s%3600/60),seconds=Math.floor(s%3600%60);return(hours<10?"0"+hours:hours)+":"+(minutes<10?"0"+minutes:minutes)+":"+(seconds<10?"0"+seconds:seconds)};var activeid=null;const renderAnnotationItems=annotations=>{if(renderVideoNav(annotations,start,totaltime),$("#annotationwrapper .loader").remove(),$("#annotation-list").empty().removeClass("d-flex align-items-center justify-content-center"),0!=annotations.length){annotations.sort((function(a,b){return Number(a.timestamp)-Number(b.timestamp)})),annotations.forEach((function(item){var listItem=$("#annotation-template").clone();ctRenderer[item.type].renderEditItem(annotations,listItem,item)}));var xp=annotations.filter((x=>x.xp)).map((x=>Number(x.xp))).reduce(((a,b)=>a+b),0);if($("#xp span").text(xp),activeid){var activeAnno=annotations.find((x=>x.id==activeid));activeAnno&&ctRenderer[activeAnno.type].postEditCallback(activeAnno)}}else $("#annotation-list").html(`${M.util.get_string("clickaddtoaddinteraction","mod_interactivevideo")}`).addClass("d-flex align-items-center justify-content-center")},getAnnotations=()=>{const getItems=$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_items",sesskey:M.cfg.sesskey,id:interaction,contextid:M.cfg.courseContextId}}),getContentTypes=$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"getallcontenttypes",sesskey:M.cfg.sesskey}});$.when(getItems,getContentTypes).done((function(items,contenttypes){annotations=JSON.parse(items[0]),contentTypes=JSON.parse(contenttypes[0]),annotations=annotations.filter((x=>contentTypes.find((y=>y.name===x.type))));const getRenderers=new Promise((resolve=>{var count=0;contentTypes.forEach((x=>{require([""+x.amdmodule],(function(Type){ctRenderer[x.name]=new Type(player,annotations,interaction,course,0,0,0,0,type,0,totaltime,start,end,x),++count==contentTypes.length&&resolve(ctRenderer)}))}))}));annotations.map((x=>(x.prop=JSON.stringify(contentTypes.find((y=>y.name===x.type))),x))),getRenderers.then((()=>{renderAnnotationItems(annotations)})).catch((()=>{}))}))},validateTimestampFormat=(timestamp,fld,existing)=>!!/^([0-9]{2}):([0-5][0-9]):([0-5][0-9])$/.test(timestamp)||(addNotification(M.util.get_string("invalidtimestampformat","mod_interactivevideo"),"danger"),existing?$(fld).val(existing):$(fld).val(convertSecondsToHMS(start)),!1),validateTimeStartEnd=(timestamp,fld,existing,seconds,checkduration,checkexisting,checkskipsegment)=>{var parts=timestamp.split(":");if(timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]),checkduration&&(timestamp>end||timestamp<start)){var message=M.util.get_string("timemustbebetweenstartandendtime","mod_interactivevideo",{start:convertSecondsToHMS(start),end:convertSecondsToHMS(end)});return addNotification(message,"danger"),existing?$(fld).val(existing):$(fld).val(convertSecondsToHMS(start)),-1}if(checkexisting&&annotations.find((x=>x.timestamp==timestamp))&&timestamp!=seconds)return addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger"),existing?$(fld).val(existing):$(fld).val(convertSecondsToHMS(start)),-1;if(checkskipsegment){var skip=annotations.filter((annotation=>"skipsegment"==annotation.type)).find((x=>Number(x.timestamp)<Number(timestamp)&&Number(x.title)>Number(timestamp)));if(skip)return addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo",{start:convertSecondsToHMS(skip.timestamp),end:convertSecondsToHMS(skip.title)}),"danger"),existing?$(fld).val(existing):$(fld).val(convertSecondsToHMS(start)),-1}return timestamp},runInteraction=annotation=>{player.pause(),$("#annotation-modal").modal("hide"),$("#message").not("[data-placement=bottom]").remove(),$("#end-screen").remove(),ctRenderer[annotation.type].runInteraction(annotation)},onReady=()=>{player.getDuration().then((t=>(end=end?Math.min(end,t):t,start>end&&(start=0),totaltime=end-start,player.ratio().then((ratio=>{$("#video-wrapper").css("padding-bottom",1/ratio*100+"%")})),playerReady=!0,$("#timeframe").text("["+convertSecondsToHMS(start)+" - "+convertSecondsToHMS(end)+"]"),getAnnotations()))).catch((()=>{}))},onEnded=()=>{player.pause(),$("#video-wrapper").append('<div id="end-screen" class="position-absolute w-100 h-100 bg-white d-flex\n                     justify-content-center align-items-center style="top: 0; left: 0;">\n                     <button class="btn btn-danger rounded-circle" style="font-size: 1.5rem;" id="restart">\n                    <i class="bi bi-arrow-repeat" style="font-size: x-large;"></i></button></div>'),$("#video-nav #progress").css("width","100%"),$("#message #restart").focus();var currentAnnotation=annotations.find((annotation=>annotation.timestamp==end));currentAnnotation&&($("#annotation-list tr").removeClass("active"),$(`tr[data-id="${currentAnnotation.id}"]`).addClass("active"),$('#video-nav .annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("show"),setTimeout((function(){$('#video-nav .annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("hide")}),2e3))},onSeek=async t=>{var percentage=((t=t?Number(t):await player.getCurrentTime())-start)/totaltime*100;return $("#video-nav #progress").css("width",percentage+"%")};var onPlayingInterval;const onPlaying=()=>{$("#message, #end-screen").remove();var intervalFunction=async function(){var thisTime=await player.getCurrentTime(),isPlaying=await player.isPlaying(),isEnded=await player.isEnded();if(isPlaying&&!isEnded){if(thisTime<start&&(player.seek(start),thisTime=start),thisTime>=end)return player.stop(end),clearInterval(onPlayingInterval),void onEnded();var percentage=(thisTime-start)/totaltime*100;$("#video-nav #progress").css("width",percentage+"%");var currentAnnotation=annotations.find((x=>thisTime-player.frequency<=x.timestamp&&thisTime+player.frequency>=x.timestamp));currentAnnotation&&($("#annotation-list tr").removeClass("active"),$(`tr[data-id="${currentAnnotation.id}"]`).addClass("active"),$('#video-nav .annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("show"),setTimeout((function(){$('#video-nav .annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("hide")}),2e3));var skip=annotations.filter((annotation=>"skipsegment"==annotation.type)).find((x=>Number(x.timestamp)<Number(thisTime)&&Number(x.title)>Number(thisTime)));skip&&(player.seek(Number(skip.title)),percentage=(skip.title-start)/totaltime*100,replaceProgressBars(percentage))}else clearInterval(onPlayingInterval)};"yt"==player.type||"wistia"==player.type?onPlayingInterval=setInterval(intervalFunction,100):intervalFunction()},onPause=()=>{clearInterval(onPlayingInterval)};require(["mod_interactivevideo/player/"+type],(function(VideoPlayer){player=new VideoPlayer(url,start,end,!0,!0)})),$(document).on("iv:playerReady",(function(){onReady()})),$(document).on("iv:playerPaused",(function(){onPause()})),$(document).on("iv:playerPlaying",(function(){onPlaying()})),$(document).on("iv:playerEnded",(function(){onEnded()})),$(document).on("iv:playerSeek",(function(e){onSeek(e.detail.time)})),$(document).on("annotationupdated",(function(e){var updated=e.originalEvent.detail.annotation,action=e.originalEvent.detail.action;"edit"==action&&(annotations=annotations.filter((function(item){return item.id!=updated.id}))),updated.prop=JSON.stringify(contentTypes.find((x=>x.name===updated.type))),annotations.push(updated),activeid="add"==action?updated.id:null,renderAnnotationItems(annotations),"add"==action||"clone"==action?(addNotification(M.util.get_string("interactionadded","mod_interactivevideo"),"success"),$(`tr[data-id="${updated.id}"]`).addClass("active"),"clone"==action&&setTimeout((function(){$(`tr[data-id="${updated.id}"]`).find('[data-editable="timestamp"]').trigger("contextmenu")}),100)):"edit"==action&&(addNotification(M.util.get_string("interactionupdated","mod_interactivevideo"),"success"),$(`tr[data-id="${updated.id}"]`).addClass("active"),setTimeout((function(){$(`tr[data-id="${updated.id}"]`).removeClass("active")}),1500))})),$(document).on("click","#addcontentdropdown a",(async function(e){if(playerReady){e.preventDefault(),$("#addcontentdropdown a").removeClass("active"),$(this).addClass("active");var contenttype=$(this).data("type");player.pause();var timestamp=currentTime||await player.getCurrentTime();timestamp=Math.floor(timestamp),currentTime=null,ctRenderer[contenttype].addAnnotation(annotations,timestamp,coursemodule)}})),$(document).on("click","tr .edit",(function(e){e.preventDefault();var timestamp=$(this).closest(".annotation").data("timestamp");timestamp&&player.seek(timestamp,!0),player.pause();var id=$(this).closest(".annotation").data("id"),contenttype=$(this).closest(".annotation").data("type");ctRenderer[contenttype].editAnnotation(annotations,id,coursemodule)})),$(document).on("click","tr .copy",(function(e){e.preventDefault();var id=$(this).closest(".annotation").data("id"),contenttype=$(this).closest(".annotation").data("type");ctRenderer[contenttype].cloneAnnotation(id)})),$(document).on("annotationdeleted",(function(e){var annotation=e.originalEvent.detail.annotation;activeid=null,$(`tr[data-id="${annotation.id}"]`).addClass("deleted"),setTimeout((function(){annotations=annotations.filter((function(item){return item.id!=annotation.id})),renderAnnotationItems(annotations),addNotification(M.util.get_string("interactiondeleted","mod_interactivevideo"),"success")}),1e3)})),$(document).on("click",".delete",(function(e){e.preventDefault(),player.pause();var id=$(this).closest(".annotation").data("id"),annotation=annotations.find((x=>x.id==id));Notification.saveCancel(M.util.get_string("deleteinteraction","mod_interactivevideo"),M.util.get_string("deleteinteractionconfirm","mod_interactivevideo"),M.util.get_string("delete","mod_interactivevideo"),(function(){ctRenderer[annotation.type].deleteAnnotation(annotations,id)}),null)})),$(document).on("click",".annotation .title",(function(e){e.preventDefault();var timestamp=$(this).closest(".annotation").data("timestamp");player.seek(timestamp,!0),player.pause(),replaceProgressBars((timestamp-start)/totaltime*100);var id=$(this).closest(".annotation").data("id"),theAnnotation=annotations.find((x=>x.id==id));runInteraction(theAnnotation)})),$(document).on("click",".timestamp",(function(e){e.preventDefault();var timestamp=$(this).data("timestamp");player.seek(timestamp),player.play()})),$(document).on("mousemove","#video-nav #seek",(function(e){if(playerReady){e.preventDefault(),e.stopImmediatePropagation();var percentage=e.offsetX/$(this).width(),time=Math.floor(percentage*totaltime+start),formattedTime=convertSecondsToHMS(time);$(".tooltip").remove(),$("#video-nav #seek #tooltip").remove(),$("#video-nav #seek").append(`<div id="tooltip" class="position-absolute bg-transparent text-white"\n                    data-toggle="tooltip" data-container="#wrapper" data-original-title="${formattedTime}"\n                    style="left: calc(${100*percentage}%); width: 3px;"></div>`),$("#tooltip").tooltip("show")}})),$(document).on("mouseleave","#video-nav #seek",(function(e){playerReady&&(e.preventDefault(),e.stopImmediatePropagation(),$("#video-nav #seek #tooltip").remove(),$(".tooltip").remove())})),$(document).on("click","#video-nav",(async function(e){if(playerReady){e.preventDefault();var percentage=e.offsetX/$(this).width();replaceProgressBars(100*percentage),player.play(),player.seek(percentage*totaltime+start),player.pause(),$("#message, #end-screen").remove()}})),$(document).on("contextmenu","#video-nav",(function(e){if(playerReady){e.preventDefault(),e.stopImmediatePropagation();var percentage=e.offsetX/$(this).width();replaceProgressBars(100*percentage),currentTime=Math.floor(percentage*totaltime)+start,player.seek(currentTime),player.pause(),$("#addcontent").trigger("click")}})),$(document).on("contextmenu","#video-nav .annotation",(function(e){e.preventDefault(),e.stopImmediatePropagation();var id=$(this).data("id");$(`tr.annotation[data-id="${id}"] .edit`).trigger("click")})),$(document).on("click","#video-nav .annotation",(function(e){e.preventDefault(),e.stopImmediatePropagation();var timestamp=$(this).data("timestamp");player.play(),player.seek(timestamp),player.pause(),$('tr.annotation[data-timestamp="'+timestamp+'"]').addClass("active");var id=$(this).data("id"),theAnnotation=annotations.find((x=>x.id==id));runInteraction(theAnnotation)})),$(document).on("contextmenu","[data-editable]",(function(e){if(e.preventDefault(),e.stopImmediatePropagation(),!($("[data-field].editing").length>0)){var fld=$(this).data("editable");$(this).hide(),$(this).siblings('[data-field="'+fld+'"]').removeClass("d-none").focus().addClass("editing")}})),$(document).on("keyup","[data-field].editing",(function(e){$(this).removeClass("is-invalid");var initialValue=$(this).data("initial-value"),val=$(this).val(),fld=$(this).data("field");if(""==val&&$(this).addClass("is-invalid"),"Escape"==e.key)return $(this).val(initialValue),$(this).removeClass("editing"),$(this).addClass("d-none"),void $(this).siblings("[data-editable]").show();if("Enter"!=e.key);else{var seconds;if("timestamp"==fld){var parts=initialValue.split(":");if(seconds=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]),!validateTimestampFormat(val,"[data-field].editing",initialValue))return void $(this).addClass("is-invalid");var timestamp=validateTimeStartEnd(val,"[data-field].editing",initialValue,seconds,!0,!0,!0);if(-1==timestamp)return window.console.log("wtf"),void $(this).addClass("is-invalid");seconds=timestamp}if($(this).hasClass("is-invalid"))return;if(val==initialValue)return $(this).removeClass("editing"),$(this).addClass("d-none"),void $(this).siblings("[data-editable]").show();var id=$(this).data("id");$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quickeditfield",sesskey:M.cfg.sesskey,id:id,field:fld,contextid:M.cfg.contextid,value:"timestamp"==fld?seconds:val},success:function(data){var updated=JSON.parse(data);dispatchEvent("annotationupdated",{annotation:updated,action:"edit"})}})}})),$(document).on("blur","[data-field].editing",(function(){var initialValue=$(this).data("initial-value");$(this).val(initialValue),$(this).removeClass("editing"),$(this).addClass("d-none"),$(this).siblings("[data-editable]").show()})),$(document).on("click","#end-screen #restart",(function(e){e.preventDefault(),$("#end-screen").remove(),player.seek(start),player.play()})),$(document).on("mouseover","tr.annotation",(function(){var id=$(this).data("id");$(`#video-nav ul li[data-id="${id}"] .item`).trigger("mouseover")})),$(document).on("mouseout","tr.annotation",(function(){var id=$(this).data("id");$(`#video-nav ul li[data-id="${id}"] .item`).trigger("mouseout"),$(".tooltip").remove()})),$(document).on("mouseover","#video-nav ul li .item",(function(){var id=$(this).closest("li").data("id");$(`tr.annotation[data-id="${id}"]`).addClass("active")})),$(document).on("mouseout","#video-nav ul li .item",(function(){var id=$(this).closest("li").data("id");$(`tr.annotation[data-id="${id}"]`).removeClass("active")})),$(document).on("change",".timestamp-input",(function(){$(this).removeClass("is-invalid");var parts=$(this).val().split(":"),seconds=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);validateTimestampFormat($(this).val(),this)?-1!=validateTimeStartEnd($(this).val(),this,"00:00:00",seconds,!0,!1,!0)||$(this).addClass("is-invalid"):$(this).addClass("is-invalid")})),$("#contentmodal").on("show.bs.modal",(function(){$("#addcontentdropdown").addClass("modal-body")})),$("#contentmodal").on("hide.bs.modal",(function(){$("#addcontentdropdown a").removeClass("active"),$("#addcontentdropdown").removeClass("modal-body")})),$(document).on("click","#fullscreen",(function(e){if(e.preventDefault(),$(this).hasClass("fullscreen"))$("#distractfreemodal").modal("hide");else{let modal='<div class="modal fade p-0" id="distractfreemodal"\n                     role="dialog" aria-hidden="true" data-backdrop="static"\n    data-keyboard="false">\n    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">\n        <div class="modal-content rounded-0 p-3">\n            <div class="modal-body px-1 px-sm-3" id="distractionfreebody">\n<div class="d-flex w-100 align-items-center justify-content-center mt-5"><div class="spinner-grow text-secondary"\n     style="width: 3rem; height: 3rem;" role="status">\n  <span class="sr-only">Loading...</span>\n</div></div>\n            </div>\n        </div>\n    </div>\n</div>';$("body").append(modal),$("#distractfreemodal").modal("show")}$(this).toggleClass("fullscreen"),$("#distractfreemodal").on("shown.bs.modal",(function(){$("body").addClass("distractionfreemode");let $wrapper=$("#wrapper").clone();$("#distractfreemodal").find("#distractionfreebody").html($wrapper),$("#wrapper").remove()})),$("#distractfreemodal").on("hidden.bs.modal",(function(){$("body").removeClass("distractionfreemode");let $wrapper=$("#distractfreemodal #wrapper").clone();$('[role="main"]').append($wrapper),$("#distractfreemodal").remove()}))}))}}}));

//# sourceMappingURL=editannotation.min.js.map