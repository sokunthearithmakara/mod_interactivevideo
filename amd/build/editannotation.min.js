/**
 * Edit interactions module
 *
 * @module     mod_interactivevideo/editannotation
 * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_interactivevideo/editannotation",["jquery","core/toast","core/notification","core/event_dispatcher","mod_interactivevideo/libraries/jquery-ui"],(function($,addToast,Notification,_ref){let{dispatchEvent:dispatchEvent}=_ref;var player,totaltime,currentTime,ctRenderer=new Object,playerReady=!1;const replaceProgressBars=percentage=>{percentage=percentage>100?100:percentage,$("#video-nav #progress").replaceWith(`<div id="progress"  style="width: ${percentage}%;"></div>`),$("#scrollbar").css("left",percentage+"%")},renderVideoNav=async function(annos,start,totaltime){if(0==annos.length)return void $("#video-nav ul").empty();$("#video-nav ul").empty(),$("#video-timeline-wrapper .skipsegment").remove(),annos.forEach((async x=>{var render=ctRenderer[x.type];await render.renderItemOnVideoNavigation(x)}));const time=await player.getCurrentTime();replaceProgressBars((time-start)/totaltime*100),dispatchEvent("annotationitemsrendered",{annotations:annos})};return{init:function(url,coursemodule,interaction,course,start,end,coursecontextid){let type=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"yt";const addNotification=function(msg){let type=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";addToast.add(msg,{type:type})};start=Number(start),isNaN(start)&&(start=0),end=Number(end),isNaN(end)&&(end=null);var contentTypes,annotations=[];const convertSecondsToHMS=function(s){let dynamic=arguments.length>1&&void 0!==arguments[1]&&arguments[1];var hours=Math.floor(s/3600),minutes=Math.floor(s%3600/60),seconds=Math.floor(s%3600%60);return dynamic&&0==hours?(minutes<10?"0"+minutes:minutes)+":"+(seconds<10?"0"+seconds:seconds):(hours<10?"0"+hours:hours)+":"+(minutes<10?"0"+minutes:minutes)+":"+(seconds<10?"0"+seconds:seconds)};var activeid=null;const renderAnnotationItems=annotations=>{if(renderVideoNav(annotations,start,totaltime),$("#annotationwrapper .loader").remove(),$("#annotation-list").empty().removeClass("d-flex align-items-center justify-content-center"),0!=annotations.length){annotations.sort((function(a,b){return Number(a.timestamp)-Number(b.timestamp)})),annotations.forEach((function(item){var listItem=$("#annotation-template").clone();ctRenderer[item.type].renderEditItem(annotations,listItem,item)}));var xp=annotations.filter((x=>x.xp)).map((x=>Number(x.xp))).reduce(((a,b)=>a+b),0);if($("#xp span").text(xp),activeid){var activeAnno=annotations.find((x=>x.id==activeid));activeAnno&&ctRenderer[activeAnno.type].postEditCallback(activeAnno)}}else $("#annotation-list").html(`${M.util.get_string("clickaddtoaddinteraction","mod_interactivevideo")}`).addClass("d-flex align-items-center justify-content-center")},getAnnotations=()=>{const getItems=$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_items",sesskey:M.cfg.sesskey,id:interaction,contextid:M.cfg.courseContextId}}),getContentTypes=$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"getallcontenttypes",sesskey:M.cfg.sesskey}});$.when(getItems,getContentTypes).done((function(items,contenttypes){annotations=JSON.parse(items[0]),contentTypes=JSON.parse(contenttypes[0]),annotations=annotations.filter((x=>contentTypes.find((y=>y.name===x.type))));const getRenderers=new Promise((resolve=>{var count=0;contentTypes.forEach((x=>{require([""+x.amdmodule],(function(Type){ctRenderer[x.name]=new Type(player,annotations,interaction,course,0,0,0,0,type,0,totaltime,start,end,x,coursemodule),++count==contentTypes.length&&resolve(ctRenderer),ctRenderer[x.name].init()}))}))}));annotations.map((x=>(x.prop=JSON.stringify(contentTypes.find((y=>y.name===x.type))),x))),getRenderers.then((()=>{renderAnnotationItems(annotations)})).catch((()=>{}))}))},validateTimestampFormat=(timestamp,fld,existing)=>!!/^([0-9]{2}):([0-5][0-9]):([0-5][0-9])$/.test(timestamp)||(addNotification(M.util.get_string("invalidtimestampformat","mod_interactivevideo"),"danger"),existing?$(fld).val(existing):$(fld).val(convertSecondsToHMS(start)),!1),validateTimeStartEnd=(timestamp,fld,existing,seconds,checkduration,checkexisting,checkskipsegment)=>{var parts=timestamp.split(":");if(timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]),checkduration&&(timestamp>end||timestamp<start)){var message=M.util.get_string("timemustbebetweenstartandendtime","mod_interactivevideo",{start:convertSecondsToHMS(start,!0),end:convertSecondsToHMS(end,!0)});return addNotification(message,"danger"),existing?$(fld).val(existing):$(fld).val(convertSecondsToHMS(start)),-1}if(checkexisting&&annotations.find((x=>x.timestamp==timestamp))&&timestamp!=seconds)return addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger"),existing?$(fld).val(existing):$(fld).val(convertSecondsToHMS(start)),-1;if(checkskipsegment){var skip=annotations.filter((annotation=>"skipsegment"==annotation.type)).find((x=>Number(x.timestamp)<Number(timestamp)&&Number(x.title)>Number(timestamp)));if(skip)return addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo",{start:convertSecondsToHMS(skip.timestamp,!0),end:convertSecondsToHMS(skip.title,!0)}),"danger"),existing?$(fld).val(existing):$(fld).val(convertSecondsToHMS(start)),-1}return timestamp},runInteraction=annotation=>{$("#annotation-modal").modal("hide"),$("#message").not("[data-placement=bottom]").remove(),$("#end-screen").remove(),player.pause(),ctRenderer[annotation.type].runInteraction(annotation)},onReady=async()=>{let t=await player.getDuration();end=end?Math.min(end,t):t,start>end&&(start=0),totaltime=end-start;let ratio=await player.ratio();$("#video-wrapper").css("padding-bottom",1/ratio*100+"%"),playerReady=!0,$("#timeline #video-timeline").css({"background-image":"url("+player.posterImage+")","background-size":"contain","background-repeat":"no-repeat"}),$("#timeline #duration").text(convertSecondsToHMS(end,!0)),$("#timeline #currenttime").text(convertSecondsToHMS(start,!0));const minutes=Math.floor(totaltime/60);$("#timeline-items-wrapper").css("width",300*minutes+"px"),$("#timeline-items .minute").remove();for(let i=start;i<=end;i+=60){let percentage=(i-start)/totaltime*100,marker="";marker=i>=3600?Math.floor(i/3600)+"h"+Math.floor(i%3600/60)+"m":Math.floor(i/60)+"m",$("#timeline-items").append(`<div class="minute position-absolute" style="left: ${percentage}%">\n                        <div class="minute-label">${marker}</div></div>`)}getAnnotations()},onEnded=()=>{player.pause(),$("#playpause").find("i").removeClass("bi-pause-fill").addClass("bi-play-fill"),$("#video-wrapper").append('<div id="end-screen" class="position-absolute w-100 h-100 bg-white d-flex\n                     justify-content-center align-items-center style="top: 0; left: 0;">\n                     <button class="btn btn-danger rounded-circle" style="font-size: 1.5rem;" id="restart">\n                    <i class="bi bi-arrow-repeat" style="font-size: x-large;"></i></button></div>'),$("#video-nav #progress").css("width","100%"),$("#scrollbar").css("left","100%"),$("#message #restart").focus();var currentAnnotation=annotations.find((annotation=>annotation.timestamp==end));currentAnnotation&&($("#annotation-list tr").removeClass("active"),$(`tr[data-id="${currentAnnotation.id}"]`).addClass("active"),$('#video-nav .annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("show"),setTimeout((function(){$('#video-nav .annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("hide")}),2e3))},onSeek=async function(t){if(playerReady){(t=t?Number(t):await player.getCurrentTime())>start&&t<end&&$("#end-screen").remove();var percentage=(t-start)/totaltime*100;$("#scrollbar").css("left",percentage+"%"),$("#timeline #currenttime").text(convertSecondsToHMS(t,!0)),dispatchEvent("timeupdate",{time:t})}};var onPlayingInterval;const onPlaying=()=>{$("#message, #end-screen").remove(),$("#playpause").find("i").removeClass("bi-play-fill").addClass("bi-pause-fill");var intervalFunction=async function(){var thisTime=await player.getCurrentTime(),isPlaying=await player.isPlaying(),isEnded=await player.isEnded();if(!isPlaying||isEnded)return void clearInterval(onPlayingInterval);if(thisTime<start&&(await player.seek(start),thisTime=start),thisTime>=end)return player.stop(end),clearInterval(onPlayingInterval),void onEnded();dispatchEvent("timeupdate",{time:thisTime}),$("#timeline #currenttime").text(convertSecondsToHMS(thisTime,!0));var percentage=(thisTime-start)/totaltime*100;$("#video-nav #progress").css("width",percentage+"%"),$("#scrollbar").css("left",percentage+"%");const scrollBar=document.getElementById("scrollbar"),rect=scrollBar.getBoundingClientRect();(rect.left<0||rect.right>window.innerWidth)&&scrollBar.scrollIntoView({behavior:"instant",block:"center",inline:"center"});var currentAnnotation=annotations.find((x=>thisTime-player.frequency<=x.timestamp&&thisTime+player.frequency>=x.timestamp));currentAnnotation&&($("#annotation-list tr").removeClass("active"),$(`tr[data-id="${currentAnnotation.id}"]`).addClass("active"),$('#video-nav .annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("show"),setTimeout((function(){$('#video-nav .annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("hide")}),2e3))};"yt"==player.type||"wistia"==player.type?onPlayingInterval=setInterval(intervalFunction,100):intervalFunction()},onPause=()=>{clearInterval(onPlayingInterval),$("#playpause").find("i").removeClass("bi-pause-fill").addClass("bi-play-fill")};require(["mod_interactivevideo/player/"+type],(function(VideoPlayer){player=new VideoPlayer(url,start,end,!0,!0)})),$(document).on("iv:playerReady",(function(){onReady()})),$(document).on("iv:playerPaused",(function(){onPause()})),$(document).on("iv:playerPlaying",(function(){onPlaying()})),$(document).on("iv:playerEnded",(function(){onEnded()})),$(document).on("iv:playerSeek",(function(e){onSeek(e.detail.time)})),$(document).on("annotationupdated",(function(e){var updated=e.originalEvent.detail.annotation,action=e.originalEvent.detail.action;"edit"!=action&&"draft"!=action&&"savedraft"!=action||(annotations=annotations.filter((function(item){return item.id!=updated.id}))),updated.prop=JSON.stringify(contentTypes.find((x=>x.name===updated.type))),annotations.push(updated),activeid="add"==action?updated.id:null,renderAnnotationItems(annotations),"add"==action||"clone"==action?(addNotification(M.util.get_string("interactionadded","mod_interactivevideo"),"success"),$(`tr[data-id="${updated.id}"]`).addClass("active"),"clone"==action&&setTimeout((function(){$(`tr[data-id="${updated.id}"]`).find('[data-editable="timestamp"]').trigger("contextmenu")}),100)):"edit"==action&&(addNotification(M.util.get_string("interactionupdated","mod_interactivevideo"),"success"),$(`tr[data-id="${updated.id}"]`).addClass("active"),setTimeout((function(){$(`tr[data-id="${updated.id}"]`).removeClass("active")}),1500)),annotations.find((x=>"draft"==x.status))?$("#timeline #savedraft").removeAttr("disabled"):$("#timeline #savedraft").attr("disabled","disabled")})),$(document).on("click","#addcontentdropdown a",(async function(e){if(!playerReady)return;e.preventDefault(),$("#addcontentdropdown a").removeClass("active"),$(this).addClass("active");let ctype=$(this).data("type");player.pause();var timestamp=currentTime||await player.getCurrentTime();timestamp=Math.floor(timestamp);var contenttype=contentTypes.find((x=>x.name==ctype));if(contenttype.hastimestamp){if(annotations.find((x=>x.timestamp==timestamp)))return void addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger");if(annotations.filter((x=>"skipsegment"==x.type)).find((x=>Number(x.timestamp)<Number(currentTime)&&Number(x.title)>Number(currentTime))))return void addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo"),"danger")}contenttype.allowmultiple||!annotations.find((x=>x.type==ctype))?(currentTime=null,ctRenderer[ctype].addAnnotation(annotations,timestamp,coursemodule)):addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger")})),$(document).on("click","tr .edit",(async function(e){e.preventDefault();var timestamp=$(this).closest(".annotation").data("timestamp");timestamp&&await player.seek(timestamp,!0),player.pause();var id=$(this).closest(".annotation").data("id"),contenttype=$(this).closest(".annotation").data("type");ctRenderer[contenttype].editAnnotation(annotations,id,coursemodule)})),$(document).on("click","tr .copy",(function(e){e.preventDefault();var id=$(this).closest(".annotation").data("id"),contenttype=$(this).closest(".annotation").data("type");ctRenderer[contenttype].cloneAnnotation(id)})),$(document).on("annotationdeleted",(function(e){var annotation=e.originalEvent.detail.annotation;activeid=null,$(`tr[data-id="${annotation.id}"]`).addClass("deleted"),setTimeout((function(){annotations=annotations.filter((function(item){return item.id!=annotation.id})),renderAnnotationItems(annotations),addNotification(M.util.get_string("interactiondeleted","mod_interactivevideo"),"success")}),1e3)})),$(document).on("click",".delete",(function(e){e.preventDefault(),player.pause();var id=$(this).closest(".annotation").data("id"),annotation=annotations.find((x=>x.id==id));Notification.saveCancel(M.util.get_string("deleteinteraction","mod_interactivevideo"),M.util.get_string("deleteinteractionconfirm","mod_interactivevideo"),M.util.get_string("delete","mod_interactivevideo"),(function(){ctRenderer[annotation.type].deleteAnnotation(annotations,id)}),null)})),$(document).on("click",".annotation .title",(async function(e){e.preventDefault();var timestamp=$(this).closest(".annotation").data("timestamp");await player.seek(timestamp,!0),replaceProgressBars((timestamp-start)/totaltime*100);var id=$(this).closest(".annotation").data("id"),theAnnotation=annotations.find((x=>x.id==id));runInteraction(theAnnotation)})),$(document).on("click",".timestamp",(async function(e){e.preventDefault();var timestamp=$(this).data("timestamp");await player.seek(timestamp),player.play()})),$(document).on("contextmenu","#vseek, #video-timeline",(async function(e){if(playerReady){e.preventDefault(),e.stopImmediatePropagation();var percentage=e.offsetX/$(this).width();replaceProgressBars(100*percentage),currentTime=Math.floor(percentage*totaltime)+start,await player.seek(currentTime),player.pause(),$("#addcontent").trigger("click")}})),$(document).on("contextmenu","#scrollbar",(async function(e){playerReady&&(e.preventDefault(),e.stopImmediatePropagation(),currentTime=await player.getCurrentTime(),$("#addcontent").trigger("click"))})),$(document).on("click","#playpause",(async function(e){if(!playerReady)return;if(e.preventDefault(),await player.isPlaying())player.pause();else{await player.getCurrentTime()>=end?$("#end-screen #restart").trigger("click"):player.play()}})),$(document).on("contextmenu","#video-nav .annotation",(function(e){e.preventDefault(),e.stopImmediatePropagation();var id=$(this).data("id");$(`tr.annotation[data-id="${id}"] .edit`).trigger("click")})),$(document).on("contextmenu","[data-editable]",(function(e){if(e.preventDefault(),e.stopImmediatePropagation(),!($("[data-field].editing").length>0)){var fld=$(this).data("editable");$(this).hide(),$(this).siblings('[data-field="'+fld+'"]').removeClass("d-none").focus().addClass("editing")}})),$(document).on("keyup","[data-field].editing",(function(e){$(this).removeClass("is-invalid");var initialValue=$(this).data("initial-value"),val=$(this).val(),fld=$(this).data("field");if(""==val&&$(this).addClass("is-invalid"),"Escape"==e.key)return $(this).val(initialValue),$(this).removeClass("editing"),$(this).addClass("d-none"),void $(this).siblings("[data-editable]").show();if("Enter"!=e.key);else{var seconds;if("timestamp"==fld){var parts=initialValue.split(":");if(seconds=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]),!validateTimestampFormat(val,"[data-field].editing",initialValue))return void $(this).addClass("is-invalid");var timestamp=validateTimeStartEnd(val,"[data-field].editing",initialValue,seconds,!0,!0,!0);if(-1==timestamp)return window.console.log("wtf"),void $(this).addClass("is-invalid");seconds=timestamp}if($(this).hasClass("is-invalid"))return;if(val==initialValue)return $(this).removeClass("editing"),$(this).addClass("d-none"),void $(this).siblings("[data-editable]").show();var id=$(this).data("id");$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quickeditfield",sesskey:M.cfg.sesskey,id:id,field:fld,contextid:M.cfg.contextid,value:"timestamp"==fld?seconds:val},success:function(data){var updated=JSON.parse(data);dispatchEvent("annotationupdated",{annotation:updated,action:"edit"})}})}})),$(document).on("blur","[data-field].editing",(function(){var initialValue=$(this).data("initial-value");$(this).val(initialValue),$(this).removeClass("editing"),$(this).addClass("d-none"),$(this).siblings("[data-editable]").show()})),$(document).on("click","#end-screen #restart",(async function(e){e.preventDefault(),$("#end-screen").remove(),await player.seek(start),player.play()})),$(document).on("mouseover","tr.annotation",(function(){var id=$(this).data("id");$(`#video-nav ul li[data-id="${id}"] .item`).trigger("mouseover")})),$(document).on("mouseout","tr.annotation",(function(){var id=$(this).data("id");$(`#video-nav ul li[data-id="${id}"] .item`).trigger("mouseout"),$(".tooltip").remove()})),$(document).on("mouseover","#video-nav ul li",(function(){var id=$(this).data("id");$(`tr.annotation[data-id="${id}"]`).addClass("active")})),$(document).on("mouseout","#video-nav ul li",(function(){var id=$(this).data("id");$(`tr.annotation[data-id="${id}"]`).removeClass("active")})),$(document).on("change",".timestamp-input, .timestamp-field input",(function(){$(this).removeClass("is-invalid");var parts=$(this).val().split(":"),seconds=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);validateTimestampFormat($(this).val(),this)?-1!=validateTimeStartEnd($(this).val(),this,"00:00:00",seconds,!0,!1,!0)||$(this).addClass("is-invalid"):$(this).addClass("is-invalid")})),$("#contentmodal").on("show.bs.modal",(function(){player.pause(),$("#addcontentdropdown").addClass("modal-body")})),$("#contentmodal").on("hide.bs.modal",(function(){$("#addcontentdropdown a").removeClass("active"),$("#addcontentdropdown").removeClass("modal-body")})),$(document).on("click","#fullscreen",(function(e){if(e.preventDefault(),$(this).hasClass("fullscreen"))$("#distractfreemodal").modal("hide");else{let modal='<div class="modal fade p-0" id="distractfreemodal"\n                     role="dialog" aria-hidden="true" data-backdrop="static"\n                    data-keyboard="false">\n                    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">\n                        <div class="modal-content rounded-0 p-3">\n                            <div class="modal-body px-1 px-sm-3" id="distractionfreebody">\n                <div class="d-flex w-100 align-items-center justify-content-center mt-5"><div class="spinner-grow text-secondary"\n                    style="width: 3rem; height: 3rem;" role="status">\n                <span class="sr-only">Loading...</span>\n                </div></div>\n                            </div>\n                        </div>\n                    </div>\n                </div>';$("body").append(modal),$("#distractfreemodal").modal("show")}$(this).toggleClass("fullscreen"),$("#distractfreemodal").on("shown.bs.modal",(function(){$("body").addClass("distractionfreemode");let $wrapper=$("#wrapper").clone();$("#distractfreemodal").find("#distractionfreebody").html($wrapper),$("#wrapper").remove()})),$("#distractfreemodal").on("hidden.bs.modal",(function(){$("body").removeClass("distractionfreemode");let $wrapper=$("#distractfreemodal #wrapper").clone();$('[role="main"]').append($wrapper),$("#distractfreemodal").remove()}))}));const appendTimestamp=seconds=>{var formattedTime=convertSecondsToHMS(seconds,!0);$("#scrollbar").append(`<div id="position" class="position-absolute bg-black text-white small rounded-sm py-0 px-1"\n                     style="top: -30px;">${formattedTime}</div>`)};$(document).on("annotationitemsrendered",(function(){let secondLength=$("#timeline-items").width()/totaltime;$('#timeline [data-toggle="tooltip"]').tooltip({boundary:"window",container:"#timeline"});let targetAnnotation=null;$("#timeline-items .annotation.li-draggable").draggable({axis:"x",grid:[secondLength,0],start:function(){appendTimestamp($(this).data("timestamp")),$(".tooltip, #message").remove(),$("#timeline-items").addClass("no-pointer-events")},drag:async function(event,ui){$(".tooltip").remove();let timestamp=(ui.position.left+5)/$("#timeline-items").width()*totaltime+start;timestamp<start&&(timestamp=start,$(this).css("left",0)),timestamp>end&&(timestamp=end,$(this).css("left","100%")),$("#scrollbar").css("left",(timestamp-start)/totaltime*100+"%"),await player.seek(Math.round(timestamp)),player.pause(),$("#scrollbar #position").text(convertSecondsToHMS(Math.round(timestamp),!0))},stop:async function(event,ui){$(".tooltip").remove(),$("#scrollbar #position").remove(),setTimeout((function(){$("#timeline-items").removeClass("no-pointer-events")}),200);let timestamp=(ui.position.left+5)/$("#timeline-items").width()*totaltime+start;timestamp<start&&(timestamp=start,$(this).css("left","-5px")),timestamp>end&&(timestamp=end,$(this).css("left","calc(100% - 5px)")),$("#scrollbar").css("left",(timestamp-start)/totaltime*100+"%");const id=$(this).data("id");targetAnnotation=annotations.find((x=>x.id==id));if(annotations.find((x=>x.timestamp==Math.round(timestamp)&&x.id!=id)))return addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger"),void renderAnnotationItems(annotations);targetAnnotation.timestamp!=Math.round(timestamp)&&(targetAnnotation.timestamp=Math.round(timestamp),targetAnnotation.status="draft",dispatchEvent("annotationupdated",{annotation:targetAnnotation,action:"draft"}),await player.seek(Math.round(timestamp)),player.pause(),$("#scrollbar").css("left",(timestamp-start)/totaltime*100+"%"))}}),$("#video-timeline-wrapper .skipsegment").draggable({axis:"x",grid:[secondLength,0],start:function(){$("#message").remove(),appendTimestamp($(this).data("timestamp")),$("#timeline-items").addClass("no-pointer-events")},drag:async function(event,ui){const id=$(this).data("id");targetAnnotation=annotations.find((x=>x.id==id));let timestamp=ui.position.left/$("#video-timeline").width()*totaltime+start;timestamp<start&&(timestamp=start),timestamp>end&&(timestamp=end),$("#scrollbar").css("left",(timestamp-start)/totaltime*100+"%"),await player.seek(Math.round(timestamp)),player.pause(),$("#scrollbar #position").text(convertSecondsToHMS(Math.round(timestamp),!0))},stop:async function(event,ui){$("#scrollbar #position").remove(),setTimeout((function(){$("#timeline-items").removeClass("no-pointer-events")}),200);let timestamp=ui.position.left/$("#video-timeline").width()*totaltime+start;const id=$(this).data("id");targetAnnotation=annotations.find((x=>x.id==id));let skipduration=Number(targetAnnotation.title)-Number(targetAnnotation.timestamp);if(timestamp<0&&timestamp+skipduration<start)return void renderAnnotationItems(annotations);if(timestamp>end)return void renderAnnotationItems(annotations);if(timestamp<start&&(skipduration-=Math.abs(start-timestamp),timestamp=start),timestamp+skipduration>end&&(skipduration=Math.abs(end-timestamp),timestamp=end-skipduration),skipduration<=0)return void renderAnnotationItems(annotations);if(annotations.find((x=>x.timestamp==Math.round(timestamp)&&x.id!=id)))return addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger"),void renderAnnotationItems(annotations);targetAnnotation.timestamp!=Math.round(timestamp)?(targetAnnotation.timestamp=Math.round(timestamp),targetAnnotation.title=Math.round(timestamp)+skipduration,targetAnnotation.status="draft",dispatchEvent("annotationupdated",{annotation:targetAnnotation,action:"draft"}),await player.seek(Math.round(timestamp)),player.pause(),$("#scrollbar").css("left",(timestamp-start)/totaltime*100+"%")):renderAnnotationItems(annotations)}}),$("#video-timeline-wrapper .skipsegment").resizable({containment:"#video-timeline-wrapper",handles:"e, w",grid:[secondLength,0],start:function(){$("#message").remove(),appendTimestamp($(this).data("timestamp")),$("#timeline-items").addClass("no-pointer-events")},resize:async function(event,ui){let timestamp;ui.originalPosition.left!=ui.position.left||ui.originalSize.width==ui.size.width?(ui.position.left<0&&(ui.position.left=0),timestamp=ui.position.left/$("#video-timeline").width()*totaltime+start):timestamp=(ui.position.left+ui.size.width)/$("#video-timeline").width()*totaltime+start,$("#scrollbar").css("left",(timestamp-start)/totaltime*100+"%"),await player.seek(Math.round(timestamp)),player.pause(),$("#scrollbar #position").text(convertSecondsToHMS(Math.round(timestamp),!0))},stop:async function(event,ui){$("#scrollbar #position").remove(),setTimeout((function(){$("#timeline-items").removeClass("no-pointer-events")}),200);const id=$(this).data("id");let timestamp,direction;targetAnnotation=annotations.find((x=>x.id==id)),ui.originalPosition.left!=ui.position.left?(ui.position.left<0&&(ui.position.left=0),timestamp=ui.position.left/$("#video-timeline").width()*totaltime+start,direction="left"):(timestamp=(ui.position.left+ui.size.width)/$("#video-timeline").width()*totaltime+start,direction="right");if(annotations.find((x=>x.timestamp==Math.round(timestamp)&&x.id!=id)))return addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger"),void renderAnnotationItems(annotations);targetAnnotation.timestamp!=Math.round(timestamp)&&("left"==direction?targetAnnotation.timestamp=Math.round(timestamp):targetAnnotation.title=Math.round(timestamp),targetAnnotation.status="draft",dispatchEvent("annotationupdated",{annotation:targetAnnotation,action:"draft"}),await player.seek(Math.round(timestamp)),player.pause(),$("#scrollbar").css("left",(timestamp-start)/totaltime*100+"%"))}}),$("#video-timeline-wrapper .skipsegment").on("contextmenu",(function(e){e.preventDefault(),e.stopImmediatePropagation();const id=$(this).data("id");$(`tr.annotation[data-id="${id}"] .edit`).trigger("click")})),$("#video-timeline-wrapper .skipsegment").on("click",(async function(e){e.preventDefault();const timestamp=$(this).data("timestamp");await player.seek(timestamp),player.pause()})),$("#video-timeline-wrapper .skipsegment .delete-skipsegment").on("click",(function(e){e.preventDefault();const id=$(this).closest(".skipsegment").data("id");$(`tr.annotation[data-id="${id}"] .delete`).trigger("click")}))})),$("#scrollbar").draggable({containment:"#timeline-items",axis:"x",handle:"#scrollhead, #scrollline",cursor:"col-resize",start:function(event,ui){$("#timeline-items").addClass("no-pointer-events"),$("#message").remove(),appendTimestamp(Math.round(ui.position.left/$("#timeline-items").width()*totaltime+start))},drag:async function(event,ui){let timestamp=ui.position.left/$("#timeline-items").width()*totaltime+start;await player.seek(Math.round(timestamp)),player.pause(),$("#scrollbar #position").text(convertSecondsToHMS(Math.round(timestamp),!0))},stop:function(event,ui){$("#scrollbar #position").remove(),setTimeout((function(){$("#timeline-items").removeClass("no-pointer-events")}),200);let timestamp=ui.position.left/$("#timeline-items").width()*totaltime+start;$("#scrollbar").css("left",(timestamp-start)/totaltime*100+"%")}}),$("#separator").draggable({axis:"x",containment:"#wrapper",grid:[1,0],start:function(){$("#wrapper").addClass("no-pointer-events")},drag:function(){const width=$(this).offset().left;$("#player-region").css("width",width+"px"),$("#content-region").css("width","calc(100% - "+width+"px)")},stop:function(){const width=$(this).offset().left;localStorage.setItem("player-width",width),$("#wrapper").removeClass("no-pointer-events")}});const playerWidth=localStorage.getItem("player-width");playerWidth&&window.innerWidth>992&&($("#separator").css("left",playerWidth+"px"),$("#player-region").css("width",playerWidth+"px"),$("#content-region").css("width","calc(100% - "+playerWidth+"px)")),$("#vseek, #video-timeline, #video-nav .annotation").on("mouseenter",(function(e){$("#cursorbar").remove(),e.preventDefault(),e.stopImmediatePropagation();var $scrollbar=$("#scrollbar").clone();$scrollbar.attr("id","cursorbar");const parentOffset=$(this).offset(),relX=e.pageX-parentOffset.left;$scrollbar.css("left",relX+5+"px"),$scrollbar.find("#scrollhead").remove();var percentage=relX/$(this).width(),time=Math.round(percentage*totaltime+start),formattedTime=convertSecondsToHMS(time,!0);$scrollbar.append(`<div id="position" class="position-absolute bg-black text-white small rounded-sm p-1"\n                     style="top: -30px;">${formattedTime}</div>`),$("#timeline-items").append($scrollbar)})),$("#vseek, #video-timeline, #video-nav .annotation").on("mouseleave",(function(e){e.stopImmediatePropagation(),$("#cursorbar").remove()})),$("#vseek, #video-timeline").on("mousemove",(function(e){e.stopImmediatePropagation();const parentOffset=$(this).offset(),relX=e.pageX-parentOffset.left;var percentage=relX/$(this).width(),time=Math.round(percentage*totaltime+start),formattedTime=convertSecondsToHMS(time,!0);$("#cursorbar").css("left",relX+5+"px"),$("#cursorbar #position").text(formattedTime)})),$(document).on("click","#video-nav .annotation",(async function(e){e.preventDefault(),e.stopImmediatePropagation();var id=$(this).data("id"),annotation=annotations.find((x=>x.id==id));await player.seek(annotation.timestamp),runInteraction(annotation)})),$(document).on("click","#vseek, #video-timeline",(async function(e){e.preventDefault(),e.stopImmediatePropagation();var percentage=e.offsetX/$(this).width();replaceProgressBars(100*percentage),await player.seek(Math.round(percentage*totaltime+start)),player.pause(),$("#message, #end-screen").remove()})),$("#zoomout").on("click",(function(){let currentLevel=$("#timeline-items-wrapper").css("width"),newLevel=parseInt(currentLevel)-300;$("#timeline-items-wrapper").css("width",newLevel+"px");let timelineElement=document.getElementById("timeline");timelineElement.scrollWidth<=timelineElement.clientWidth&&$(this).attr("disabled","disabled"),dispatchEvent("annotationitemsrendered",{annotations:annotations})})),$("#timeline").on("wheel",(function(e){e.shiftKey||(e.originalEvent.deltaY<0?$("#zoomin").trigger("click"):$("#zoomout").trigger("click"))})),$("#zoomin").on("click",(function(){let currentLevel=$("#timeline-items-wrapper").css("width"),newLevel=parseInt(currentLevel)+300;$("#timeline-items-wrapper").css("width",newLevel+"px"),$("#zoomout").removeAttr("disabled"),dispatchEvent("annotationitemsrendered",{annotations:annotations})})),$("#savedraft").on("click",(function(e){e.stopImmediatePropagation();let draftAnnotations=annotations.filter((x=>"draft"==x.status)),count=0;draftAnnotations.forEach((function(a){$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quickeditfield",sesskey:M.cfg.sesskey,id:a.id,field:"timestamp",contextid:M.cfg.contextid,value:a.timestamp},success:function(data){var updated=JSON.parse(data);dispatchEvent("annotationupdated",{annotation:updated,action:"savedraft"})}}),"skipsegment"==a.type&&$.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quickeditfield",sesskey:M.cfg.sesskey,id:a.id,field:"title",contextid:M.cfg.contextid,value:a.title},success:function(data){var updated=JSON.parse(data);dispatchEvent("annotationupdated",{annotation:updated,action:"savedraft"})}}),count++,count==draftAnnotations.length&&addNotification(M.util.get_string("draftsaved","mod_interactivevideo"),"success")}))})),$("#addcontent").on("click",(async function(e){e.preventDefault(),playerReady&&$("#contentmodal").modal("show")})),window.addEventListener("beforeunload",(e=>{if(annotations.find((x=>"draft"==x.status))){const confirmationMessage=M.util.get_string("unsavedchanges","mod_interactivevideo");return e.returnValue=confirmationMessage,confirmationMessage}return!0}))}}}));

//# sourceMappingURL=editannotation.min.js.map