{"version":3,"file":"viewannotation.min.js","sources":["../src/viewannotation.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * View page module\n *\n * @module     mod_interactivevideo/viewannotation\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/event_dispatcher', 'core/toast'], function($, {dispatchEvent}, Toast) {\n    let ctRenderer = new Object();\n    let annotations, // Array of annotations.\n        totaltime, // Video total time.\n        activityType, // Current activityType.\n        lastanno, // Last run annotation.\n        contentTypes, // Array of available content types.\n        displayoptions, // Display options.\n        releventAnnotations, // Array of annotations that are not skipped and have completion.\n        player;\n\n    const $videoNav = $('#video-nav');\n\n    const convertSecondsToMinutes = (seconds) => {\n        if (seconds < 60) {\n            return seconds + 's';\n        } else {\n            const minutes = Math.floor(seconds / 60);\n            const remainingSeconds = seconds % 60;\n            return minutes + 'm ' + remainingSeconds + 's';\n        }\n    };\n\n    const renderAnnotationItems = async(annos, start, totaltime) => {\n        releventAnnotations = annos;\n\n        let actualduration = totaltime;\n\n        const skipsegments = annos.filter(x => x.type == 'skipsegment');\n\n        if (skipsegments.length > 0) {\n            skipsegments.forEach(x => {\n                const length = (Number(x.title) - Number(x.timestamp));\n                actualduration -= length;\n            });\n        }\n\n        const completableAnno = releventAnnotations.filter(x => JSON.parse(x.prop).hascompletion);\n        const actualAnnotationCounts = completableAnno.length;\n\n        const xp = completableAnno.map(x => Number(x.xp)).reduce((a, b) => a + b, 0);\n\n        const completedAnnos = completableAnno\n            .filter(x => x.completed);\n\n        const xpEarned = completedAnnos.map(x => Number(x.xp)).reduce((a, b) => a + b, 0);\n\n        $(\".metadata\").empty();\n        $(\".metadata\").append(`<span class=\"d-inline-block mr-3\">\n            <i class=\"bi bi-stopwatch mr-2\"></i>${convertSecondsToMinutes(Math.ceil(actualduration))}</span>\n            <span class=\"d-inline-block mr-3\">\n        <i class=\"bi bi-bullseye mr-2\"></i>${completedAnnos.length} / ${actualAnnotationCounts}</span>\n        <span class=\"d-inline-block\"><i class=\"bi bi-star mr-2\"></i>${xpEarned} / ${xp}</span>`);\n\n        $(\"#video-nav ul\").empty();\n\n        if (annos.length == 0) {\n            return;\n        }\n\n        if (displayoptions.preventseeking == 1) {\n            $videoNav.addClass('no-pointer-events');\n        }\n\n        if (displayoptions.hidemainvideocontrols == 1 || displayoptions.hideinteractions == 1) {\n            if (displayoptions.hidemainvideocontrols == 1) {\n                $('#wrapper').addClass('no-videonav');\n            }\n            return;\n        }\n        const render = new Promise((resolve) => {\n            annos.forEach(async(x) => {\n                const renderer = ctRenderer[x.type];\n                renderer.renderItemOnVideoNavigation(x);\n            });\n            resolve();\n        });\n\n        render.then(() => {\n            dispatchEvent('annotationitemsrendered', {'annotations': annos});\n            $('.annolistinchapter').empty();\n            const chapteritems = releventAnnotations.filter(x => x.type != 'skipsegment' && JSON.parse(x.prop).hascompletion);\n            chapteritems.sort((a, b) => a.timestamp - b.timestamp);\n            chapteritems.forEach((x) => {\n                $('[data-region=\"chapterlists\"] li').each(function() {\n                    const cstart = $(this).data('start');\n                    const cend = $(this).data('end');\n                    if (x.timestamp >= cstart && x.timestamp < cend) {\n                        $(this).find('.annolistinchapter')\n                            .append(`<li class=\"border-bottom anno d-flex align-items-center justify-content-between\n                         px-3 py-2 ${x.completed ? \"completed\" : \"\"}\" data-id=\"${x.id}\" data-timestamp=\"${x.timestamp}\">\n                         <span class=\"text-nowrap\">\n                         <i class=\"small bi ${x.completed ? \"bi-check-circle-fill text-success\" : 'bi-circle'} mr-2\"></i>\n                         <i class=\"${JSON.parse(x.prop).icon} mr-2\"></i></span>\n                         <span class=\"flex-grow-1 text-truncate\">${x.formattedtitle}</span>\n                         <span class=\"text-nowrap\">${x.xp}<i class=\"bi bi-star ml-1\"></i></span></li>`);\n                    }\n                });\n            });\n        }).then(() => {\n            dispatchEvent('chapterrendered', {'annotations': releventAnnotations});\n        });\n\n        $(document).on('annotationitemsrendered', function() {\n            $('#controler [data-toggle=\"tooltip\"]').tooltip({\n                container: '#controler',\n                boundary: 'window',\n            });\n            if (displayoptions.disableinteractionclickuntilcompleted == 1) {\n                $videoNav.find('ul li:not(.completed):not(.chapter)').addClass('no-click');\n            }\n            if (displayoptions.disableinteractionclick == 1) {\n                $videoNav.find('ul li:not(.chapter)').addClass('no-click');\n            }\n            if (displayoptions.preventseeking == 1) {\n                $videoNav.find('ul li').addClass('no-click');\n                $videoNav.addClass('no-click');\n            }\n        });\n    };\n\n    return {\n        renderAnnotationItems: renderAnnotationItems,\n        init: function(url, coursemodule, interaction, course, userid, start = 0, end,\n            completionpercentage, gradeiteminstance, grademax, vtype, preventskip = true, moment = null, doptions = {}) {\n            // Convert start to number if string\n            start = Number(start);\n            if (isNaN(start)) {\n                start = 0;\n            }\n\n            // Convert end to number if string\n            end = Number(end);\n            if (isNaN(end)) {\n                end = null;\n            }\n\n            displayoptions = doptions;\n\n            let playerReady = false;\n\n            const convertSecondsToHMS = (seconds) => {\n                const h = Math.floor(seconds / 3600);\n                const m = Math.floor(seconds % 3600 / 60);\n                const s = Math.floor(seconds % 3600 % 60);\n                return (h > 0 ? h + ':' : '') + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;\n            };\n\n            const replaceProgressBars = (percentage) => {\n                percentage = percentage > 100 ? 100 : percentage;\n                $videoNav.find('#progress').replaceWith(`<div id=\"progress\" style=\"width: ${percentage}%;\"></div>`);\n            };\n\n            const getAnnotations = (callback) => {\n                // Get all interaction items.\n                const annnoitems = $.ajax({\n                    url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                    method: \"POST\",\n                    dataType: \"text\",\n                    data: {\n                        action: 'get_items',\n                        sesskey: M.cfg.sesskey,\n                        id: interaction,\n                        contextid: M.cfg.courseContextId\n                    }\n                });\n\n                // Get current user progress.\n                const userprogress = $.ajax({\n                    url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                    method: \"POST\",\n                    dataType: \"text\",\n                    data: {\n                        action: 'get_progress',\n                        sesskey: M.cfg.sesskey,\n                        id: interaction,\n                        uid: userid\n                    }\n                });\n\n                // Get all content types.\n                const getContentTypes = $.ajax({\n                    url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                    method: \"POST\",\n                    dataType: \"text\",\n                    data: {\n                        action: 'getallcontenttypes',\n                        sesskey: M.cfg.sesskey,\n                    }\n                });\n\n                $.when(annnoitems, userprogress, getContentTypes).done(function(annos, progress, ct) {\n                    window.console.log(annos, progress, ct);\n                    annotations = JSON.parse(annos[0]);\n                    progress = JSON.parse(progress[0]);\n                    contentTypes = JSON.parse(ct[0]);\n\n                    // Get only annotations within the start and end times.\n                    // Remove the skip segments that are completely outside the start and end times.\n                    // Remove the annotations whose content type is not in the contentTypes.\n                    annotations = annotations.filter(x => {\n                        const inContentType = contentTypes.some(y => y.name === x.type);\n                        if (!inContentType) {\n return false;\n}\n\n                        if (x.type === 'skipsegment') {\n                            return !(x.timestamp > end || x.title < start);\n                        }\n\n                        return x.timestamp >= start && x.timestamp <= end;\n                    });\n\n                    const completedItems = progress.completeditems == '' ? [] : JSON.parse(progress.completeditems);\n                    annotations = annotations.map(x => {\n                        // First, let's make sure numbers are treated as numbers.\n                        x.timestamp = Number(x.timestamp);\n                        x.xp = Number(x.xp);\n                        if (x.type == 'skipsegment') {\n                            x.title = Number(x.title);\n                        }\n                        // Properties must be stringified so it can be passed through Fragment.\n                        x.prop = JSON.stringify(contentTypes.find(y => y.name == x.type));\n\n                        x.completed = completedItems.indexOf(x.id) > -1;\n\n                        // Handle the skip segments that are half inside the start and end times.\n                        if (x.type == 'skipsegment') {\n                            if (x.timestamp < start && x.title > start) {\n                                x.timestamp = start;\n                            }\n                            if (x.title > end && x.timestamp < end) {\n                                x.title = end;\n                            }\n                        }\n\n                        const advanced = JSON.parse(x.advanced);\n                        x.rerunnable = advanced && advanced.replaybehavior === '1';\n\n                        return x;\n                    });\n\n                    // Sort by timestamp.\n                    annotations.sort((a, b) => a.timestamp - b.timestamp);\n\n                    const skipsegments = annotations.filter(x => x.type == 'skipsegment');\n\n                    releventAnnotations = [];\n                    annotations.forEach(x => {\n                        if (JSON.parse(x.prop).hascompletion) {\n                            let shouldAdd = true;\n                            skipsegments.forEach(y => {\n                                if (Number(x.timestamp) > Number(y.timestamp) && Number(x.timestamp) < Number(y.title)) {\n                                    shouldAdd = false;\n                                }\n                            });\n                            if (shouldAdd) {\n                                releventAnnotations.push(x);\n                            }\n                        } else {\n                            releventAnnotations.push(x);\n                        }\n                    });\n\n                    if (releventAnnotations.length > 0 && !releventAnnotations.find(x => x.type == 'chapter')) {\n                        // Add a dummy chapter at the start of the video.\n                        releventAnnotations.unshift({\n                            id: 0,\n                            title: M.util.get_string('startchapter', 'mod_interactivevideo'),\n                            formattedtitle: M.util.get_string('startchapter', 'mod_interactivevideo'),\n                            timestamp: start,\n                            type: 'chapter',\n                            prop: JSON.stringify(contentTypes.find(x => x.name == 'chapter')),\n                            xp: 0,\n                            completed: true,\n                            hide: true\n                        });\n                    }\n\n                    const getRenderers = new Promise((resolve) => {\n                        const chapterContentType = contentTypes.find(x => x.name == 'chapter');\n                        // We want to use only the content types that are being used in the annotations\n                        contentTypes = contentTypes.filter(x => releventAnnotations.map(y => y.type).includes(x.name));\n                        if (contentTypes.length == 0) {\n                            // Remove the chapter toggle\n                            $('#chaptertoggle, #chapter-container-left, #chapter-container-right').remove();\n                            resolve(ctRenderer);\n                        } else {\n                            $('#chaptertoggle, #chapter-container-left, #chapter-container-right').removeClass('d-none');\n                        }\n                        if (!contentTypes.find(x => x.name == 'chapter')) {\n                            // Include the chapterContentType\n                            contentTypes.push(chapterContentType);\n                        }\n                        var count = 0;\n                        contentTypes.forEach(x => {\n                            require(['' + x.amdmodule], function(Type) {\n                                ctRenderer[x.name] = new Type(player, releventAnnotations, interaction, course, userid,\n                                    completionpercentage, gradeiteminstance, grademax, vtype, preventskip, totaltime, start,\n                                    end, x);\n                                try {\n                                    ctRenderer[x.name].init();\n                                } catch (error) {\n                                    // Do nothing.\n                                }\n                                count++;\n                                if (count == contentTypes.length) {\n                                    resolve(ctRenderer);\n                                }\n                            });\n                        });\n                    });\n\n                    getRenderers.then(() => {\n                        renderAnnotationItems(releventAnnotations, start, totaltime);\n                        $(\"#play\").removeClass('d-none');\n                        $(\"#spinner\").remove();\n                        $(\"#video-info\").toggleClass('d-none d-flex');\n                        callback();\n                    });\n                });\n            };\n\n            const runInteraction = async(annotation) => {\n                player.pause();\n                lastanno = annotation;\n                // Remove the previous message but keep the one below the video.\n                $('#annotation-modal').modal('hide');\n                $('#message').not('[data-placement=bottom]').remove();\n                $('#end-screen, #start-screen').fadeOut(300);\n\n                if (preventskip) {\n                    const theAnnotations = releventAnnotations\n                        .filter(x => Number(x.timestamp) < Number(annotation.timestamp)\n                            && x.completed == false && JSON.parse(x.prop).hascompletion == true);\n                    if (theAnnotations.length > 0) {\n                        const theAnnotation = theAnnotations[0];\n                        player.pause();\n                        await player.seek((theAnnotation.timestamp - 0.7 > start) ? (theAnnotation.timestamp - 0.7) : start);\n                        $('#toast').toast('show');\n                        return;\n                    }\n                }\n                activityType = ctRenderer[annotation.type];\n                activityType.runInteraction(annotation);\n            };\n\n            const shareMoment = async() => {\n                if (!moment) {\n                    return;\n                }\n                // Check if the url has a timestamp using url params.\n                const urlParams = new URLSearchParams(window.location.search);\n                const time = Number(moment);\n                if (time && !isNaN(time) && time >= start && time <= end) {\n                    // Hide the start screen.\n                    $('#video-wrapper #start-screen').hide(0);\n                    await player.seek(time);\n                    player.play();\n                    const theAnnotation = releventAnnotations.find(x => x.timestamp == time);\n                    if (theAnnotation) {\n                        runInteraction(theAnnotation);\n                    }\n\n                    replaceProgressBars(((time - start) / totaltime) * 100);\n\n                }\n                urlParams.delete('t');\n                const newurl = window.location.protocol\n                    + '//' + window.location.host + window.location.pathname + '?' + urlParams.toString();\n                window.history.replaceState(null, null, newurl);\n            };\n\n            const onReady = () => {\n                if (player.posterImage) {\n                    $('#video-wrapper #start-screen').css({\n                        'background': `url(${player.posterImage}) no-repeat center center / cover`,\n                    });\n                }\n                $(\".video-block\").css('background', 'transparent');\n                player.getDuration().then((duration) => {\n                    end = !end ? duration : Math.min(end, duration);\n                    start = start > end ? 0 : start;\n                    totaltime = end - start;\n                    getAnnotations(shareMoment);\n                    $('#duration').text(convertSecondsToHMS(totaltime));\n                });\n\n                // Recalculate the ratio of the video\n                player.ratio().then((ratio) => {\n                    $(\"#video-wrapper\").css('padding-bottom', (1 / ratio) * 100 + '%');\n                });\n\n                playerReady = true;\n                $('#start-screen #start').focus();\n            };\n\n            const onPaused = () => {\n                if (!playerReady) {\n                    return;\n                }\n                clearInterval(interval);\n                $('#playpause').find('i').removeClass('bi-pause-fill').addClass('bi-play-fill');\n                $('#playpause').attr('data-original-title', M.util.get_string('play', 'mod_interactivevideo'));\n            };\n\n            const onEnded = (t) => {\n                if (!playerReady) {\n                    return;\n                }\n                const time = t || end;\n                // Check if theAnnotation exists at the end of the video.\n                const theAnnotation = releventAnnotations.find(x => x.timestamp == time);\n                if (theAnnotation && !lastanno) {\n                    if (!theAnnotation.completed || theAnnotation.rerunnable) {\n                        player.pause();\n                        runInteraction(theAnnotation);\n                    }\n                    // Toggle the tooltip to show the title.\n                    $videoNav.find('.annotation[data-id=\"' + theAnnotation.id + '\"] .item').tooltip('show');\n                    // Hide the tooltip after 2 seconds.\n                    setTimeout(function() {\n                        $videoNav.find('.annotation[data-id=\"' + theAnnotation.id + '\"] .item').tooltip('hide');\n                    }, 2000);\n                }\n\n                $('#restart').removeClass('d-none').fadeIn(300);\n                $('#end-screen').removeClass('d-none').fadeIn(300);\n                $('#progress').css('width', '100%');\n                clearInterval(interval);\n                player.pause();\n                $('#playpause').find('i').removeClass('bi-pause-fill').addClass('bi-play-fill');\n                $('#playpause').attr('data-original-title', M.util.get_string('play', 'mod_interactivevideo'));\n            };\n\n            let interval;\n            const onPlaying = () => { // Use with player timeupdate event.\n                // Reset the annotation content.\n                if (!playerReady) {\n                    return;\n                }\n                $('#annotation-modal').modal('hide');\n                $('#message').not('[data-placement=bottom]').remove();\n                $('#end-screen, #start-screen').fadeOut(300);\n                $('#restart').addClass('d-none');\n\n                $('#playpause').find('i').removeClass('bi-play-fill').addClass('bi-pause-fill');\n                $('#playpause').attr('data-original-title', M.util.get_string('pause', 'mod_interactivevideo'));\n                const intervalFunction = async function() {\n                    const isPlaying = await player.isPlaying();\n                    const isEnded = await player.isEnded();\n                    if (!isPlaying || isEnded) {\n                        clearInterval(interval);\n                        return;\n                    }\n\n                    player.getCurrentTime().then((time) => {\n                        const t = time;\n                        if (t > end || isEnded) {\n                            clearInterval(interval);\n                            onEnded(end);\n                            return;\n                        }\n\n                        dispatchEvent('timeupdate', {'time': t});\n\n                        time = Math.round(time);\n\n                        // If it is the same annotation we just run, then we don't need to run it again.\n                        if (lastanno && time == lastanno.timestamp) {\n                            return;\n                        } else {\n                            if (lastanno && time > lastanno.timestamp) {\n                                lastanno = null;\n                            }\n                            let percentagePlayed = (t - start) / totaltime;\n                            $('#currenttime').text(convertSecondsToHMS(t - start));\n                            percentagePlayed = percentagePlayed > 1 ? 1 : percentagePlayed;\n                            $('#video-nav #progress').css('width', percentagePlayed * 100 + '%');\n\n                            const theAnnotation = releventAnnotations.find(x => (t - player.frequency) <= x.timestamp\n                                && (t + player.frequency) >= x.timestamp && x.id != 0);\n                            if (theAnnotation) {\n                                if (theAnnotation.completed && !theAnnotation.rerunnable) {\n                                    $('#video-nav .annotation[data-id=\"' + theAnnotation.id + '\"] .item').tooltip('show');\n                                    setTimeout(function() {\n                                        $('#video-nav .annotation[data-id=\"' + theAnnotation.id + '\"] .item').tooltip('hide');\n                                    }, 2000);\n                                } else {\n                                    player.pause();\n                                    $('#video-nav #progress')\n                                        .css('width', (theAnnotation.timestamp - start) / totaltime * 100 + '%');\n                                    runInteraction(theAnnotation);\n                                }\n                            }\n                        }\n                    });\n\n                    // Pause video on spacebar pressed\n                    $(document).on('keydown', function(e) {\n                        if (e.keyCode == 32) {\n                            e.preventDefault();\n                            player.pause();\n                        }\n                    });\n                };\n\n                if (player.type == 'yt' || player.type == 'wistia') {\n                    interval = setInterval(intervalFunction, player.frequency * 100);\n                } else {\n                    intervalFunction();\n                }\n\n            };\n\n            // Implement the player\n            require(['mod_interactivevideo/player/' + vtype], function(VideoPlayer) {\n                player = new VideoPlayer(\n                    url,\n                    start,\n                    end,\n                    displayoptions.useoriginalvideocontrols == 1,\n                    true,\n                    false\n                );\n            });\n\n            $(document).on('timeupdate', async function(e) {\n                const t = e.originalEvent.detail.time;\n                if (preventskip) {\n                    const theAnnotations = releventAnnotations.filter(x => Number(x.timestamp) <= (t + player.frequency)\n                        && x.completed == false && JSON.parse(x.prop).hascompletion == true);\n                    if (theAnnotations.length > 0) {\n                        const theAnnotation = theAnnotations[0];\n                        player.pause();\n                        await player.seek((theAnnotation.timestamp - 0.7 > start) ? (theAnnotation.timestamp - 0.7) : start);\n                        clearInterval(interval);\n                        $('#toast').toast('show');\n                        $videoNav('#progress').css('width', ((theAnnotation.timestamp - start) / totaltime) * 100 + '%');\n                    }\n                }\n            });\n\n            // Handle the refresh button:: allowing user to refresh the content\n            $(document).on('click', '#refresh', function(e) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                const id = $(this).data('id');\n                const annotation = releventAnnotations.find(x => x.id == id);\n                $(this).closest('#message').find(\"#content\").empty();\n                runInteraction(annotation, true);\n            });\n\n            // Handle video control events:: fullscreen toggle\n            $(document).on('click', '#fullscreen', function(e) {\n                e.preventDefault();\n                if (!playerReady) {\n                    return;\n                }\n                // Put the wrapper in fullscreen mode\n                const elem = document.getElementById('wrapper');\n                $('#fullscreen').toggleClass('active');\n                if (!$('#wrapper').hasClass('fullscreen')) {\n                    if (elem.requestFullscreen) {\n                        elem.requestFullscreen();\n                    } else if (elem.mozRequestFullScreen) { /* Firefox */\n                        elem.mozRequestFullScreen();\n                    } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */\n                        elem.webkitRequestFullscreen();\n                    } else if (elem.msRequestFullscreen) { /* IE/Edge */\n                        elem.msRequestFullscreen();\n                    }\n\n                } else {\n                    if (document.exitFullscreen) {\n                        document.exitFullscreen();\n                    } else if (document.mozCancelFullScreen) { /* Firefox */\n                        document.mozCancelFullScreen();\n                    } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */\n                        document.webkitExitFullscreen();\n                    } else if (document.msExitFullscreen) { /* IE/Edge */\n                        document.msExitFullscreen();\n                    }\n                }\n            });\n\n            $(document).on('fullscreenchange', function() {\n                if (document.fullscreenElement) {\n                    $('#wrapper, #interactivevideo-container').addClass('fullscreen');\n                    $(\"#video-wrapper\").css('padding-bottom', '0');\n                } else {\n                    $('#wrapper, #interactivevideo-container').removeClass('fullscreen');\n                    player.ratio().then((ratio) => {\n                        $(\"#video-wrapper\").css('padding-bottom', (1 / ratio) * 100 + '%');\n                    });\n                }\n                $('#wrapper #fullscreen i').toggleClass('bi-fullscreen bi-fullscreen-exit');\n            });\n\n            // Pause video when the tab is not visible.\n            $(document).on('visibilitychange', function() {\n                if (document.visibilityState == 'hidden') {\n                    player.pause();\n                }\n            });\n\n            // Handle share this moment event.\n            $(document).on('click', '#controler #share', function(e) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                const $this = $(this);\n                $this.find('i').toggleClass('bi-share-fill bi-share');\n                player.getCurrentTime().then((time) => {\n                    const url = window.location.href;\n                    const shareurl = url + (url.indexOf('?') > 0 ? '&' : '?') + 't=' + Math.round(time);\n                    // Add shareurl to clipboard.\n                    navigator.clipboard.writeText(shareurl).then(function() {\n                        // Show the copied message.\n                        // Change tooltip to copied.\n                        $this.attr('data-original-title', M.util.get_string(\"copied\", \"mod_interactivevideo\")).tooltip('show');\n                        setTimeout(function() {\n                            // Change tooltip back to share.\n                            $this\n                                .attr('data-original-title', M.util.get_string(\"sharethismoment\", \"mod_interactivevideo\"))\n                                .tooltip('hide');\n                            $this.find('i').toggleClass('bi-share-fill bi-share');\n                        }, 2000);\n                    });\n                });\n            });\n\n            // Display time when user hover on the progress bar.\n            $(document).on('mousemove', '#video-nav #seek', function(e) {\n                if (!playerReady) {\n                    return;\n                }\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                const percentage = e.offsetX / $(this).width();\n                const time = Math.floor(percentage * totaltime);\n                const formattedTime = convertSecondsToHMS(time);\n                $('.tooltip').remove();\n                $videoNav.find('#seek #tooltip').remove();\n                // Create a dummy element on the ul and show the time as tooltip.\n                $videoNav.find('#seek').append(`<div id=\"tooltip\" class=\"position-absolute bg-transparent text-white\"\n                     data-original-title=\"${formattedTime}\" style=\"left: calc(${percentage * 100}%); width: 3px;\"></div>`);\n                $('#tooltip').tooltip({\n                    container: '#wrapper',\n                    boundary: 'window',\n                }).tooltip('show');\n            });\n\n            $(document).on('mouseleave', '#video-nav #seek', function() {\n                if (!playerReady) {\n                    return;\n                }\n                $videoNav.find('#seek #tooltip').tooltip('hide');\n                $('.tooltip').remove();\n            });\n\n            // Handle annotation click event:: when user click on the annotation on the progress bar\n            $(document).on('click', '#video-nav .annotation', async function(e) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                if ($(this).hasClass('no-click')) {\n                    // Add a tooltip that seeking is disabled.\n                    Toast.add(M.util.get_string('youcannotviewthisannotationyet', 'mod_interactivevideo'), {\n                        type: 'danger'\n                    });\n                    return;\n                }\n                const timestamp = $(this).data('timestamp');\n                player.play();\n                if (player.type == 'yt') {\n                    clearInterval(interval);\n                }\n                await player.seek(Number(timestamp));\n                replaceProgressBars(((timestamp - start) / totaltime) * 100);\n                const id = $(this).data('id');\n                const theAnnotation = releventAnnotations.find(x => x.id == id);\n                runInteraction(theAnnotation);\n                lastanno = theAnnotation;\n            });\n\n            // Handle seeking event:: when user click on the progress bar\n            $(document).on('click', '#video-nav', async function(e) {\n                if (!playerReady) {\n                    return;\n                }\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                if ($(this).hasClass('no-click')) {\n                    // Add a tooltip that seeking is disabled.\n                    Toast.add(M.util.get_string('seekingdisabled', 'mod_interactivevideo'), {\n                        type: 'danger'\n                    });\n                    return;\n                }\n                lastanno = null;\n                $('#start-screen').fadeOut(300);\n                $('#end-screen').fadeOut(300);\n                var percentage = e.offsetX / $(this).width();\n                // Gotta check if this affects anything.\n                if (player.type == 'yt') {\n                    clearInterval(interval);\n                }\n                player.pause(); // Especially for vimeo.\n                await player.seek((percentage * totaltime) + start);\n                replaceProgressBars(percentage * 100);\n                player.play();\n\n            });\n\n            // Handle video control events:: play\n            $(document).on('click', '#start-screen #play', async function(e) {\n                e.preventDefault();\n                $('#start-screen').fadeOut(300);\n                $(this).addClass('d-none');\n                $videoNav.removeClass('d-none');\n                if ($('body').hasClass('mobiletheme')) {\n                    $(\"#fullscreen\").trigger('click');\n                }\n                await player.seek(start);\n                player.play();\n            });\n\n            // Handle video control events:: restart\n            $(document).on('click', '#end-screen #restart', async function(e) {\n                e.preventDefault();\n                $('#message').remove();\n                lastanno = null;\n                await player.seek(start);\n                $videoNav.find(\"#progress\").css('width', '0%');\n                $('#end-screen').fadeOut(300);\n                $(this).addClass('d-none');\n                $videoNav.removeClass('d-none');\n                replaceProgressBars(0);\n                player.play();\n            });\n\n            // Handle video control events:: pause/resume when user click on the video\n            $(document).on('click', '#video-wrapper .video-block', async function(e) {\n                if (!playerReady) {\n                    return;\n                }\n                clearInterval(interval);\n                e.preventDefault();\n                // Pause or resume the video.\n                player.isPlaying().then(async(playing) => {\n                    if (playing) {\n                        player.pause();\n                    } else {\n                        player.play();\n                    }\n                });\n            });\n\n            $(document).on('click', '#playpause', function(e) {\n                if (!playerReady) {\n                    return;\n                }\n                e.preventDefault();\n                $(this).tooltip('hide');\n                // Pause or resume the video.\n                player.isPlaying().then(async(playing) => {\n                    if (playing) {\n                        player.pause();\n                    } else {\n                        let t = await player.getCurrentTime();\n                        if (t >= end) {\n                            $('#end-screen #restart').trigger('click');\n                        } else {\n                            player.play();\n                        }\n                    }\n                });\n            });\n\n            $(document).on('click', 'li.anno', async function(e) {\n                e.preventDefault();\n                const id = $(this).data('id');\n                $(`li.annotation[data-id=${id}]`).trigger('click');\n                if ($(this).closest('#chapter-container-left').length > 0) {\n                    $('#chaptertoggle button').trigger('click');\n                }\n            });\n\n            $(document).on('click', '#mute', function(e) {\n                e.preventDefault();\n                $(this).tooltip('hide');\n                $(this).toggleClass('active');\n                if ($(this).hasClass('active')) {\n                    player.mute();\n                    $(this).attr('data-original-title', M.util.get_string('unmute', 'mod_interactivevideo'));\n                } else {\n                    player.unMute();\n                    $(this).attr('data-original-title', M.util.get_string('mute', 'mod_interactivevideo'));\n                }\n                $(this).find('i').toggleClass('bi-volume-mute bi-volume-up');\n                $(this).tooltip('show');\n            });\n\n            $(document).on('interactionrun', function(e) {\n                window.console.log(e);\n            });\n\n            $(document).on('interactionclose', function(e) {\n                window.console.log(e);\n            });\n\n            $(document).on('interactionCompletionUpdated', function(e) {\n                window.console.log(e);\n            });\n\n            $(document).on('iv:playerReady', function() {\n                onReady();\n            });\n\n            $(document).on('iv:playerPaused', function() {\n                onPaused();\n            });\n\n            $(document).on('iv:playerPlaying', function() {\n                onPlaying();\n            });\n\n            $(document).on('iv:playerEnded', function() {\n                onEnded();\n            });\n\n            $(document).on('iv:playerError', function() {\n                Toast.add(M.util.get_string('thereisanissueloadingvideo', 'mod_interactivevideo'), {\n                    type: 'danger'\n                });\n                $('#spinner').remove();\n            });\n\n        }\n    };\n});"],"names":["define","$","Toast","annotations","totaltime","activityType","lastanno","contentTypes","displayoptions","releventAnnotations","player","dispatchEvent","ctRenderer","Object","$videoNav","renderAnnotationItems","async","annos","start","actualduration","skipsegments","filter","x","type","length","forEach","Number","title","timestamp","completableAnno","JSON","parse","prop","hascompletion","actualAnnotationCounts","xp","map","reduce","a","b","completedAnnos","completed","xpEarned","seconds","empty","append","Math","ceil","floor","preventseeking","addClass","hidemainvideocontrols","hideinteractions","Promise","resolve","renderItemOnVideoNavigation","then","chapteritems","sort","each","cstart","this","data","cend","find","id","icon","formattedtitle","document","on","tooltip","container","boundary","disableinteractionclickuntilcompleted","disableinteractionclick","init","url","coursemodule","interaction","course","userid","end","completionpercentage","gradeiteminstance","grademax","vtype","preventskip","moment","doptions","isNaN","playerReady","convertSecondsToHMS","h","m","s","replaceProgressBars","percentage","replaceWith","getAnnotations","callback","annnoitems","ajax","M","cfg","wwwroot","method","dataType","action","sesskey","contextid","courseContextId","userprogress","uid","getContentTypes","when","done","progress","ct","window","console","log","some","y","name","completedItems","completeditems","stringify","indexOf","advanced","rerunnable","replaybehavior","shouldAdd","push","unshift","util","get_string","hide","chapterContentType","includes","remove","removeClass","count","require","amdmodule","Type","error","toggleClass","runInteraction","pause","annotation","modal","not","fadeOut","theAnnotations","theAnnotation","seek","toast","shareMoment","urlParams","URLSearchParams","location","search","time","play","delete","newurl","protocol","host","pathname","toString","history","replaceState","onReady","posterImage","css","getDuration","duration","min","text","ratio","focus","onPaused","clearInterval","interval","attr","onEnded","t","setTimeout","fadeIn","onPlaying","intervalFunction","isPlaying","isEnded","getCurrentTime","round","percentagePlayed","frequency","e","keyCode","preventDefault","setInterval","VideoPlayer","useoriginalvideocontrols","originalEvent","detail","stopImmediatePropagation","closest","elem","getElementById","hasClass","exitFullscreen","mozCancelFullScreen","webkitExitFullscreen","msExitFullscreen","requestFullscreen","mozRequestFullScreen","webkitRequestFullscreen","msRequestFullscreen","fullscreenElement","visibilityState","$this","href","shareurl","navigator","clipboard","writeText","offsetX","width","formattedTime","add","trigger","playing","mute","unMute"],"mappings":";;;;;;;AAuBAA,6CAAO,CAAC,SAAU,wBAAyB,eAAe,SAASC,OAAoBC,WAE/EC,YACAC,UACAC,aACAC,SACAC,aACAC,eACAC,oBACAC,QAT8DC,cAACA,oBAC/DC,WAAa,IAAIC,aAUfC,UAAYb,EAAE,cAYdc,sBAAwBC,MAAMC,MAAOC,MAAOd,aAC9CK,oBAAsBQ,UAElBE,eAAiBf,gBAEfgB,aAAeH,MAAMI,QAAOC,GAAe,eAAVA,EAAEC,OAErCH,aAAaI,OAAS,GACtBJ,aAAaK,SAAQH,UACXE,OAAUE,OAAOJ,EAAEK,OAASD,OAAOJ,EAAEM,WAC3CT,gBAAkBK,gBAIpBK,gBAAkBpB,oBAAoBY,QAAOC,GAAKQ,KAAKC,MAAMT,EAAEU,MAAMC,gBACrEC,uBAAyBL,gBAAgBL,OAEzCW,GAAKN,gBAAgBO,KAAId,GAAKI,OAAOJ,EAAEa,MAAKE,QAAO,CAACC,EAAGC,IAAMD,EAAIC,GAAG,GAEpEC,eAAiBX,gBAClBR,QAAOC,GAAKA,EAAEmB,YAEbC,SAAWF,eAAeJ,KAAId,GAAKI,OAAOJ,EAAEa,MAAKE,QAAO,CAACC,EAAGC,IAAMD,EAAIC,GAAG,GAhClDI,IAAAA,WAkC7B1C,EAAE,aAAa2C,QACf3C,EAAE,aAAa4C,OAAQ,uFAnCMF,QAoCqCG,KAAKC,KAAK5B,gBAnCxEwB,QAAU,GACHA,QAAU,IAEDG,KAAKE,MAAML,QAAU,IAEpB,KADQA,QAAU,GACQ,0GAgCVH,eAAehB,YAAYU,sGACFQ,cAAcP,aAE5ElC,EAAE,iBAAiB2C,QAEC,GAAhB3B,MAAMO,iBAI2B,GAAjChB,eAAeyC,gBACfnC,UAAUoC,SAAS,qBAGqB,GAAxC1C,eAAe2C,uBAAiE,GAAnC3C,eAAe4C,6BAChB,GAAxC5C,eAAe2C,uBACflD,EAAE,YAAYiD,SAAS,gBAIhB,IAAIG,SAASC,UACxBrC,MAAMQ,SAAQT,MAAAA,IACOJ,WAAWU,EAAEC,MACrBgC,4BAA4BjC,MAEzCgC,aAGGE,MAAK,KACR7C,cAAc,0BAA2B,aAAgBM,QACzDhB,EAAE,sBAAsB2C,cAClBa,aAAehD,oBAAoBY,QAAOC,GAAe,eAAVA,EAAEC,MAAyBO,KAAKC,MAAMT,EAAEU,MAAMC,gBACnGwB,aAAaC,MAAK,CAACpB,EAAGC,IAAMD,EAAEV,UAAYW,EAAEX,YAC5C6B,aAAahC,SAASH,IAClBrB,EAAE,mCAAmC0D,MAAK,iBAChCC,OAAS3D,EAAE4D,MAAMC,KAAK,SACtBC,KAAO9D,EAAE4D,MAAMC,KAAK,OACtBxC,EAAEM,WAAagC,QAAUtC,EAAEM,UAAYmC,MACvC9D,EAAE4D,MAAMG,KAAK,sBACRnB,OAAQ,uHACAvB,EAAEmB,UAAY,YAAc,gBAAgBnB,EAAE2C,uBAAuB3C,EAAEM,iHAE9DN,EAAEmB,UAAY,oCAAsC,8DAC7DX,KAAKC,MAAMT,EAAEU,MAAMkC,4FACW5C,EAAE6C,6EAChB7C,EAAEa,0DAI5CqB,MAAK,KACJ7C,cAAc,kBAAmB,aAAgBF,yBAGrDR,EAAEmE,UAAUC,GAAG,2BAA2B,WACtCpE,EAAE,sCAAsCqE,QAAQ,CAC5CC,UAAW,aACXC,SAAU,WAE8C,GAAxDhE,eAAeiE,uCACf3D,UAAUkD,KAAK,uCAAuCd,SAAS,YAErB,GAA1C1C,eAAekE,yBACf5D,UAAUkD,KAAK,uBAAuBd,SAAS,YAEd,GAAjC1C,eAAeyC,iBACfnC,UAAUkD,KAAK,SAASd,SAAS,YACjCpC,UAAUoC,SAAS,uBAKxB,CACHnC,sBAAuBA,sBACvB4D,KAAM,SAASC,IAAKC,aAAcC,YAAaC,OAAQC,YAAQ9D,6DAAQ,EAAG+D,2CACtEC,4DAAsBC,yDAAmBC,gDAAUC,+CAAOC,0EAAoBC,iEAAS,KAAMC,mEAAW,GAExGtE,MAAQQ,OAAOR,OACXuE,MAAMvE,SACNA,MAAQ,GAIZ+D,IAAMvD,OAAOuD,KACTQ,MAAMR,OACNA,IAAM,MAGVzE,eAAiBgF,aAEbE,aAAc,QAEZC,oBAAuBhD,gBACnBiD,EAAI9C,KAAKE,MAAML,QAAU,MACzBkD,EAAI/C,KAAKE,MAAML,QAAU,KAAO,IAChCmD,EAAIhD,KAAKE,MAAML,QAAU,KAAO,WAC9BiD,EAAI,EAAIA,EAAI,IAAM,KAAOC,EAAI,GAAK,IAAM,IAAMA,EAAI,KAAOC,EAAI,GAAK,IAAM,IAAMA,GAGpFC,oBAAuBC,aACzBA,WAAaA,WAAa,IAAM,IAAMA,WACtClF,UAAUkD,KAAK,aAAaiC,YAAa,oCAAmCD,yBAG1EE,eAAkBC,iBAEdC,WAAanG,EAAEoG,KAAK,CACtBzB,IAAK0B,EAAEC,IAAIC,QAAU,iCACrBC,OAAQ,OACRC,SAAU,OACV5C,KAAM,CACF6C,OAAQ,YACRC,QAASN,EAAEC,IAAIK,QACf3C,GAAIa,YACJ+B,UAAWP,EAAEC,IAAIO,mBAKnBC,aAAe9G,EAAEoG,KAAK,CACxBzB,IAAK0B,EAAEC,IAAIC,QAAU,iCACrBC,OAAQ,OACRC,SAAU,OACV5C,KAAM,CACF6C,OAAQ,eACRC,QAASN,EAAEC,IAAIK,QACf3C,GAAIa,YACJkC,IAAKhC,UAKPiC,gBAAkBhH,EAAEoG,KAAK,CAC3BzB,IAAK0B,EAAEC,IAAIC,QAAU,iCACrBC,OAAQ,OACRC,SAAU,OACV5C,KAAM,CACF6C,OAAQ,qBACRC,QAASN,EAAEC,IAAIK,WAIvB3G,EAAEiH,KAAKd,WAAYW,aAAcE,iBAAiBE,MAAK,SAASlG,MAAOmG,SAAUC,IAC7EC,OAAOC,QAAQC,IAAIvG,MAAOmG,SAAUC,IACpClH,YAAc2B,KAAKC,MAAMd,MAAM,IAC/BmG,SAAWtF,KAAKC,MAAMqF,SAAS,IAC/B7G,aAAeuB,KAAKC,MAAMsF,GAAG,IAK7BlH,YAAcA,YAAYkB,QAAOC,KACPf,aAAakH,MAAKC,GAAKA,EAAEC,OAASrG,EAAEC,SAK3C,gBAAXD,EAAEC,OACOD,EAAEM,UAAYqD,KAAO3D,EAAEK,MAAQT,OAGrCI,EAAEM,WAAaV,OAASI,EAAEM,WAAaqD,aAG5C2C,eAA4C,IAA3BR,SAASS,eAAuB,GAAK/F,KAAKC,MAAMqF,SAASS,gBAChF1H,YAAcA,YAAYiC,KAAId,IAE1BA,EAAEM,UAAYF,OAAOJ,EAAEM,WACvBN,EAAEa,GAAKT,OAAOJ,EAAEa,IACF,eAAVb,EAAEC,OACFD,EAAEK,MAAQD,OAAOJ,EAAEK,QAGvBL,EAAEU,KAAOF,KAAKgG,UAAUvH,aAAayD,MAAK0D,GAAKA,EAAEC,MAAQrG,EAAEC,QAE3DD,EAAEmB,UAAYmF,eAAeG,QAAQzG,EAAE2C,KAAO,EAGhC,eAAV3C,EAAEC,OACED,EAAEM,UAAYV,OAASI,EAAEK,MAAQT,QACjCI,EAAEM,UAAYV,OAEdI,EAAEK,MAAQsD,KAAO3D,EAAEM,UAAYqD,MAC/B3D,EAAEK,MAAQsD,YAIZ+C,SAAWlG,KAAKC,MAAMT,EAAE0G,iBAC9B1G,EAAE2G,WAAaD,UAAwC,MAA5BA,SAASE,eAE7B5G,KAIXnB,YAAYuD,MAAK,CAACpB,EAAGC,IAAMD,EAAEV,UAAYW,EAAEX,kBAErCR,aAAejB,YAAYkB,QAAOC,GAAe,eAAVA,EAAEC,OAE/Cd,oBAAsB,GACtBN,YAAYsB,SAAQH,OACZQ,KAAKC,MAAMT,EAAEU,MAAMC,cAAe,KAC9BkG,WAAY,EAChB/G,aAAaK,SAAQiG,IACbhG,OAAOJ,EAAEM,WAAaF,OAAOgG,EAAE9F,YAAcF,OAAOJ,EAAEM,WAAaF,OAAOgG,EAAE/F,SAC5EwG,WAAY,MAGhBA,WACA1H,oBAAoB2H,KAAK9G,QAG7Bb,oBAAoB2H,KAAK9G,MAI7Bb,oBAAoBe,OAAS,IAAMf,oBAAoBuD,MAAK1C,GAAe,WAAVA,EAAEC,QAEnEd,oBAAoB4H,QAAQ,CACxBpE,GAAI,EACJtC,MAAO2E,EAAEgC,KAAKC,WAAW,eAAgB,wBACzCpE,eAAgBmC,EAAEgC,KAAKC,WAAW,eAAgB,wBAClD3G,UAAWV,MACXK,KAAM,UACNS,KAAMF,KAAKgG,UAAUvH,aAAayD,MAAK1C,GAAe,WAAVA,EAAEqG,QAC9CxF,GAAI,EACJM,WAAW,EACX+F,MAAM,IAIO,IAAInF,SAASC,gBACxBmF,mBAAqBlI,aAAayD,MAAK1C,GAAe,WAAVA,EAAEqG,OAEpDpH,aAAeA,aAAac,QAAOC,GAAKb,oBAAoB2B,KAAIsF,GAAKA,EAAEnG,OAAMmH,SAASpH,EAAEqG,QAC7D,GAAvBpH,aAAaiB,QAEbvB,EAAE,qEAAqE0I,SACvErF,QAAQ1C,aAERX,EAAE,qEAAqE2I,YAAY,UAElFrI,aAAayD,MAAK1C,GAAe,WAAVA,EAAEqG,QAE1BpH,aAAa6H,KAAKK,wBAElBI,MAAQ,EACZtI,aAAakB,SAAQH,IACjBwH,QAAQ,CAAC,GAAKxH,EAAEyH,YAAY,SAASC,MACjCpI,WAAWU,EAAEqG,MAAQ,IAAIqB,KAAKtI,OAAQD,oBAAqBqE,YAAaC,OAAQC,OAC5EE,qBAAsBC,kBAAmBC,SAAUC,MAAOC,YAAalF,UAAWc,MAClF+D,IAAK3D,OAELV,WAAWU,EAAEqG,MAAMhD,OACrB,MAAOsE,UAGTJ,OACatI,aAAaiB,QACtB8B,QAAQ1C,qBAMX4C,MAAK,KACdzC,sBAAsBN,oBAAqBS,EAAOd,WAClDH,EAAE,SAAS2I,YAAY,UACvB3I,EAAE,YAAY0I,SACd1I,EAAE,eAAeiJ,YAAY,iBAC7B/C,kBAKNgD,eAAiBnI,MAAAA,gBACnBN,OAAO0I,QACP9I,SAAW+I,WAEXpJ,EAAE,qBAAqBqJ,MAAM,QAC7BrJ,EAAE,YAAYsJ,IAAI,2BAA2BZ,SAC7C1I,EAAE,8BAA8BuJ,QAAQ,KAEpClE,YAAa,OACPmE,eAAiBhJ,oBAClBY,QAAOC,GAAKI,OAAOJ,EAAEM,WAAaF,OAAO2H,WAAWzH,YAC/B,GAAfN,EAAEmB,WAA0D,GAApCX,KAAKC,MAAMT,EAAEU,MAAMC,mBAClDwH,eAAejI,OAAS,EAAG,OACrBkI,cAAgBD,eAAe,UACrC/I,OAAO0I,cACD1I,OAAOiJ,KAAMD,cAAc9H,UAAY,GAAMV,MAAUwI,cAAc9H,UAAY,GAAOV,YAC9FjB,EAAE,UAAU2J,MAAM,SAI1BvJ,aAAeO,WAAWyI,WAAW9H,MACrClB,aAAa8I,eAAeE,aAG1BQ,YAAc7I,cACXuE,oBAICuE,UAAY,IAAIC,gBAAgBzC,OAAO0C,SAASC,QAChDC,KAAOxI,OAAO6D,WAChB2E,OAASzE,MAAMyE,OAASA,MAAQhJ,OAASgJ,MAAQjF,IAAK,CAEtDhF,EAAE,gCAAgCuI,KAAK,SACjC9H,OAAOiJ,KAAKO,MAClBxJ,OAAOyJ,aACDT,cAAgBjJ,oBAAoBuD,MAAK1C,GAAKA,EAAEM,WAAasI,OAC/DR,eACAP,eAAeO,eAGnB3D,qBAAsBmE,KAAOhJ,OAASd,UAAa,KAGvD0J,UAAUM,OAAO,WACXC,OAAS/C,OAAO0C,SAASM,SACzB,KAAOhD,OAAO0C,SAASO,KAAOjD,OAAO0C,SAASQ,SAAW,IAAMV,UAAUW,WAC/EnD,OAAOoD,QAAQC,aAAa,KAAM,KAAMN,SAGtCO,QAAU,KACRlK,OAAOmK,aACP5K,EAAE,gCAAgC6K,IAAI,YACnB,OAAMpK,OAAOmK,iDAGpC5K,EAAE,gBAAgB6K,IAAI,aAAc,eACpCpK,OAAOqK,cAAcvH,MAAMwH,WACvB/F,IAAOA,IAAiBnC,KAAKmI,IAAIhG,IAAK+F,UAAzBA,SACb9J,MAAQA,MAAQ+D,IAAM,EAAI/D,MAC1Bd,UAAY6E,IAAM/D,MAClBgF,eAAe2D,aACf5J,EAAE,aAAaiL,KAAKvF,oBAAoBvF,eAI5CM,OAAOyK,QAAQ3H,MAAM2H,QACjBlL,EAAE,kBAAkB6K,IAAI,iBAAmB,EAAIK,MAAS,IAAM,QAGlEzF,aAAc,EACdzF,EAAE,wBAAwBmL,SAGxBC,SAAW,KACR3F,cAGL4F,cAAcC,UACdtL,EAAE,cAAc+D,KAAK,KAAK4E,YAAY,iBAAiB1F,SAAS,gBAChEjD,EAAE,cAAcuL,KAAK,sBAAuBlF,EAAEgC,KAAKC,WAAW,OAAQ,2BAGpEkD,QAAWC,QACRhG,yBAGCwE,KAAOwB,GAAKzG,IAEZyE,cAAgBjJ,oBAAoBuD,MAAK1C,GAAKA,EAAEM,WAAasI,OAC/DR,gBAAkBpJ,WACboJ,cAAcjH,YAAaiH,cAAczB,aAC1CvH,OAAO0I,QACPD,eAAeO,gBAGnB5I,UAAUkD,KAAK,wBAA0B0F,cAAczF,GAAK,YAAYK,QAAQ,QAEhFqH,YAAW,WACP7K,UAAUkD,KAAK,wBAA0B0F,cAAczF,GAAK,YAAYK,QAAQ,UACjF,MAGPrE,EAAE,YAAY2I,YAAY,UAAUgD,OAAO,KAC3C3L,EAAE,eAAe2I,YAAY,UAAUgD,OAAO,KAC9C3L,EAAE,aAAa6K,IAAI,QAAS,QAC5BQ,cAAcC,UACd7K,OAAO0I,QACPnJ,EAAE,cAAc+D,KAAK,KAAK4E,YAAY,iBAAiB1F,SAAS,gBAChEjD,EAAE,cAAcuL,KAAK,sBAAuBlF,EAAEgC,KAAKC,WAAW,OAAQ,8BAGtEgD,eACEM,UAAY,SAETnG,mBAGLzF,EAAE,qBAAqBqJ,MAAM,QAC7BrJ,EAAE,YAAYsJ,IAAI,2BAA2BZ,SAC7C1I,EAAE,8BAA8BuJ,QAAQ,KACxCvJ,EAAE,YAAYiD,SAAS,UAEvBjD,EAAE,cAAc+D,KAAK,KAAK4E,YAAY,gBAAgB1F,SAAS,iBAC/DjD,EAAE,cAAcuL,KAAK,sBAAuBlF,EAAEgC,KAAKC,WAAW,QAAS,+BACjEuD,iBAAmB9K,uBACf+K,gBAAkBrL,OAAOqL,YACzBC,cAAgBtL,OAAOsL,UACxBD,YAAaC,SAKlBtL,OAAOuL,iBAAiBzI,MAAM0G,aACpBwB,EAAIxB,QACNwB,EAAIzG,KAAO+G,eACXV,cAAcC,eACdE,QAAQxG,QAIZtE,cAAc,aAAc,MAAS+K,IAErCxB,KAAOpH,KAAKoJ,MAAMhC,OAGd5J,UAAY4J,MAAQ5J,SAASsB,UAE1B,CACCtB,UAAY4J,KAAO5J,SAASsB,YAC5BtB,SAAW,UAEX6L,kBAAoBT,EAAIxK,OAASd,UACrCH,EAAE,gBAAgBiL,KAAKvF,oBAAoB+F,EAAIxK,QAC/CiL,iBAAmBA,iBAAmB,EAAI,EAAIA,iBAC9ClM,EAAE,wBAAwB6K,IAAI,QAA4B,IAAnBqB,iBAAyB,WAE1DzC,cAAgBjJ,oBAAoBuD,MAAK1C,GAAMoK,EAAIhL,OAAO0L,WAAc9K,EAAEM,WACxE8J,EAAIhL,OAAO0L,WAAc9K,EAAEM,WAAqB,GAARN,EAAE2C,KAC9CyF,gBACIA,cAAcjH,YAAciH,cAAczB,YAC1ChI,EAAE,mCAAqCyJ,cAAczF,GAAK,YAAYK,QAAQ,QAC9EqH,YAAW,WACP1L,EAAE,mCAAqCyJ,cAAczF,GAAK,YAAYK,QAAQ,UAC/E,OAEH5D,OAAO0I,QACPnJ,EAAE,wBACG6K,IAAI,SAAUpB,cAAc9H,UAAYV,OAASd,UAAY,IAAM,KACxE+I,eAAeO,qBAO/BzJ,EAAEmE,UAAUC,GAAG,WAAW,SAASgI,GACd,IAAbA,EAAEC,UACFD,EAAEE,iBACF7L,OAAO0I,aAlDXkC,cAAcC,WAuDH,MAAf7K,OAAOa,MAA+B,UAAfb,OAAOa,KAC9BgK,SAAWiB,YAAYV,iBAAqC,IAAnBpL,OAAO0L,WAEhDN,oBAMRhD,QAAQ,CAAC,+BAAiCzD,QAAQ,SAASoH,aACvD/L,OAAS,IAAI+L,YACT7H,IACA1D,MACA+D,IAC2C,GAA3CzE,eAAekM,0BACf,GACA,MAIRzM,EAAEmE,UAAUC,GAAG,cAAcrD,eAAeqL,SAClCX,EAAIW,EAAEM,cAAcC,OAAO1C,QAC7B5E,YAAa,OACPmE,eAAiBhJ,oBAAoBY,QAAOC,GAAKI,OAAOJ,EAAEM,YAAe8J,EAAIhL,OAAO0L,WACpE,GAAf9K,EAAEmB,WAA0D,GAApCX,KAAKC,MAAMT,EAAEU,MAAMC,mBAC9CwH,eAAejI,OAAS,EAAG,OACrBkI,cAAgBD,eAAe,GACrC/I,OAAO0I,cACD1I,OAAOiJ,KAAMD,cAAc9H,UAAY,GAAMV,MAAUwI,cAAc9H,UAAY,GAAOV,OAC9FoK,cAAcC,UACdtL,EAAE,UAAU2J,MAAM,QAClB9I,UAAU,aAAagK,IAAI,SAAWpB,cAAc9H,UAAYV,OAASd,UAAa,IAAM,UAMxGH,EAAEmE,UAAUC,GAAG,QAAS,YAAY,SAASgI,GACzCA,EAAEE,iBACFF,EAAEQ,iCACI5I,GAAKhE,EAAE4D,MAAMC,KAAK,MAClBuF,WAAa5I,oBAAoBuD,MAAK1C,GAAKA,EAAE2C,IAAMA,KACzDhE,EAAE4D,MAAMiJ,QAAQ,YAAY9I,KAAK,YAAYpB,QAC7CuG,eAAeE,YAAY,MAI/BpJ,EAAEmE,UAAUC,GAAG,QAAS,eAAe,SAASgI,MAC5CA,EAAEE,kBACG7G,yBAICqH,KAAO3I,SAAS4I,eAAe,WACrC/M,EAAE,eAAeiJ,YAAY,UACxBjJ,EAAE,YAAYgN,SAAS,cAYpB7I,SAAS8I,eACT9I,SAAS8I,iBACF9I,SAAS+I,oBAChB/I,SAAS+I,sBACF/I,SAASgJ,qBAChBhJ,SAASgJ,uBACFhJ,SAASiJ,kBAChBjJ,SAASiJ,mBAlBTN,KAAKO,kBACLP,KAAKO,oBACEP,KAAKQ,qBACZR,KAAKQ,uBACER,KAAKS,wBACZT,KAAKS,0BACET,KAAKU,qBACZV,KAAKU,yBAgBjBxN,EAAEmE,UAAUC,GAAG,oBAAoB,WAC3BD,SAASsJ,mBACTzN,EAAE,yCAAyCiD,SAAS,cACpDjD,EAAE,kBAAkB6K,IAAI,iBAAkB,OAE1C7K,EAAE,yCAAyC2I,YAAY,cACvDlI,OAAOyK,QAAQ3H,MAAM2H,QACjBlL,EAAE,kBAAkB6K,IAAI,iBAAmB,EAAIK,MAAS,IAAM,SAGtElL,EAAE,0BAA0BiJ,YAAY,uCAI5CjJ,EAAEmE,UAAUC,GAAG,oBAAoB,WACC,UAA5BD,SAASuJ,iBACTjN,OAAO0I,WAKfnJ,EAAEmE,UAAUC,GAAG,QAAS,qBAAqB,SAASgI,GAClDA,EAAEE,iBACFF,EAAEQ,iCACIe,MAAQ3N,EAAE4D,MAChB+J,MAAM5J,KAAK,KAAKkF,YAAY,0BAC5BxI,OAAOuL,iBAAiBzI,MAAM0G,aACpBtF,IAAM0C,OAAO0C,SAAS6D,KACtBC,SAAWlJ,KAAOA,IAAImD,QAAQ,KAAO,EAAI,IAAM,KAAO,KAAOjF,KAAKoJ,MAAMhC,MAE9E6D,UAAUC,UAAUC,UAAUH,UAAUtK,MAAK,WAGzCoK,MAAMpC,KAAK,sBAAuBlF,EAAEgC,KAAKC,WAAW,SAAU,yBAAyBjE,QAAQ,QAC/FqH,YAAW,WAEPiC,MACKpC,KAAK,sBAAuBlF,EAAEgC,KAAKC,WAAW,kBAAmB,yBACjEjE,QAAQ,QACbsJ,MAAM5J,KAAK,KAAKkF,YAAY,4BAC7B,cAMfjJ,EAAEmE,UAAUC,GAAG,YAAa,oBAAoB,SAASgI,OAChD3G,mBAGL2G,EAAEE,iBACFF,EAAEQ,iCACI7G,WAAaqG,EAAE6B,QAAUjO,EAAE4D,MAAMsK,QACjCjE,KAAOpH,KAAKE,MAAMgD,WAAa5F,WAC/BgO,cAAgBzI,oBAAoBuE,MAC1CjK,EAAE,YAAY0I,SACd7H,UAAUkD,KAAK,kBAAkB2E,SAEjC7H,UAAUkD,KAAK,SAASnB,OAAQ,oHACJuL,oCAAiD,IAAbpI,qCAChE/F,EAAE,YAAYqE,QAAQ,CAClBC,UAAW,WACXC,SAAU,WACXF,QAAQ,WAGfrE,EAAEmE,UAAUC,GAAG,aAAc,oBAAoB,WACxCqB,cAGL5E,UAAUkD,KAAK,kBAAkBM,QAAQ,QACzCrE,EAAE,YAAY0I,aAIlB1I,EAAEmE,UAAUC,GAAG,QAAS,0BAA0BrD,eAAeqL,MAC7DA,EAAEE,iBACFF,EAAEQ,2BACE5M,EAAE4D,MAAMoJ,SAAS,wBAEjB/M,MAAMmO,IAAI/H,EAAEgC,KAAKC,WAAW,iCAAkC,wBAAyB,CACnFhH,KAAM,iBAIRK,UAAY3B,EAAE4D,MAAMC,KAAK,aAC/BpD,OAAOyJ,OACY,MAAfzJ,OAAOa,MACP+J,cAAcC,gBAEZ7K,OAAOiJ,KAAKjI,OAAOE,YACzBmE,qBAAsBnE,UAAYV,OAASd,UAAa,WAClD6D,GAAKhE,EAAE4D,MAAMC,KAAK,MAClB4F,cAAgBjJ,oBAAoBuD,MAAK1C,GAAKA,EAAE2C,IAAMA,KAC5DkF,eAAeO,eACfpJ,SAAWoJ,iBAIfzJ,EAAEmE,UAAUC,GAAG,QAAS,cAAcrD,eAAeqL,MAC5C3G,eAGL2G,EAAEE,iBACFF,EAAEQ,2BACE5M,EAAE4D,MAAMoJ,SAAS,YAEjB/M,MAAMmO,IAAI/H,EAAEgC,KAAKC,WAAW,kBAAmB,wBAAyB,CACpEhH,KAAM,gBAIdjB,SAAW,KACXL,EAAE,iBAAiBuJ,QAAQ,KAC3BvJ,EAAE,eAAeuJ,QAAQ,SACrBxD,WAAaqG,EAAE6B,QAAUjO,EAAE4D,MAAMsK,QAElB,MAAfzN,OAAOa,MACP+J,cAAcC,UAElB7K,OAAO0I,cACD1I,OAAOiJ,KAAM3D,WAAa5F,UAAac,OAC7C6E,oBAAiC,IAAbC,YACpBtF,OAAOyJ,WAKXlK,EAAEmE,UAAUC,GAAG,QAAS,uBAAuBrD,eAAeqL,GAC1DA,EAAEE,iBACFtM,EAAE,iBAAiBuJ,QAAQ,KAC3BvJ,EAAE4D,MAAMX,SAAS,UACjBpC,UAAU8H,YAAY,UAClB3I,EAAE,QAAQgN,SAAS,gBACnBhN,EAAE,eAAeqO,QAAQ,eAEvB5N,OAAOiJ,KAAKzI,OAClBR,OAAOyJ,UAIXlK,EAAEmE,UAAUC,GAAG,QAAS,wBAAwBrD,eAAeqL,GAC3DA,EAAEE,iBACFtM,EAAE,YAAY0I,SACdrI,SAAW,WACLI,OAAOiJ,KAAKzI,OAClBJ,UAAUkD,KAAK,aAAa8G,IAAI,QAAS,MACzC7K,EAAE,eAAeuJ,QAAQ,KACzBvJ,EAAE4D,MAAMX,SAAS,UACjBpC,UAAU8H,YAAY,UACtB7C,oBAAoB,GACpBrF,OAAOyJ,UAIXlK,EAAEmE,UAAUC,GAAG,QAAS,+BAA+BrD,eAAeqL,GAC7D3G,cAGL4F,cAAcC,UACdc,EAAEE,iBAEF7L,OAAOqL,YAAYvI,MAAKxC,MAAAA,UAChBuN,QACA7N,OAAO0I,QAEP1I,OAAOyJ,cAKnBlK,EAAEmE,UAAUC,GAAG,QAAS,cAAc,SAASgI,GACtC3G,cAGL2G,EAAEE,iBACFtM,EAAE4D,MAAMS,QAAQ,QAEhB5D,OAAOqL,YAAYvI,MAAKxC,MAAAA,aAChBuN,QACA7N,OAAO0I,YACJ,OACW1I,OAAOuL,kBACZhH,IACLhF,EAAE,wBAAwBqO,QAAQ,SAElC5N,OAAOyJ,eAMvBlK,EAAEmE,UAAUC,GAAG,QAAS,WAAWrD,eAAeqL,GAC9CA,EAAEE,uBACItI,GAAKhE,EAAE4D,MAAMC,KAAK,MACxB7D,EAAG,yBAAwBgE,OAAOqK,QAAQ,SACtCrO,EAAE4D,MAAMiJ,QAAQ,2BAA2BtL,OAAS,GACpDvB,EAAE,yBAAyBqO,QAAQ,YAI3CrO,EAAEmE,UAAUC,GAAG,QAAS,SAAS,SAASgI,GACtCA,EAAEE,iBACFtM,EAAE4D,MAAMS,QAAQ,QAChBrE,EAAE4D,MAAMqF,YAAY,UAChBjJ,EAAE4D,MAAMoJ,SAAS,WACjBvM,OAAO8N,OACPvO,EAAE4D,MAAM2H,KAAK,sBAAuBlF,EAAEgC,KAAKC,WAAW,SAAU,2BAEhE7H,OAAO+N,SACPxO,EAAE4D,MAAM2H,KAAK,sBAAuBlF,EAAEgC,KAAKC,WAAW,OAAQ,0BAElEtI,EAAE4D,MAAMG,KAAK,KAAKkF,YAAY,+BAC9BjJ,EAAE4D,MAAMS,QAAQ,WAGpBrE,EAAEmE,UAAUC,GAAG,kBAAkB,SAASgI,GACtC/E,OAAOC,QAAQC,IAAI6E,MAGvBpM,EAAEmE,UAAUC,GAAG,oBAAoB,SAASgI,GACxC/E,OAAOC,QAAQC,IAAI6E,MAGvBpM,EAAEmE,UAAUC,GAAG,gCAAgC,SAASgI,GACpD/E,OAAOC,QAAQC,IAAI6E,MAGvBpM,EAAEmE,UAAUC,GAAG,kBAAkB,WAC7BuG,aAGJ3K,EAAEmE,UAAUC,GAAG,mBAAmB,WAC9BgH,cAGJpL,EAAEmE,UAAUC,GAAG,oBAAoB,WAC/BwH,eAGJ5L,EAAEmE,UAAUC,GAAG,kBAAkB,WAC7BoH,aAGJxL,EAAEmE,UAAUC,GAAG,kBAAkB,WAC7BnE,MAAMmO,IAAI/H,EAAEgC,KAAKC,WAAW,6BAA8B,wBAAyB,CAC/EhH,KAAM,WAEVtB,EAAE,YAAY0I"}