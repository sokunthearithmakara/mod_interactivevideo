{"version":3,"file":"launch.min.js","sources":["../src/launch.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * Launch the interactive video in modal on course page\n *\n * @module     mod_interactivevideo/launch\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function($) {\n    return {\n        init: function() {\n            // Launch the interactive video in modal\n            $(document).on('click', '.launch-interactivevideo', function(e) {\n                // Get showcontrols from cache.\n                let showcontrols = localStorage.getItem('showcontrols') ? true : false;\n                e.preventDefault();\n                const id = $(this).data('id');\n                const instance = $(this).data('instance');\n                const course = $(this).data('course');\n                const contextid = $(this).data('contextid');\n                const $card = $(this).closest('#interactivevideo-' + instance);\n                $card.find('.image-container').addClass('hovered');\n                const modal = `<div class=\"modal fade p-0 modal-fullscreen rounded-0\" id=\"playermodal\"\n                data-backdrop=\"static\" data-keyboard=\"false\" tabindex=\"-1\" aria-labelledby=\"playermodalLabel\"\n                aria-hidden=\"true\">\n                   <div class=\"rounded-0 modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl position-relative\">\n                    <div class=\"position-fixed w-100 h-100 no-pointer bg-transparent z-index-1\" id=\"background-loading\">\n                        <div class=\"d-flex h-100 align-items-center justify-content-center\">\n                            <div class=\"spinner-border text-danger\" style=\"width: 3rem; height: 3rem;\" role=\"status\">\n                                <span class=\"sr-only\">Loading...</span>\n                            </div>\n                        </div>\n                    </div>\n                       <div class=\"modal-content ${showcontrols ? 'show-control' : ''}\">\n                       <div class=\"modal-header border-0 text-white align-items-center py-0 h-0\n                        position-absolute w-100 z-index-1 rounded-0\">\n                         <div class=\"modal-background w-100 position-absolute\"></div>\n                               <span class=\"modal-title position-relative z-index-1 d-flex align-items-center overflow-hidden\"\n                                id=\"playermodalLabel\">\n                                <span class=\"h5 mb-0\">\n                                    <button type=\"button\" class=\"btn border-0 m-1 p-1 h5\" data-dismiss=\"modal\" aria-label=\"Close\">\n                                        <i class=\"fa fa-arrow-left text-white m-0 fa-2x\" aria-hidden=\"true\"></i>\n                                    </button>\n                                </span>\n\n                                <div class=\"d-sm-none d-block small ml-2\" data-region=\"activity-completion\">\n                                </div>\n                               </span>\n\n                               <div class=\"modal-action d-flex align-items-center position-relative z-index-1\">\n                               <div class=\"d-none d-sm-block small\" data-region=\"activity-completion\">\n                               </div>\n                               <a type=\"button\" class=\"btn ml-2 border-0 h5 mb-0\"\n                                href=\"${M.cfg.wwwroot}/mod/interactivevideo/view.php?id=${id}\">\n                               <i class=\"fa fa-external-link text-white m-0 fa-xl\" aria-hidden=\"true\"></i></a>\n                               </div>\n                           </div>\n                           <div class=\"modal-body p-0 position-relative\">\n                           <iframe id=\"ivplayer\" src=\"${M.cfg.wwwroot}/mod/interactivevideo/view.php?id=${id}&embed=1\" frameborder=0\n                           class=\"w-100 position-absolute h-100\"></iframe>\n                           <button type=\"button\" class=\"btn border-0 m-1 p-1 h5 toggle-controls d-none\">\n                                   <i class=\"fa fa-chevron-up text-white m-0 fa-2x\" aria-hidden=\"true\"></i>\n                               </button></span>\n                           </div>\n                       </div>\n                   </div>\n               </div>`;\n                $('#playermodal').remove(); // Important:: Remove the previous modal ONLY after the new one is created.\n                $('body').append(modal);\n                $('#playermodal').modal('show');\n\n                const headerFunction = function() {\n                    let $header = $('#playermodal .modal-header');\n                    if ($header.hasClass('show')) {\n                        return;\n                    }\n\n                    $header.addClass('show');\n                    $header.fadeIn();\n\n                    setTimeout(function() {\n                        $header.removeClass('show');\n                        $header.fadeOut();\n                    }, 5000);\n                };\n\n                let iframeDoc, iframeAnnos, details, player;\n                $('#playermodal').on('shown.bs.modal', function() {\n                    $(this).find('.modal-header').addClass('show');\n                    let $completion = $card.find('[data-region=activity-information]');\n                    $completion = $completion.clone();\n                    $(this).find('[data-region=\"activity-completion\"]').html($completion);\n                    // Listen the player timeupdate event in the iframe.\n                    let checkIframeDoc = function() {\n                        iframeDoc = document.getElementById('ivplayer').contentDocument;\n                        iframeAnnos = document.getElementById('ivplayer').contentWindow.IVANNO;\n                        if (!iframeDoc.getElementById('player')) {\n                            requestAnimationFrame(checkIframeDoc);\n                            return;\n                        }\n                        // Hide the background-loading.\n                        $('#background-loading').hide(0);\n                        if (!iframeAnnos) {\n                            requestAnimationFrame(checkIframeDoc);\n                            return;\n                        }\n\n                        player = document.getElementById('ivplayer').contentWindow.IVPLAYER;\n\n                        if (iframeDoc.getElementById('player')) {\n                            $('#playermodal .modal-header').removeClass('show');\n                            $('#playermodal .toggle-controls').removeClass('d-none');\n\n                            if (!showcontrols) {\n                                setTimeout(function() {\n                                    $('#playermodal .modal-content').removeClass('show-control');\n                                }, 1000);\n                            }\n\n                            $('#playermodal .toggle-controls').on('click', function() {\n                                $('#playermodal .modal-content').toggleClass('show-control');\n                                showcontrols = $('#playermodal .modal-content').hasClass('show-control');\n                                if (showcontrols) {\n                                    localStorage.setItem('showcontrols', '1');\n                                } else {\n                                    localStorage.removeItem('showcontrols');\n                                }\n                            });\n\n                            iframeDoc.addEventListener('annotationitemsrendered', function(e) {\n                                details = e.detail;\n                            });\n\n                            $(iframeDoc).on('mousemove', '#video-wrapper', function() {\n                                let $message = iframeDoc.querySelector('#message');\n                                let $activestart = iframeDoc.querySelector('#start-screen:not(.d-none) .hasintro');\n                                if ($message || $activestart) {\n                                    $('#playermodal .modal-header').removeClass('show');\n                                } else {\n                                    headerFunction();\n                                }\n                            });\n\n                            // Analytics progress bar.\n                            let $progressbar = $card.find('.analytics.progress .progress-bar');\n                            if ($progressbar.length == 0) {\n                                return;\n                            }\n                            let current = $progressbar.data('current');\n                            iframeDoc.addEventListener('analyticsupdated', function(e) {\n                                let percentage = e.detail.percentage;\n                                if (percentage > current) {\n                                    $progressbar.css('width', percentage + '%')\n                                        .data('current', percentage);\n\n                                    $card.find('.analytics-percentage').text(Math.round(percentage));\n                                }\n                            });\n\n                        } else {\n                            requestAnimationFrame(checkIframeDoc);\n                        }\n                    };\n                    requestAnimationFrame(checkIframeDoc);\n\n                    $(document).off('click', '#playermodal [data-action=\"toggle-manual-completion\"]')\n                        .on('click', '#playermodal [data-action=\"toggle-manual-completion\"]', function() {\n                            $(this).parent().addClass('updated');\n                            if ($(this).data('withavailability') == 1) {\n                                history.pushState(null, null, M.cfg.wwwroot + '/course/view.php?id=' + course + '#module-' + id);\n                            }\n                        });\n\n                    // Update the browser url to the current activity.\n                    history.pushState(null, null, M.cfg.wwwroot + '/mod/interactivevideo/view.php?id=' + id);\n                });\n\n                $('#playermodal').on('hide.bs.modal', async function() {\n                    // Trigger hover on .image-container for 2 seconds.\n                    setTimeout(function() {\n                        $card.find('.image-container').removeClass('hovered');\n                    }, 1000);\n\n                    if (player) { // Must check this in case user close modal before the player is ready.\n                        await player.pause();\n                    } else {\n                        $(this).remove();\n                        return;\n                    }\n                    // If there is automatic completion conditions, we have to update it.\n                    let $autocompletion = $card.find('.automatic-completion-conditions');\n                    if ($autocompletion.length > 0) {\n                        const completion = await $.ajax({\n                            url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                            method: 'POST',\n                            dataType: 'text',\n                            data: {\n                                action: 'get_cm_completion',\n                                cmid: id,\n                                sesskey: M.cfg.sesskey,\n                                contextid: contextid,\n                                courseid: course,\n                                userid: M.cfg.userId || 0,\n                            }\n                        });\n\n                        if (completion) {\n                            const completiondata = JSON.parse(completion);\n                            $card.find('[data-region=activity-information]')\n                                .html($(completiondata.completion).html());\n                        }\n                    }\n\n                    // If there is manual completion, we have to copy the button to the course page.\n                    let $manualcompletion = $(this).find('.completion-info.updated');\n                    if ($manualcompletion.length > 0) {\n                        $card.find('.completion-info').html($manualcompletion.html());\n                    }\n\n                    if (details) {\n                        let progressbar = $card.find('.tasks .progress-bar');\n                        if (progressbar.length > 0) {\n                            progressbar.css('width', Math.round(details.completed / details.total * 100) + '%');\n                            if (details.completed == details.total) {\n                                progressbar.addClass('bg-success').removeClass('bg-primary');\n                            } else {\n                                progressbar.removeClass('bg-success').addClass('bg-primary');\n                            }\n                            $card.find('.percentage')\n                                .text(Math.round(details.completed / details.total * 100));\n                            $card.find('.items').text(`(${details.completed}/${details.total})`);\n                            $card.find('.xp').text(details.xp);\n                        }\n                    }\n\n                    // Update the browser url to the current course.\n                    history.pushState(null, null, M.cfg.wwwroot + '/course/view.php?id=' + course);\n\n                    if (iframeAnnos) {\n                        // Remove the new-bagde from the poster.\n                        $card.find('.new-badge').remove();\n                    }\n\n                    $card.closest('.modtype_interactivevideo')[0]\n                        .scrollIntoView({behavior: \"smooth\", block: \"center\", inline: \"center\"});\n                });\n\n                // Close modal when the browser back button is clicked.\n                window.onpopstate = function() {\n                    $('#playermodal').modal('hide');\n                };\n            });\n\n            $(document).on('click', '.interactivevideo-card .description-show',\n                function() {\n                    const $description = $(this).closest('.top-section').find('.description');\n                    $description.slideToggle('fast', 'swing');\n                    $(this).toggleClass('rotate');\n                });\n\n            // Get the #hash from the url and scroll to the element and hover it.\n            $(document).ready(function() {\n                let hash = window.location.hash;\n                if (hash) {\n                    let $element = $(hash);\n                    if ($element.length > 0 && $element.hasClass('modtype_interactivevideo')) {\n                        $element.addClass('highlighted');\n                        setTimeout(() => {\n                            $element[0].scrollIntoView({behavior: \"smooth\", block: \"center\", inline: \"center\"});\n                            setTimeout(function() {\n                                $element.removeClass('highlighted');\n                            }, 3000);\n                        }, 1000);\n                    }\n                }\n            });\n        },\n    };\n});"],"names":["define","$","init","document","on","e","showcontrols","localStorage","getItem","preventDefault","id","this","data","instance","course","contextid","$card","closest","find","addClass","modal","M","cfg","wwwroot","remove","append","iframeDoc","iframeAnnos","details","player","$completion","clone","html","checkIframeDoc","getElementById","contentDocument","contentWindow","IVANNO","hide","IVPLAYER","removeClass","setTimeout","toggleClass","hasClass","setItem","removeItem","addEventListener","detail","$message","querySelector","$activestart","$header","fadeIn","fadeOut","headerFunction","$progressbar","length","current","percentage","css","text","Math","round","requestAnimationFrame","off","parent","history","pushState","async","pause","completion","ajax","url","method","dataType","action","cmid","sesskey","courseid","userid","userId","completiondata","JSON","parse","$manualcompletion","progressbar","completed","total","xp","scrollIntoView","behavior","block","inline","window","onpopstate","slideToggle","ready","hash","location","$element"],"mappings":"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"}