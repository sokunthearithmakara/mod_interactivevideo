/**
 * Launch the interactive video in modal on course page
 *
 * @module     mod_interactivevideo/launch
 * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_interactivevideo/launch",["jquery"],(function($){return{init:function(){$(document).on("click",".launch-interactivevideo",(function(e){let showcontrols=!!localStorage.getItem("showcontrols");e.preventDefault();const id=$(this).data("id"),instance=$(this).data("instance"),course=$(this).data("course"),contextid=$(this).data("contextid"),$card=$(this).closest("#interactivevideo-"+instance);$card.find(".image-container").addClass("hovered");const modal='<div class="modal fade p-0 modal-fullscreen rounded-0" id="playermodal"\n                data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="playermodalLabel"\n                aria-hidden="true">\n                   <div class="rounded-0 modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl position-relative">\n                    <div class="position-fixed w-100 h-100 no-pointer bg-transparent z-index-1" id="background-loading">\n                        <div class="d-flex h-100 align-items-center justify-content-center">\n                            <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;" role="status">\n                                <span class="sr-only">Loading...</span>\n                            </div>\n                        </div>\n                    </div>\n                       <div class="modal-content '.concat(showcontrols?"show-control":"",'">\n                       <div class="modal-header border-0 text-white align-items-center py-0 h-0\n                        position-absolute w-100 z-index-1 rounded-0">\n                         <div class="modal-background w-100 position-absolute"></div>\n                               <span class="modal-title text-truncate position-relative z-index-1" id="playermodalLabel">\n                               <span class="h5 text-truncate mb-0">\n                               <button type="button" class="btn border-0 m-1 p-1 h5" data-dismiss="modal" aria-label="Close">\n                                   <i class="fa fa-arrow-left text-white m-0 fa-2x" aria-hidden="true"></i>\n                               </button></span>\n                               <div class="d-sm-none d-block small ml-2" data-region="activity-completion">\n                               </div></span>\n                               <div class="modal-action d-flex align-items-center position-relative z-index-1">\n                               <div class="d-none d-sm-block small" data-region="activity-completion">\n                               </div>\n                               <a type="button" class="btn ml-2 border-0 h5 mb-0"\n                                href="').concat(M.cfg.wwwroot,"/mod/interactivevideo/view.php?id=").concat(id,'">\n                               <i class="fa fa-external-link text-white m-0 fa-xl" aria-hidden="true"></i></a>\n                               </div>\n                           </div>\n                           <div class="modal-body p-0 position-relative">\n                           <iframe id="ivplayer" src="').concat(M.cfg.wwwroot,"/mod/interactivevideo/view.php?id=").concat(id,'&embed=1" frameborder=0\n                           class="w-100 position-absolute h-100"></iframe>\n                           <button type="button" class="btn border-0 m-1 p-1 h5 toggle-controls d-none">\n                                   <i class="fa fa-chevron-up text-white m-0 fa-2x" aria-hidden="true"></i>\n                               </button></span>\n                           </div>\n                       </div>\n                   </div>\n               </div>');$("#playermodal").remove(),$("body").append(modal),$("#playermodal").modal("show");let iframeDoc,iframeAnnos,details,player;$("#playermodal").on("shown.bs.modal",(function(){$(this).find(".modal-header").addClass("show");let $completion=$card.find("[data-region=activity-information]");$completion=$completion.clone(),$(this).find('[data-region="activity-completion"]').html($completion);let checkIframeDoc=function(){if(iframeDoc=document.getElementById("ivplayer").contentDocument,iframeAnnos=document.getElementById("ivplayer").contentWindow.IVANNO,iframeDoc.getElementById("player"))if($("#background-loading").hide(0),iframeAnnos)if(player=document.getElementById("ivplayer").contentWindow.IVPLAYER,iframeDoc.getElementById("player")){$("#playermodal .modal-header").removeClass("show"),$("#playermodal .toggle-controls").removeClass("d-none"),showcontrols||setTimeout((function(){$("#playermodal .modal-content").removeClass("show-control")}),1e3),$("#playermodal .toggle-controls").on("click",(function(){$("#playermodal .modal-content").toggleClass("show-control"),showcontrols=$("#playermodal .modal-content").hasClass("show-control"),showcontrols?localStorage.setItem("showcontrols","1"):localStorage.removeItem("showcontrols")})),iframeDoc.addEventListener("annotationitemsrendered",(function(e){details=e.detail})),$(iframeDoc).on("mousemove","#video-wrapper",(function(){let $message=iframeDoc.querySelector("#message"),$activestart=iframeDoc.querySelector("#start-screen:not(.d-none) .hasintro");$message||$activestart?$("#playermodal .modal-header").removeClass("show"):function(){let $header=$("#playermodal .modal-header");$header.hasClass("show")||($header.addClass("show"),$header.fadeIn(),setTimeout((function(){$header.removeClass("show"),$header.fadeOut()}),5e3))}()}));let $progressbar=$card.find(".analytics.progress .progress-bar");if(0==$progressbar.length)return;let current=$progressbar.data("current");iframeDoc.addEventListener("analyticsupdated",(function(e){let percentage=e.detail.percentage;percentage>current&&($progressbar.css("width",percentage+"%").data("current",percentage),$card.find(".analytics-percentage").text(Math.round(percentage)))}))}else requestAnimationFrame(checkIframeDoc);else requestAnimationFrame(checkIframeDoc);else requestAnimationFrame(checkIframeDoc)};requestAnimationFrame(checkIframeDoc),$(document).off("click",'#playermodal [data-action="toggle-manual-completion"]').on("click",'#playermodal [data-action="toggle-manual-completion"]',(function(){$(this).parent().addClass("updated"),1==$(this).data("withavailability")&&history.pushState(null,null,M.cfg.wwwroot+"/course/view.php?id="+course+"#module-"+id)})),history.pushState(null,null,M.cfg.wwwroot+"/mod/interactivevideo/view.php?id="+id)})),$("#playermodal").on("hide.bs.modal",(async function(){if(setTimeout((function(){$card.find(".image-container").removeClass("hovered")}),1e3),!player)return void $(this).remove();if(await player.pause(),$card.find(".automatic-completion-conditions").length>0){const completion=await $.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_cm_completion",cmid:id,sesskey:M.cfg.sesskey,contextid:contextid,courseid:course,userid:M.cfg.userId||0}});completion&&$card.find("[data-region=activity-information]").html($(completion).html())}let $manualcompletion=$(this).find(".completion-info.updated");if($manualcompletion.length>0&&$card.find(".completion-info").html($manualcompletion.html()),details){let progressbar=$card.find(".tasks .progress-bar");progressbar.length>0&&(progressbar.css("width",Math.round(details.completed/details.total*100)+"%"),details.completed==details.total?progressbar.addClass("bg-success").removeClass("bg-primary"):progressbar.removeClass("bg-success").addClass("bg-primary"),$card.find(".percentage").text(Math.round(details.completed/details.total*100)),$card.find(".items").text("(".concat(details.completed,"/").concat(details.total,")")),$card.find(".xp").text(details.xp))}history.pushState(null,null,M.cfg.wwwroot+"/course/view.php?id="+course),iframeAnnos&&$card.find(".new-badge").remove(),$card.closest(".modtype_interactivevideo")[0].scrollIntoView({behavior:"smooth",block:"center",inline:"center"})})),window.onpopstate=function(){$("#playermodal").modal("hide")}})),$(document).on("click",".interactivevideo-card .description-show",(function(){$(this).closest(".top-section").find(".description").slideToggle("fast","swing"),$(this).toggleClass("rotate")})),$(document).ready((function(){let hash=window.location.hash;if(hash){let $element=$(hash);$element.length>0&&$element.hasClass("modtype_interactivevideo")&&($element.addClass("highlighted"),setTimeout((()=>{$element[0].scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),setTimeout((function(){$element.removeClass("highlighted")}),3e3)}),1e3))}}))}}}));

//# sourceMappingURL=launch.min.js.map